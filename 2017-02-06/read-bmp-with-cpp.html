<!DOCTYPE html>
<html lang="zh">

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  
  
  <title>使用 C++ 读取简单的 24、32 位 BMP 图像</title>
  <meta name="description" content="BMP 是 Windows 下常见的一种位图格式。之所以我们选择直接读取 BMP 格式（即不使用其他的库）而非 JPG、PNG 等其他图像格式，是因为：">
  

  <link rel="stylesheet" href="/assets/main.css">
  <link rel="canonical" href="https://blog.taoky.moe/2017-02-06/read-bmp-with-cpp.html">
  
  
  <link rel="alternate" type="application/rss+xml" title="taoky&#39;s blog" href="https://blog.taoky.moe/feed.xml">

  <link rel="stylesheet" href="/assets/typo.css">
<link rel="stylesheet" href="/assets/fonts.css">

  <link href="/assets/fonts/bitter.css" rel="stylesheet">
  
  
  
    <!-- Google Analytics -->
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-44647340-1', 'auto');
      ga('send', 'pageview');
    </script>
  


</head>


  <body>

    <header class="site-header">

  <div class="wrapper">

    <a class="site-title" href="/">taoky&#39;s blog</a>

    <nav class="site-nav">
      <input type="checkbox" id="nav-trigger" class="nav-trigger" />
      <label for="nav-trigger">
        <span class="menu-icon">
          <svg viewBox="0 0 18 15" width="18px" height="15px">
            <path
              d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z" />
          </svg>
        </span>
      </label>
      <div class="trigger">
        
        
        <a class="page-link" href="/about/">About</a>
        
        
        <a class="page-link" href="/archives/">Archives</a>
        
        
        <a class="page-link" href="/projects/">Projects</a>
        
        
        <a class="page-link" href="/TAsterisk">TA*</a>
        
        
        <a class="page-link" href="https://github.com/taoky">GitHub</a>
        
      </div>
    </nav>

  </div>

</header>

    <main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post typo" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    
      <h1 class="post-title" itemprop="name headline">使用 C++ 读取简单的 24、32 位 BMP 图像</h1>
    
    <p class="post-meta"><time datetime="2017-02-06T00:00:00+00:00" itemprop="datePublished">Feb 6, 2017</time> •
  
    
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
        <a href="/categories/%E7%A8%8B%E5%BA%8F/">程序</a>
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
  


 •
  
    
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
        <a href="/tags/c++/">C++</a>,
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
  
    
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
        <a href="/tags/bmp/">BMP</a>
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
  

</p>
  </header>

  

  <div class="post-content" itemprop="articleBody">
    <p>BMP 是 Windows 下常见的一种位图格式。之所以我们选择直接读取 BMP 格式（即不使用其他的库）而非 JPG、PNG 等其他图像格式，是因为：</p>

<ul>
  <li>BMP 的文档是公开的。没有版权、专利问题。</li>
  <li>运用较广泛，常见。</li>
  <li>结构相对简单，一般来讲没有压缩，代码容易写。</li>
</ul>

<p>接下来，我将尝试用最简单的方式来介绍 BMP 格式的结构，并且尽可能让之后出现的代码不依赖于具体的操作系统平台与特定的编译器实现。建议备一个十六进制查看器以方便理解。</p>

<p>（下文可能会有错误，并且不会处理「特殊的」BMP 文件。等我高考完之后如果还有兴趣，可能会再去做其他情况下的 BMP 文件读取。）
<!--more--></p>

<h2 id="文件头-1bitmapfileheader">文件头 1：<code class="language-plaintext highlighter-rouge">BITMAPFILEHEADER</code></h2>

<p><code class="language-plaintext highlighter-rouge">BITMAPFILEHEADER</code> 有四小块。如下表：</p>

<table>
  <thead>
    <tr>
      <th style="text-align: left">名称</th>
      <th style="text-align: left">大小（字节）</th>
      <th style="text-align: left">介绍</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">bfType</code></td>
      <td style="text-align: left">2</td>
      <td style="text-align: left">Windows 格式的 BMP 文件为「BM」。</td>
    </tr>
    <tr>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">bfSize</code></td>
      <td style="text-align: left">4</td>
      <td style="text-align: left">BMP 文件的大小。</td>
    </tr>
    <tr>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">bfReserved1</code></td>
      <td style="text-align: left">2</td>
      <td style="text-align: left">保留值。</td>
    </tr>
    <tr>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">bfReserved2</code></td>
      <td style="text-align: left">2</td>
      <td style="text-align: left">保留值。</td>
    </tr>
    <tr>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">bfOffBits</code></td>
      <td style="text-align: left">4</td>
      <td style="text-align: left">位图像素内容的偏移量（起始地址）。</td>
    </tr>
  </tbody>
</table>

<p>可能没有什么特别的地方，<code class="language-plaintext highlighter-rouge">bfType</code> 中检查是不是 <code class="language-plaintext highlighter-rouge">BM</code> 就行了，OS/2 有其他类型的 BMP 格式，可是也不想想它死了多少年了……</p>

<p>注意，文件头中的所有数据均以<strong>小端序</strong>存放。（简单而很不严谨地说，就是字节倒着读）</p>

<h2 id="文件头-2bitmapinfoheader">文件头 2：<code class="language-plaintext highlighter-rouge">BITMAPINFOHEADER</code></h2>

<p>其实在这个位置是有其他版本的不同的文件头的，但是一般的 BMP 文件都是 <code class="language-plaintext highlighter-rouge">BITMAPINFOHEADER</code>。</p>

<p>它有十一小块，如下表：</p>

<table>
  <thead>
    <tr>
      <th style="text-align: left">名称</th>
      <th style="text-align: left">大小（字节）</th>
      <th style="text-align: left">介绍</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">biSize</code></td>
      <td style="text-align: left">4</td>
      <td style="text-align: left">此文件头（<code class="language-plaintext highlighter-rouge">BITMAPINFOHEADER</code>）的大小。</td>
    </tr>
    <tr>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">biWidth</code></td>
      <td style="text-align: left">4</td>
      <td style="text-align: left">图像的宽度，以像素为单位。</td>
    </tr>
    <tr>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">biHeight</code></td>
      <td style="text-align: left">4</td>
      <td style="text-align: left">图像的高度，以像素为单位。</td>
    </tr>
    <tr>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">biPlanes</code></td>
      <td style="text-align: left">2</td>
      <td style="text-align: left">图像的色彩平面，正常情况下均为 1。</td>
    </tr>
    <tr>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">biBitCount</code></td>
      <td style="text-align: left">2</td>
      <td style="text-align: left">每个像素的位数。</td>
    </tr>
    <tr>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">biCompression</code></td>
      <td style="text-align: left">4</td>
      <td style="text-align: left">BMP 文件的压缩种类，0 为无压缩。</td>
    </tr>
    <tr>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">biSizeImage</code></td>
      <td style="text-align: left">4</td>
      <td style="text-align: left">位图像素内容的大小，无压缩时可以填 0。</td>
    </tr>
    <tr>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">biXPelsPerMeter</code></td>
      <td style="text-align: left">4</td>
      <td style="text-align: left">图像横向每米存放的像素。</td>
    </tr>
    <tr>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">biYPelsPerMeter</code></td>
      <td style="text-align: left">4</td>
      <td style="text-align: left">图像纵向每米存放的像素。</td>
    </tr>
    <tr>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">biClrUsed</code></td>
      <td style="text-align: left">4</td>
      <td style="text-align: left">图像使用的色彩数，可以为 0。</td>
    </tr>
    <tr>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">biClrImportant</code></td>
      <td style="text-align: left">4</td>
      <td style="text-align: left">图像使用的「重要」的色彩数，0 时均重要。</td>
    </tr>
  </tbody>
</table>

<p>因为我们不想写解压算法，所以需要保证处理的 BMP 文件的 <code class="language-plaintext highlighter-rouge">biCompression</code> 为 0。我们之后也不想处理调色板（Color Table, Palette），而是直接读取像素内容，所以需要保证 <code class="language-plaintext highlighter-rouge">biBitCount</code> 为 24 或者 32（即 24 或 32 位的位图），因为它们一般是不含调色板的。</p>

<p>注意，图像的高度<strong>可以为负</strong>。负数值表示接下来的像素内容将从左上角从左到右、从上到下读取；而正数值表示接下来的像素内容将从右下角从左到右、从下到上读取。必要的时候请记得取绝对值。</p>

<p><img src="/pictures/bmp-cpp/1.png" alt="对高度取相反数后的结果" /></p>

<p>（对 <code class="language-plaintext highlighter-rouge">biHeight</code> 取相反数后的结果，改了四个字节，图像就反过来了～）</p>

<h2 id="像素内容">像素内容</h2>

<p>接下来就是我们期待的位图像素内容了。我们之前说过<strong>忽略</strong>了调色板等其他的东西，所以在 <code class="language-plaintext highlighter-rouge">BITMAPINFOHEADER</code> 之后便直接是像素内容了。</p>

<p>标题中只写了 24 位和 32 位的图像，所以更低的位数不考虑。（毕竟你现在，除了在 gif 动图之外，还能见到 8 位色的图像吗？）</p>

<p>在 24 位（3 字节）的位图中，每个像素按<strong>顺序</strong>由三部分组成：蓝色值、绿色值、红色值。32 位（4 字节）的图像添加了 Alpha 透明度部分，在红色值后添加了一字节的 Alpha 值（不透明的 32 位 BMP 图像，每个像素的 Alpha 值字节十六进制均为 <code class="language-plaintext highlighter-rouge">FF</code>）。</p>

<p>然后我们只需要一个一个读就行了吗？</p>

<p>当然不是。还有一个特别的注意点：<strong>图像每行的字节大小都必须是 4 字节的倍数。</strong>不足的需要补齐。当然很明显的是，32 位的 BMP 就不需要考虑这一点了。</p>

<hr />

<p>一切准备好了。所以，让我们开干吧。</p>

<h2 id="具体实现">具体实现</h2>

<p>（这个实现比较草率，因为我确实时间不多了。）</p>

<p>首先把两个文件头，加上表示像素的结构，包在 <code class="language-plaintext highlighter-rouge">struct</code> 里面：</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">struct</span> <span class="nc">BITMAPFILEHEADER</span>
<span class="p">{</span>
  <span class="kt">char</span> <span class="n">bfType</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span> <span class="c1">// must be "BM"</span>
  <span class="kt">char</span> <span class="n">bfSize</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span> <span class="c1">// the size of the bmp file</span>
  <span class="kt">char</span> <span class="n">bfReserved1</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
  <span class="kt">char</span> <span class="n">bfReserved2</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
  <span class="kt">char</span> <span class="n">bfOffBits</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span> <span class="c1">// the offset to the bitmap data</span>
<span class="p">}</span> <span class="n">FileHeader</span><span class="p">;</span>

<span class="k">struct</span> <span class="nc">BITMAPINFOHEADER</span>
<span class="p">{</span>
  <span class="kt">char</span> <span class="n">biSize</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span> <span class="c1">// the size of BITMAPINFOHEADER</span>
  <span class="kt">char</span> <span class="n">biWidth</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span> <span class="c1">// width (pixels)</span>
  <span class="kt">char</span> <span class="n">biHeight</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span> <span class="c1">// height (pixels)</span>
  <span class="kt">char</span> <span class="n">biPlanes</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span> <span class="c1">// color planes</span>
  <span class="kt">char</span> <span class="n">biBitCount</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span> <span class="c1">// bits per pixel</span>
  <span class="kt">char</span> <span class="n">biCompression</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span> <span class="c1">// type of compression (0 is no compression)</span>
  <span class="kt">char</span> <span class="n">biSizeImage</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span> <span class="c1">// the origin size of the bitmap data (before compression)</span>
  <span class="kt">char</span> <span class="n">biXPelsPerMeter</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span> <span class="c1">// horizontal pixels per meter</span>
  <span class="kt">char</span> <span class="n">biYPelsPerMeter</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span> <span class="c1">// vertical pixels per meter</span>
  <span class="kt">char</span> <span class="n">biClrUsed</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span> <span class="c1">// the number of colors used</span>
  <span class="kt">char</span> <span class="n">biClrImportant</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span> <span class="c1">// "important" colors, usually 0</span>
<span class="p">}</span> <span class="n">InfoHeader</span><span class="p">;</span>

<span class="k">struct</span> <span class="nc">Pixel</span>
<span class="p">{</span>
  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">b</span><span class="p">;</span>
  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">g</span><span class="p">;</span>
  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span> <span class="n">p</span><span class="p">;</span>
</code></pre></div></div>

<p>为了能够把小端序转换成整型变量，我们还需要一个小函数：</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kr">inline</span> <span class="kt">int</span> <span class="nf">ToHumanRead</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="mi">4</span><span class="p">)</span>
<span class="p">{</span>
  <span class="c1">// Convert to Big Endian</span>
  <span class="kt">long</span> <span class="n">l</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">l</span><span class="p">,</span> <span class="n">str</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
  <span class="k">return</span> <span class="p">(</span><span class="kt">signed</span> <span class="kt">int</span><span class="p">)</span><span class="n">l</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>在主函数部分，我们先读取文件，然后进行进一步操作：</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span>
<span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span>
  <span class="p">{</span>

    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"Parameters Error."</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"Use: "</span> <span class="o">&lt;&lt;</span> <span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="s">" xxxx.bmp"</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="n">bmpfile</span><span class="p">.</span><span class="n">open</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">ios</span><span class="o">::</span><span class="n">in</span> <span class="o">|</span> <span class="n">ios</span><span class="o">::</span><span class="n">binary</span><span class="p">);</span> <span class="c1">// open the file</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">bmpfile</span><span class="p">.</span><span class="n">is_open</span><span class="p">())</span>
  <span class="p">{</span>
    <span class="n">bmpfile</span><span class="p">.</span><span class="n">read</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">FileHeader</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">FileHeader</span><span class="p">));</span> <span class="c1">// Read BITMAPFILEHEADER</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">FileHeader</span><span class="p">.</span><span class="n">bfType</span><span class="p">,</span> <span class="s">"BM"</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="c1">// Judge whether a BMP.</span>
    <span class="p">{</span>
      <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"Not a BMP File, or an Unsupported OS/2 BMP File."</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
      <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">bmpfile</span><span class="p">.</span><span class="n">read</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">InfoHeader</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">InfoHeader</span><span class="p">));</span> <span class="c1">// Read BITMAPINFOHEADER</span>
    <span class="cm">/* Information Output */</span>
    <span class="n">Output_FileHeader</span><span class="p">();</span>
    <span class="n">Output_InfoHeader</span><span class="p">();</span>
    <span class="cm">/* Output End */</span>
    <span class="n">vector</span> <span class="o">&lt;</span><span class="n">Pixel</span><span class="o">&gt;</span> <span class="o">*</span><span class="n">vec</span> <span class="o">=</span> <span class="n">ReadBitmap</span><span class="p">();</span> <span class="c1">// Read the data</span>
    
    <span class="kt">int</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">cin</span> <span class="o">&gt;&gt;</span> <span class="n">x</span> <span class="o">&gt;&gt;</span> <span class="n">y</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">x</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
      <span class="n">PrintLocation</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">vec</span><span class="p">);</span>
    <span class="p">}</span>
    
    <span class="c1">// Close file and delete vec</span>
    <span class="n">bmpfile</span><span class="p">.</span><span class="n">close</span><span class="p">();</span>
    <span class="k">delete</span> <span class="p">[]</span> <span class="n">vec</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">else</span>
  <span class="p">{</span>
    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"Open File Error."</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>其中的 <code class="language-plaintext highlighter-rouge">vector</code> 是用来储存像素内容的，Output 部分输出 BMP 文件头内容，使用 <code class="language-plaintext highlighter-rouge">ReadBitmap()</code> 读入后等待用户输入坐标，显示对应像素的 RGB 值。</p>

<p>Output 部分：</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">Output_FileHeader</span><span class="p">()</span>
<span class="p">{</span>
  <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"File Size (BITMAPFILEHEADER): "</span> <span class="o">&lt;&lt;</span> <span class="n">ToHumanRead</span><span class="p">(</span><span class="n">FileHeader</span><span class="p">.</span><span class="n">bfSize</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
  <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"Reserved 1 (usually 0, BITMAPFILEHEADER): "</span> <span class="o">&lt;&lt;</span> <span class="n">ToHumanRead</span><span class="p">(</span><span class="n">FileHeader</span><span class="p">.</span><span class="n">bfReserved1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
  <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"Reserved 2 (usually 0, BITMAPFILEHEADER): "</span> <span class="o">&lt;&lt;</span> <span class="n">ToHumanRead</span><span class="p">(</span><span class="n">FileHeader</span><span class="p">.</span><span class="n">bfReserved2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
  <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"Bitmap Data Offset (BITMAPFILEHEADER): "</span> <span class="o">&lt;&lt;</span> <span class="n">ToHumanRead</span><span class="p">(</span><span class="n">FileHeader</span><span class="p">.</span><span class="n">bfOffBits</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">Output_InfoHeader</span><span class="p">()</span>
<span class="p">{</span>
  <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"BITMAPINFOHEADER Size: "</span> <span class="o">&lt;&lt;</span> <span class="n">ToHumanRead</span><span class="p">(</span><span class="n">InfoHeader</span><span class="p">.</span><span class="n">biSize</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
  <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"Width (BITMAPINFOHEADER): "</span> <span class="o">&lt;&lt;</span> <span class="n">ToHumanRead</span><span class="p">(</span><span class="n">InfoHeader</span><span class="p">.</span><span class="n">biWidth</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
  <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"Height (BITMAPINFOHEADER): "</span> <span class="o">&lt;&lt;</span> <span class="n">ToHumanRead</span><span class="p">(</span><span class="n">InfoHeader</span><span class="p">.</span><span class="n">biHeight</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
  <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"Number of Color Planes (BITMAPINFOHEADER): "</span> <span class="o">&lt;&lt;</span> <span class="n">ToHumanRead</span><span class="p">(</span><span class="n">InfoHeader</span><span class="p">.</span><span class="n">biPlanes</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
  <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"Number of Bits per Pixel (BITMAPINFOHEADER): "</span> <span class="o">&lt;&lt;</span> <span class="n">ToHumanRead</span><span class="p">(</span><span class="n">InfoHeader</span><span class="p">.</span><span class="n">biBitCount</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
  <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"Compression Type (0 is none, BITMAPINFOHEADER): "</span> <span class="o">&lt;&lt;</span> <span class="n">ToHumanRead</span><span class="p">(</span><span class="n">InfoHeader</span><span class="p">.</span><span class="n">biCompression</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
  <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"Original Size of Bitmap (0 usually if no compression, BITMAPINFOHEADER): "</span> <span class="o">&lt;&lt;</span> <span class="n">ToHumanRead</span><span class="p">(</span><span class="n">InfoHeader</span><span class="p">.</span><span class="n">biSizeImage</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
  <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"Number of Horizontal Pixels per Meter (0 usually, BITMAPINFOHEADER): "</span> <span class="o">&lt;&lt;</span> <span class="n">ToHumanRead</span><span class="p">(</span><span class="n">InfoHeader</span><span class="p">.</span><span class="n">biXPelsPerMeter</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
  <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"Number of Vertical Pixels per Meter (0 usually, BITMAPINFOHEADER): "</span> <span class="o">&lt;&lt;</span> <span class="n">ToHumanRead</span><span class="p">(</span><span class="n">InfoHeader</span><span class="p">.</span><span class="n">biYPelsPerMeter</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
  <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"Number of Color Used (0 sometimes, BITMAPINFOHEADER): "</span> <span class="o">&lt;&lt;</span> <span class="n">ToHumanRead</span><span class="p">(</span><span class="n">InfoHeader</span><span class="p">.</span><span class="n">biClrUsed</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
  <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"Number of Important Color (0 means all is important, BITMAPINFOHEADER): "</span> <span class="o">&lt;&lt;</span> <span class="n">ToHumanRead</span><span class="p">(</span><span class="n">InfoHeader</span><span class="p">.</span><span class="n">biClrImportant</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>写得比较草率。将文件头的内容全部输出。</p>

<p>读取部分：</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">drop_alpha</span><span class="p">()</span>
<span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">ToHumanRead</span><span class="p">(</span><span class="n">InfoHeader</span><span class="p">.</span><span class="n">biBitCount</span><span class="p">)</span> <span class="o">==</span> <span class="mi">32</span><span class="p">)</span>
  <span class="p">{</span>

    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">null</span><span class="p">;</span>
    <span class="n">bmpfile</span><span class="p">.</span><span class="n">read</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">null</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">null</span><span class="p">));</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="n">vector</span> <span class="o">&lt;</span><span class="n">Pixel</span><span class="o">&gt;</span> <span class="o">*</span> <span class="nf">ReadBitmap</span><span class="p">()</span>
<span class="p">{</span>
  <span class="kt">int</span> <span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">height</span> <span class="o">=</span> <span class="n">ToHumanRead</span><span class="p">(</span><span class="n">InfoHeader</span><span class="p">.</span><span class="n">biHeight</span><span class="p">);</span>
  <span class="kt">int</span> <span class="n">width</span> <span class="o">=</span> <span class="n">ToHumanRead</span><span class="p">(</span><span class="n">InfoHeader</span><span class="p">.</span><span class="n">biWidth</span><span class="p">);</span>

  <span class="kt">int</span> <span class="n">linebyte</span> <span class="o">=</span> <span class="n">width</span> <span class="o">*</span> <span class="n">ToHumanRead</span><span class="p">(</span><span class="n">InfoHeader</span><span class="p">.</span><span class="n">biBitCount</span><span class="p">)</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>
  <span class="n">offset</span> <span class="o">=</span> <span class="n">linebyte</span> <span class="o">%</span> <span class="mi">4</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">offset</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="n">offset</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">-</span> <span class="n">offset</span><span class="p">;</span> <span class="c1">// "linebyte" should be the multiple of 4</span>
  <span class="c1">// cout &lt;&lt; "Bytes per line: " &lt;&lt; linebyte &lt;&lt; endl;</span>
  <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"Offset: "</span> <span class="o">&lt;&lt;</span> <span class="n">offset</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
  <span class="n">vector</span> <span class="o">&lt;</span><span class="n">Pixel</span><span class="o">&gt;</span> <span class="o">*</span><span class="n">vec</span> <span class="o">=</span> <span class="k">new</span> <span class="n">vector</span> <span class="o">&lt;</span><span class="n">Pixel</span><span class="o">&gt;</span> <span class="p">[</span><span class="n">abs</span><span class="p">(</span><span class="n">height</span><span class="p">)];</span>
  <span class="c1">// Height could be a negative number.</span>
  <span class="kt">bool</span> <span class="n">isBottom</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">ToHumanRead</span><span class="p">(</span><span class="n">InfoHeader</span><span class="p">.</span><span class="n">biHeight</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="c1">// read from bottom</span>
  <span class="p">{</span>
    <span class="n">isBottom</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">abs</span><span class="p">(</span><span class="n">height</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">width</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">bmpfile</span><span class="p">.</span><span class="n">read</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">p</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">p</span><span class="p">));</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">isBottom</span><span class="p">)</span> <span class="n">vec</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">push_back</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
      <span class="k">else</span> <span class="n">vec</span><span class="p">[</span><span class="n">height</span> <span class="o">-</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="n">push_back</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
      <span class="n">drop_alpha</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">offset</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">null</span><span class="p">;</span>
      <span class="n">bmpfile</span><span class="p">.</span><span class="n">read</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">null</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">null</span><span class="p">));</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="n">vec</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">drop_alpha()</code> 是为了把 32 位位图中的 Alpha 信息丢掉，方便处理，当然你也可以把它们留着……<code class="language-plaintext highlighter-rouge">ReadBitmap()</code> 部分先计算 <code class="language-plaintext highlighter-rouge">offset</code>（每行需要补齐的字节），再根据高度的正负值分类读取数据。</p>

<p>最后一个部分，输出 RGB 值：</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">PrintLocation</span><span class="p">(</span><span class="kt">int</span> <span class="n">x</span><span class="p">,</span> <span class="kt">int</span> <span class="n">y</span><span class="p">,</span> <span class="n">vector</span> <span class="o">&lt;</span><span class="n">Pixel</span><span class="o">&gt;</span> <span class="o">*</span> <span class="n">vec</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">vec</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="n">y</span><span class="p">].</span><span class="n">r</span> <span class="o">&lt;&lt;</span> <span class="s">" "</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">vec</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="n">y</span><span class="p">].</span><span class="n">g</span> <span class="o">&lt;&lt;</span> <span class="s">" "</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">vec</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="n">y</span><span class="p">].</span><span class="n">b</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>完整的代码在<a href="/attachments/bmp1.cpp">此</a>。</p>

<h2 id="参考链接">参考链接：</h2>

<p><a href="https://web.archive.org/web/20080912171714/http://www.fortunecity.com/skyscraper/windows/364/bmpffrmt.html">The .bmp file format</a></p>

<p><a href="https://en.wikipedia.org/wiki/BMP_file_format">BMP file format (Wikipedia)</a></p>

  </div>

  
    <div class="post-comments" itemprop="comment">
      <hr />
<h3>Comments</h3>
<p id="comment_darkmode_warning" style="display: none;">Note: Disqus 完整评论组件不以暗黑模式显示。</p>
<div id="disqus_thread"></div>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/disqusjs@1.3/dist/disqusjs.css">
<script src="https://cdn.jsdelivr.net/npm/disqusjs@1.3/dist/disqus.js"></script>
<script>
var dsqjs = new DisqusJS({
    shortname: 'taokyblog',
    siteName: 'taoky\'s blog',
    // identifier: '',
    // url: '',
    // title: '',
    api: '//blog.taoky.moe/api/',
    apikey: 'L3W1Q35kDbi2ZGTV2iEfZ8SIksrYf847Ft0ufGon9ye1PTVxG902wO3FtIUq4wgO',
    nocomment: '无评论.',
    admin: 'taoky',
    adminLabel: 'taoky'
});
/**
*  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
*  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
/*
var disqus_config = function () {
this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
};
*/
// (function() { // DON'T EDIT BELOW THIS LINE
// var d = document, s = d.createElement('script');
// s.src = 'https://taokyblog.disqus.com/embed.js';
// s.setAttribute('data-timestamp', +new Date());
// (d.head || d.body).appendChild(s);
// })();
</script>
<noscript>Disqus comment requires JavaScript.</a></noscript>
    </div>
  

</article>

      </div>
    </main>

    <footer class="site-footer">

  <div class="wrapper">

    <p>
      

Author: taoky - Subscribe via <a href="https://blog.taoky.moe/feed.xml">RSS</a>
<br>
License: <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/">知识共享署名-非商业性使用-相同方式共享 4.0 国际许可协议（CC-BY-NC-SA 4.0）</a>
    </p>

  </div>

</footer>


  </body>

</html>
