<!DOCTYPE html>
<html lang="zh_CN">

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  
  
  <title>OS X 下的 App 数字证书和更多</title>
  <meta name="description" content="最近的 XcodeGhost 事情闹得沸沸扬扬，大家都被吓得不轻。假的 Xcode 这么长时间没有被发现，一方面可能是关掉了 Gatekeeper 的原因；另一方面，有时开了 Gatekeeper 还是没有被检测出来，并且表面上是看不出来程序有没有数字签名的，不像 Windows 里面右键属性就可以看到。 Gatekeeper 是什么？它出了什么问题？">
  

  <link rel="stylesheet" href="/assets/main.css">
  <link rel="canonical" href="https://taoky.github.io/2015-09-26/the-codesign-in-osx.html">
  
  
  <link rel="alternate" type="application/rss+xml" title="taoky&#39;s blog" href="https://taoky.github.io/feed.xml">

  <link rel="stylesheet" href="/assets/typo.css">

  
  <meta name="twitter:card" content="summary">
  
  <meta name="twitter:title" content="OS X 下的 App 数字证书和更多">
  <meta name="twitter:description" content="最近的 XcodeGhost 事情闹得沸沸扬扬，大家都被吓得不轻。假的 Xcode 这么长时间没有被发现，一方面可能是关掉了 Gatekeeper 的原因；另一方面，有时开了 Gatekeeper 还是没有被检测出来，并且表面上是看不出来程序有没有数字签名的，不像 Windows 里面右键属性就可以看到。 Gatekeeper 是什么？它出了什么问题？">
  
  

  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css?family=Bitter:400,400i,700" rel="stylesheet">

  
  <!-- Google Analytics -->
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-44647340-1', 'auto');
    ga('send', 'pageview');

  </script>


</head>


  <body>

    <header class="site-header">

  <div class="wrapper">

    <a class="site-title" href="/">taoky&#39;s blog</a>

    <nav class="site-nav">
      <input type="checkbox" id="nav-trigger" class="nav-trigger" />
      <label for="nav-trigger">
        <span class="menu-icon">
          <svg viewBox="0 0 18 15" width="18px" height="15px">
            <path
              d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z" />
          </svg>
        </span>
      </label>
      <div class="trigger">
        
        
        <a class="page-link" href="/about/">About</a>
        
        
        <a class="page-link" href="/archives/">Archives</a>
        
        
        <a class="page-link" href="/projects/">Projects</a>
        
        
        <a class="page-link" href="/TAsterisk">TA*</a>
        
        
        <a class="page-link" href="https://github.com/taoky">GitHub</a>
        
      </div>
    </nav>

  </div>

</header>

    <main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post typo" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    
      <h1 class="post-title" itemprop="name headline">OS X 下的 App 数字证书和更多</h1>
    
    <p class="post-meta"><time datetime="2015-09-26T00:00:00+00:00" itemprop="datePublished">Sep 26, 2015</time> •
  
    
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
        <a href="/categories/%E5%AE%89%E5%85%A8/">安全</a>
      
    
      
    
      
    
      
    
      
    
      
    
      
    
  


 •
  
    
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
        <a href="/tags/%E6%95%B0%E5%AD%97%E8%AF%81%E4%B9%A6/">数字证书</a>,
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
  
    
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
        <a href="/tags/%E5%AE%89%E5%85%A8/">安全</a>,
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
  
    
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
        <a href="/tags/app/">App</a>
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
  

</p>
  </header>

  <div class="user-toc">
    <h3>TOC | 目录</h3>
    <p>最近的 XcodeGhost 事情闹得沸沸扬扬，大家都被吓得不轻。假的 Xcode 这么长时间没有被发现，一方面可能是关掉了 Gatekeeper 的原因；另一方面，有时开了 Gatekeeper 还是没有被检测出来，并且表面上是看不出来程序有没有数字签名的，不像 Windows 里面右键属性就可以看到。
<!--more--></p>
<h3 id="gatekeeper-是什么它出了什么问题">Gatekeeper 是什么？它出了什么问题？</h3>

<p>Gatekeeper 可以检查下载到电脑中的 App 是否有数字签名，文件是否被篡改。如果检测到问题，它会停止应用的运行。然而，它只会检查从互联网上下载的应用。</p>

<p>根据 Apple 官方给的<a href="https://support.apple.com/zh-cn/HT202491">帮助</a>，Gatekeeper 在检测有问题的 App 时会有如下信息：</p>

<ul>
  <li>仅允许 Mac App Store 应用时其它的应用都会被阻止，提示「打不开“XXX”，因为它不是从 Mac App Store 下载的。」</li>
  <li>仅允许 Mac App Store 和被认可的开发者时未签名或已被篡改的应用会被阻止，提示「打不开“XXX”，因为它来自身份不明的开发者。」</li>
  <li>允许任何来源时被篡改的应用仍然会被阻止，提示「“XXX”已损坏，打不开。您应该将它移到废纸篓。」</li>
</ul>

<p>“不对啊，那 Gatekeeper 也应该检测出有问题的 Xcode 并阻止它运行啊。”</p>

<p>Gatekeeper 是通过 com.apple.quarantine 标记来判断文件是否从互联网上下载的。标记可以用 <code class="highlighter-rouge">xattr</code> 来查看。</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  Downloads  xattr -l *.app             
CheatSheet.app: com.apple.quarantine: 0023;00000000;The\x20Unarchiver;8F22E217-7ED8-44D7-B11F-88B319E5B82E
Retinizer.app: com.apple.quarantine: 0043;00000000;The\x20Unarchiver;5E278371-834C-4C31-BC70-58E89F7CD0AF
diumoo.app: com.apple.quarantine: 0003;00000000;The Unarchiver;C91583C2-3D0B-4639-A2D7-41C37AEF5650
</code></pre></div></div>

<p>这是 xattr 在我的电脑的下载目录里的运行结果。从 quarantine 中可知这三个应用都是从网络上下载的。（并且还有一些别的内容，比如说都是用「The Unarchiver」解压缩的）</p>

<p>有些程序在下载的时候并没有设置 quarantine 标记，Gatekeeper 就不会检查，于是……（其实我觉得它不应该只检查从互联网上下载的应用，应该检查所有的应用才是正常的啊）</p>

<p>再说了，就算 Gatekeeper 提示了问题，也挡不住想死的人的步伐：可以直接关掉 Gatekeeper，可以右键打开（打开过后 Gatekeeper 就再也不会检查），还可以在终端里开……</p>

<h3 id="检查数字签名">检查数字签名</h3>

<p>要检查应用的数字签名似乎只能在终端下。<code class="highlighter-rouge">codesign</code> 和 <code class="highlighter-rouge">spctl</code> 可以用来检查应用的数字签名。</p>

<h4 id="codesign"><code class="highlighter-rouge">codesign</code></h4>

<p><code class="highlighter-rouge">codesign</code> 可以来检查应用是否签名以及签名后是否被篡改。</p>

<p>如果一切正常，显示如下：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  /Applications  codesign -vv iTunes.app 
iTunes.app: valid on disk
iTunes.app: satisfies its Designated Requirement
</code></pre></div></div>

<p>如果应用被篡改过，显示如下：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  /Applications  codesign -vv VLC.app 
VLC.app: a sealed resource is missing or invalid
file added: /Applications/VLC.app/Contents/MacOS/plugins/plugins.dat
</code></pre></div></div>

<p>如果应用压根没有签名，显示如下：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  /Applications  codesign -vv OnyX.app 
OnyX.app: code object is not signed at all
In architecture: x86_64
</code></pre></div></div>

<h4 id="spctl"><code class="highlighter-rouge">spctl</code></h4>

<p><code class="highlighter-rouge">spctl</code> 可以用来看是谁给应用签名，当然也可以同时检查签名是否正常。</p>

<p>系统应用：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  /Applications  spctl -avv iTunes.app 
iTunes.app: accepted
source=Apple System
origin=Software Signing
</code></pre></div></div>

<p>Mac App Store 上下载的应用：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  /Applications  spctl -avv GeoGebra\ 5.app 
GeoGebra 5.app: accepted
source=Mac App Store
origin=Apple Mac OS Application Signing
</code></pre></div></div>

<p>其它开发者（就是 Gatekeeper 里面的「被认可的开发者」）授权获得的证书签名的应用：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  /Applications  spctl -avv NeteaseMusic.app 
NeteaseMusic.app: accepted
source=Developer ID
origin=Developer ID Application: NetEase (Hangzhou) Network Co., Ltd. (J669Y64Z9Y)
</code></pre></div></div>

<p>被篡改过的应用：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  /Applications  spctl -avv VLC.app 
VLC.app: a sealed resource is missing or invalid
</code></pre></div></div>

<p>没有签名的应用：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  /Applications  spctl -avv OnyX.app        
OnyX.app: rejected
source=no usable signature
</code></pre></div></div>

<p>如果说这个应用的签名者有问题（比如像 Windows 里面，从百度一不小心下载的 Chrome 安装包却是百度的签名）的话，那这个应用也是有问题的。</p>

<p>以上。</p>

  </div>

  <div class="post-content" itemprop="articleBody">
    <p>最近的 XcodeGhost 事情闹得沸沸扬扬，大家都被吓得不轻。假的 Xcode 这么长时间没有被发现，一方面可能是关掉了 Gatekeeper 的原因；另一方面，有时开了 Gatekeeper 还是没有被检测出来，并且表面上是看不出来程序有没有数字签名的，不像 Windows 里面右键属性就可以看到。
<!--more--></p>
<h3 id="gatekeeper-是什么它出了什么问题">Gatekeeper 是什么？它出了什么问题？</h3>

<p>Gatekeeper 可以检查下载到电脑中的 App 是否有数字签名，文件是否被篡改。如果检测到问题，它会停止应用的运行。然而，它只会检查从互联网上下载的应用。</p>

<p>根据 Apple 官方给的<a href="https://support.apple.com/zh-cn/HT202491">帮助</a>，Gatekeeper 在检测有问题的 App 时会有如下信息：</p>

<ul>
  <li>仅允许 Mac App Store 应用时其它的应用都会被阻止，提示「打不开“XXX”，因为它不是从 Mac App Store 下载的。」</li>
  <li>仅允许 Mac App Store 和被认可的开发者时未签名或已被篡改的应用会被阻止，提示「打不开“XXX”，因为它来自身份不明的开发者。」</li>
  <li>允许任何来源时被篡改的应用仍然会被阻止，提示「“XXX”已损坏，打不开。您应该将它移到废纸篓。」</li>
</ul>

<p>“不对啊，那 Gatekeeper 也应该检测出有问题的 Xcode 并阻止它运行啊。”</p>

<p>Gatekeeper 是通过 com.apple.quarantine 标记来判断文件是否从互联网上下载的。标记可以用 <code class="highlighter-rouge">xattr</code> 来查看。</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  Downloads  xattr -l *.app             
CheatSheet.app: com.apple.quarantine: 0023;00000000;The\x20Unarchiver;8F22E217-7ED8-44D7-B11F-88B319E5B82E
Retinizer.app: com.apple.quarantine: 0043;00000000;The\x20Unarchiver;5E278371-834C-4C31-BC70-58E89F7CD0AF
diumoo.app: com.apple.quarantine: 0003;00000000;The Unarchiver;C91583C2-3D0B-4639-A2D7-41C37AEF5650
</code></pre></div></div>

<p>这是 xattr 在我的电脑的下载目录里的运行结果。从 quarantine 中可知这三个应用都是从网络上下载的。（并且还有一些别的内容，比如说都是用「The Unarchiver」解压缩的）</p>

<p>有些程序在下载的时候并没有设置 quarantine 标记，Gatekeeper 就不会检查，于是……（其实我觉得它不应该只检查从互联网上下载的应用，应该检查所有的应用才是正常的啊）</p>

<p>再说了，就算 Gatekeeper 提示了问题，也挡不住想死的人的步伐：可以直接关掉 Gatekeeper，可以右键打开（打开过后 Gatekeeper 就再也不会检查），还可以在终端里开……</p>

<h3 id="检查数字签名">检查数字签名</h3>

<p>要检查应用的数字签名似乎只能在终端下。<code class="highlighter-rouge">codesign</code> 和 <code class="highlighter-rouge">spctl</code> 可以用来检查应用的数字签名。</p>

<h4 id="codesign"><code class="highlighter-rouge">codesign</code></h4>

<p><code class="highlighter-rouge">codesign</code> 可以来检查应用是否签名以及签名后是否被篡改。</p>

<p>如果一切正常，显示如下：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  /Applications  codesign -vv iTunes.app 
iTunes.app: valid on disk
iTunes.app: satisfies its Designated Requirement
</code></pre></div></div>

<p>如果应用被篡改过，显示如下：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  /Applications  codesign -vv VLC.app 
VLC.app: a sealed resource is missing or invalid
file added: /Applications/VLC.app/Contents/MacOS/plugins/plugins.dat
</code></pre></div></div>

<p>如果应用压根没有签名，显示如下：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  /Applications  codesign -vv OnyX.app 
OnyX.app: code object is not signed at all
In architecture: x86_64
</code></pre></div></div>

<h4 id="spctl"><code class="highlighter-rouge">spctl</code></h4>

<p><code class="highlighter-rouge">spctl</code> 可以用来看是谁给应用签名，当然也可以同时检查签名是否正常。</p>

<p>系统应用：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  /Applications  spctl -avv iTunes.app 
iTunes.app: accepted
source=Apple System
origin=Software Signing
</code></pre></div></div>

<p>Mac App Store 上下载的应用：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  /Applications  spctl -avv GeoGebra\ 5.app 
GeoGebra 5.app: accepted
source=Mac App Store
origin=Apple Mac OS Application Signing
</code></pre></div></div>

<p>其它开发者（就是 Gatekeeper 里面的「被认可的开发者」）授权获得的证书签名的应用：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  /Applications  spctl -avv NeteaseMusic.app 
NeteaseMusic.app: accepted
source=Developer ID
origin=Developer ID Application: NetEase (Hangzhou) Network Co., Ltd. (J669Y64Z9Y)
</code></pre></div></div>

<p>被篡改过的应用：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  /Applications  spctl -avv VLC.app 
VLC.app: a sealed resource is missing or invalid
</code></pre></div></div>

<p>没有签名的应用：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  /Applications  spctl -avv OnyX.app        
OnyX.app: rejected
source=no usable signature
</code></pre></div></div>

<p>如果说这个应用的签名者有问题（比如像 Windows 里面，从百度一不小心下载的 Chrome 安装包却是百度的签名）的话，那这个应用也是有问题的。</p>

<p>以上。</p>

  </div>

  
    <div class="post-comments" itemprop="comment">
      <hr />
<h3>Comments</h3>
<div id="disqus_thread"></div>
<script>

/**
*  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
*  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
/*
var disqus_config = function () {
this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
};
*/
(function() { // DON'T EDIT BELOW THIS LINE
var d = document, s = d.createElement('script');
s.src = 'https://taokyblog.disqus.com/embed.js';
s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    </div>
  

</article>

      </div>
    </main>

    <footer class="site-footer">

  <div class="wrapper">

    <p>
      

Author: taoky - Subscribe via <a href="https://taoky.github.io/feed.xml">RSS</a>
<br>
License: <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/">知识共享署名-非商业性使用-相同方式共享 4.0 国际许可协议（CC-BY-NC-SA 4.0）</a>
    </p>

  </div>

</footer>


  </body>

</html>
